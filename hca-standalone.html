<!DOCTYPE html>
<html>
<head></head>
<body>
    <h1>HCA decoder demo</h1>
    <i>Standalone version - you may right-click & save this page for offline use.</i><br>
    <hr>
    <button disabled id="startworkerbtn">start background worker</button><br>
    <button disabled id="shutdownbtn">shutdown background worker</button><br>
    <hr>
    <h3>Choose a HCA file</h3>
    Drag & drop a file here,<br>
    <form id="localfileform">
        Or pick a local file: <input type="file" id="localfile" accept=".hca,application/octet-stream" onchange="buttons.loadfilebtn = this.files.length > 0"><br>
    </form>
    <b><u>Don't forget to</u></b> <button disabled id="loadfilebtn">load picked file</button><br>
    Or download from URL: <input type="text" spellcheck="false" id="urlinput" value="bgm01_anime02_hca.hca"><br>
    <button id="downloadbtn">download</button><br>
    <hr>
    <h3>Set keys for decryption/encryption</h3>
    key1=<input type="text" spellcheck="false" id="key1input" value="0x01395C51"><br>
    key2=<input type="text" spellcheck="false" id="key2input" value="0x00000000"><br>
    <i>Note: output waveform will be nothing but unpleasant meaningless noise if incorrect keys are given!</i><br>
    <hr>
    <h3>Decode the whole file</h3>
    Decoding mode: <input type="number" step="8" min="0" max="32" placeholder="0-99" id="decodingmodeinput" value="16"><br>
    Loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
    Volume: <input type="number" step="1" min="0" max="100" placeholder="0-100" id="volumeinput" value="100"><br>
    Note:<br>
    (1) Setting decoding mode to <b>zero means 32-bit float mode</b>, or <b>8/16/24/32-bit integer mode</b> otherwise.<br>
    (2) Loop count is <b>ignored if HCA header doesn't have loop section</b><br>
    (3) Loop count doesn't count the existing part which is originally supposed to be looped.<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>In other words, actual loop count will be: the number set here plus one.</b><br>
    (4) When <b>decoding the whole file</b>, setting loop count to <b>zero</b> means: <b>disabling loop</b>.</b><br>
    <button disabled id="infobtn">get HCA info</button><br>
    <style>
        table {
            border-top: 1px solid #000;
            border-left: 1px solid #000;
            border-spacing: 0;
        }
        tbody td {
            border-bottom: 1px solid #000;
            border-right: 1px solid #000;
            min-width: 8ch;
        }
        thead tr th, tfoot tr th {
            background-color: #fff;
            color: #000;
            border-bottom: 1px solid #000;
            border-right: 1px solid #000;
        }
    </style>
    <table id="hcaInfoTable">
        <thead>
            <tr>
                <th colspan="3">HCA info</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>(Not loaded)</td>
            </tr>
        </tbody>
    </table>
    <button disabled id="fixcsumbtn">fix checksum</button><br>
    <button disabled id="encryptbtn">encrypt</button><br>
    <button disabled id="decryptbtn">decrypt</button><br>
    <button disabled id="decodebtn">decode</button><br>
    <audio id="audioElement" controls></audio>
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script> -->
    <script type="module">
        const hcaJsUrl = new URL("data:text/javascript;base64,Y2xhc3MgSENBQ2lwaGVyIHsKICAgIGNvbnN0cnVjdG9yKGtleTEsIGtleTIpIHsKICAgICAgICB0aGlzLmNpcGhlclR5cGUgPSAwOwogICAgICAgIHRoaXMuZW5jcnlwdCA9IGZhbHNlOwogICAgICAgIHRoaXMua2V5MWJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICB0aGlzLmtleTJidWYgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgICAgdGhpcy5fdGFibGUgPSBuZXcgVWludDhBcnJheSgyNTYpOwogICAgICAgIHRoaXMuZHYxID0gbmV3IERhdGFWaWV3KHRoaXMua2V5MWJ1Zik7CiAgICAgICAgdGhpcy5kdjIgPSBuZXcgRGF0YVZpZXcodGhpcy5rZXkyYnVmKTsKICAgICAgICBpZiAoa2V5MSA9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbm8ga2V5cyBnaXZlbi4gdXNlICJkZWZhdWx0a2V5IiBpZiB5b3Ugd2FudCB0byB1c2UgdGhlIGRlZmF1bHQga2V5Jyk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoa2V5MSkgewogICAgICAgICAgICBjYXNlICJub25lIjoKICAgICAgICAgICAgY2FzZSAibm9rZXkiOgogICAgICAgICAgICBjYXNlICJub0tleSI6CiAgICAgICAgICAgIGNhc2UgIm5vIGtleSI6CiAgICAgICAgICAgIGNhc2UgIm5vX0tleSI6CiAgICAgICAgICAgICAgICB0aGlzLnNldFRvTm9LZXkoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZWZhdWx0a2V5IjoKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdEtleSI6CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHQga2V5IjoKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdF9rZXkiOgogICAgICAgICAgICAgICAgdGhpcy5zZXRUb0RlZktleXMoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAga2V5MSA9IEhDQUNpcGhlci5wYXJzZUtleShrZXkxKTsKICAgICAgICAgICAgICAgIGlmIChrZXkyID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrZXkyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGtleTIgPSBIQ0FDaXBoZXIucGFyc2VLZXkoa2V5Mik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnNldEtleXMoa2V5MSwga2V5Mik7CiAgICAgICAgfQogICAgfQogICAgaW5pdDEoKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDEsIHYgPSAwOyBpIDwgMHhGRjsgaSsrKSB7CiAgICAgICAgICAgIHYgPSAodiAqIDEzICsgMTEpICYgMHhGRjsKICAgICAgICAgICAgaWYgKHYgPT0gMCB8fCB2ID09IDB4RkYpCiAgICAgICAgICAgICAgICB2ID0gKHYgKiAxMyArIDExKSAmIDB4RkY7CiAgICAgICAgICAgIHRoaXMuX3RhYmxlW2ldID0gdjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdGFibGVbMF0gPSAwOwogICAgICAgIHRoaXMuX3RhYmxlWzB4RkZdID0gMHhGRjsKICAgIH0KICAgIGluaXQ1NigpIHsKICAgICAgICBsZXQga2V5MSA9IHRoaXMuZ2V0S2V5MSgpOwogICAgICAgIGxldCBrZXkyID0gdGhpcy5nZXRLZXkyKCk7CiAgICAgICAgaWYgKCFrZXkxKQogICAgICAgICAgICBrZXkyLS07CiAgICAgICAga2V5MS0tOwogICAgICAgIHRoaXMuZHYxLnNldFVpbnQzMigwLCBrZXkxLCB0cnVlKTsKICAgICAgICB0aGlzLmR2Mi5zZXRVaW50MzIoMCwga2V5MiwgdHJ1ZSk7CiAgICAgICAgbGV0IHQxID0gdGhpcy5nZXRCeXRlc09mVHdvS2V5cygpOwogICAgICAgIGxldCB0MiA9IG5ldyBVaW50OEFycmF5KFsKICAgICAgICAgICAgdDFbMV0sIHQxWzFdIF4gdDFbNl0sIHQxWzJdIF4gdDFbM10sCiAgICAgICAgICAgIHQxWzJdLCB0MVsyXSBeIHQxWzFdLCB0MVszXSBeIHQxWzRdLAogICAgICAgICAgICB0MVszXSwgdDFbM10gXiB0MVsyXSwgdDFbNF0gXiB0MVs1XSwKICAgICAgICAgICAgdDFbNF0sIHQxWzRdIF4gdDFbM10sIHQxWzVdIF4gdDFbNl0sCiAgICAgICAgICAgIHQxWzVdLCB0MVs1XSBeIHQxWzRdLCB0MVs2XSBeIHQxWzFdLAogICAgICAgICAgICB0MVs2XQogICAgICAgIF0pOwogICAgICAgIGxldCB0MyA9IG5ldyBVaW50OEFycmF5KDB4MTAwKTsKICAgICAgICBsZXQgdDMxID0gbmV3IFVpbnQ4QXJyYXkoMHgxMCk7CiAgICAgICAgbGV0IHQzMiA9IG5ldyBVaW50OEFycmF5KDB4MTApOwogICAgICAgIHRoaXMuY3JlYXRlVGFibGUodDMxLCB0MVswXSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHQgPSAwOyBpIDwgMHgxMDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlVGFibGUodDMyLCB0MltpXSk7CiAgICAgICAgICAgIGxldCB2ID0gdDMxW2ldIDw8IDQ7CiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMHgxMDsgaisrKSB7CiAgICAgICAgICAgICAgICB0M1t0KytdID0gdiB8IHQzMltqXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMCwgdiA9IDAsIHQgPSAxOyBpIDwgMHgxMDA7IGkrKykgewogICAgICAgICAgICB2ID0gKHYgKyAweDExKSAmIDB4RkY7CiAgICAgICAgICAgIGxldCBhID0gdDNbdl07CiAgICAgICAgICAgIGlmIChhICE9IDAgJiYgYSAhPSAweEZGKQogICAgICAgICAgICAgICAgdGhpcy5fdGFibGVbdCsrXSA9IGE7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3RhYmxlWzBdID0gMDsKICAgICAgICB0aGlzLl90YWJsZVsweEZGXSA9IDB4RkY7CiAgICB9CiAgICBjcmVhdGVUYWJsZShyLCBrZXkpIHsKICAgICAgICBsZXQgbXVsID0gKChrZXkgJiAxKSA8PCAzKSB8IDU7CiAgICAgICAgbGV0IGFkZCA9IChrZXkgJiAweEUpIHwgMTsKICAgICAgICBsZXQgdCA9IDA7CiAgICAgICAga2V5ID4+PSA0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMHgxMDsgaSsrKSB7CiAgICAgICAgICAgIGtleSA9IChrZXkgKiBtdWwgKyBhZGQpICYgMHhGOwogICAgICAgICAgICByW3QrK10gPSBrZXk7CiAgICAgICAgfQogICAgfQogICAgaW52ZXJ0VGFibGUoKSB7CiAgICAgICAgLy8gYWN0dWFsbHksIHRoaXMgbWV0aG9kIHN3aXRjaCB0aGUgbW9kZSBiZXR3ZWVuIGVuY3J5cHQvZGVjcnlwdAogICAgICAgIHRoaXMuZW5jcnlwdCA9ICF0aGlzLmVuY3J5cHQ7CiAgICAgICAgbGV0IF9vbGRfdGFibGUgPSB0aGlzLl90YWJsZS5zbGljZSgwKTsKICAgICAgICBsZXQgYml0TWFwID0gbmV3IFVpbnQxNkFycmF5KDE2KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI1NjsgaSsrKSB7CiAgICAgICAgICAgIC8vIGludmVydCBrZXkgYW5kIHZhbHVlCiAgICAgICAgICAgIGxldCBrZXkgPSBfb2xkX3RhYmxlW2ldOwogICAgICAgICAgICBsZXQgdmFsID0gaTsKICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGluY29uc2lzdGVuY3kKICAgICAgICAgICAgbGV0IGhpZ2hlcjQgPSBrZXkgPj4gNCAmIDB4MEY7CiAgICAgICAgICAgIGxldCBsb3dlcjQgPSBrZXkgJiAweDBGOwogICAgICAgICAgICBsZXQgZmxhZyA9IDB4MDEgPDwgbG93ZXI0OwogICAgICAgICAgICBpZiAoYml0TWFwW2hpZ2hlcjRdICYgZmxhZykKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiX3RhYmxlIGlzIG5vdCBiaWplY3RpdmUiKTsKICAgICAgICAgICAgLy8gdXBkYXRlIHRhYmxlCiAgICAgICAgICAgIHRoaXMuX3RhYmxlW2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgZ2V0VHlwZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jaXBoZXJUeXBlOwogICAgfQogICAgZ2V0RW5jcnlwdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNyeXB0OwogICAgfQogICAgZ2V0S2V5MSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5kdjEuZ2V0VWludDMyKDAsIHRydWUpOwogICAgfQogICAgZ2V0S2V5MigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kdjIuZ2V0VWludDMyKDAsIHRydWUpOwogICAgfQogICAgZ2V0Qnl0ZXNPZlR3b0tleXMoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDgpOwogICAgICAgIGJ1Zi5zZXQobmV3IFVpbnQ4QXJyYXkodGhpcy5rZXkxYnVmKSwgMCk7CiAgICAgICAgYnVmLnNldChuZXcgVWludDhBcnJheSh0aGlzLmtleTJidWYpLCA0KTsKICAgICAgICByZXR1cm4gYnVmOwogICAgfQogICAgc2V0S2V5MShrZXkpIHsKICAgICAgICB0aGlzLmR2MS5zZXRVaW50MzIoMCwga2V5LCB0cnVlKTsKICAgICAgICB0aGlzLmluaXQ1NigpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4Mzg7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBzZXRLZXkyKGtleSkgewogICAgICAgIHRoaXMuZHYyLnNldFVpbnQzMigwLCBrZXksIHRydWUpOwogICAgICAgIHRoaXMuaW5pdDU2KCk7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMHgzODsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHNldEtleXMoa2V5MSwga2V5MikgewogICAgICAgIHRoaXMuZHYxLnNldFVpbnQzMigwLCBrZXkxLCB0cnVlKTsKICAgICAgICB0aGlzLmR2Mi5zZXRVaW50MzIoMCwga2V5MiwgdHJ1ZSk7CiAgICAgICAgdGhpcy5pbml0NTYoKTsKICAgICAgICB0aGlzLmNpcGhlclR5cGUgPSAweDM4OwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgc2V0VG9EZWZLZXlzKCkgewogICAgICAgIHJldHVybiB0aGlzLnNldEtleXMoSENBQ2lwaGVyLmRlZktleTEsIEhDQUNpcGhlci5kZWZLZXkyKTsKICAgIH0KICAgIHNldFRvTm9LZXkoKSB7CiAgICAgICAgdGhpcy5pbml0MSgpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4MDE7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBtYXNrKGJsb2NrLCBvZmZzZXQsIHNpemUpIHsKICAgICAgICAvLyBlbmNyeXB0IG9yIGRlY3J5cHQgYmxvY2sgZGF0YQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIGJsb2NrW29mZnNldCArIGldID0gdGhpcy5fdGFibGVbYmxvY2tbb2Zmc2V0ICsgaV1dOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBpc0hDQUhlYWRlck1hc2tlZChoY2EpIHsKICAgICAgICAvLyBmYXN0ICYgZGlydHkgd2F5IHRvIGRldGVybWluZSB3aGV0aGVyIGVuY3J5cHRlZCwgbm90IHJlY29tbWVuZGVkCiAgICAgICAgaWYgKGhjYVswXSAmIDB4ODAgfHwgaGNhWzFdICYgMHg4MCB8fCBoY2FbMl0gJiAweDgwKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHN0YXRpYyBwYXJzZUtleShrZXkpIHsKICAgICAgICBzd2l0Y2ggKHR5cGVvZiBrZXkpIHsKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAvLyBhdm9pZCBhbWJpZ3VpdHk6IGFsd2F5cyB0cmVhdCBhcyBoZXgKICAgICAgICAgICAgICAgIGlmICgha2V5Lm1hdGNoKC9eMHgvKSkKICAgICAgICAgICAgICAgICAgICBrZXkgPSAiMHgiICsga2V5OwogICAgICAgICAgICAgICAga2V5ID0gcGFyc2VJbnQoa2V5KTsKICAgICAgICAgICAgICAgIGlmIChpc05hTihrZXkpKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IHBhcnNlIGFzIGludGVnZXIiKTsKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAvLyBhdm9pZCBlbmRpYW5uZXNzIGFtYmlndWl0eTogb25seSBhY2NlcHRpbmcgVWludDhBcnJheSwgdGhlbiByZWFkIGFzIGxpdHRsZSBlbmRpYW4KICAgICAgICAgICAgICAgIGlmIChrZXkgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGtleS5ieXRlTGVuZ3RoID09IDQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGFWaWV3KGtleS5idWZmZXIsIGtleS5ieXRlT2Zmc2V0LCBrZXkuYnl0ZUxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgLmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2FuIG9ubHkgYWNjZXB0IG51bWJlci9oZXggc3RyaW5nL1VpbnQ4QXJyYXlbNF0iKTsKICAgICAgICB9CiAgICB9Cn0KSENBQ2lwaGVyLmRlZktleTEgPSAweDAxMzk1QzUxOwpIQ0FDaXBoZXIuZGVmS2V5MiA9IDB4MDAwMDAwMDA7Cgpjb25zdCBTdWJmcmFtZXNQZXJGcmFtZSA9IDg7CmNvbnN0IFN1YkZyYW1lU2FtcGxlc0JpdHMgPSA3Owpjb25zdCBTYW1wbGVzUGVyU3ViRnJhbWUgPSAxIDw8IFN1YkZyYW1lU2FtcGxlc0JpdHM7CmNvbnN0IFNhbXBsZXNQZXJGcmFtZSA9IFN1YmZyYW1lc1BlckZyYW1lICoKICAgIFNhbXBsZXNQZXJTdWJGcmFtZTsKCmZ1bmN0aW9uIERpdmlkZUJ5Um91bmRVcCh2YWx1ZSwgZGl2aXNvcikgewogICAgcmV0dXJuIE1hdGguY2VpbCh2YWx1ZSAvIGRpdmlzb3IpOwp9CmZ1bmN0aW9uIEdldEhpZ2hOaWJibGUodmFsdWUpIHsKICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIHJldHVybiAodmFsdWUgPj4+IDQpICYgMHhGOwp9CmZ1bmN0aW9uIEdldExvd05pYmJsZSh2YWx1ZSkgewogICAgaWYgKHZhbHVlID4gMHhmZikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIGlmICh2YWx1ZSA8IC0weDgwKQogICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgcmV0dXJuIHZhbHVlICYgMHhGOwp9CmZ1bmN0aW9uIEdldE5leHRNdWx0aXBsZSh2YWx1ZSwgbXVsdGlwbGUpIHsKICAgIGlmIChtdWx0aXBsZSA8PSAwKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHZhbHVlICUgbXVsdGlwbGUgPT0gMCkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHJldHVybiB2YWx1ZSArIG11bHRpcGxlIC0gdmFsdWUgJSBtdWx0aXBsZTsKfQpmdW5jdGlvbiBTaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpIHsKICAgIGlmICh2YWx1ZSA+IDB4ZmZmZmZmZmYpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICBpZiAodmFsdWUgPCAtMHg4MDAwMDAwMCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4YWFhYWFhYWEpID4+PiAxKSB8ICgodmFsdWUgJiAweDU1NTU1NTU1KSA8PCAxKTsKICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4Y2NjY2NjY2MpID4+PiAyKSB8ICgodmFsdWUgJiAweDMzMzMzMzMzKSA8PCAyKTsKICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4ZjBmMGYwZjApID4+PiA0KSB8ICgodmFsdWUgJiAweDBmMGYwZjBmKSA8PCA0KTsKICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4ZmYwMGZmMDApID4+PiA4KSB8ICgodmFsdWUgJiAweDAwZmYwMGZmKSA8PCA4KTsKICAgIHJldHVybiAoKHZhbHVlICYgMHhmZmZmMDAwMCkgPj4+IDE2KSB8ICgodmFsdWUgJiAweDAwMDBmZmZmKSA8PCAxNik7Cn0KZnVuY3Rpb24gVW5zaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpIHsKICAgIHJldHVybiBTaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpID4+PiAwOwp9CmZ1bmN0aW9uIFVuc2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUsIGJpdENvdW50KSB7CiAgICByZXR1cm4gVW5zaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpID4+PiAoMzIgLSBiaXRDb3VudCk7Cn0KZnVuY3Rpb24gU2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUsIGJpdENvdW50KSB7CiAgICByZXR1cm4gVW5zaWduZWRCaXRSZXZlcnNlMzJUcnVuYyh2YWx1ZSA+Pj4gMCwgYml0Q291bnQpOwp9CmZ1bmN0aW9uIENsYW1wKHZhbHVlLCBtaW4sIG1heCkgewogICAgaWYgKHZhbHVlIDwgbWluKSB7CiAgICAgICAgcmV0dXJuIG1pbjsKICAgIH0KICAgIGlmICh2YWx1ZSA+IG1heCkgewogICAgICAgIHJldHVybiBtYXg7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gRGVidWdBc3NlcnQoY29uZGl0aW9uKSB7CiAgICBpZiAoIWNvbmRpdGlvbikKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlYnVnQXNzZXJ0IGZhaWxlZCIpOwp9CgpjbGFzcyBCaXRSZWFkZXIgewogICAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICAgICAgdGhpcy5CdWZmZXIgPSBidWZmZXI7CiAgICAgICAgdGhpcy5kdiA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHRoaXMuTGVuZ3RoQml0cyA9IGJ1ZmZlci5sZW5ndGggKiA4OwogICAgICAgIHRoaXMuUG9zaXRpb24gPSAwOwogICAgfQogICAgZ2V0IFJlbWFpbmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5MZW5ndGhCaXRzIC0gdGhpcy5Qb3NpdGlvbjsKICAgIH0KICAgIFJlYWRJbnQoYml0Q291bnQpIHsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLlBlZWtJbnQoYml0Q291bnQpOwogICAgICAgIHRoaXMuUG9zaXRpb24gKz0gYml0Q291bnQ7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgUmVhZEJvb2woKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuUmVhZEludCgxKSA9PSAxOwogICAgfQogICAgUmVhZE9mZnNldEJpbmFyeShiaXRDb3VudCwgYmlhcykgewogICAgICAgIGxldCBvZmZzZXQgPSAoMSA8PCAoYml0Q291bnQgLSAxKSkgLSBiaWFzOwogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuUGVla0ludChiaXRDb3VudCkgLSBvZmZzZXQ7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBBbGlnblBvc2l0aW9uKG11bHRpcGxlKSB7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IEdldE5leHRNdWx0aXBsZSh0aGlzLlBvc2l0aW9uLCBtdWx0aXBsZSk7CiAgICB9CiAgICBQZWVrSW50KGJpdENvdW50KSB7CiAgICAgICAgRGVidWdBc3NlcnQoYml0Q291bnQgPj0gMCAmJiBiaXRDb3VudCA8PSAzMik7CiAgICAgICAgaWYgKGJpdENvdW50ID4gdGhpcy5SZW1haW5pbmcpIHsKICAgICAgICAgICAgaWYgKHRoaXMuUG9zaXRpb24gPj0gdGhpcy5MZW5ndGhCaXRzKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIGxldCBleHRyYUJpdHMgPSBiaXRDb3VudCAtIHRoaXMuUmVtYWluaW5nOwogICAgICAgICAgICByZXR1cm4gdGhpcy5QZWVrSW50RmFsbGJhY2sodGhpcy5SZW1haW5pbmcpIDw8IGV4dHJhQml0czsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHZhbHVlICY9IDB4RkZGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDE2IC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoYml0Q291bnQgPD0gMTcgJiYgdGhpcy5SZW1haW5pbmcgPj0gMjQpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MTYoYnl0ZUluZGV4KSA8PCA4IHwKICAgICAgICAgICAgICAgIHRoaXMuZHYuZ2V0VWludDgoYnl0ZUluZGV4ICsgMik7CiAgICAgICAgICAgIHZhbHVlICY9IDB4RkZGRkZGID4+IGJpdEluZGV4OwogICAgICAgICAgICB2YWx1ZSA+Pj0gMjQgLSBiaXRDb3VudCAtIGJpdEluZGV4OwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChiaXRDb3VudCA8PSAyNSAmJiB0aGlzLlJlbWFpbmluZyA+PSAzMikgewogICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmR2LmdldFVpbnQzMihieXRlSW5kZXgpOwogICAgICAgICAgICB2YWx1ZSAmPSAweEZGRkZGRkZGID4+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDMyIC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5QZWVrSW50RmFsbGJhY2soYml0Q291bnQpOwogICAgfQogICAgUGVla0ludEZhbGxiYWNrKGJpdENvdW50KSB7CiAgICAgICAgbGV0IHZhbHVlID0gMDsKICAgICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5Qb3NpdGlvbiAvIDg7CiAgICAgICAgbGV0IGJpdEluZGV4ID0gdGhpcy5Qb3NpdGlvbiAlIDg7CiAgICAgICAgd2hpbGUgKGJpdENvdW50ID4gMCkgewogICAgICAgICAgICBpZiAoYml0SW5kZXggPj0gOCkgewogICAgICAgICAgICAgICAgYml0SW5kZXggPSAwOwogICAgICAgICAgICAgICAgYnl0ZUluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGJpdHNUb1JlYWQgPSBNYXRoLm1pbihiaXRDb3VudCwgOCAtIGJpdEluZGV4KTsKICAgICAgICAgICAgbGV0IG1hc2sgPSAweEZGID4+IGJpdEluZGV4OwogICAgICAgICAgICBsZXQgY3VycmVudEJ5dGUgPSAobWFzayAmIHRoaXMuZHYuZ2V0VWludDgoYnl0ZUluZGV4KSkgPj4KICAgICAgICAgICAgICAgICg4IC0gYml0SW5kZXggLSBiaXRzVG9SZWFkKTsKICAgICAgICAgICAgdmFsdWUgPSAodmFsdWUgPDwgYml0c1RvUmVhZCkgfCBjdXJyZW50Qnl0ZTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvUmVhZDsKICAgICAgICAgICAgYml0Q291bnQgLT0gYml0c1RvUmVhZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9CihmdW5jdGlvbiAoQml0UmVhZGVyKSB7CiAgICAoZnVuY3Rpb24gKE9mZnNldEJpYXMpIHsKICAgICAgICBPZmZzZXRCaWFzW09mZnNldEJpYXNbIlBvc2l0aXZlIl0gPSAxXSA9ICJQb3NpdGl2ZSI7CiAgICAgICAgT2Zmc2V0Qmlhc1tPZmZzZXRCaWFzWyJOZWdhdGl2ZSJdID0gMF0gPSAiTmVnYXRpdmUiOwogICAgfSkoQml0UmVhZGVyLk9mZnNldEJpYXMgfHwgKEJpdFJlYWRlci5PZmZzZXRCaWFzID0ge30pKTsKfSkoQml0UmVhZGVyIHx8IChCaXRSZWFkZXIgPSB7fSkpOwp2YXIgSENBQml0UmVhZGVyID0gQml0UmVhZGVyOwoKdmFyIEhDQUNoYW5uZWxUeXBlOwooZnVuY3Rpb24gKEhDQUNoYW5uZWxUeXBlKSB7CiAgICBIQ0FDaGFubmVsVHlwZVtIQ0FDaGFubmVsVHlwZVsiRGlzY3JldGUiXSA9IDBdID0gIkRpc2NyZXRlIjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9QcmltYXJ5Il0gPSAxXSA9ICJTdGVyZW9QcmltYXJ5IjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9TZWNvbmRhcnkiXSA9IDJdID0gIlN0ZXJlb1NlY29uZGFyeSI7Cn0pKEhDQUNoYW5uZWxUeXBlIHx8IChIQ0FDaGFubmVsVHlwZSA9IHt9KSk7CnZhciBIQ0FDaGFubmVsVHlwZSQxID0gSENBQ2hhbm5lbFR5cGU7CgpjbGFzcyBCaXRXcml0ZXIgewogICAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IDA7CiAgICAgICAgdGhpcy5CdWZmZXIgPSBidWZmZXI7CiAgICAgICAgdGhpcy5kdiA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHRoaXMuTGVuZ3RoQml0cyA9IGJ1ZmZlci5sZW5ndGggKiA4OwogICAgfQogICAgZ2V0IFJlbWFpbmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5MZW5ndGhCaXRzIC0gdGhpcy5Qb3NpdGlvbjsKICAgIH0KICAgIEFsaWduUG9zaXRpb24obXVsdGlwbGUpIHsKICAgICAgICBsZXQgbmV3UG9zaXRpb24gPSBHZXROZXh0TXVsdGlwbGUodGhpcy5Qb3NpdGlvbiwgbXVsdGlwbGUpOwogICAgICAgIGxldCBiaXRzID0gbmV3UG9zaXRpb24gLSB0aGlzLlBvc2l0aW9uOwogICAgICAgIHRoaXMuV3JpdGUoMCwgYml0cyk7CiAgICB9CiAgICBXcml0ZSh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICBEZWJ1Z0Fzc2VydChiaXRDb3VudCA+PSAwICYmIGJpdENvdW50IDw9IDMyKTsKICAgICAgICBpZiAoYml0Q291bnQgPiB0aGlzLlJlbWFpbmluZykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBlbm91Z2ggYml0cyBsZWZ0IGluIG91dHB1dCBidWZmZXIiKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCBvdXRWYWx1ZSA9ICgodmFsdWUgPDwgKDE2IC0gYml0Q291bnQpKSAmIDB4RkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDE2KGJ5dGVJbmRleCwgb3V0VmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAxNyAmJiB0aGlzLlJlbWFpbmluZyA+PSAyNCkgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKHZhbHVlIDw8ICgyNCAtIGJpdENvdW50KSkgJiAweEZGRkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCkgPDwgOCB8CiAgICAgICAgICAgICAgICB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCArIDIpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQxNihieXRlSW5kZXgsIG91dFZhbHVlID4+PiA4KTsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50OChieXRlSW5kZXggKyAyLCBvdXRWYWx1ZSAmIDB4RkYpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAyNSAmJiB0aGlzLlJlbWFpbmluZyA+PSAzMikgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKCh2YWx1ZSA8PCAoMzIgLSBiaXRDb3VudCkpICYgMHhGRkZGRkZGRikgPj4+IGJpdEluZGV4KTsKICAgICAgICAgICAgb3V0VmFsdWUgfD0gdGhpcy5kdi5nZXRVaW50MzIoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50MzIoYnl0ZUluZGV4LCBvdXRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLldyaXRlRmFsbGJhY2sodmFsdWUsIGJpdENvdW50KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgIH0KICAgIFdyaXRlRmFsbGJhY2sodmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIHdoaWxlIChiaXRDb3VudCA+IDApIHsKICAgICAgICAgICAgaWYgKGJpdEluZGV4ID49IDgpIHsKICAgICAgICAgICAgICAgIGJpdEluZGV4ID0gMDsKICAgICAgICAgICAgICAgIGJ5dGVJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB0b1NoaWZ0ID0gOCAtIGJpdEluZGV4IC0gYml0Q291bnQ7CiAgICAgICAgICAgIGxldCBzaGlmdGVkID0gdG9TaGlmdCA8IDAgPyB2YWx1ZSA+Pj4gLXRvU2hpZnQgOiB2YWx1ZSA8PCB0b1NoaWZ0OwogICAgICAgICAgICBsZXQgYml0c1RvV3JpdGUgPSBNYXRoLm1pbihiaXRDb3VudCwgOCAtIGJpdEluZGV4KTsKICAgICAgICAgICAgbGV0IG1hc2sgPSAoKDEgPDwgYml0c1RvV3JpdGUpIC0gMSkgPDwgOCAtIGJpdEluZGV4IC0gYml0c1RvV3JpdGU7CiAgICAgICAgICAgIGxldCBvdXRCeXRlID0gdGhpcy5kdi5nZXRVaW50OChieXRlSW5kZXgpICYgfm1hc2s7CiAgICAgICAgICAgIG91dEJ5dGUgfD0gc2hpZnRlZCAmIG1hc2s7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDgoYnl0ZUluZGV4LCBvdXRCeXRlKTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvV3JpdGU7CiAgICAgICAgICAgIGJpdENvdW50IC09IGJpdHNUb1dyaXRlOwogICAgICAgIH0KICAgIH0KfQoKY2xhc3MgQ3JjMTYgewogICAgc3RhdGljIGNhbGMoZGF0YSwgc2l6ZSkgewogICAgICAgIGlmIChzaXplID4gZGF0YS5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoc2l6ZSA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIHN1bSA9ICgoc3VtIDw8IDgpIF4gdGhpcy5fdlsoc3VtID4+IDgpIF4gZGF0YVtpXV0pICYgMHgwMDAwZmZmZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bSAmIDB4MDAwMGZmZmY7CiAgICB9CiAgICBzdGF0aWMgdmVyaWZ5KGRhdGEsIHNpemUsIGV4cGVjdGVkLCBkb05vdFRocm93ID0gZmFsc2UpIHsKICAgICAgICBpZiAoZXhwZWN0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICBleHBlY3RlZCA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpCiAgICAgICAgICAgICAgICAuZ2V0VWludDE2KHNpemUpOwogICAgICAgIH0KICAgICAgICBsZXQgYWN0dWFsID0gdGhpcy5jYWxjKGRhdGEsIHNpemUpOwogICAgICAgIGxldCByZXN1bHQgPSBleHBlY3RlZCA9PSBhY3R1YWw7CiAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgZnVuY3Rpb24gdG9IZXgobnVtKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gIjAwMDAiOwogICAgICAgICAgICAgICAgbGV0IGhleCA9IHBhZGRpbmcgKyBudW0udG9TdHJpbmcocGFkZGluZy5sZW5ndGggKiA0KS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuICIweCIgKyBoZXguc3Vic3RyaW5nKGhleC5sZW5ndGggLSBwYWRkaW5nLmxlbmd0aCwgaGV4Lmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IG1zZyA9IGBjaGVja3N1bSBtaXNtYXRjaCAoZXhwZWN0ZWQ9JHt0b0hleChleHBlY3RlZCl9IGFjdHVhbD0ke3RvSGV4KGFjdHVhbCl9KWA7CiAgICAgICAgICAgIGlmIChkb05vdFRocm93KQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHN0YXRpYyBmaXgoZGF0YSwgc2l6ZSkgewogICAgICAgIGxldCBuZXdDcmMxNiA9IHRoaXMuY2FsYyhkYXRhLCBzaXplKTsKICAgICAgICBuZXcgRGF0YVZpZXcoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoKS5zZXRVaW50MTYoc2l6ZSwgbmV3Q3JjMTYpOwogICAgICAgIHJldHVybiBkYXRhOwogICAgfQp9CkNyYzE2Ll92ID0gbmV3IFVpbnQxNkFycmF5KFsKICAgIDB4MDAwMCwgMHg4MDA1LCAweDgwMEYsIDB4MDAwQSwgMHg4MDFCLCAweDAwMUUsIDB4MDAxNCwgMHg4MDExLCAweDgwMzMsIDB4MDAzNiwgMHgwMDNDLCAweDgwMzksIDB4MDAyOCwgMHg4MDJELCAweDgwMjcsIDB4MDAyMiwKICAgIDB4ODA2MywgMHgwMDY2LCAweDAwNkMsIDB4ODA2OSwgMHgwMDc4LCAweDgwN0QsIDB4ODA3NywgMHgwMDcyLCAweDAwNTAsIDB4ODA1NSwgMHg4MDVGLCAweDAwNUEsIDB4ODA0QiwgMHgwMDRFLCAweDAwNDQsIDB4ODA0MSwKICAgIDB4ODBDMywgMHgwMEM2LCAweDAwQ0MsIDB4ODBDOSwgMHgwMEQ4LCAweDgwREQsIDB4ODBENywgMHgwMEQyLCAweDAwRjAsIDB4ODBGNSwgMHg4MEZGLCAweDAwRkEsIDB4ODBFQiwgMHgwMEVFLCAweDAwRTQsIDB4ODBFMSwKICAgIDB4MDBBMCwgMHg4MEE1LCAweDgwQUYsIDB4MDBBQSwgMHg4MEJCLCAweDAwQkUsIDB4MDBCNCwgMHg4MEIxLCAweDgwOTMsIDB4MDA5NiwgMHgwMDlDLCAweDgwOTksIDB4MDA4OCwgMHg4MDhELCAweDgwODcsIDB4MDA4MiwKICAgIDB4ODE4MywgMHgwMTg2LCAweDAxOEMsIDB4ODE4OSwgMHgwMTk4LCAweDgxOUQsIDB4ODE5NywgMHgwMTkyLCAweDAxQjAsIDB4ODFCNSwgMHg4MUJGLCAweDAxQkEsIDB4ODFBQiwgMHgwMUFFLCAweDAxQTQsIDB4ODFBMSwKICAgIDB4MDFFMCwgMHg4MUU1LCAweDgxRUYsIDB4MDFFQSwgMHg4MUZCLCAweDAxRkUsIDB4MDFGNCwgMHg4MUYxLCAweDgxRDMsIDB4MDFENiwgMHgwMURDLCAweDgxRDksIDB4MDFDOCwgMHg4MUNELCAweDgxQzcsIDB4MDFDMiwKICAgIDB4MDE0MCwgMHg4MTQ1LCAweDgxNEYsIDB4MDE0QSwgMHg4MTVCLCAweDAxNUUsIDB4MDE1NCwgMHg4MTUxLCAweDgxNzMsIDB4MDE3NiwgMHgwMTdDLCAweDgxNzksIDB4MDE2OCwgMHg4MTZELCAweDgxNjcsIDB4MDE2MiwKICAgIDB4ODEyMywgMHgwMTI2LCAweDAxMkMsIDB4ODEyOSwgMHgwMTM4LCAweDgxM0QsIDB4ODEzNywgMHgwMTMyLCAweDAxMTAsIDB4ODExNSwgMHg4MTFGLCAweDAxMUEsIDB4ODEwQiwgMHgwMTBFLCAweDAxMDQsIDB4ODEwMSwKICAgIDB4ODMwMywgMHgwMzA2LCAweDAzMEMsIDB4ODMwOSwgMHgwMzE4LCAweDgzMUQsIDB4ODMxNywgMHgwMzEyLCAweDAzMzAsIDB4ODMzNSwgMHg4MzNGLCAweDAzM0EsIDB4ODMyQiwgMHgwMzJFLCAweDAzMjQsIDB4ODMyMSwKICAgIDB4MDM2MCwgMHg4MzY1LCAweDgzNkYsIDB4MDM2QSwgMHg4MzdCLCAweDAzN0UsIDB4MDM3NCwgMHg4MzcxLCAweDgzNTMsIDB4MDM1NiwgMHgwMzVDLCAweDgzNTksIDB4MDM0OCwgMHg4MzRELCAweDgzNDcsIDB4MDM0MiwKICAgIDB4MDNDMCwgMHg4M0M1LCAweDgzQ0YsIDB4MDNDQSwgMHg4M0RCLCAweDAzREUsIDB4MDNENCwgMHg4M0QxLCAweDgzRjMsIDB4MDNGNiwgMHgwM0ZDLCAweDgzRjksIDB4MDNFOCwgMHg4M0VELCAweDgzRTcsIDB4MDNFMiwKICAgIDB4ODNBMywgMHgwM0E2LCAweDAzQUMsIDB4ODNBOSwgMHgwM0I4LCAweDgzQkQsIDB4ODNCNywgMHgwM0IyLCAweDAzOTAsIDB4ODM5NSwgMHg4MzlGLCAweDAzOUEsIDB4ODM4QiwgMHgwMzhFLCAweDAzODQsIDB4ODM4MSwKICAgIDB4MDI4MCwgMHg4Mjg1LCAweDgyOEYsIDB4MDI4QSwgMHg4MjlCLCAweDAyOUUsIDB4MDI5NCwgMHg4MjkxLCAweDgyQjMsIDB4MDJCNiwgMHgwMkJDLCAweDgyQjksIDB4MDJBOCwgMHg4MkFELCAweDgyQTcsIDB4MDJBMiwKICAgIDB4ODJFMywgMHgwMkU2LCAweDAyRUMsIDB4ODJFOSwgMHgwMkY4LCAweDgyRkQsIDB4ODJGNywgMHgwMkYyLCAweDAyRDAsIDB4ODJENSwgMHg4MkRGLCAweDAyREEsIDB4ODJDQiwgMHgwMkNFLCAweDAyQzQsIDB4ODJDMSwKICAgIDB4ODI0MywgMHgwMjQ2LCAweDAyNEMsIDB4ODI0OSwgMHgwMjU4LCAweDgyNUQsIDB4ODI1NywgMHgwMjUyLCAweDAyNzAsIDB4ODI3NSwgMHg4MjdGLCAweDAyN0EsIDB4ODI2QiwgMHgwMjZFLCAweDAyNjQsIDB4ODI2MSwKICAgIDB4MDIyMCwgMHg4MjI1LCAweDgyMkYsIDB4MDIyQSwgMHg4MjNCLCAweDAyM0UsIDB4MDIzNCwgMHg4MjMxLCAweDgyMTMsIDB4MDIxNiwgMHgwMjFDLCAweDgyMTksIDB4MDIwOCwgMHg4MjBELCAweDgyMDcsIDB4MDIwMgpdKTsKCnZhciBfYTsKY2xhc3MgSENBVGFibGVzIHsKICAgIHN0YXRpYyBpc0xpdHRsZUVuZGlhbigpIHsKICAgICAgICBsZXQgdGVzdCA9IG5ldyBGbG9hdDY0QXJyYXkoWzEuMF0pOwogICAgICAgIGxldCBkdiA9IG5ldyBEYXRhVmlldyh0ZXN0LmJ1ZmZlcik7CiAgICAgICAgaWYgKGR2LmdldFVpbnQzMigwKSAhPSAwKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgYWRhcHRFbmRpYW5uZXNzNjQzMihhKSB7CiAgICAgICAgaWYgKGEuYnl0ZUxlbmd0aCAlIDggIT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgaWYgKCF0aGlzLmlzTGl0dGxlRW5kaWFuKCkpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgICAgICBsZXQgdGVtcCA9IGFbaV07CiAgICAgICAgICAgICAgICBhW2ldID0gYVtpICsgMV07CiAgICAgICAgICAgICAgICBhW2kgKyAxXSA9IHRlbXA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGE7CiAgICB9Cn0KX2EgPSBIQ0FUYWJsZXM7CkhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtQml0cyA9IFsKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAyLCAweDAxLCAweDAyLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAzLCAweDAyLCAweDAyLCAweDAyLCAweDAzLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAzLCAweDAzLCAweDAzLCAweDAyLCAweDAzLCAweDAzLCAweDAzLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDA0LCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDA0LCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDA0LCAweDA0LCAweDA0LCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDAzLCAweDAzLCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0CiAgICBdKSwKXTsKSENBVGFibGVzLlF1YW50aXplU3BlY3RydW1WYWx1ZSA9IFsKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAzLCAweDAwLCAweDAyLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDA3LCAweDAyLCAweDAwLCAweDAxLCAweDA2LCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDA3LCAweDA1LCAweDAzLCAweDAwLCAweDAyLCAweDA0LCAweDA2LCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDBGLCAweDA2LCAweDA0LCAweDAyLCAweDAwLCAweDAxLCAweDAzLCAweDA1LCAweDBFLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDBGLCAweDBELCAweDBCLCAweDA0LCAweDAyLCAweDAwLCAweDAxLCAweDAzLCAweDBBLCAweDBDLCAweDBFLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDBGLCAweDBELCAweDBCLCAweDA5LCAweDA3LCAweDAyLCAweDAwLCAweDAxLCAweDA2LCAweDA4LCAweDBBLCAweDBDLCAweDBFLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDBGLCAweDBELCAweDBCLCAweDA5LCAweDA3LCAweDA1LCAweDAzLCAweDAwLCAweDAyLCAweDA0LCAweDA2LCAweDA4LCAweDBBLCAweDBDLCAweDBFCiAgICBdKSwKXTsKSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtQml0cyA9IFsKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAxLCAweDAxLCAweDAyLCAweDAyLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAyLCAweDAyLCAweDAyLCAweDAyLCAweDAyLCAweDAyLCAweDAzLCAweDAzLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAyLCAweDAyLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDA0LCAweDA0CiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0CiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0CiAgICBdKSwKICAgIG5ldyBVaW50OEFycmF5KFsKICAgICAgICAweDAzLCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA0CiAgICBdKSwKXTsKSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtTWF4Qml0cyA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4MDAsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDUsIDB4MDYsIDB4MDcsIDB4MDgsIDB4MDksIDB4MEEsIDB4MEIsIDB4MEMKXSk7CkhDQVRhYmxlcy5RdWFudGl6ZWRTcGVjdHJ1bVZhbHVlID0gWwogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweEZGLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDEsIDB4RkYsIDB4RkYsIDB4MDIsIDB4RkUsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHhGRiwgMHgwMiwgMHhGRSwgMHgwMywgMHhGRCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweDAxLCAweEZGLCAweEZGLCAweDAyLCAweDAyLCAweEZFLCAweEZFLCAweDAzLCAweDAzLCAweEZELCAweEZELCAweDA0LCAweEZDCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDEsIDB4RkYsIDB4RkYsIDB4MDIsIDB4MDIsIDB4RkUsIDB4RkUsIDB4MDMsIDB4RkQsIDB4MDQsIDB4RkMsIDB4MDUsIDB4RkIKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHhGRSwgMHgwMywgMHhGRCwgMHgwNCwgMHhGQywgMHgwNSwgMHhGQiwgMHgwNiwgMHhGQQogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDA0LCAweEZDLCAweDA1LCAweEZCLCAweDA2LCAweEZBLCAweDA3LCAweEY5CiAgICBdKSwKXTsKSENBVGFibGVzLlNjYWxlVG9SZXNvbHV0aW9uQ3VydmUgPSBuZXcgVWludDhBcnJheShbCiAgICAweDBGLCAweDBFLCAweDBFLCAweDBFLCAweDBFLCAweDBFLCAweDBFLCAweDBELCAweDBELCAweDBELCAweDBELCAweDBELCAweDBELCAweDBDLCAweDBDLCAweDBDLAogICAgMHgwQywgMHgwQywgMHgwQywgMHgwQiwgMHgwQiwgMHgwQiwgMHgwQiwgMHgwQiwgMHgwQiwgMHgwQSwgMHgwQSwgMHgwQSwgMHgwQSwgMHgwQSwgMHgwQSwgMHgwQSwKICAgIDB4MDksIDB4MDksIDB4MDksIDB4MDksIDB4MDksIDB4MDksIDB4MDgsIDB4MDgsIDB4MDgsIDB4MDgsIDB4MDgsIDB4MDgsIDB4MDcsIDB4MDYsIDB4MDYsIDB4MDUsCiAgICAweDA0LCAweDA0LCAweDA0LCAweDAzLCAweDAzLCAweDAzLCAweDAyLCAweDAyLCAweDAyLCAweDAyLCAweDAxCl0pOwpIQ0FUYWJsZXMuQXRoQ3VydmUgPSBuZXcgVWludDhBcnJheShbCiAgICAweDc4LCAweDVGLCAweDU2LCAweDUxLCAweDRFLCAweDRDLCAweDRCLCAweDQ5LCAweDQ4LCAweDQ4LCAweDQ3LCAweDQ2LCAweDQ2LCAweDQ1LCAweDQ1LCAweDQ1LAogICAgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0MywgMHg0MywgMHg0MywgMHg0MywgMHg0MywgMHg0MywgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwKICAgIDB4NDIsIDB4NDIsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsCiAgICAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLAogICAgMHgzRiwgMHgzRiwgMHgzRiwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwKICAgIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0MsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsCiAgICAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLAogICAgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywKICAgIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0QsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0UsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDNGLAogICAgMHgzRiwgMHgzRiwgMHgzRiwgMHgzRiwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwKICAgIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsCiAgICAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLAogICAgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwKICAgIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDIsIDB4NDMsIDB4NDMsIDB4NDMsCiAgICAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQ0LCAweDQ0LAogICAgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NCwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwKICAgIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDUsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsIDB4NDYsCiAgICAweDQ2LCAweDQ2LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ3LCAweDQ4LCAweDQ4LCAweDQ4LCAweDQ4LAogICAgMHg0OCwgMHg0OCwgMHg0OCwgMHg0OCwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0OSwgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QSwKICAgIDB4NEEsIDB4NEEsIDB4NEEsIDB4NEEsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEIsIDB4NEMsIDB4NEMsIDB4NEMsIDB4NEMsIDB4NEMsCiAgICAweDRDLCAweDRELCAweDRELCAweDRELCAweDRELCAweDRELCAweDRELCAweDRFLCAweDRFLCAweDRFLCAweDRFLCAweDRFLCAweDRFLCAweDRGLCAweDRGLCAweDRGLAogICAgMHg0RiwgMHg0RiwgMHg0RiwgMHg1MCwgMHg1MCwgMHg1MCwgMHg1MCwgMHg1MCwgMHg1MSwgMHg1MSwgMHg1MSwgMHg1MSwgMHg1MSwgMHg1MiwgMHg1MiwgMHg1MiwKICAgIDB4NTIsIDB4NTIsIDB4NTMsIDB4NTMsIDB4NTMsIDB4NTMsIDB4NTQsIDB4NTQsIDB4NTQsIDB4NTQsIDB4NTQsIDB4NTUsIDB4NTUsIDB4NTUsIDB4NTUsIDB4NTYsCiAgICAweDU2LCAweDU2LCAweDU2LCAweDU3LCAweDU3LCAweDU3LCAweDU3LCAweDU3LCAweDU4LCAweDU4LCAweDU4LCAweDU5LCAweDU5LCAweDU5LCAweDU5LCAweDVBLAogICAgMHg1QSwgMHg1QSwgMHg1QSwgMHg1QiwgMHg1QiwgMHg1QiwgMHg1QiwgMHg1QywgMHg1QywgMHg1QywgMHg1RCwgMHg1RCwgMHg1RCwgMHg1RCwgMHg1RSwgMHg1RSwKICAgIDB4NUUsIDB4NUYsIDB4NUYsIDB4NUYsIDB4NjAsIDB4NjAsIDB4NjAsIDB4NjEsIDB4NjEsIDB4NjEsIDB4NjEsIDB4NjIsIDB4NjIsIDB4NjIsIDB4NjMsIDB4NjMsCiAgICAweDYzLCAweDY0LCAweDY0LCAweDY0LCAweDY1LCAweDY1LCAweDY2LCAweDY2LCAweDY2LCAweDY3LCAweDY3LCAweDY3LCAweDY4LCAweDY4LCAweDY4LCAweDY5LAogICAgMHg2OSwgMHg2QSwgMHg2QSwgMHg2QSwgMHg2QiwgMHg2QiwgMHg2QiwgMHg2QywgMHg2QywgMHg2RCwgMHg2RCwgMHg2RCwgMHg2RSwgMHg2RSwgMHg2RiwgMHg2RiwKICAgIDB4NzAsIDB4NzAsIDB4NzAsIDB4NzEsIDB4NzEsIDB4NzIsIDB4NzIsIDB4NzMsIDB4NzMsIDB4NzMsIDB4NzQsIDB4NzQsIDB4NzUsIDB4NzUsIDB4NzYsIDB4NzYsCiAgICAweDc3LCAweDc3LCAweDc4LCAweDc4LCAweDc4LCAweDc5LCAweDc5LCAweDdBLCAweDdBLCAweDdCLCAweDdCLCAweDdDLCAweDdDLCAweDdELCAweDdELCAweDdFLAogICAgMHg3RSwgMHg3RiwgMHg3RiwgMHg4MCwgMHg4MCwgMHg4MSwgMHg4MSwgMHg4MiwgMHg4MywgMHg4MywgMHg4NCwgMHg4NCwgMHg4NSwgMHg4NSwgMHg4NiwgMHg4NiwKICAgIDB4ODcsIDB4ODgsIDB4ODgsIDB4ODksIDB4ODksIDB4OEEsIDB4OEEsIDB4OEIsIDB4OEMsIDB4OEMsIDB4OEQsIDB4OEQsIDB4OEUsIDB4OEYsIDB4OEYsIDB4OTAsCiAgICAweDkwLCAweDkxLCAweDkyLCAweDkyLCAweDkzLCAweDk0LCAweDk0LCAweDk1LCAweDk1LCAweDk2LCAweDk3LCAweDk3LCAweDk4LCAweDk5LCAweDk5LCAweDlBLAogICAgMHg5QiwgMHg5QiwgMHg5QywgMHg5RCwgMHg5RCwgMHg5RSwgMHg5RiwgMHhBMCwgMHhBMCwgMHhBMSwgMHhBMiwgMHhBMiwgMHhBMywgMHhBNCwgMHhBNSwgMHhBNSwKICAgIDB4QTYsIDB4QTcsIDB4QTcsIDB4QTgsIDB4QTksIDB4QUEsIDB4QUEsIDB4QUIsIDB4QUMsIDB4QUQsIDB4QUUsIDB4QUUsIDB4QUYsIDB4QjAsIDB4QjEsIDB4QjEsCiAgICAweEIyLCAweEIzLCAweEI0LCAweEI1LCAweEI2LCAweEI2LCAweEI3LCAweEI4LCAweEI5LCAweEJBLCAweEJBLCAweEJCLCAweEJDLCAweEJELCAweEJFLCAweEJGLAogICAgMHhDMCwgMHhDMSwgMHhDMSwgMHhDMiwgMHhDMywgMHhDNCwgMHhDNSwgMHhDNiwgMHhDNywgMHhDOCwgMHhDOSwgMHhDOSwgMHhDQSwgMHhDQiwgMHhDQywgMHhDRCwKICAgIDB4Q0UsIDB4Q0YsIDB4RDAsIDB4RDEsIDB4RDIsIDB4RDMsIDB4RDQsIDB4RDUsIDB4RDYsIDB4RDcsIDB4RDgsIDB4RDksIDB4REEsIDB4REIsIDB4REMsIDB4REQsCiAgICAweERFLCAweERGLCAweEUwLCAweEUxLCAweEUyLCAweEUzLCAweEU0LCAweEU1LCAweEU2LCAweEU3LCAweEU4LCAweEU5LCAweEVBLCAweEVCLCAweEVELCAweEVFLAogICAgMHhFRiwgMHhGMCwgMHhGMSwgMHhGMiwgMHhGMywgMHhGNCwgMHhGNSwgMHhGNywgMHhGOCwgMHhGOSwgMHhGQSwgMHhGQiwgMHhGQywgMHhGRApdKTsKSENBVGFibGVzLk1kY3RXaW5kb3cgPSBuZXcgRmxvYXQ2NEFycmF5KF9hLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4MDAwMDAwMDAsIDB4M0Y0NkEwOUUsIDB4MDAwMDAwMDAsIDB4M0Y2MDMwNzcsIDB4MDAwMDAwMDAsIDB4M0Y2RTE4QTcsIDB4MDAwMDAwMDAsIDB4M0Y3NzcyNEQsCiAgICAweDIwMDAwMDAwLCAweDNGODA5NTAxLCAweDAwMDAwMDAwLCAweDNGODYxMDQwLCAweDgwMDAwMDAwLCAweDNGOEMyNTA5LCAweEUwMDAwMDAwLCAweDNGOTE2N0UyLAogICAgMHg0MDAwMDAwMCwgMHgzRjk1MDczMiwgMHhBMDAwMDAwMCwgMHgzRjk4RUZGNywgMHgwMDAwMDAwMCwgMHgzRjlEMjIyMiwgMHhBMDAwMDAwMCwgMHgzRkEwQ0VGOSwKICAgIDB4ODAwMDAwMDAsIDB4M0ZBMzMxRjgsIDB4ODAwMDAwMDAsIDB4M0ZBNUJBNkIsIDB4NjAwMDAwMDAsIDB4M0ZBODY4QzgsIDB4MjAwMDAwMDAsIDB4M0ZBQjNEOTgsCiAgICAweDAwMDAwMDAwLCAweDNGQUUzOTc1LCAweEMwMDAwMDAwLCAweDNGQjBBRTgzLCAweDYwMDAwMDAwLCAweDNGQjI1NDgyLCAweDgwMDAwMDAwLCAweDNGQjQwRjE2LAogICAgMHg0MDAwMDAwMCwgMHgzRkI1REVBNCwgMHhDMDAwMDAwMCwgMHgzRkI3QzM5MywgMHg2MDAwMDAwMCwgMHgzRkI5QkU0RiwgMHhBMDAwMDAwMCwgMHgzRkJCQ0Y0MywKICAgIDB4QTAwMDAwMDAsIDB4M0ZCREY2REQsIDB4NjAwMDAwMDAsIDB4M0ZDMDFBQzUsIDB4NDAwMDAwMDAsIDB4M0ZDMTQ1REIsIDB4NDAwMDAwMDAsIDB4M0ZDMjdDRTUsCiAgICAweDIwMDAwMDAwLCAweDNGQzNDMDE2LCAweDQwMDAwMDAwLCAweDNGQzUwRjlFLCAweEEwMDAwMDAwLCAweDNGQzY2QkFBLCAweDIwMDAwMDAwLCAweDNGQzdENDY0LAogICAgMHhBMDAwMDAwMCwgMHgzRkM5NDlFRSwgMHhFMDAwMDAwMCwgMHgzRkNBQ0M2NywgMHhFMDAwMDAwMCwgMHgzRkNDNUJFNiwgMHgyMDAwMDAwMCwgMHgzRkNERjg3QSwKICAgIDB4MDAwMDAwMDAsIDB4M0ZDRkEyMjcsIDB4NDAwMDAwMDAsIDB4M0ZEMEFDNzQsIDB4RTAwMDAwMDAsIDB4M0ZEMThFNTYsIDB4MjAwMDAwMDAsIDB4M0ZEMjc2QUMsCiAgICAweEUwMDAwMDAwLCAweDNGRDM2NTVELCAweEUwMDAwMDAwLCAweDNGRDQ1QTRELCAweDYwMDAwMDAwLCAweDNGRDU1NTU1LCAweDQwMDAwMDAwLCAweDNGRDY1NjQ0LAogICAgMHhDMDAwMDAwMCwgMHgzRkQ3NUNFMCwgMHhFMDAwMDAwMCwgMHgzRkQ4NjhFNiwgMHhBMDAwMDAwMCwgMHgzRkQ5N0EwNywgMHhDMDAwMDAwMCwgMHgzRkRBOEZFOCwKICAgIDB4MDAwMDAwMDAsIDB4M0ZEQkFBMjUsIDB4ODAwMDAwMDAsIDB4M0ZEQ0M4NEIsIDB4RTAwMDAwMDAsIDB4M0ZEREU5REYsIDB4RTAwMDAwMDAsIDB4M0ZERjBFNUEsCiAgICAweDIwMDAwMDAwLCAweDNGRTAxQTk1LCAweDQwMDAwMDAwLCAweDNGRTBBRUQ5LCAweDYwMDAwMDAwLCAweDNGRTE0M0E3LCAweDAwMDAwMDAwLCAweDNGRTFEOEE5LAogICAgMHhBMDAwMDAwMCwgMHgzRkUyNkQ4NCwgMHg0MDAwMDAwMCwgMHgzRkUzMDFERSwgMHg0MDAwMDAwMCwgMHgzRkUzOTU1OCwgMHg0MDAwMDAwMCwgMHgzRkU0Mjc5NCwKICAgIDB4QTAwMDAwMDAsIDB4M0ZFNEI4MzQsIDB4RTAwMDAwMDAsIDB4M0ZFNTQ2REMsIDB4MDAwMDAwMDAsIDB4M0ZFNUQzMzMsIDB4QTAwMDAwMDAsIDB4M0ZFNjVDRTAsCiAgICAweEMwMDAwMDAwLCAweDNGRTZFMzkzLCAweEMwMDAwMDAwLCAweDNGRTc2NkZGLCAweDQwMDAwMDAwLCAweDNGRTdFNkRFLCAweDAwMDAwMDAwLCAweDNGRTg2MkYwLAogICAgMHhDMDAwMDAwMCwgMHgzRkU4REFGQywgMHg4MDAwMDAwMCwgMHgzRkU5NEVENCwgMHg4MDAwMDAwMCwgMHgzRkU5QkU0RiwgMHhFMDAwMDAwMCwgMHgzRkVBMjk0RCwKICAgIDB4QTAwMDAwMDAsIDB4M0ZFQThGQjgsIDB4NjAwMDAwMDAsIDB4M0ZFQUYxODAsIDB4QzAwMDAwMDAsIDB4M0ZFQjRFOUQsIDB4RTAwMDAwMDAsIDB4M0ZFQkE3MTAsCiAgICAweEUwMDAwMDAwLCAweDNGRUJGQUUwLCAweDQwMDAwMDAwLCAweDNGRUM0QTFCLCAweDIwMDAwMDAwLCAweDNGRUM5NEQzLCAweDAwMDAwMDAwLCAweDNGRUNEQjIxLAogICAgMHhDMDAwMDAwMCwgMHgzRkVEMUQyMSwgMHgyMDAwMDAwMCwgMHgzRkVENUFGNiwgMHgyMDAwMDAwMCwgMHgzRkVEOTRDMiwgMHg0MDAwMDAwMCwgMHgzRkVEQ0FBQywKICAgIDB4RTAwMDAwMDAsIDB4M0ZFREZDREMsIDB4RTAwMDAwMDAsIDB4M0ZFRTJCN0QsIDB4MjAwMDAwMDAsIDB4M0ZFRTU2QkEsIDB4QzAwMDAwMDAsIDB4M0ZFRTdFQkMsCiAgICAweDIwMDAwMDAwLCAweDNGRUVBM0IxLCAweDYwMDAwMDAwLCAweDNGRUVDNUMyLCAweEUwMDAwMDAwLCAweDNGRUVFNTFBLCAweDAwMDAwMDAwLCAweDNGRUYwMUU0LAogICAgMHg4MDAwMDAwMCwgMHgzRkVGMUM0NiwgMHg4MDAwMDAwMCwgMHgzRkVGMzQ2OSwgMHhFMDAwMDAwMCwgMHgzRkVGNEE3MiwgMHgyMDAwMDAwMCwgMHgzRkVGNUU4NywKICAgIDB4MDAwMDAwMDAsIDB4M0ZFRjcwQzksIDB4QzAwMDAwMDAsIDB4M0ZFRjgxNTksIDB4MDAwMDAwMDAsIDB4M0ZFRjkwNTksIDB4QzAwMDAwMDAsIDB4M0ZFRjlERTQsCiAgICAweDYwMDAwMDAwLCAweDNGRUZBQTE5LCAweEMwMDAwMDAwLCAweDNGRUZCNTExLCAweEUwMDAwMDAwLCAweDNGRUZCRUU2LCAweEMwMDAwMDAwLCAweDNGRUZDN0IwLAogICAgMHg0MDAwMDAwMCwgMHgzRkVGQ0Y4NSwgMHg4MDAwMDAwMCwgMHgzRkVGRDY3OSwgMHhFMDAwMDAwMCwgMHgzRkVGRENBMCwgMHg4MDAwMDAwMCwgMHgzRkVGRTIwRCwKICAgIDB4NjAwMDAwMDAsIDB4M0ZFRkU2RDAsIDB4NDAwMDAwMDAsIDB4M0ZFRkVBRjksIDB4QzAwMDAwMDAsIDB4M0ZFRkVFOTYsIDB4QzAwMDAwMDAsIDB4M0ZFRkYxQjYsCiAgICAweEMwMDAwMDAwLCAweDNGRUZGNDY1LCAweDYwMDAwMDAwLCAweDNGRUZGNkFGLCAweEMwMDAwMDAwLCAweDNGRUZGODlFLCAweEEwMDAwMDAwLCAweDNGRUZGQTNELAogICAgMHhBMDAwMDAwMCwgMHgzRkVGRkI5NSwgMHgyMDAwMDAwMCwgMHgzRkVGRkNBRiwgMHgwMDAwMDAwMCwgMHgzRkVGRkQ5MiwgMHhDMDAwMDAwMCwgMHgzRkVGRkU0NSwKICAgIDB4MDAwMDAwMDAsIDB4M0ZFRkZFRDEsIDB4MDAwMDAwMDAsIDB4M0ZFRkZGM0EsIDB4NDAwMDAwMDAsIDB4M0ZFRkZGODYsIDB4NDAwMDAwMDAsIDB4M0ZFRkZGQkIsCiAgICAweEEwMDAwMDAwLCAweDNGRUZGRkRELCAweEUwMDAwMDAwLCAweDNGRUZGRkYxLCAweEUwMDAwMDAwLCAweDNGRUZGRkZCLCAweDgwMDAwMDAwLCAweDNGRUZGRkZGCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuRGVmYXVsdENoYW5uZWxNYXBwaW5nID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwNCwgMHgwMCwgMHgwMSwgMHgwMywgMHgwNywgMHgwMwpdKTsKSENBVGFibGVzLlZhbGlkQ2hhbm5lbE1hcHBpbmdzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDEsIDB4MDEsIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDEsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDEKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDEKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLApdOwpIQ0FUYWJsZXMuRGVxdWFudGl6ZXJTY2FsaW5nVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9hLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4Q0E1RDkyMDEsIDB4M0U4NTUxQTQsIDB4MkU1N0QxMzksIDB4M0U4QzY3RjEsIDB4QTkzRTJGNEEsIDB4M0U5MkVDQUYsIDB4QjBDREM1RDUsIDB4M0U5OTM3MzcsCiAgICAweDJCNzI0N0VELCAweDNFQTBDQzkyLCAweDgyNTUyMjE3LCAweDNFQTY2MjM4LCAweEYzMDFCNDRGLCAweDNFQUREMzIxLCAweDRDMTIzNDE2LCAweDNFQjNERUE2LAogICAgMHgxMzMwQjM0OSwgMHgzRUJBNzk5RSwgMHhFQjZGQ0I2QywgMHgzRUMxQTM1QiwgMHg0RkRFNUQzMywgMHgzRUM3ODA2OSwgMHg1QjZFNDUyRiwgMHgzRUNGNTA3NiwKICAgIDB4OTlGREREMDMsIDB4M0VENERDQjIsIDB4OTA0QkMxQzMsIDB4M0VEQkNDMUUsIDB4RTFGNTYzNzgsIDB4M0VFMjg0REYsIDB4NDIyQUEwQ0YsIDB4M0VFOEFDRTUsCiAgICAweDI5RERGNkQ2LCAweDNFRjA3MDZCLCAweDE1QUQyMTNFLCAweDNFRjVFNzZGLCAweDA4MEQ4OUUzLCAweDNFRkQyRjg3LCAweDM3M0FBOUMyLCAweDNGMDM3MUE3LAogICAgMHgxOUUzMjMxOCwgMHgzRjA5RTg2MywgMHhBRUE5MkREOCwgMHgzRjExNDI5QSwgMHhGOTUxOTQ3QiwgMHgzRjE2RkY3RCwgMHhBMkE0OTBDRCwgMHgzRjFFQTRBRiwKICAgIDB4RUQxRDAwNTAsIDB4M0YyNDZBNDEsIDB4Qjg0RjE1RjAsIDB4M0YyQjMzQTIsIDB4OTE3RERDOTAsIDB4M0YzMjFGNDksIDB4OTk0Q0NFMEEsIDB4M0YzODI1ODksCiAgICAweEE5RkIzMzJGLCAweDNGNDAxNjNELCAweDM2QjUyN0QzLCAweDNGNDU2RjQ3LCAweDk0MDZFN0FDLCAweDNGNEM4RjZELCAweDBBMzFCNzBGLCAweDNGNTMwNkZFLAogICAgMHhDQkM4NTIwNywgMHgzRjU5NUE0NCwgMHgzMkQzRDE5RCwgMHgzRjYwRTNFQywgMHhENDRDQTk2QywgMHgzRjY2ODE1NSwgMHgzMzdCOUI1NiwgMHgzRjZERkM5NywKICAgIDB4MDRBQzgwMTYsIDB4M0Y3M0ZBNDUsIDB4NTU3OUZEQjgsIDB4M0Y3QTlFNkIsIDB4ODQwNDVDQ0YsIDB4M0Y4MUJCRTAsIDB4NzNFQjAxODEsIDB4M0Y4N0ExMTQsCiAgICAweEFEOUNCRTBDLCAweDNGOEY3QkZELCAweDc2OUQyQ0EyLCAweDNGOTRGOUIyLCAweDVCRDcxRTAzLCAweDNGOUJGMkMyLCAweEY1MUZERURFLCAweDNGQTI5RTlELAogICAgMHgxNkI1NDQ4NywgMHgzRkE4Q0YzMiwgMHgxODc1OUJDNSwgMHgzRkIwODc0NSwgMHhCOTc2REMwNSwgMHgzRkI2MDVFMSwgMHhEQ0ZCQTQ4MywgMHgzRkJENTgxOCwKICAgIDB4NkQwNUQ4NjMsIDB4M0ZDMzhDQUUsIDB4N0I1REU1NjEsIDB4M0ZDQTBDNjYsIDB4QzhBNThFNEYsIDB4M0ZEMTVBOTgsIDB4RThFQzVGNzEsIDB4M0ZENzFGNzUsCiAgICAweDJEOEU2N0VELCAweDNGREVDRjQ4LCAweEI1QzEzQ0NFLCAweDNGRTQ4NkEyLCAweDhERTU1OTM4LCAweDNGRUI1OTcyLCAweDZFNzU2MjM3LCAweDNGRjIzODdBLAogICAgMHg0NjIzQzdBQywgMHgzRkY4NDcxQSwgMHgzRTc3ODA2MCwgMHg0MDAwMkM5QSwgMHhENDk3QzdGRCwgMHg0MDA1OEQxMiwgMHhEQ0VGOTA2OCwgMHg0MDBDQjcyMCwKICAgIDB4RkM0Q0Q4MzEsIDB4NDAxMzIxNzAsIDB4OUZERTRFNTAsIDB4NDAxOTdEODIsIDB4QUZGRUQzMUIsIDB4NDAyMEZCNjYsIDB4NjY3RjNCQ0QsIDB4NDAyNkEwOUUKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJTdGVwU2l6ZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHg1NTU1NTU1NSwgMHgzRkU1NTU1NSwgMHg5OTk5OTk5QSwgMHgzRkQ5OTk5OSwgMHg5MjQ5MjQ5MiwgMHgzRkQyNDkyNCwKICAgIDB4MUM3MUM3MUMsIDB4M0ZDQzcxQzcsIDB4NzQ1RDE3NDYsIDB4M0ZDNzQ1RDEsIDB4MTNCMTNCMTQsIDB4M0ZDM0IxM0IsIDB4MTExMTExMTEsIDB4M0ZDMTExMTEsCiAgICAweDA4NDIxMDg0LCAweDNGQjA4NDIxLCAweDEwNDEwNDEwLCAweDNGQTA0MTA0LCAweDgxMDIwNDA4LCAweDNGOTAyMDQwLCAweDEwMTAxMDEwLCAweDNGODAxMDEwLAogICAgMHgwMjAxMDA4MCwgMHgzRjcwMDgwNCwgMHgwMDQwMTAwNCwgMHgzRjYwMDQwMSwgMHg0MDA4MDEwMCwgMHgzRjUwMDIwMCwgMHgxMDAxMDAxMCwgMHgzRjQwMDEwMApdKSkuYnVmZmVyKTsKSENBVGFibGVzLlF1YW50aXplckRlYWRab25lID0gbmV3IEZsb2F0NjRBcnJheShfYS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweEZGRkZGRkZGLCAweEZGRkZGRkZGLCAweDU1NTU1NTUzLCAweDNGRDU1NTU1LCAweDk5OTk5OTk3LCAweDNGQzk5OTk5LCAweDkyNDkyNDhFLCAweDNGQzI0OTI0LAogICAgMHgxQzcxQzcxNywgMHgzRkJDNzFDNywgMHg3NDVEMTc0MCwgMHgzRkI3NDVEMSwgMHgxM0IxM0IwRCwgMHgzRkIzQjEzQiwgMHgxMTExMTEwOSwgMHgzRkIxMTExMSwKICAgIDB4MDg0MjEwNzQsIDB4M0ZBMDg0MjEsIDB4MTA0MTAzRjAsIDB4M0Y5MDQxMDQsIDB4ODEwMjAzQzgsIDB4M0Y4MDIwNDAsIDB4MTAxMDBGOTAsIDB4M0Y3MDEwMTAsCiAgICAweDAyMDBGRjgwLCAweDNGNjAwODA0LCAweDAwNDAwRTA0LCAweDNGNTAwNDAxLCAweDQwMDdGRDAwLCAweDNGNDAwMjAwLCAweDEwMDBGODEwLCAweDNGMzAwMTAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUXVhbnRpemVyU2NhbGluZ1RhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDU0M0UxQTIxLCAweDQxNTgwNDI3LCAweDg4NjI4Q0UyLCAweDQxNTIwNjNCLCAweDI5OERCNjc3LCAweDQxNEIwRTA3LCAweDYwNjE4OTNBLCAweDQxNDQ0RTA4LAogICAgMHhGQkM3NEM5NiwgMHg0MTNFN0E1MSwgMHgzQzY1MUEzRCwgMHg0MTM2REZCMiwgMHhDMDZDMzFENiwgMHg0MTMxMkFCRCwgMHg4MkEzRjBBMCwgMHg0MTI5QzQ5MSwKICAgIDB4NUY5MjlGRkMsIDB4NDEyMzU2QzUsIDB4NEEwNzg5OEIsIDB4NDExRDA3MkQsIDB4OEE1OTQ2QzIsIDB4NDExNUM5MjYsIDB4RDMxNTg1N0QsIDB4NDExMDU5QjAsCiAgICAweEQ5OEE2NkE2LCAweDQxMDg4QUM3LCAweDY1RTI3Q0U3LCAweDQxMDI2QjQ1LCAweDMwQTEwNjU2LCAweDQwRkJBNUIwLCAweEQ1MzYyQTMyLCAweDQwRjRCRkRBLAogICAgMHgzNzZCQkFBNiwgMHg0MEVGMjUyQiwgMHg1NjQyNjdENCwgMHg0MEU3NUZFQiwgMHgzODhDOERGMiwgMHg0MEUxOEFGOSwgMHhCMjNFMjU2OCwgMHg0MERBNTUwMywKICAgIDB4QzMxM0E4RUQsIDB4NDBEM0MzMkQsIDB4MDNEQjMyOTMsIDB4NDBDREE5RTYsIDB4MzRDQ0MzMjgsIDB4NDBDNjQzNDYsIDB4NkNGOTg5MTYsIDB4NDBDMEI1NTgsCiAgICAweDBCOTFGRkNGLCAweDQwQjkxNDVCLCAweEE2RTQwMzEzLCAweDQwQjJEMjg1LCAweDVGRkZEMDg0LCAweDQwQUM0MEFCLCAweDU2OUQ0Rjg5LCAweDQwQTUzNDJCLAogICAgMHgyQjhGNzFGRSwgMHg0MDlGRDNDMiwgMHgzNkNGNEU2QSwgMHg0MDk3RTJGMywgMHgyMkZDRDkyMiwgMHg0MDkxRUQ1MCwgMHg5OTVBRDNCNiwgMHg0MDhBRTg5RiwKICAgIDB4RDk1MEE4OUQsIDB4NDA4NDMxRjUsIDB4RTc4QjNGRkYsIDB4NDA3RTUwMkUsIDB4NzUwQkRBQzYsIDB4NDA3NkMwMTIsIDB4RDAxMjVCNTYsIDB4NDA3MTEzMDEsCiAgICAweDcwQ0EwN0MxLCAweDQwNjlBMEYxLCAweEIyNjQxNzA1LCAweDQwNjMzQzA4LCAweDU1NURDNDAxLCAweDQwNUNERjBCLCAweERENDg1NDJGLCAweDQwNTVBQjA3LAogICAgMHhFODZFN0Y4OSwgMHg0MDUwNDMxNSwgMHg5QjQ0OTJGMiwgMHg0MDQ4NjhEOSwgMHg0RkIyQTY0MywgMHg0MDQyNTFDRSwgMHhGMkZCNUU0QywgMHg0MDNCN0Y3NiwKICAgIDB4RjBEN0QzRTMsIDB4NDAzNEEzMkEsIDB4RUU2MTVBMkQsIDB4NDAyRUZBMUIsIDB4NDhBNTgxNzgsIDB4NDAyNzNGOUEsIDB4M0M3RDUxN0QsIDB4NDAyMTcyQjgsCiAgICAweEVDNEEyRDM3LCAweDQwMUEzMDlCLCAweDM0RTU5RkZBLCAweDQwMTNBN0RCLCAweDE2Qzk4MzlCLCAweDQwMEQ4MEUzLCAweEIwM0E1NTg3LCAweDQwMDYyNDdFLAogICAgMHhDQUM2RjM4NSwgMHg0MDAwOUUzRSwgMHg5OTE1NzczOSwgMHgzRkY4RjFBRSwgMHhEMERBRDk5MSwgMHgzRkYyQjg3RiwgMHhERDg1NTI5RSwgMHgzRkVDMTk5QiwKICAgIDB4QTJDRjY2NDIsIDB4M0ZFNTE2REEsIDB4ODE5RTkwREEsIDB4M0ZERkE3QzEsIDB4MDEzMEMxMzMsIDB4M0ZEN0MxRUQsIDB4MzE2OEI5QUIsIDB4M0ZEMUQ0ODcsCiAgICAweEJGRDNGMzdBLCAweDNGQ0FDMzZCLCAweDIxRjcyRTJBLCAweDNGQzQxNjBBLCAweDE0RjVBMTI5LCAweDNGQkUyNjQ2LCAweDY2N0YzQkNDLCAweDNGQjZBMDlFCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUXVhbnRpemVySW52ZXJzZVN0ZXBTaXplID0gbmV3IEZsb2F0NjRBcnJheShfYS5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDNGRTAwMDAwLCAweDAwMDAwMDAwLCAweDNGRjgwMDAwLCAweDAwMDAwMDAwLCAweDQwMDQwMDAwLCAweDAwMDAwMDAwLCAweDQwMEMwMDAwLAogICAgMHgwMDAwMDAwMCwgMHg0MDEyMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDE2MDAwMCwgMHgwMDAwMDAwMCwgMHg0MDFBMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDFFMDAwMCwKICAgIDB4MDAwMDAwMDAsIDB4NDAyRjAwMDAsIDB4MDAwMDAwMDAsIDB4NDAzRjgwMDAsIDB4MDAwMDAwMDAsIDB4NDA0RkMwMDAsIDB4MDAwMDAwMDAsIDB4NDA1RkUwMDAsCiAgICAweDAwMDAwMDAwLCAweDQwNkZGMDAwLCAweDAwMDAwMDAwLCAweDQwN0ZGODAwLCAweDAwMDAwMDAwLCAweDQwOEZGQzAwLCAweDAwMDAwMDAwLCAweDQwOUZGRTAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUmVzb2x1dGlvbk1heFZhbHVlcyA9IG5ldyBJbnQzMkFycmF5KFsKICAgIDB4MDAwMDAwMDAsIDB4MDAwMDAwMDEsIDB4MDAwMDAwMDIsIDB4MDAwMDAwMDMsIDB4MDAwMDAwMDQsIDB4MDAwMDAwMDUsIDB4MDAwMDAwMDYsIDB4MDAwMDAwMDcsCiAgICAweDAwMDAwMDBGLCAweDAwMDAwMDFGLCAweDAwMDAwMDNGLCAweDAwMDAwMDdGLCAweDAwMDAwMEZGLCAweDAwMDAwMUZGLCAweDAwMDAwM0ZGLCAweDAwMDAwN0ZGCl0pOwpIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9UYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHg0MDAwMDAwMCwgMHg2REI2REI2RSwgMHgzRkZEQjZEQiwgMHhEQjZEQjZEQiwgMHgzRkZCNkRCNiwgMHg0OTI0OTI0OSwgMHgzRkY5MjQ5MiwKICAgIDB4QjZEQjZEQjcsIDB4M0ZGNkRCNkQsIDB4MjQ5MjQ5MjUsIDB4M0ZGNDkyNDksIDB4OTI0OTI0OTIsIDB4M0ZGMjQ5MjQsIDB4MDAwMDAwMDAsIDB4M0ZGMDAwMDAsCiAgICAweERCNkRCNkRCLCAweDNGRUI2REI2LCAweEI2REI2REI3LCAweDNGRTZEQjZELCAweDkyNDkyNDkyLCAweDNGRTI0OTI0LCAweERCNkRCNkRCLCAweDNGREI2REI2LAogICAgMHg5MjQ5MjQ5MiwgMHgzRkQyNDkyNCwgMHg5MjQ5MjQ5MiwgMHgzRkMyNDkyNCwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMApdKSkuYnVmZmVyKTsKSENBVGFibGVzLkludGVuc2l0eVJhdGlvQm91bmRzVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9hLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4QjZEQjZEQjcsIDB4M0ZGRURCNkQsIDB4MjQ5MjQ5MjUsIDB4M0ZGQzkyNDksIDB4OTI0OTI0OTIsIDB4M0ZGQTQ5MjQsIDB4MDAwMDAwMDAsIDB4M0ZGODAwMDAsCiAgICAweDZEQjZEQjZFLCAweDNGRjVCNkRCLCAweERCNkRCNkRCLCAweDNGRjM2REI2LCAweDQ5MjQ5MjQ5LCAweDNGRjEyNDkyLCAweDZEQjZEQjZFLCAweDNGRURCNkRCLAogICAgMHg0OTI0OTI0OSwgMHgzRkU5MjQ5MiwgMHgyNDkyNDkyNSwgMHgzRkU0OTI0OSwgMHgwMDAwMDAwMCwgMHgzRkUwMDAwMCwgMHhCNkRCNkRCNywgMHgzRkQ2REI2RCwKICAgIDB4REI2REI2REIsIDB4M0ZDQjZEQjYsIDB4OTI0OTI0OTIsIDB4M0ZCMjQ5MjQKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5TY2FsZUNvbnZlcnNpb25UYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2EuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMCwgMHgyMUY3MkUxRCwgMHgzRTU0MTYwQSwgMHhCRkQzRjM2OCwgMHgzRTVBQzM2QiwKICAgIDB4MzE2OEI5OUYsIDB4M0U2MUQ0ODcsIDB4MDEzMEMxMjMsIDB4M0U2N0MxRUQsIDB4ODE5RTkwQzQsIDB4M0U2RkE3QzEsIDB4QTJDRjY2MzUsIDB4M0U3NTE2REEsCiAgICAweEREODU1MjhCLCAweDNFN0MxOTlCLCAweEQwREFEOTg1LCAweDNFODJCODdGLCAweDk5MTU3NzI4LCAweDNFODhGMUFFLCAweENBQzZGMzdBLCAweDNFOTA5RTNFLAogICAgMHhCMDNBNTU3OCwgMHgzRTk2MjQ3RSwgMHgxNkM5ODM4OCwgMHgzRTlEODBFMywgMHgzNEU1OUZFQywgMHgzRUEzQTdEQiwgMHhFQzRBMkQyNiwgMHgzRUFBMzA5QiwKICAgIDB4M0M3RDUxNzIsIDB4M0VCMTcyQjgsIDB4NDhBNTgxNjgsIDB4M0VCNzNGOUEsIDB4RUU2MTVBMTgsIDB4M0VCRUZBMUIsIDB4RjBEN0QzRDQsIDB4M0VDNEEzMkEsCiAgICAweEYyRkI1RTNBLCAweDNFQ0I3Rjc2LCAweDRGQjJBNjM3LCAweDNFRDI1MUNFLCAweDlCNDQ5MkUxLCAweDNFRDg2OEQ5LCAweEU4NkU3RjdFLCAweDNFRTA0MzE1LAogICAgMHhERDQ4NTQyMCwgMHgzRUU1QUIwNywgMHg1NTVEQzNFRSwgMHgzRUVDREYwQiwgMHhCMjY0MTZGNywgMHgzRUYzM0MwOCwgMHg3MENBMDdCMCwgMHgzRUY5QTBGMSwKICAgIDB4RDAxMjVCNEEsIDB4M0YwMTEzMDEsIDB4NzUwQkRBQjYsIDB4M0YwNkMwMTIsIDB4RTc4QjNGRUIsIDB4M0YwRTUwMkUsIDB4RDk1MEE4OTAsIDB4M0YxNDMxRjUsCiAgICAweDk5NUFEM0E0LCAweDNGMUFFODlGLCAweDIyRkNEOTE3LCAweDNGMjFFRDUwLCAweDM2Q0Y0RTVBLCAweDNGMjdFMkYzLCAweDJCOEY3MUU3LCAweDNGMkZEM0MyLAogICAgMHg1NjlENEY3QiwgMHgzRjM1MzQyQiwgMHg1RkZGRDA3MiwgMHgzRjNDNDBBQiwgMHhBNkU0MDMwNiwgMHgzRjQyRDI4NSwgMHgwQjkxRkZCRiwgMHgzRjQ5MTQ1QiwKICAgIDB4NkNGOTg5MEIsIDB4M0Y1MEI1NTgsIDB4MzRDQ0MzMUEsIDB4M0Y1NjQzNDYsIDB4MDNEQjMyN0UsIDB4M0Y1REE5RTYsIDB4QzMxM0E4RTAsIDB4M0Y2M0MzMkQsCiAgICAweEIyM0UyNTU3LCAweDNGNkE1NTAzLCAweDM4OEM4REU2LCAweDNGNzE4QUY5LCAweDU2NDI2N0M0LCAweDNGNzc1RkVCLCAweDM3NkJCQTkyLCAweDNGN0YyNTJCLAogICAgMHhENTM2MkEyNCwgMHgzRjg0QkZEQSwgMHgzMEExMDY0NSwgMHgzRjhCQTVCMCwgMHg2NUUyN0NEQSwgMHgzRjkyNkI0NSwgMHhEOThBNjY5NiwgMHgzRjk4OEFDNywKICAgIDB4RDMxNTg1NzIsIDB4M0ZBMDU5QjAsIDB4OEE1OTQ2QjQsIDB4M0ZBNUM5MjYsIDB4NEEwNzg5NzgsIDB4M0ZBRDA3MkQsIDB4NUY5MjlGRUYsIDB4M0ZCMzU2QzUsCiAgICAweDgyQTNGMDhFLCAweDNGQjlDNDkxLCAweEMwNkMzMUNCLCAweDNGQzEyQUJELCAweDNDNjUxQTJELCAweDNGQzZERkIyLCAweEZCQzc0QzgyLCAweDNGQ0U3QTUxLAogICAgMHg2MDYxODkyQywgMHgzRkQ0NEUwOCwgMHgyOThEQjY2NSwgMHgzRkRCMEUwNywgMHg4ODYyOENENiwgMHgzRkUyMDYzQiwgMHg1NDNFMUExMSwgMHgzRkU4MDQyNywKICAgIDB4MDAwMDAwMDAsIDB4M0ZGMDAwMDAsIDB4Q0E1RDkyMEYsIDB4M0ZGNTUxQTQsIDB4MkU1N0QxNEMsIDB4M0ZGQzY3RjEsIDB4QTkzRTJGNTcsIDB4NDAwMkVDQUYsCiAgICAweEIwQ0RDNUU2LCAweDQwMDkzNzM3LCAweDJCNzI0N0Y4LCAweDQwMTBDQzkyLCAweDgyNTUyMjI2LCAweDQwMTY2MjM4LCAweEYzMDFCNDYzLCAweDQwMUREMzIxLAogICAgMHg0QzEyMzQyNCwgMHg0MDIzREVBNiwgMHgxMzMwQjM1QiwgMHg0MDJBNzk5RSwgMHhFQjZGQ0I3NywgMHg0MDMxQTM1QiwgMHg0RkRFNUQ0MiwgMHg0MDM3ODA2OSwKICAgIDB4NUI2RTQ1NDQsIDB4NDAzRjUwNzYsIDB4OTlGREREMTAsIDB4NDA0NERDQjIsIDB4OTA0QkMxRDYsIDB4NDA0QkNDMUUsIDB4RTFGNTYzODQsIDB4NDA1Mjg0REYsCiAgICAweDQyMkFBMEUwLCAweDQwNThBQ0U1LCAweDI5RERGNkUxLCAweDQwNjA3MDZCLCAweDE1QUQyMTRELCAweDQwNjVFNzZGLCAweDA4MEQ4OUY4LCAweDQwNkQyRjg3LAogICAgMHgzNzNBQTlDRiwgMHg0MDczNzFBNywgMHgxOUUzMjMyOSwgMHg0MDc5RTg2MywgMHhBRUE5MkRFNCwgMHg0MDgxNDI5QSwgMHhGOTUxOTQ4QSwgMHg0MDg2RkY3RCwKICAgIDB4QTJBNDkwRTEsIDB4NDA4RUE0QUYsIDB4RUQxRDAwNUQsIDB4NDA5NDZBNDEsIDB4Qjg0RjE2MDMsIDB4NDA5QjMzQTIsIDB4OTE3RERDOUIsIDB4NDBBMjFGNDksCiAgICAweDk5NENDRTFBLCAweDQwQTgyNTg5LCAweEE5RkIzMzNBLCAweDQwQjAxNjNELCAweDM2QjUyN0UxLCAweDQwQjU2RjQ3LCAweDk0MDZFN0JGLCAweDQwQkM4RjZELAogICAgMHgwQTMxQjcxQywgMHg0MEMzMDZGRSwgMHhDQkM4NTIxOCwgMHg0MEM5NUE0NCwgMHgzMkQzRDFBOCwgMHg0MEQwRTNFQywgMHhENDRDQTk3QywgMHg0MEQ2ODE1NSwKICAgIDB4MzM3QjlCNkEsIDB4NDBEREZDOTcsIDB4MDRBQzgwMjQsIDB4NDBFM0ZBNDUsIDB4NTU3OUZEQ0EsIDB4NDBFQTlFNkIsIDB4ODQwNDVDREIsIDB4NDBGMUJCRTAsCiAgICAweDczRUIwMTkxLCAweDQwRjdBMTE0LCAweEFEOUNCRTIxLCAweDQwRkY3QkZELCAweDc2OUQyQ0IwLCAweDQxMDRGOUIyLCAweDVCRDcxRTE1LCAweDQxMEJGMkMyLAogICAgMHhGNTFGREVFQSwgMHg0MTEyOUU5RCwgMHgxNkI1NDQ5OCwgMHg0MTE4Q0YzMiwgMHgxODc1OUJEMCwgMHg0MTIwODc0NSwgMHhCOTc2REMxNCwgMHg0MTI2MDVFMSwKICAgIDB4RENGQkE0OTYsIDB4NDEyRDU4MTgsIDB4NkQwNUQ4NzAsIDB4NDEzMzhDQUUsIDB4N0I1REU1NzMsIDB4NDEzQTBDNjYsIDB4QzhBNThFNUIsIDB4NDE0MTVBOTgsCiAgICAweEU4RUM1RjgxLCAweDQxNDcxRjc1LCAweDJEOEU2ODAyLCAweDQxNEVDRjQ4LCAweEI1QzEzQ0RDLCAweDQxNTQ4NkEyLCAweDhERTU1OTRBLCAweDQxNUI1OTcyLAogICAgMHg2RTc1NjI0MywgMHg0MTYyMzg3QSwgMHg0NjIzQzdCQywgMHg0MTY4NDcxQSwgMHgzRTc3ODA2QiwgMHg0MTcwMkM5QSwgMHhENDk3QzgwQiwgMHg0MTc1OEQxMiwKICAgIDB4RENFRjkwN0MsIDB4NDE3Q0I3MjAsIDB4RkM0Q0Q4M0UsIDB4NDE4MzIxNzAsIDB4OUZERTRFNjEsIDB4NDE4OTdEODIsIDB4MDAwMDAwMDAsIDB4MDAwMDAwMDAKXSkpLmJ1ZmZlcik7CgpjbGFzcyBIQ0FQYWNraW5nIHsKICAgIHN0YXRpYyBVbnBhY2tGcmFtZShmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgaWYgKCF0aGlzLlVucGFja0ZyYW1lSGVhZGVyKGZyYW1lLCByZWFkZXIpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdGhpcy5SZWFkU3BlY3RyYWxDb2VmZmljaWVudHMoZnJhbWUsIHJlYWRlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5wYWNraW5nV2FzU3VjY2Vzc2Z1bChmcmFtZSwgcmVhZGVyKTsKICAgIH0KICAgIHN0YXRpYyBQYWNrRnJhbWUoZnJhbWUsIG91dEJ1ZmZlcikgewogICAgICAgIHZhciB3cml0ZXIgPSBuZXcgQml0V3JpdGVyKG91dEJ1ZmZlcik7CiAgICAgICAgd3JpdGVyLldyaXRlKDB4ZmZmZiwgMTYpOwogICAgICAgIHdyaXRlci5Xcml0ZShmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCwgOSk7CiAgICAgICAgd3JpdGVyLldyaXRlKGZyYW1lLkV2YWx1YXRpb25Cb3VuZGFyeSwgNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICB0aGlzLldyaXRlU2NhbGVGYWN0b3JzKHdyaXRlciwgY2hhbm5lbCk7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUkMS5TdGVyZW9TZWNvbmRhcnkpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgU3ViZnJhbWVzUGVyRnJhbWU7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShjaGFubmVsLkludGVuc2l0eVtpXSwgNCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoZnJhbWUuSGNhLkhmckdyb3VwQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lLkhjYS5IZnJHcm91cENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoY2hhbm5lbC5IZnJTY2FsZXNbaV0sIDYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBTdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgICAgICB0aGlzLldyaXRlU3BlY3RyYSh3cml0ZXIsIGNoYW5uZWwsIHNmKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB3cml0ZXIuQWxpZ25Qb3NpdGlvbig4KTsKICAgICAgICBmb3IgKGxldCBpID0gd3JpdGVyLlBvc2l0aW9uIC8gODsgaSA8IGZyYW1lLkhjYS5ibG9ja1NpemUgLSAyOyBpKyspIHsKICAgICAgICAgICAgd3JpdGVyLmR2LnNldFVpbnQ4KGksIDApOwogICAgICAgIH0KICAgICAgICB0aGlzLldyaXRlQ2hlY2tzdW0od3JpdGVyLCBvdXRCdWZmZXIpOwogICAgfQogICAgc3RhdGljIENhbGN1bGF0ZVJlc29sdXRpb24oc2NhbGVGYWN0b3IsIG5vaXNlTGV2ZWwpIHsKICAgICAgICBpZiAoc2NhbGVGYWN0b3IgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgbGV0IGN1cnZlUG9zaXRpb24gPSBub2lzZUxldmVsIC0gKDUgKiBzY2FsZUZhY3RvciA+PiAxKSArIDI7CiAgICAgICAgY3VydmVQb3NpdGlvbiA9IENsYW1wKGN1cnZlUG9zaXRpb24sIDAsIDU4KTsKICAgICAgICByZXR1cm4gSENBVGFibGVzLlNjYWxlVG9SZXNvbHV0aW9uQ3VydmVbY3VydmVQb3NpdGlvbl07CiAgICB9CiAgICBzdGF0aWMgVW5wYWNrRnJhbWVIZWFkZXIoZnJhbWUsIHJlYWRlcikgewogICAgICAgIGxldCBzeW5jV29yZCA9IHJlYWRlci5SZWFkSW50KDE2KTsKICAgICAgICBpZiAoc3luY1dvcmQgIT0gMHhmZmZmKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBmcmFtZSBoZWFkZXIiKTsKICAgICAgICB9CiAgICAgICAgbGV0IGF0aEN1cnZlID0gZnJhbWUuQXRoQ3VydmU7CiAgICAgICAgZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwgPSByZWFkZXIuUmVhZEludCg5KTsKICAgICAgICBmcmFtZS5FdmFsdWF0aW9uQm91bmRhcnkgPSByZWFkZXIuUmVhZEludCg3KTsKICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5SZWFkU2NhbGVGYWN0b3JzKGNoYW5uZWwsIHJlYWRlcikpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpKyspIHsKICAgICAgICAgICAgICAgIGNoYW5uZWwuUmVzb2x1dGlvbltpXSA9IHRoaXMuQ2FsY3VsYXRlUmVzb2x1dGlvbihjaGFubmVsLlNjYWxlRmFjdG9yc1tpXSwgYXRoQ3VydmVbaV0gKyBmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCAtIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAobGV0IGkgPSBmcmFtZS5FdmFsdWF0aW9uQm91bmRhcnk7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLlJlc29sdXRpb25baV0gPSB0aGlzLkNhbGN1bGF0ZVJlc29sdXRpb24oY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0sIGF0aEN1cnZlW2ldICsgZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUkMS5TdGVyZW9TZWNvbmRhcnkpIHsKICAgICAgICAgICAgICAgIHRoaXMuUmVhZEludGVuc2l0eShyZWFkZXIsIGNoYW5uZWwuSW50ZW5zaXR5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChmcmFtZS5IY2EuSGZyR3JvdXBDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuUmVhZEhmclNjYWxlRmFjdG9ycyhyZWFkZXIsIGZyYW1lLkhjYS5IZnJHcm91cENvdW50LCBjaGFubmVsLkhmclNjYWxlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgUmVhZFNjYWxlRmFjdG9ycyhjaGFubmVsLCByZWFkZXIpIHsKICAgICAgICBjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzID0gcmVhZGVyLlJlYWRJbnQoMyk7CiAgICAgICAgaWYgKGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPT0gMCkgewogICAgICAgICAgICBjaGFubmVsLlNjYWxlRmFjdG9ycy5maWxsKDAsIDAsIGNoYW5uZWwuU2NhbGVGYWN0b3JzLmxlbmd0aCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA+PSA2KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0gPSByZWFkZXIuUmVhZEludCg2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuRGVsdGFEZWNvZGUocmVhZGVyLCBjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzLCA2LCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCwgY2hhbm5lbC5TY2FsZUZhY3RvcnMpOwogICAgfQogICAgc3RhdGljIFJlYWRJbnRlbnNpdHkocmVhZGVyLCBpbnRlbnNpdHkpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IFN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgaW50ZW5zaXR5W2ldID0gcmVhZGVyLlJlYWRJbnQoNCk7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIFJlYWRIZnJTY2FsZUZhY3RvcnMocmVhZGVyLCBncm91cENvdW50LCBoZnJTY2FsZSkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JvdXBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGhmclNjYWxlW2ldID0gcmVhZGVyLlJlYWRJbnQoNik7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIFJlYWRTcGVjdHJhbENvZWZmaWNpZW50cyhmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgZm9yIChsZXQgc2YgPSAwOyBzZiA8IFN1YmZyYW1lc1BlckZyYW1lOyBzZisrKSB7CiAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IHMrKykgewogICAgICAgICAgICAgICAgICAgIGxldCByZXNvbHV0aW9uID0gY2hhbm5lbC5SZXNvbHV0aW9uW3NdOwogICAgICAgICAgICAgICAgICAgIGxldCBiaXRzID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtTWF4Qml0c1tyZXNvbHV0aW9uXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29kZSA9IHJlYWRlci5QZWVrSW50KGJpdHMpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uIDwgOCkgewogICAgICAgICAgICAgICAgICAgICAgICBiaXRzID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtQml0c1tyZXNvbHV0aW9uXVtjb2RlXTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5RdWFudGl6ZWRTcGVjdHJhW3NmXVtzXSA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1WYWx1ZVtyZXNvbHV0aW9uXVtjb2RlXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlYWQgdGhlIHNpZ24tbWFnbml0dWRlIHZhbHVlLiBUaGUgbG93IGJpdCBpcyB0aGUgc2lnbgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcXVhbnRpemVkQ29lZmZpY2llbnQgPSAoY29kZSA+PiAxKSAqICgxIC0gKGNvZGUgJSAyICogMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocXVhbnRpemVkQ29lZmZpY2llbnQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cy0tOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzZl1bc10gPSBxdWFudGl6ZWRDb2VmZmljaWVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVhZGVyLlBvc2l0aW9uICs9IGJpdHM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdLmZpbGwoMCwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQsIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50ICsgMHg4MCAtIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBEZWx0YURlY29kZShyZWFkZXIsIGRlbHRhQml0cywgZGF0YUJpdHMsIGNvdW50LCBvdXRwdXQpIHsKICAgICAgICBvdXRwdXRbMF0gPSByZWFkZXIuUmVhZEludChkYXRhQml0cyk7CiAgICAgICAgbGV0IG1heERlbHRhID0gMSA8PCAoZGVsdGFCaXRzIC0gMSk7CiAgICAgICAgbGV0IG1heFZhbHVlID0gKDEgPDwgZGF0YUJpdHMpIC0gMTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGRlbHRhID0gcmVhZGVyLlJlYWRPZmZzZXRCaW5hcnkoZGVsdGFCaXRzLCBIQ0FCaXRSZWFkZXIuT2Zmc2V0Qmlhcy5Qb3NpdGl2ZSk7CiAgICAgICAgICAgIGlmIChkZWx0YSA8IG1heERlbHRhKSB7CiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBvdXRwdXRbaSAtIDFdICsgZGVsdGE7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPCAwIHx8IHZhbHVlID4gbWF4VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXRbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHB1dFtpXSA9IHJlYWRlci5SZWFkSW50KGRhdGFCaXRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBVbnBhY2tpbmdXYXNTdWNjZXNzZnVsKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICAvLyAxMjggbGVmdG92ZXIgYml0cyBhZnRlciB1bnBhY2tpbmcgc2hvdWxkIGJlIGhpZ2ggZW5vdWdoIHRvIGdldCByaWQgb2YgZmFsc2UgbmVnYXRpdmVzLAogICAgICAgIC8vIGFuZCBsb3cgZW5vdWdoIHRoYXQgZmFsc2UgcG9zaXRpdmVzIHdpbGwgYmUgdW5jb21tb24uCiAgICAgICAgcmV0dXJuIHJlYWRlci5SZW1haW5pbmcgPj0gMTYgJiYgcmVhZGVyLlJlbWFpbmluZyA8PSAxMjggfHwKICAgICAgICAgICAgdGhpcy5GcmFtZUVtcHR5KGZyYW1lKSB8fAogICAgICAgICAgICBmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCA9PSAwICYmIHJlYWRlci5SZW1haW5pbmcgPj0gMTY7CiAgICB9CiAgICBzdGF0aWMgRnJhbWVFbXB0eShmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCA+IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAvLyBJZiBhbGwgdGhlIHNjYWxlIGZhY3RvcnMgYXJlIDAsIHRoZSBmcmFtZSBpcyBlbXB0eQogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgaWYgKGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgV3JpdGVDaGVja3N1bSh3cml0ZXIsIGhjYUJ1ZmZlcikgewogICAgICAgIHdyaXRlci5Qb3NpdGlvbiA9IHdyaXRlci5MZW5ndGhCaXRzIC0gMTY7CiAgICAgICAgbGV0IGNyYzE2ID0gQ3JjMTYuY2FsYyhoY2FCdWZmZXIsIGhjYUJ1ZmZlci5sZW5ndGggLSAyKTsKICAgICAgICB3cml0ZXIuV3JpdGUoY3JjMTYsIDE2KTsKICAgIH0KICAgIHN0YXRpYyBXcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzdWJGcmFtZSkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgcmVzb2x1dGlvbiA9IGNoYW5uZWwuUmVzb2x1dGlvbltpXTsKICAgICAgICAgICAgbGV0IHF1YW50aXplZFNwZWN0cmEgPSBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc3ViRnJhbWVdW2ldOwogICAgICAgICAgICBpZiAocmVzb2x1dGlvbiA9PSAwKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uIDwgOCkgewogICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bUJpdHNbcmVzb2x1dGlvbl1bcXVhbnRpemVkU3BlY3RyYSArIDhdOwogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKEhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtVmFsdWVbcmVzb2x1dGlvbl1bcXVhbnRpemVkU3BlY3RyYSArIDhdLCBiaXRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChyZXNvbHV0aW9uIDwgMTYpIHsKICAgICAgICAgICAgICAgIGxldCBiaXRzID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtTWF4Qml0c1tyZXNvbHV0aW9uXSAtIDE7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoTWF0aC5hYnMocXVhbnRpemVkU3BlY3RyYSksIGJpdHMpOwogICAgICAgICAgICAgICAgaWYgKHF1YW50aXplZFNwZWN0cmEgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShxdWFudGl6ZWRTcGVjdHJhID4gMCA/IDAgOiAxLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBXcml0ZVNjYWxlRmFjdG9ycyh3cml0ZXIsIGNoYW5uZWwpIHsKICAgICAgICBsZXQgZGVsdGFCaXRzID0gY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0czsKICAgICAgICBsZXQgc2NhbGVzID0gY2hhbm5lbC5TY2FsZUZhY3RvcnM7CiAgICAgICAgd3JpdGVyLldyaXRlKGRlbHRhQml0cywgMyk7CiAgICAgICAgaWYgKGRlbHRhQml0cyA9PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKGRlbHRhQml0cyA9PSA2KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKHNjYWxlc1tpXSwgNik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzWzBdLCA2KTsKICAgICAgICBsZXQgbWF4RGVsdGEgPSAoMSA8PCAoZGVsdGFCaXRzIC0gMSkpIC0gMTsKICAgICAgICBsZXQgZXNjYXBlVmFsdWUgPSAoMSA8PCBkZWx0YUJpdHMpIC0gMTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGRlbHRhID0gc2NhbGVzW2ldIC0gc2NhbGVzW2kgLSAxXTsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRlbHRhKSA+IG1heERlbHRhKSB7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoZXNjYXBlVmFsdWUsIGRlbHRhQml0cyk7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShtYXhEZWx0YSArIGRlbHRhLCBkZWx0YUJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpjbGFzcyBIQ0FEZWNvZGVyIHsKICAgIHN0YXRpYyBEZWNvZGVGcmFtZShhdWRpbywgZnJhbWUpIHsKICAgICAgICBsZXQgcmVhZGVyID0gbmV3IEhDQUJpdFJlYWRlcihhdWRpbyk7CiAgICAgICAgSENBUGFja2luZy5VbnBhY2tGcmFtZShmcmFtZSwgcmVhZGVyKTsKICAgICAgICB0aGlzLkRlcXVhbnRpemVGcmFtZShmcmFtZSk7CiAgICAgICAgdGhpcy5SZXN0b3JlTWlzc2luZ0JhbmRzKGZyYW1lKTsKICAgICAgICB0aGlzLlJ1bkltZGN0KGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyBEZXF1YW50aXplRnJhbWUoZnJhbWUpIHsKICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgIHRoaXMuQ2FsY3VsYXRlR2FpbihjaGFubmVsKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgc2YgPSAwOyBzZiA8IFN1YmZyYW1lc1BlckZyYW1lOyBzZisrKSB7CiAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IHMrKykgewogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuU3BlY3RyYVtzZl1bc10gPSBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc2ZdW3NdICoKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5HYWluW3NdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIFJlc3RvcmVNaXNzaW5nQmFuZHMoZnJhbWUpIHsKICAgICAgICB0aGlzLlJlY29uc3RydWN0SGlnaEZyZXF1ZW5jeShmcmFtZSk7CiAgICAgICAgdGhpcy5BcHBseUludGVuc2l0eVN0ZXJlbyhmcmFtZSk7CiAgICB9CiAgICBzdGF0aWMgQ2FsY3VsYXRlR2FpbihjaGFubmVsKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGNoYW5uZWwuR2FpbltpXSA9CiAgICAgICAgICAgICAgICBIQ0FUYWJsZXMuRGVxdWFudGl6ZXJTY2FsaW5nVGFibGVbY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV1dICoKICAgICAgICAgICAgICAgICAgICBIQ0FUYWJsZXMuUXVhbnRpemVyU3RlcFNpemVbY2hhbm5lbC5SZXNvbHV0aW9uW2ldXTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVjb25zdHJ1Y3RIaWdoRnJlcXVlbmN5KGZyYW1lKSB7CiAgICAgICAgbGV0IGhjYSA9IGZyYW1lLkhjYTsKICAgICAgICBpZiAoaGNhLkhmckdyb3VwQ291bnQgPT0gMCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIC8vIFRoZSBsYXN0IHNwZWN0cmFsIGNvZWZmaWNpZW50IHNob3VsZCBhbHdheXMgYmUgMDsKICAgICAgICBsZXQgdG90YWxCYW5kQ291bnQgPSBNYXRoLm1pbihoY2EuY29tcERlYy5Ub3RhbEJhbmRDb3VudCwgMTI3KTsKICAgICAgICBsZXQgaGZyU3RhcnRCYW5kID0gaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudCArIGhjYS5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudDsKICAgICAgICBsZXQgaGZyQmFuZENvdW50ID0gTWF0aC5taW4oaGNhLmNvbXBEZWMuSGZyQmFuZENvdW50LCB0b3RhbEJhbmRDb3VudCAtIGhjYS5jb21wRGVjLkhmckJhbmRDb3VudCk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoY2hhbm5lbC5UeXBlID09IEhDQUNoYW5uZWxUeXBlJDEuU3RlcmVvU2Vjb25kYXJ5KQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGZvciAobGV0IGdyb3VwID0gMCwgYmFuZCA9IDA7IGdyb3VwIDwgaGNhLkhmckdyb3VwQ291bnQ7IGdyb3VwKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGNhLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCAmJiBiYW5kIDwgaGZyQmFuZENvdW50OyBiYW5kKyssIGkrKykgewogICAgICAgICAgICAgICAgICAgIGxldCBoaWdoQmFuZCA9IGhmclN0YXJ0QmFuZCArIGJhbmQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IGxvd0JhbmQgPSBoZnJTdGFydEJhbmQgLSBiYW5kIC0gMTsKICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBjaGFubmVsLkhmclNjYWxlc1tncm91cF0gLSBjaGFubmVsLlNjYWxlRmFjdG9yc1tsb3dCYW5kXSArCiAgICAgICAgICAgICAgICAgICAgICAgIDY0OwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBTdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdW2hpZ2hCYW5kXSA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBIQ0FUYWJsZXMuU2NhbGVDb252ZXJzaW9uVGFibGVbaW5kZXhdICoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdW2xvd0JhbmRdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBBcHBseUludGVuc2l0eVN0ZXJlbyhmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5IY2EuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPD0gMCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgaWYgKGZyYW1lLkNoYW5uZWxzW2NdLlR5cGUgIT0gSENBQ2hhbm5lbFR5cGUkMS5TdGVyZW9QcmltYXJ5KQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBTdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICAgICAgbGV0IGwgPSBmcmFtZS5DaGFubmVsc1tjXS5TcGVjdHJhW3NmXTsKICAgICAgICAgICAgICAgIGxldCByID0gZnJhbWUuQ2hhbm5lbHNbYyArIDFdLlNwZWN0cmFbc2ZdOwogICAgICAgICAgICAgICAgbGV0IHJhdGlvTCA9IEhDQVRhYmxlcy5JbnRlbnNpdHlSYXRpb1RhYmxlW2ZyYW1lLkNoYW5uZWxzW2MgKyAxXS5JbnRlbnNpdHlbc2ZdXTsKICAgICAgICAgICAgICAgIGxldCByYXRpb1IgPSByYXRpb0wgLSAyLjA7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBiID0gZnJhbWUuSGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudDsgYiA8IGZyYW1lLkhjYS5jb21wRGVjLlRvdGFsQmFuZENvdW50OyBiKyspIHsKICAgICAgICAgICAgICAgICAgICByW2JdID0gbFtiXSAqIHJhdGlvUjsKICAgICAgICAgICAgICAgICAgICBsW2JdICo9IHJhdGlvTDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSdW5JbWRjdChmcmFtZSkgewogICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBTdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLk1kY3QuUnVuSW1kY3QoY2hhbm5lbC5TcGVjdHJhW3NmXSwgY2hhbm5lbC5QY21GbG9hdFtzZl0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpjbGFzcyBNZGN0IHsKICAgIGNvbnN0cnVjdG9yKG1kY3RCaXRzLCB3aW5kb3csIHNjYWxlID0gMSkgewogICAgICAgIE1kY3QuU2V0VGFibGVzKG1kY3RCaXRzKTsKICAgICAgICB0aGlzLk1kY3RCaXRzID0gbWRjdEJpdHM7CiAgICAgICAgdGhpcy5NZGN0U2l6ZSA9IDEgPDwgbWRjdEJpdHM7CiAgICAgICAgdGhpcy5TY2FsZSA9IHNjYWxlOwogICAgICAgIGlmICh3aW5kb3cubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldpbmRvdyBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fbWRjdFByZXZpb3VzID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9pbWRjdFByZXZpb3VzID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9zY3JhdGNoTWRjdCA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5NZGN0U2l6ZSk7CiAgICAgICAgdGhpcy5fc2NyYXRjaERjdCA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5NZGN0U2l6ZSk7CiAgICAgICAgdGhpcy5faW1kY3RXaW5kb3cgPSB3aW5kb3c7CiAgICB9CiAgICBzdGF0aWMgU2V0VGFibGVzKG1heEJpdHMpIHsKICAgICAgICBpZiAobWF4Qml0cyA+IHRoaXMuX3RhYmxlQml0cykgewogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5fdGFibGVCaXRzICsgMTsgaSA8PSBtYXhCaXRzOyBpKyspIHsKICAgICAgICAgICAgICAgIGxldCBvdXQgPSB0aGlzLkdlbmVyYXRlVHJpZ1RhYmxlcyhpKTsKICAgICAgICAgICAgICAgIHRoaXMuU2luVGFibGVzLnB1c2gob3V0LnNpbik7CiAgICAgICAgICAgICAgICB0aGlzLkNvc1RhYmxlcy5wdXNoKG91dC5jb3MpOwogICAgICAgICAgICAgICAgdGhpcy5TaHVmZmxlVGFibGVzLnB1c2godGhpcy5HZW5lcmF0ZVNodWZmbGVUYWJsZShpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdGFibGVCaXRzID0gbWF4Qml0czsKICAgICAgICB9CiAgICB9CiAgICBSdW5NZGN0KGlucHV0LCBvdXRwdXQpIHsKICAgICAgICBpZiAoaW5wdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklucHV0IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICBpZiAob3V0cHV0Lmxlbmd0aCA8IHRoaXMuTWRjdFNpemUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPdXRwdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGxldCBzaXplID0gdGhpcy5NZGN0U2l6ZTsKICAgICAgICBsZXQgaGFsZiA9IChzaXplID4+IDEpOwogICAgICAgIGxldCBkY3RJbiA9IHRoaXMuX3NjcmF0Y2hNZGN0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGFsZjsgaSsrKSB7CiAgICAgICAgICAgIGxldCBhID0gdGhpcy5faW1kY3RXaW5kb3dbaGFsZiAtIGkgLSAxXSAqIC1pbnB1dFtoYWxmICsgaV07CiAgICAgICAgICAgIGxldCBiID0gdGhpcy5faW1kY3RXaW5kb3dbaGFsZiArIGldICogaW5wdXRbaGFsZiAtIGkgLSAxXTsKICAgICAgICAgICAgbGV0IGMgPSB0aGlzLl9pbWRjdFdpbmRvd1tpXSAqIHRoaXMuX21kY3RQcmV2aW91c1tpXTsKICAgICAgICAgICAgbGV0IGQgPSB0aGlzLl9pbWRjdFdpbmRvd1tzaXplIC0gaSAtIDFdICoKICAgICAgICAgICAgICAgIHRoaXMuX21kY3RQcmV2aW91c1tzaXplIC0gaSAtIDFdOwogICAgICAgICAgICBkY3RJbltpXSA9IGEgLSBiOwogICAgICAgICAgICBkY3RJbltoYWxmICsgaV0gPSBjIC0gZDsKICAgICAgICB9CiAgICAgICAgdGhpcy5EY3Q0KGRjdEluLCBvdXRwdXQpOwogICAgICAgIHRoaXMuX21kY3RQcmV2aW91cy5zZXQoaW5wdXQsIGlucHV0Lmxlbmd0aCk7CiAgICB9CiAgICBSdW5JbWRjdChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgaWYgKGlucHV0Lmxlbmd0aCA8IHRoaXMuTWRjdFNpemUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG91dHB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT3V0cHV0IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuTWRjdFNpemU7CiAgICAgICAgbGV0IGhhbGYgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBsZXQgZGN0T3V0ID0gdGhpcy5fc2NyYXRjaE1kY3Q7CiAgICAgICAgdGhpcy5EY3Q0KGlucHV0LCBkY3RPdXQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGFsZjsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dFtpXSA9IHRoaXMuX2ltZGN0V2luZG93W2ldICogZGN0T3V0W2kgKyBoYWxmXSArCiAgICAgICAgICAgICAgICB0aGlzLl9pbWRjdFByZXZpb3VzW2ldOwogICAgICAgICAgICBvdXRwdXRbaSArIGhhbGZdID0gdGhpcy5faW1kY3RXaW5kb3dbaSArIGhhbGZdICogLWRjdE91dFtzaXplIC0gMSAtIGldIC0KICAgICAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaSArIGhhbGZdOwogICAgICAgICAgICB0aGlzLl9pbWRjdFByZXZpb3VzW2ldID0gdGhpcy5faW1kY3RXaW5kb3dbc2l6ZSAtIDEgLSBpXSAqCiAgICAgICAgICAgICAgICAtZGN0T3V0W2hhbGYgLSBpIC0gMV07CiAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaSArIGhhbGZdID0gdGhpcy5faW1kY3RXaW5kb3dbaGFsZiAtIGkgLSAxXSAqCiAgICAgICAgICAgICAgICBkY3RPdXRbaV07CiAgICAgICAgfQogICAgfQogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIERvZXMgYSBUeXBlLTQgRENULgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iaW5wdXQiPlRoZSBpbnB1dCBhcnJheSBjb250YWluaW5nIHRoZSB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICAvLy8gPHBhcmFtIG5hbWU9Im91dHB1dCI+VGhlIG91dHB1dCBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgdHJhbnNmb3JtZWQgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXM8L3BhcmFtPgogICAgRGN0NChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgbGV0IHNodWZmbGVUYWJsZSA9IE1kY3QuU2h1ZmZsZVRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgc2luVGFibGUgPSBNZGN0LlNpblRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgY29zVGFibGUgPSBNZGN0LkNvc1RhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgZGN0VGVtcCA9IHRoaXMuX3NjcmF0Y2hEY3Q7CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBsYXN0SW5kZXggPSBzaXplIC0gMTsKICAgICAgICBsZXQgaGFsZlNpemUgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGZTaXplOyBpKyspIHsKICAgICAgICAgICAgbGV0IGkyID0gaSAqIDI7CiAgICAgICAgICAgIGxldCBhID0gaW5wdXRbaTJdOwogICAgICAgICAgICBsZXQgYiA9IGlucHV0W2xhc3RJbmRleCAtIGkyXTsKICAgICAgICAgICAgbGV0IHNpbiA9IHNpblRhYmxlW2ldOwogICAgICAgICAgICBsZXQgY29zID0gY29zVGFibGVbaV07CiAgICAgICAgICAgIGRjdFRlbXBbaTJdID0gYSAqIGNvcyArIGIgKiBzaW47CiAgICAgICAgICAgIGRjdFRlbXBbaTIgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgIH0KICAgICAgICBsZXQgc3RhZ2VDb3VudCA9IHRoaXMuTWRjdEJpdHMgLSAxOwogICAgICAgIGZvciAobGV0IHN0YWdlID0gMDsgc3RhZ2UgPCBzdGFnZUNvdW50OyBzdGFnZSsrKSB7CiAgICAgICAgICAgIGxldCBibG9ja0NvdW50ID0gMSA8PCBzdGFnZTsKICAgICAgICAgICAgbGV0IGJsb2NrU2l6ZUJpdHMgPSBzdGFnZUNvdW50IC0gc3RhZ2U7CiAgICAgICAgICAgIGxldCBibG9ja0hhbGZTaXplQml0cyA9IGJsb2NrU2l6ZUJpdHMgLSAxOwogICAgICAgICAgICBsZXQgYmxvY2tTaXplID0gMSA8PCBibG9ja1NpemVCaXRzOwogICAgICAgICAgICBsZXQgYmxvY2tIYWxmU2l6ZSA9IDEgPDwgYmxvY2tIYWxmU2l6ZUJpdHM7CiAgICAgICAgICAgIHNpblRhYmxlID0gTWRjdC5TaW5UYWJsZXNbYmxvY2tIYWxmU2l6ZUJpdHNdOwogICAgICAgICAgICBjb3NUYWJsZSA9IE1kY3QuQ29zVGFibGVzW2Jsb2NrSGFsZlNpemVCaXRzXTsKICAgICAgICAgICAgZm9yIChsZXQgYmxvY2sgPSAwOyBibG9jayA8IGJsb2NrQ291bnQ7IGJsb2NrKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tIYWxmU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGZyb250UG9zID0gKGJsb2NrICogYmxvY2tTaXplICsgaSkgKiAyOwogICAgICAgICAgICAgICAgICAgIGxldCBiYWNrUG9zID0gZnJvbnRQb3MgKyBibG9ja1NpemU7CiAgICAgICAgICAgICAgICAgICAgbGV0IGEgPSBkY3RUZW1wW2Zyb250UG9zXSAtIGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGIgPSBkY3RUZW1wW2Zyb250UG9zICsgMV0gLSBkY3RUZW1wW2JhY2tQb3MgKyAxXTsKICAgICAgICAgICAgICAgICAgICBsZXQgc2luID0gc2luVGFibGVbaV07CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvcyA9IGNvc1RhYmxlW2ldOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbZnJvbnRQb3NdICs9IGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgZGN0VGVtcFtmcm9udFBvcyArIDFdICs9IGRjdFRlbXBbYmFja1BvcyArIDFdOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbYmFja1Bvc10gPSBhICogY29zICsgYiAqIHNpbjsKICAgICAgICAgICAgICAgICAgICBkY3RUZW1wW2JhY2tQb3MgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5NZGN0U2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dFtpXSA9IGRjdFRlbXBbc2h1ZmZsZVRhYmxlW2ldXSAqIHRoaXMuU2NhbGU7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIEdlbmVyYXRlVHJpZ1RhYmxlcyhzaXplQml0cykgewogICAgICAgIGxldCBzaXplID0gMSA8PCBzaXplQml0czsKICAgICAgICBsZXQgb3V0ID0gewogICAgICAgICAgICBzaW46IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSksCiAgICAgICAgICAgIGNvczogbmV3IEZsb2F0NjRBcnJheShzaXplKSwKICAgICAgICB9OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IE1hdGguUEkgKiAoNCAqIGkgKyAxKSAvICg0ICogc2l6ZSk7CiAgICAgICAgICAgIG91dC5zaW5baV0gPSBNYXRoLnNpbih2YWx1ZSk7CiAgICAgICAgICAgIG91dC5jb3NbaV0gPSBNYXRoLmNvcyh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXQ7CiAgICB9CiAgICBzdGF0aWMgR2VuZXJhdGVTaHVmZmxlVGFibGUoc2l6ZUJpdHMpIHsKICAgICAgICBsZXQgc2l6ZSA9IDEgPDwgc2l6ZUJpdHM7CiAgICAgICAgdmFyIHRhYmxlID0gbmV3IEludDMyQXJyYXkoc2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgICAgdGFibGVbaV0gPSBTaWduZWRCaXRSZXZlcnNlMzJUcnVuYyhpIF4gKGkgPj4gMSksIHNpemVCaXRzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhYmxlOwogICAgfQogICAgLy8gUmVTaGFycGVyIGRpc2FibGUgb25jZSBVbnVzZWRNZW1iZXIuTG9jYWwKICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyBEb2VzIGEgVHlwZS00IERDVC4gSW50ZW5kZWQgZm9yIHJlZmVyZW5jZS4KICAgIC8vLyA8L3N1bW1hcnk+CiAgICAvLy8gPHBhcmFtIG5hbWU9ImlucHV0Ij5UaGUgaW5wdXQgYXJyYXkgY29udGFpbmluZyB0aGUgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXM8L3BhcmFtPgogICAgLy8vIDxwYXJhbSBuYW1lPSJvdXRwdXQiPlRoZSBvdXRwdXQgYXJyYXkgdGhhdCB3aWxsIGNvbnRhaW4gdGhlIHRyYW5zZm9ybWVkIHRpbWUgb3IgZnJlcXVlbmN5LWRvbWFpbiBzYW1wbGVzPC9wYXJhbT4KICAgIERjdDRTbG93KGlucHV0LCBvdXRwdXQpIHsKICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IHRoaXMuTWRjdFNpemU7IGsrKykgewogICAgICAgICAgICBsZXQgc2FtcGxlID0gMDsKICAgICAgICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCB0aGlzLk1kY3RTaXplOyBuKyspIHsKICAgICAgICAgICAgICAgIGxldCBhbmdsZSA9IE1hdGguUEkgLyB0aGlzLk1kY3RTaXplICogKGsgKyAwLjUpICogKG4gKyAwLjUpOwogICAgICAgICAgICAgICAgc2FtcGxlICs9IE1hdGguY29zKGFuZ2xlKSAqIGlucHV0W25dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG91dHB1dFtrXSA9IHNhbXBsZSAqIHRoaXMuU2NhbGU7CiAgICAgICAgfQogICAgfQp9Ck1kY3QuX3RhYmxlQml0cyA9IC0xOwpNZGN0LlNpblRhYmxlcyA9IFtdOwpNZGN0LkNvc1RhYmxlcyA9IFtdOwpNZGN0LlNodWZmbGVUYWJsZXMgPSBbXTsKCmNsYXNzIEhDQUNoYW5uZWwgewogICAgY29uc3RydWN0b3IodmFsdWVzKSB7CiAgICAgICAgdGhpcy5UeXBlID0gMDsKICAgICAgICB0aGlzLkNvZGVkU2NhbGVGYWN0b3JDb3VudCA9IDA7CiAgICAgICAgdGhpcy5QY21GbG9hdCA9IEFycmF5LmZyb20oeyBsZW5ndGg6IFN1YmZyYW1lc1BlckZyYW1lIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TcGVjdHJhID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogU3ViZnJhbWVzUGVyRnJhbWUgfSwgKCkgPT4gbmV3IEZsb2F0NjRBcnJheShTYW1wbGVzUGVyU3ViRnJhbWUpKTsKICAgICAgICB0aGlzLlNjYWxlZFNwZWN0cmEgPSBBcnJheS5mcm9tKHsKICAgICAgICAgICAgbGVuZ3RoOiBTYW1wbGVzUGVyU3ViRnJhbWUsCiAgICAgICAgfSwgKCkgPT4gbmV3IEZsb2F0NjRBcnJheShTdWJmcmFtZXNQZXJGcmFtZSkpOwogICAgICAgIHRoaXMuUXVhbnRpemVkU3BlY3RyYSA9IEFycmF5LmZyb20oewogICAgICAgICAgICBsZW5ndGg6IFN1YmZyYW1lc1BlckZyYW1lLAogICAgICAgIH0sICgpID0+IG5ldyBJbnQzMkFycmF5KFNhbXBsZXNQZXJTdWJGcmFtZSkpOwogICAgICAgIHRoaXMuR2FpbiA9IG5ldyBGbG9hdDY0QXJyYXkoU2FtcGxlc1BlclN1YkZyYW1lKTsKICAgICAgICB0aGlzLkludGVuc2l0eSA9IG5ldyBJbnQzMkFycmF5KFN1YmZyYW1lc1BlckZyYW1lKTsKICAgICAgICB0aGlzLkhmclNjYWxlcyA9IG5ldyBJbnQzMkFycmF5KDgpOwogICAgICAgIHRoaXMuSGZyR3JvdXBBdmVyYWdlU3BlY3RyYSA9IG5ldyBGbG9hdDY0QXJyYXkoOCk7CiAgICAgICAgdGhpcy5NZGN0ID0gbmV3IE1kY3QoU3ViRnJhbWVTYW1wbGVzQml0cywgSENBVGFibGVzLk1kY3RXaW5kb3csIE1hdGguc3FydCgyLjAgLyBTYW1wbGVzUGVyU3ViRnJhbWUpKTsKICAgICAgICB0aGlzLlNjYWxlRmFjdG9ycyA9IG5ldyBJbnQzMkFycmF5KFNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5SZXNvbHV0aW9uID0gbmV3IEludDMyQXJyYXkoU2FtcGxlc1BlclN1YkZyYW1lKTsKICAgICAgICB0aGlzLkhlYWRlckxlbmd0aEJpdHMgPSAwOwogICAgICAgIHRoaXMuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPSAwOwogICAgICAgIGxldCB0ID0gdGhpczsKICAgICAgICBmb3IgKGxldCBrZXkgaW4gdmFsdWVzKSB7CiAgICAgICAgICAgIHRba2V5XSA9IHZhbHVlc1trZXldOwogICAgICAgIH0KICAgIH0KfQoKY2xhc3MgSENBRnJhbWUgewogICAgY29uc3RydWN0b3IoaGNhKSB7CiAgICAgICAgdGhpcy5BY2NlcHRhYmxlTm9pc2VMZXZlbCA9IDA7CiAgICAgICAgdGhpcy5FdmFsdWF0aW9uQm91bmRhcnkgPSAwOwogICAgICAgIHRoaXMuSGNhID0gaGNhOwogICAgICAgIGxldCBjaGFubmVsVHlwZXMgPSBIQ0FGcmFtZS5HZXRDaGFubmVsVHlwZXMoaGNhKTsKICAgICAgICB0aGlzLkNoYW5uZWxzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoY2EuZm9ybWF0LmNoYW5uZWxDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMuQ2hhbm5lbHMucHVzaChuZXcgSENBQ2hhbm5lbCh7CiAgICAgICAgICAgICAgICBUeXBlOiBjaGFubmVsVHlwZXNbaV0sCiAgICAgICAgICAgICAgICBDb2RlZFNjYWxlRmFjdG9yQ291bnQ6IGNoYW5uZWxUeXBlc1tpXSA9PSBIQ0FDaGFubmVsVHlwZSQxLlN0ZXJlb1NlY29uZGFyeQogICAgICAgICAgICAgICAgICAgID8gaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudAogICAgICAgICAgICAgICAgICAgIDogaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudCArIGhjYS5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCwKICAgICAgICAgICAgfSkpOwogICAgICAgIH0KICAgICAgICB0aGlzLkF0aEN1cnZlID0gaGNhLlVzZUF0aEN1cnZlCiAgICAgICAgICAgID8gSENBRnJhbWUuU2NhbGVBdGhDdXJ2ZShoY2EuZm9ybWF0LnNhbXBsaW5nUmF0ZSkKICAgICAgICAgICAgOiBuZXcgVWludDhBcnJheShTYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgfQogICAgc3RhdGljIEdldENoYW5uZWxUeXBlcyhoY2EpIHsKICAgICAgICBsZXQgY2hhbm5lbHNQZXJUcmFjayA9IGhjYS5mb3JtYXQuY2hhbm5lbENvdW50IC8gaGNhLmNvbXBEZWMuVHJhY2tDb3VudDsKICAgICAgICBpZiAoaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50ID09IDAgfHwgY2hhbm5lbHNQZXJUcmFjayA9PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXkoOCkuZmlsbChIQ0FDaGFubmVsVHlwZSQxKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgRGlzY3JldGUgPSBIQ0FDaGFubmVsVHlwZSQxLkRpc2NyZXRlOwogICAgICAgIGNvbnN0IFN0ZXJlb1ByaW1hcnkgPSBIQ0FDaGFubmVsVHlwZSQxLlN0ZXJlb1ByaW1hcnk7CiAgICAgICAgY29uc3QgU3RlcmVvU2Vjb25kYXJ5ID0gSENBQ2hhbm5lbFR5cGUkMS5TdGVyZW9TZWNvbmRhcnk7CiAgICAgICAgc3dpdGNoIChjaGFubmVsc1BlclRyYWNrKSB7CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5XTsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlXTsKICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgaWYgKGhjYS5jb21wRGVjLkNoYW5uZWxDb25maWcgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBTdGVyZW9TZWNvbmRhcnksCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgaWYgKGhjYS5jb21wRGVjLkNoYW5uZWxDb25maWcgPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZSwgRGlzY3JldGVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICBEaXNjcmV0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9TZWNvbmRhcnksCiAgICAgICAgICAgICAgICAgICAgRGlzY3JldGUsCiAgICAgICAgICAgICAgICAgICAgRGlzY3JldGUsCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvUHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9TZWNvbmRhcnksCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1ByaW1hcnksCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgIERpc2NyZXRlLAogICAgICAgICAgICAgICAgICAgIERpc2NyZXRlLAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1ByaW1hcnksCiAgICAgICAgICAgICAgICAgICAgU3RlcmVvU2Vjb25kYXJ5LAogICAgICAgICAgICAgICAgICAgIERpc2NyZXRlLAogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1NlY29uZGFyeSwKICAgICAgICAgICAgICAgICAgICBEaXNjcmV0ZSwKICAgICAgICAgICAgICAgICAgICBEaXNjcmV0ZSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1NlY29uZGFyeSwKICAgICAgICAgICAgICAgICAgICBTdGVyZW9QcmltYXJ5LAogICAgICAgICAgICAgICAgICAgIFN0ZXJlb1NlY29uZGFyeSwKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEFycmF5KGNoYW5uZWxzUGVyVHJhY2spLmZpbGwoSENBQ2hhbm5lbFR5cGUkMSk7CiAgICAgICAgfQogICAgfQogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIFNjYWxlcyBhbiBBVEggY3VydmUgdG8gdGhlIHNwZWNpZmllZCBmcmVxdWVuY3kuCiAgICAvLy8gPC9zdW1tYXJ5PgogICAgLy8vIDxwYXJhbSBuYW1lPSJmcmVxdWVuY3kiPlRoZSBmcmVxdWVuY3kgdG8gc2NhbGUgdGhlIGN1cnZlIHRvLjwvcGFyYW0+CiAgICAvLy8gPHJldHVybnM+VGhlIHNjYWxlZCBBVEggY3VydmU8L3JldHVybnM+CiAgICAvLy8gPHJlbWFya3M+VGhlIG9yaWdpbmFsIEFUSCBjdXJ2ZSBpcyBmb3IgYSBmcmVxdWVuY3kgb2YgNDE4NTYgSHouPC9yZW1hcmtzPgogICAgc3RhdGljIFNjYWxlQXRoQ3VydmUoZnJlcXVlbmN5KSB7CiAgICAgICAgdmFyIGF0aCA9IG5ldyBVaW50OEFycmF5KFNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgbGV0IGFjYyA9IDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhY2MgKz0gZnJlcXVlbmN5OwogICAgICAgICAgICBsZXQgaW5kZXggPSBhY2MgPj4gMTM7CiAgICAgICAgICAgIGlmIChpbmRleCA+PSBIQ0FUYWJsZXMuQXRoQ3VydmUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBhdGhbaV0gPSBIQ0FUYWJsZXMuQXRoQ3VydmVbaW5kZXhdOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgaSA8IGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhdGhbaV0gPSAweGZmOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXRoOwogICAgfQp9CgpjbGFzcyBIQ0FJbmZvIHsKICAgIGNvbnN0cnVjdG9yKGhjYSwgY2hhbmdlTWFzayA9IGZhbHNlLCBlbmNyeXB0ID0gZmFsc2UpIHsKICAgICAgICB0aGlzLnZlcnNpb24gPSAiIjsKICAgICAgICB0aGlzLmRhdGFPZmZzZXQgPSAwOwogICAgICAgIHRoaXMuZm9ybWF0ID0gewogICAgICAgICAgICBjaGFubmVsQ291bnQ6IDAsCiAgICAgICAgICAgIHNhbXBsaW5nUmF0ZTogMCwKICAgICAgICAgICAgYmxvY2tDb3VudDogMCwKICAgICAgICAgICAgZHJvcHBlZEhlYWRlcjogMCwKICAgICAgICAgICAgZHJvcHBlZEZvb3RlcjogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMuYmxvY2tTaXplID0gMDsKICAgICAgICB0aGlzLmhhc0hlYWRlciA9IHt9OwogICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0ID0ge307IC8vIFtzdGFydCAoaW5jbHVzaXZlKSwgZW5kIChleGNsdXNpdmUpXQogICAgICAgIHRoaXMua2JwcyA9IDA7CiAgICAgICAgdGhpcy5jb21wRGVjID0gewogICAgICAgICAgICBNaW5SZXNvbHV0aW9uOiAwLAogICAgICAgICAgICBNYXhSZXNvbHV0aW9uOiAwLAogICAgICAgICAgICBUcmFja0NvdW50OiAwLAogICAgICAgICAgICBDaGFubmVsQ29uZmlnOiAwLAogICAgICAgICAgICBUb3RhbEJhbmRDb3VudDogMCwKICAgICAgICAgICAgQmFzZUJhbmRDb3VudDogMCwKICAgICAgICAgICAgU3RlcmVvQmFuZENvdW50OiAwLAogICAgICAgICAgICBIZnJCYW5kQ291bnQ6IDAsCiAgICAgICAgICAgIEJhbmRzUGVySGZyR3JvdXA6IDAsCiAgICAgICAgICAgIFJlc2VydmVkMTogMCwKICAgICAgICAgICAgUmVzZXJ2ZWQyOiAwLAogICAgICAgIH07CiAgICAgICAgdGhpcy5kZWMgPSB7CiAgICAgICAgICAgIERlY1N0ZXJlb1R5cGU6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLmxvb3AgPSB7CiAgICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgICBlbmQ6IDAsCiAgICAgICAgICAgIC8vIGNvdW50OiAwLCAvLyBOeWFnYW1vbidzIGludGVycHJldGF0aW9uCiAgICAgICAgICAgIC8vIHIwMTogMCwKICAgICAgICAgICAgZHJvcHBlZEhlYWRlcjogMCwKICAgICAgICAgICAgZHJvcHBlZEZvb3RlcjogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMudmJyID0gewogICAgICAgICAgICBNYXhCbG9ja1NpemU6IDAsCiAgICAgICAgICAgIE5vaXNlTGV2ZWw6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLlVzZUF0aEN1cnZlID0gZmFsc2U7CiAgICAgICAgdGhpcy5jaXBoZXIgPSAwOwogICAgICAgIHRoaXMucnZhID0gMC4wOwogICAgICAgIHRoaXMuY29tbWVudCA9ICIiOwogICAgICAgIC8vIGNvbXB1dGVkIHNhbXBsZSBjb3VudC9vZmZzZXRzCiAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gMDsKICAgICAgICB0aGlzLmZ1bGxTYW1wbGVDb3VudCA9IDA7CiAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wU3RhcnRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wRW5kQXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMubG9vcFNhbXBsZUNvdW50ID0gMDsKICAgICAgICB0aGlzLmVuZEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLnNhbXBsZUNvdW50ID0gMDsKICAgICAgICAvLyBmdWxsIGZpbGUgc2l6ZSAvIGRhdGEgcGFydCAoZXhjbHVkaW5nIGhlYWRlciwganVzdCBibG9ja3MvZnJhbWVzKSBzaXplCiAgICAgICAgdGhpcy5mdWxsU2l6ZSA9IDA7CiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IDA7CiAgICAgICAgLy8gaWYgY2hhbmdlTWFzayA9PSB0cnVlLCAodW4pbWFzayB0aGUgaGVhZGVyIHNpZ3MgaW4tcGxhY2UKICAgICAgICB0aGlzLnJhd0hlYWRlciA9IHRoaXMucGFyc2VIZWFkZXIoaGNhLCBjaGFuZ2VNYXNrLCBlbmNyeXB0LCB7fSk7CiAgICB9CiAgICBzdGF0aWMgZ2V0U2lnbihyYXcsIG9mZnNldCA9IDAsIGNoYW5nZU1hc2ssIGVuY3J5cHQpIHsKICAgICAgICBsZXQgbWFnaWMgPSByYXcuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgICAgbGV0IHN0ckxlbiA9IDQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICAgICAgaWYgKHJhdy5nZXRVaW50OChvZmZzZXQgKyBpKSA9PSAwKSB7CiAgICAgICAgICAgICAgICBzdHJMZW4gPSBpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHN0ckxlbiA+IDApIHsKICAgICAgICAgICAgbGV0IG1hc2sgPSAweDgwODA4MDgwID4+PiA4ICogKDQgLSBzdHJMZW4pOwogICAgICAgICAgICBtYWdpYyAmPSAweDdmN2Y3ZjdmOwogICAgICAgICAgICBpZiAoY2hhbmdlTWFzaykgewogICAgICAgICAgICAgICAgcmF3LnNldFVpbnQzMihvZmZzZXQsIGVuY3J5cHQgPyBtYWdpYyB8IG1hc2sgOiBtYWdpYywgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGhleCA9IFsKICAgICAgICAgICAgbWFnaWMgJiAweGZmLAogICAgICAgICAgICBtYWdpYyA+PiA4ICYgMHhmZiwKICAgICAgICAgICAgbWFnaWMgPj4gMTYgJiAweGZmLAogICAgICAgICAgICBtYWdpYyA+PiAyNCAmIDB4ZmYsCiAgICAgICAgXTsKICAgICAgICBoZXggPSBoZXguc2xpY2UoMCwgc3RyTGVuKTsKICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGhleCk7CiAgICB9CiAgICBjbG9uZSgpIHsKICAgICAgICByZXR1cm4gbmV3IEhDQUluZm8odGhpcy5yYXdIZWFkZXIpOwogICAgfQogICAgcGFyc2VIZWFkZXIoaGNhLCBjaGFuZ2VNYXNrLCBlbmNyeXB0LCBtb2RMaXN0KSB7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoaGNhLmJ1ZmZlciwgaGNhLmJ5dGVPZmZzZXQsIDgpOwogICAgICAgIGxldCBoZWFkID0gSENBSW5mby5nZXRTaWduKHAsIDAsIGZhbHNlLCBlbmNyeXB0KTsgLy8gZG8gbm90IG92ZXJ3cml0ZSBmb3Igbm93LCB1bnRpbCBjaGVja3N1bSB2ZXJpZmllZAogICAgICAgIGlmIChoZWFkICE9PSAiSENBIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBhIEhDQSBmaWxlIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZlcnNpb24gPSB7CiAgICAgICAgICAgIG1haW46IHAuZ2V0VWludDgoNCksCiAgICAgICAgICAgIHN1YjogcC5nZXRVaW50OCg1KSwKICAgICAgICB9OwogICAgICAgIHRoaXMudmVyc2lvbiA9IHZlcnNpb24ubWFpbiArICIuIiArIHZlcnNpb24uc3ViOwogICAgICAgIHRoaXMuZGF0YU9mZnNldCA9IHAuZ2V0VWludDE2KDYpOwogICAgICAgIC8vIHZlcmlmeSBjaGVja3N1bQogICAgICAgIENyYzE2LnZlcmlmeShoY2EsIHRoaXMuZGF0YU9mZnNldCAtIDIpOwogICAgICAgIGxldCBoYXNNb2REb25lID0gZmFsc2U7CiAgICAgICAgLy8gY2hlY2tzdW0gdmVyaWZpZWQsIG5vdyB3ZSBjYW4gb3ZlcndyaXRlIGl0CiAgICAgICAgaWYgKGNoYW5nZU1hc2spCiAgICAgICAgICAgIEhDQUluZm8uZ2V0U2lnbihwLCAwLCBjaGFuZ2VNYXNrLCBlbmNyeXB0KTsKICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyCiAgICAgICAgcCA9IG5ldyBEYXRhVmlldyhoY2EuYnVmZmVyLCBoY2EuYnl0ZU9mZnNldCwgdGhpcy5kYXRhT2Zmc2V0KTsKICAgICAgICBsZXQgZnRlbGwgPSA4OwogICAgICAgIHdoaWxlIChmdGVsbCA8IHRoaXMuZGF0YU9mZnNldCAtIDIpIHsKICAgICAgICAgICAgbGV0IGxhc3RGdGVsbCA9IGZ0ZWxsOwogICAgICAgICAgICAvLyBnZXQgdGhlIHNpZwogICAgICAgICAgICBsZXQgc2lnbiA9IEhDQUluZm8uZ2V0U2lnbihwLCBmdGVsbCwgY2hhbmdlTWFzaywgZW5jcnlwdCk7CiAgICAgICAgICAgIC8vIHJlY29yZCBoYXNIZWFkZXIKICAgICAgICAgICAgdGhpcy5oYXNIZWFkZXJbc2lnbl0gPSB0cnVlOwogICAgICAgICAgICAvLyBwYWRkaW5nIHNob3VsZCBiZSB0aGUgbGFzdCBvbmUKICAgICAgICAgICAgaWYgKHNpZ24gPT0gInBhZCIpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0W3NpZ25dID0gW2Z0ZWxsLCB0aGlzLmRhdGFPZmZzZXQgLSAyXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHBhcnNlIGRhdGEgYWNjb3JkaW5nbHkKICAgICAgICAgICAgc3dpdGNoIChzaWduKSB7CiAgICAgICAgICAgICAgICBjYXNlICJmbXQiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmNoYW5uZWxDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGUgPSBwLmdldFVpbnQzMihmdGVsbCArIDQpICYgMHgwMGZmZmZmZjsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5ibG9ja0NvdW50ID0gcC5nZXRVaW50MzIoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5kcm9wcGVkSGVhZGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuZHJvcHBlZEZvb3RlciA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgMTQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY29tcCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ibG9ja1NpemUgPSBwLmdldFVpbnQxNihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMua2JwcyA9IHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSAqIHRoaXMuYmxvY2tTaXplIC8gMTI4MDAwLjA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLk1pblJlc29sdXRpb24gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLk1heFJlc29sdXRpb24gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkNoYW5uZWxDb25maWcgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDEwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXAgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDEgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDIgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTUpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rYnBzID0gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlICogdGhpcy5ibG9ja1NpemUgLyAxMjgwMDAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWluUmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWF4UmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA3KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOSk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGEgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5UcmFja0NvdW50ID0gR2V0SGlnaE5pYmJsZShhKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyA9IEdldExvd05pYmJsZShhKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlYy5EZWNTdGVyZW9UeXBlID0gcC5nZXRVaW50OChmdGVsbCArIDExKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWMuRGVjU3RlcmVvVHlwZSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCA9IHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCAtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJ2YnIiOgogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJhdGgiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuVXNlQXRoQ3VydmUgPSBwLmdldFVpbnQxNihmdGVsbCArIDQpID09IDE7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImxvb3AiOgogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5zdGFydCA9IHAuZ2V0VWludDMyKGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29wLmVuZCA9IHAuZ2V0VWludDMyKGZ0ZWxsICsgOCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29wLmRyb3BwZWRIZWFkZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDEyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3AuZHJvcHBlZEZvb3RlciA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgMTQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY2lwaCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXBoZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJydmEiOgogICAgICAgICAgICAgICAgICAgIHRoaXMucnZhID0gcC5nZXRGbG9hdDMyKGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gODsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInZiciI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YnIuTWF4QmxvY2tTaXplID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnZici5Ob2lzZUxldmVsID0gcC5nZXRJbnQxNihmdGVsbCArIDYpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY29tbSI6CiAgICAgICAgICAgICAgICAgICAgbGV0IGxlbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICBsZXQgamlzZGVjb2RlciA9IG5ldyBUZXh0RGVjb2Rlcigic2hpZnQtamlzIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21tZW50ID0gamlzZGVjb2Rlci5kZWNvZGUoaGNhLnNsaWNlKGZ0ZWxsICsgNSwgZnRlbGwgKyA1ICsgbGVuKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5rbm93biBoZWFkZXIgc2lnIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcmVjb3JkIGhlYWRlck9mZnNldAogICAgICAgICAgICB0aGlzLmhlYWRlck9mZnNldFtzaWduXSA9IFtsYXN0RnRlbGwsIGZ0ZWxsXTsKICAgICAgICAgICAgLy8gZG8gbW9kaWZpY2F0aW9uIGlmIG5lZWRlZAogICAgICAgICAgICBsZXQgc2VjdGlvbkRhdGFMZW4gPSBmdGVsbCAtIGxhc3RGdGVsbCAtIDQ7CiAgICAgICAgICAgIGxldCBuZXdEYXRhID0gbW9kTGlzdFtzaWduXTsKICAgICAgICAgICAgaWYgKG5ld0RhdGEgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5ld0RhdGEuYnl0ZUxlbmd0aCA+IHNlY3Rpb25EYXRhTGVuKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgaGNhLnNldChuZXdEYXRhLCBsYXN0RnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgIGhhc01vZERvbmUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8qCiAgICAgICAgICAvLyAocG9ydGVkIGZyb20pIE55YWdhbW9uJ3Mgb3JpZ2luYWwgY29kZSwgc2hvdWxkIGJlIChhbG1vc3QpIGVxdWl2YWxlbnQgdG8gQ2FsY3VsYXRlSGZyVmFsdWVzCiAgICAgICAgICB0aGlzLmNvbXBQYXJhbVsyXSA9IHRoaXMuY29tcFBhcmFtWzJdIHx8IDE7CiAgICAgICAgICBsZXQgX2EgPSB0aGlzLmNvbXBQYXJhbVs0XSAtIHRoaXMuY29tcFBhcmFtWzVdIC0gdGhpcy5jb21wUGFyYW1bNl07CiAgICAgICAgICBsZXQgX2IgPSB0aGlzLmNvbXBQYXJhbVs3XTsKICAgICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDEgPSBfYiA+IDAgPyBfYSAvIF9iICsgKF9hICUgX2IgPyAxIDogMCkgOiAwOwogICAgICAgICAgLy8gVHJhbnNsYXRpbmcgdGhlIGFib3ZlIGNvZGUgd2l0aCBtZWFuaW5nZnVsIHZhcmlhYmxlIG5hbWVzOgogICAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSB0aGlzLmNvbXBEZWMuVHJhY2tDb3VudCB8fCAxOwogICAgICAgICAgdGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCA9IHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCAtIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudDsKICAgICAgICAgIHRoaXMuSGZyR3JvdXBDb3VudCA9IHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwOwogICAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMSA9IHRoaXMuSGZyR3JvdXBDb3VudCA+IDAgPyB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50IC8gdGhpcy5IZnJHcm91cENvdW50ICsgKHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgJSB0aGlzLkhmckdyb3VwQ291bnQgPyAxIDogMCkgOiAwOwogICAgICAgICAgKi8KICAgICAgICAvLyBDYWxjdWxhdGVIZnJWYWx1ZXMsIHBvcnRlZCBmcm9tIFZHQXVkaW8KICAgICAgICBpZiAodGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXAgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgLQogICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgICAgICB0aGlzLkhmckdyb3VwQ291bnQgPSBEaXZpZGVCeVJvdW5kVXAodGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCwgdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXApOwogICAgICAgIH0KICAgICAgICAvLyBjYWxjdWxhdGUgc2FtcGxlIGNvdW50L29mZnNldHMKICAgICAgICB0aGlzLmZ1bGxTYW1wbGVDb3VudCA9IHRoaXMuZm9ybWF0LmJsb2NrQ291bnQgKiBTYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlID0gdGhpcy5mb3JtYXQuZHJvcHBlZEhlYWRlcjsKICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA9IHRoaXMuZnVsbFNhbXBsZUNvdW50IC0gdGhpcy5mb3JtYXQuZHJvcHBlZEZvb3RlcjsKICAgICAgICBpZiAodGhpcy5oYXNIZWFkZXJbImxvb3AiXSkgewogICAgICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlID0gdGhpcy5sb29wLnN0YXJ0ICogU2FtcGxlc1BlckZyYW1lICsKICAgICAgICAgICAgICAgIHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyOwogICAgICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA9ICh0aGlzLmxvb3AuZW5kICsgMSkgKiBTYW1wbGVzUGVyRnJhbWUgLQogICAgICAgICAgICAgICAgdGhpcy5sb29wLmRyb3BwZWRGb290ZXI7CiAgICAgICAgICAgIHRoaXMubG9vcFNhbXBsZUNvdW50ID0gdGhpcy5sb29wRW5kQXRTYW1wbGUgLSB0aGlzLmxvb3BTdGFydEF0U2FtcGxlOwogICAgICAgIH0KICAgICAgICB0aGlzLmVuZEF0U2FtcGxlID0gdGhpcy5oYXNIZWFkZXJbImxvb3AiXQogICAgICAgICAgICA/IHRoaXMubG9vcEVuZEF0U2FtcGxlCiAgICAgICAgICAgIDogdGhpcy5mdWxsRW5kQXRTYW1wbGU7CiAgICAgICAgdGhpcy5zYW1wbGVDb3VudCA9IHRoaXMuZW5kQXRTYW1wbGUgLSB0aGlzLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgLy8gY2FsY3VsYXRlIGZpbGUvZGF0YSBzaXplCiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IHRoaXMuYmxvY2tTaXplICogdGhpcy5mb3JtYXQuYmxvY2tDb3VudDsKICAgICAgICB0aGlzLmZ1bGxTaXplID0gdGhpcy5kYXRhT2Zmc2V0ICsgdGhpcy5kYXRhU2l6ZTsKICAgICAgICBpZiAoY2hhbmdlTWFzayB8fCBoYXNNb2REb25lKSB7CiAgICAgICAgICAgIC8vIGZpeCBjaGVja3N1bSBpZiByZXF1ZXN0ZWQKICAgICAgICAgICAgQ3JjMTYuZml4KGhjYSwgdGhpcy5kYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgfQogICAgICAgIGxldCByYXdIZWFkZXIgPSBoY2Euc2xpY2UoMCwgdGhpcy5kYXRhT2Zmc2V0KTsKICAgICAgICAvLyBjaGVjayB2YWxpZGl0eSBvZiBwYXJzZWQgdmFsdWVzCiAgICAgICAgdGhpcy5jaGVja1ZhbGlkaXR5KCk7CiAgICAgICAgcmV0dXJuIHJhd0hlYWRlcjsKICAgIH0KICAgIGNoZWNrVmFsaWRpdHkoKSB7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFsKICAgICAgICAgICAgdGhpcy5ibG9ja1NpemUgPiAwLAogICAgICAgICAgICAwIDwgdGhpcy5mb3JtYXQuYmxvY2tDb3VudCwKICAgICAgICAgICAgMCA8PSB0aGlzLnN0YXJ0QXRTYW1wbGUsCiAgICAgICAgICAgIHRoaXMuc3RhcnRBdFNhbXBsZSA8IHRoaXMuZnVsbEVuZEF0U2FtcGxlLAogICAgICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA8PSB0aGlzLmZ1bGxTYW1wbGVDb3VudCwKICAgICAgICBdOwogICAgICAgIHJlc3VsdHMuZmluZCgocmVzdWx0LCBpbmRleCkgPT4gewogICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBkaWQgbm90IHBhc3Mgbm9ybWFsIGNoZWNrIG9uIHJ1bGUgJHtpbmRleH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmhhc0hlYWRlclsibG9vcCJdKSB7CiAgICAgICAgICAgIGNvbnN0IGxvb3BDaGVja3MgPSBbCiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0QXRTYW1wbGUgPD0gdGhpcy5sb29wU3RhcnRBdFNhbXBsZSwKICAgICAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUgPCB0aGlzLmxvb3BFbmRBdFNhbXBsZSwKICAgICAgICAgICAgICAgIHRoaXMubG9vcEVuZEF0U2FtcGxlIDw9IHRoaXMuZnVsbEVuZEF0U2FtcGxlLAogICAgICAgICAgICBdOwogICAgICAgICAgICBsb29wQ2hlY2tzLmZpbmQoKHJlc3VsdCwgaW5kZXgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBkaWQgbm90IHBhc3MgbG9vcCBjaGVjayBvbiBydWxlICR7aW5kZXh9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGdldFJhd0hlYWRlcigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYXdIZWFkZXIuc2xpY2UoMCk7CiAgICB9CiAgICBpc0hlYWRlckNoYW5nZWQoaGNhKSB7CiAgICAgICAgaWYgKGhjYS5sZW5ndGggPj0gdGhpcy5yYXdIZWFkZXIubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yYXdIZWFkZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChoY2FbaV0gIT0gdGhpcy5yYXdIZWFkZXJbaV0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIG1vZGlmeShoY2EsIHNpZywgbmV3RGF0YSkgewogICAgICAgIC8vIHJlcGFyc2UgaGVhZGVyIGlmIG5lZWRlZAogICAgICAgIGlmICh0aGlzLmlzSGVhZGVyQ2hhbmdlZChoY2EpKSB7CiAgICAgICAgICAgIHRoaXMucGFyc2VIZWFkZXIoaGNhLCBmYWxzZSwgZmFsc2UsIHt9KTsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSB0byBtb2RpZnkgZGF0YSBpbi1wbGFjZQogICAgICAgIGxldCBtb2RMaXN0ID0ge307CiAgICAgICAgbW9kTGlzdFtzaWddID0gbmV3RGF0YTsKICAgICAgICBsZXQgZW5jcnlwdCA9IHRoaXMuY2lwaGVyICE9IDA7CiAgICAgICAgaWYgKHNpZyA9PT0gImNpcGgiKSB7CiAgICAgICAgICAgIGVuY3J5cHQgPQogICAgICAgICAgICAgICAgbmV3IERhdGFWaWV3KG5ld0RhdGEuYnVmZmVyLCBuZXdEYXRhLmJ5dGVPZmZzZXQsIG5ld0RhdGEuYnl0ZUxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAuZ2V0VWludDE2KDApICE9IDA7CiAgICAgICAgfQogICAgICAgIC8vIGRvIGFjdHVhbCBtb2RpZmljYXRpb24gJiBjaGVjayB2YWxpZGl0eQogICAgICAgIHRoaXMucmF3SGVhZGVyID0gdGhpcy5wYXJzZUhlYWRlcihoY2EsIHRydWUsIGVuY3J5cHQsIG1vZExpc3QpOwogICAgfQogICAgc3RhdGljIGFkZEhlYWRlcihoY2EsIHNpZywgbmV3RGF0YSkgewogICAgICAgIC8vIHNpZyBtdXN0IGNvbnNpc3Qgb2YgMS00IEFTQ0lJIGNoYXJhY3RlcnMKICAgICAgICBpZiAoc2lnLmxlbmd0aCA8IDEgfHwgc2lnLmxlbmd0aCA+IDQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBuZXdTaWcgPSBuZXcgVWludDhBcnJheSg0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgICBsZXQgYyA9IHNpZy5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBpZiAoYyA+PSAweDgwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIG5ld1NpZ1tpXSA9IGM7CiAgICAgICAgfQogICAgICAgIC8vIHBhcnNlIGhlYWRlciAmIGNoZWNrIHZhbGlkdHkKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7CiAgICAgICAgLy8gY2hlY2sgd2hldGhlciBzcGVjaWZpZWQgaGVhZGVyIHNlY3Rpb24gYWxyZWFkeSBleGlzdHMKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbc2lnXSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGhlYWRlciBzZWN0aW9uICR7c2lnfSBhbHJlYWR5IGV4aXN0c2ApOwogICAgICAgIH0KICAgICAgICAvLyBwcmVwYXJlIGEgbmV3bHkgYWxsb2NhdGVkIGJ1ZmZlcgogICAgICAgIGxldCBuZXdIY2EgPSBuZXcgVWludDhBcnJheShoY2EuYnl0ZUxlbmd0aCArIG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoKTsKICAgICAgICBsZXQgaW5zZXJ0T2Zmc2V0ID0gaW5mby5oZWFkZXJPZmZzZXRbInBhZCJdWzBdOwogICAgICAgIC8vIGNvcHkgZXhpc3RpbmcgaGVhZGVycyAoZXhjZXB0IHBhZGRpbmcpCiAgICAgICAgbmV3SGNhLnNldChoY2Euc3ViYXJyYXkoMCwgaW5zZXJ0T2Zmc2V0KSwgMCk7CiAgICAgICAgLy8gY29weSBpbnNlcnRlZCBoZWFkZXIKICAgICAgICBuZXdIY2Euc2V0KG5ld1NpZywgaW5zZXJ0T2Zmc2V0KTsKICAgICAgICBuZXdIY2Euc2V0KG5ld0RhdGEsIGluc2VydE9mZnNldCArIG5ld1NpZy5ieXRlTGVuZ3RoKTsKICAgICAgICAvLyBjb3B5IHJlbWFpbmluZyBkYXRhIChwYWRkaW5nIGFuZCBibG9ja3MpCiAgICAgICAgbmV3SGNhLnNldChoY2Euc3ViYXJyYXkoaW5zZXJ0T2Zmc2V0LCBoY2EuYnl0ZUxlbmd0aCksIGluc2VydE9mZnNldCArIG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoKTsKICAgICAgICAvLyB1cGRhdGUgZGF0YU9mZnNldAogICAgICAgIGluZm8uZGF0YU9mZnNldCArPSBuZXdTaWcuYnl0ZUxlbmd0aCArIG5ld0RhdGEuYnl0ZUxlbmd0aDsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhuZXdIY2EuYnVmZmVyLCBuZXdIY2EuYnl0ZU9mZnNldCwgbmV3SGNhLmJ5dGVMZW5ndGgpOwogICAgICAgIHAuc2V0SW50MTYoNiwgaW5mby5kYXRhT2Zmc2V0KTsKICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICBDcmMxNi5maXgobmV3SGNhLCBpbmZvLmRhdGFPZmZzZXQgLSAyKTsKICAgICAgICAvLyByZXBhcnNlIGhlYWRlciAmIHJlY2hlY2sgdmFsaWR0eQogICAgICAgIGluZm8gPSBuZXcgSENBSW5mbyhuZXdIY2EpOwogICAgICAgIHJldHVybiBuZXdIY2E7CiAgICB9CiAgICBzdGF0aWMgYWRkQ2lwaGVySGVhZGVyKGhjYSwgY2lwaGVyVHlwZSkgewogICAgICAgIGxldCBuZXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgaWYgKGNpcGhlclR5cGUgIT0gbnVsbCkgewogICAgICAgICAgICBuZXcgRGF0YVZpZXcobmV3RGF0YS5idWZmZXIpLnNldFVpbnQxNigwLCBjaXBoZXJUeXBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkSGVhZGVyKGhjYSwgImNpcGgiLCBuZXdEYXRhKTsKICAgIH0KICAgIHN0YXRpYyBmaXhIZWFkZXJDaGVja3N1bShoY2EpIHsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhoY2EuYnVmZmVyLCBoY2EuYnl0ZU9mZnNldCwgOCk7CiAgICAgICAgbGV0IGhlYWQgPSB0aGlzLmdldFNpZ24ocCwgMCwgZmFsc2UsIGZhbHNlKTsKICAgICAgICBpZiAoaGVhZCAhPT0gIkhDQSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgYSBIQ0EgZmlsZSIpOwogICAgICAgIH0KICAgICAgICBsZXQgZGF0YU9mZnNldCA9IHAuZ2V0VWludDE2KDYpOwogICAgICAgIENyYzE2LmZpeChoY2EsIGRhdGFPZmZzZXQgLSAyKTsKICAgICAgICByZXR1cm4gaGNhOwogICAgfQogICAgY2FsY0luV2F2U2l6ZShtb2RlID0gMzIpIHsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBsZXQgYml0c1BlclNhbXBsZSA9IG1vZGUgPT0gMCA/IDMyIDogbW9kZTsKICAgICAgICBsZXQgc2FtcGxlU2l6ZUluV2F2ID0gdGhpcy5mb3JtYXQuY2hhbm5lbENvdW50ICogYml0c1BlclNhbXBsZSAvIDg7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5XYXZTaXplID0gewogICAgICAgICAgICBiaXRzUGVyU2FtcGxlOiBiaXRzUGVyU2FtcGxlLAogICAgICAgICAgICBzYW1wbGU6IHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgYmxvY2s6IFNhbXBsZXNQZXJGcmFtZSAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgZHJvcHBlZDogewogICAgICAgICAgICAgICAgaGVhZGVyOiB0aGlzLmZvcm1hdC5kcm9wcGVkSGVhZGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgZm9vdGVyOiB0aGlzLmZvcm1hdC5kcm9wcGVkRm9vdGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICB9LAogICAgICAgICAgICBsb29wOiB0aGlzLmhhc0hlYWRlclsibG9vcCJdCiAgICAgICAgICAgICAgICA/IHsKICAgICAgICAgICAgICAgICAgICBsb29wUGFydDogKHRoaXMubG9vcEVuZEF0U2FtcGxlIC0gdGhpcy5sb29wU3RhcnRBdFNhbXBsZSkgKgogICAgICAgICAgICAgICAgICAgICAgICBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgICAgICAgICAgZHJvcHBlZDogewogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXI6IHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgICAgICAgICBmb290ZXI6IHRoaXMubG9vcC5kcm9wcGVkRm9vdGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCwKICAgICAgICB9OwogICAgfQp9CgpjbGFzcyBIQ0FXYXZDb21tZW50Q2h1bmsgewogICAgY29uc3RydWN0b3IoaW5mbykgewogICAgICAgIHRoaXMuY29tbWVudEJ1ZiA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShpbmZvLmNvbW1lbnQpOwogICAgICAgIGxldCBzaXplID0gdGhpcy5jb21tZW50QnVmLmJ5dGVMZW5ndGg7CiAgICAgICAgc2l6ZSArPSA0OwogICAgICAgIGlmIChzaXplICUgNCkKICAgICAgICAgICAgc2l6ZSArPSA0IC0gc2l6ZSAlIDQ7CiAgICAgICAgdGhpcy5zaXplID0gc2l6ZTsKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDggKyB0aGlzLnNpemUpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoIm5vdGUiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICByZXQuc2V0KHRoaXMuY29tbWVudEJ1ZiwgOCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQoKY2xhc3MgSENBV2F2ZVNtcGxDaHVuayB7CiAgICBjb25zdHJ1Y3RvcihpbmZvKSB7CiAgICAgICAgdGhpcy5zaXplID0gNjA7CiAgICAgICAgdGhpcy5tYW51ZmFjdHVyZXIgPSAwOwogICAgICAgIHRoaXMucHJvZHVjdCA9IDA7CiAgICAgICAgdGhpcy5NSURJVW5pdHlOb3RlID0gMHgzYzsKICAgICAgICB0aGlzLk1JRElQaXRjaEZyYWN0aW9uID0gMDsKICAgICAgICB0aGlzLlNNUFRFRm9ybWF0ID0gMDsKICAgICAgICB0aGlzLnNhbXBsZUxvb3BzID0gMTsKICAgICAgICB0aGlzLnNhbXBsZXJEYXRhID0gMHgxODsKICAgICAgICB0aGlzLmxvb3BfSWRlbnRpZmllciA9IDA7CiAgICAgICAgdGhpcy5sb29wX1R5cGUgPSAwOwogICAgICAgIHRoaXMubG9vcF9GcmFjdGlvbiA9IDA7CiAgICAgICAgdGhpcy5sb29wX1BsYXlDb3VudCA9IDA7CiAgICAgICAgaWYgKCFpbmZvLmhhc0hlYWRlclsibG9vcCJdKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgImxvb3AiIGhlYWRlcicpOwogICAgICAgIHRoaXMuc2FtcGxlUGVyaW9kID0gMSAvIGluZm8uZm9ybWF0LnNhbXBsaW5nUmF0ZSAqIDEwMDAwMDAwMDA7CiAgICAgICAgdGhpcy5sb29wX1N0YXJ0ID0gaW5mby5sb29wU3RhcnRBdFNhbXBsZSAtIGluZm8uc3RhcnRBdFNhbXBsZTsKICAgICAgICB0aGlzLmxvb3BfRW5kID0gaW5mby5sb29wRW5kQXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5TTVBURU9mZnNldCA9IDE7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJzbXBsIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoOCwgdGhpcy5tYW51ZmFjdHVyZXIsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDEyLCB0aGlzLnByb2R1Y3QsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDE2LCB0aGlzLnNhbXBsZVBlcmlvZCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMjAsIHRoaXMuTUlESVVuaXR5Tm90ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMjQsIHRoaXMuTUlESVBpdGNoRnJhY3Rpb24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDI4LCB0aGlzLlNNUFRFRm9ybWF0LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigzMiwgdGhpcy5TTVBURU9mZnNldCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMzYsIHRoaXMuc2FtcGxlTG9vcHMsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDQwLCB0aGlzLnNhbXBsZXJEYXRhLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0NCwgdGhpcy5sb29wX0lkZW50aWZpZXIsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDQ4LCB0aGlzLmxvb3BfVHlwZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNTIsIHRoaXMubG9vcF9TdGFydCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNTYsIHRoaXMubG9vcF9FbmQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDYwLCB0aGlzLmxvb3BfRnJhY3Rpb24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDY0LCB0aGlzLmxvb3BfUGxheUNvdW50LCB0cnVlKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQp9CgpjbGFzcyBIQ0FXYXZGbXRDaHVuayB7CiAgICBjb25zdHJ1Y3RvcihpbmZvLCBtb2RlID0gMzIpIHsKICAgICAgICB0aGlzLnNpemUgPSAxNjsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBsZXQgaW5XYXZTaXplID0gaW5mby5jYWxjSW5XYXZTaXplKG1vZGUpOwogICAgICAgIHRoaXMuZm9ybWF0VGFnID0gbW9kZSA+IDAgPyAxIDogMzsKICAgICAgICB0aGlzLmNoYW5uZWxDb3VudCA9IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudDsKICAgICAgICB0aGlzLnNhbXBsZXNQZXJTZWMgPSBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5ieXRlc1BlclNlYyA9IGluV2F2U2l6ZS5zYW1wbGUgKiBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5ibG9ja0FsaWduID0gaW5XYXZTaXplLnNhbXBsZTsKICAgICAgICB0aGlzLmJpdHNQZXJTYW1wbGUgPSBpbldhdlNpemUuYml0c1BlclNhbXBsZTsKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDggKyB0aGlzLnNpemUpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoImZtdCAiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQxNig4LCB0aGlzLmZvcm1hdFRhZywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMTAsIHRoaXMuY2hhbm5lbENvdW50LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxMiwgdGhpcy5zYW1wbGVzUGVyU2VjLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxNiwgdGhpcy5ieXRlc1BlclNlYywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMjAsIHRoaXMuYmxvY2tBbGlnbiwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMjIsIHRoaXMuYml0c1BlclNhbXBsZSwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQoKY2xhc3MgSENBV2F2V2F2ZVJpZmZIZWFkZXIgewogICAgY29uc3RydWN0b3Ioc2l6ZSkgewogICAgICAgIGlmIChpc05hTihzaXplKSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaXplIG11c3QgYmUgbnVtYmVyIik7CiAgICAgICAgc2l6ZSA9IE1hdGguZmxvb3Ioc2l6ZSk7CiAgICAgICAgaWYgKHNpemUgPD0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdGhpcy5zaXplID0gNCArIHNpemU7IC8vICJXQVZFIiArIHJlbWFpbmluZyBwYXJ0CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcigxMik7CiAgICAgICAgbGV0IHJldCA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoYnVmKTsKICAgICAgICBsZXQgdGUgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgICAgICByZXQuc2V0KHRlLmVuY29kZSgiUklGRiIpLCAwKTsKICAgICAgICBwLnNldFVpbnQzMig0LCB0aGlzLnNpemUsIHRydWUpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJXQVZFIiksIDgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KCmNsYXNzIEhDQVdhdiB7CiAgICBjb25zdHJ1Y3RvcihpbmZvLCBtb2RlID0gMzIsIGxvb3AgPSAwKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTmFOKGxvb3ApKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImxvb3AgaXMgbm90IG51bWJlciIpOwogICAgICAgIGxvb3AgPSBNYXRoLmZsb29yKGxvb3ApOwogICAgICAgIGlmIChsb29wIDwgMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICBsZXQgZGF0YVNpemUgPSBpbldhdlNpemUuc2FtcGxlICogaW5mby5zYW1wbGVDb3VudDsKICAgICAgICBpZiAobG9vcCA+IDApIHsKICAgICAgICAgICAgaWYgKGluV2F2U2l6ZS5sb29wID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgZGF0YVNpemUgKz0gaW5XYXZTaXplLmxvb3AubG9vcFBhcnQgKiBsb29wOwogICAgICAgIH0KICAgICAgICAvLyBwcmVwYXJlIG1ldGFkYXRhIGNodW5rcyBhbmQgZGF0YSBjaHVuayBoZWFkZXIKICAgICAgICB0aGlzLmZtdCA9IG5ldyBIQ0FXYXZGbXRDaHVuayhpbmZvLCBtb2RlKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImNvbW0iXSkKICAgICAgICAgICAgdGhpcy5ub3RlID0gbmV3IEhDQVdhdkNvbW1lbnRDaHVuayhpbmZvKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImxvb3AiXSkKICAgICAgICAgICAgdGhpcy5zbXBsID0gbmV3IEhDQVdhdmVTbXBsQ2h1bmsoaW5mbyk7CiAgICAgICAgdGhpcy53YXZlUmlmZiA9IG5ldyBIQ0FXYXZXYXZlUmlmZkhlYWRlcig4ICsgdGhpcy5mbXQuc2l6ZSArCiAgICAgICAgICAgICh0aGlzLm5vdGUgPT0gbnVsbCA/IDAgOiA4ICsgdGhpcy5ub3RlLnNpemUpICsKICAgICAgICAgICAgOCArIGRhdGFTaXplICsKICAgICAgICAgICAgKHRoaXMuc21wbCA9PSBudWxsID8gMCA6IDggKyB0aGlzLnNtcGwuc2l6ZSkpOwogICAgICAgIC8vIGdldCBieXRlcyBvZiBwcmVwYXJlZCBjaHVua3MKICAgICAgICBsZXQgd2F2ZVJpZmZIZWFkZXIgPSB0aGlzLndhdmVSaWZmLmdldCgpOwogICAgICAgIGxldCBmbXRDaHVuayA9IHRoaXMuZm10LmdldCgpOwogICAgICAgIGxldCBub3RlQ2h1bmsgPSB0aGlzLm5vdGUgIT0gbnVsbCA/IHRoaXMubm90ZS5nZXQoKSA6IG5ldyBVaW50OEFycmF5KDApOwogICAgICAgIGxldCBkYXRhQ2h1bmtIZWFkZXIgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgICBkYXRhQ2h1bmtIZWFkZXIuc2V0KG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZSgiZGF0YSIpKTsKICAgICAgICBuZXcgRGF0YVZpZXcoZGF0YUNodW5rSGVhZGVyLmJ1ZmZlcikuc2V0VWludDMyKDQsIGRhdGFTaXplLCB0cnVlKTsKICAgICAgICBsZXQgc21wbENodW5rID0gdGhpcy5zbXBsICE9IG51bGwgPyB0aGlzLnNtcGwuZ2V0KCkgOiBuZXcgVWludDhBcnJheSgwKTsKICAgICAgICAvLyBjcmVhdGUgd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICB0aGlzLmZpbGVCdWYgPSBuZXcgVWludDhBcnJheSg4ICsgdGhpcy53YXZlUmlmZi5zaXplKTsKICAgICAgICAvLyBjb3B5IHByZXBhcmVkIG1ldGFkYXRhIGNodW5rcyBhbmQgZGF0YSBjaHVuayBoZWFkZXIgdG8gd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICBsZXQgd3JpdHRlbkxlbmd0aCA9IDA7CiAgICAgICAgW3dhdmVSaWZmSGVhZGVyLCBmbXRDaHVuaywgbm90ZUNodW5rLCBkYXRhQ2h1bmtIZWFkZXJdLmZvckVhY2goKGNodW5rKSA9PiB7CiAgICAgICAgICAgIHRoaXMuZmlsZUJ1Zi5zZXQoY2h1bmssIHdyaXR0ZW5MZW5ndGgpOwogICAgICAgICAgICB3cml0dGVuTGVuZ3RoICs9IGNodW5rLmJ5dGVMZW5ndGg7CiAgICAgICAgfSk7CiAgICAgICAgLy8gc2tpcCBkYXRhUGFydCBzaW5jZSBpdCdzIGVtcHR5CiAgICAgICAgdGhpcy5kYXRhUGFydCA9IHRoaXMuZmlsZUJ1Zi5zdWJhcnJheSh3cml0dGVuTGVuZ3RoLCB3cml0dGVuTGVuZ3RoICsgZGF0YVNpemUpOwogICAgICAgIHdyaXR0ZW5MZW5ndGggKz0gZGF0YVNpemU7CiAgICAgICAgLy8gY29weSB0aGUgbGFzdCBwcmVwYXJlZCBjaHVuayB0byB3aG9sZS1maWxlIGJ1ZmZlcgogICAgICAgIHRoaXMuZmlsZUJ1Zi5zZXQoc21wbENodW5rLCB3cml0dGVuTGVuZ3RoKTsKICAgICAgICB3cml0dGVuTGVuZ3RoICs9IHNtcGxDaHVuay5ieXRlTGVuZ3RoOwogICAgICAgIGlmICh3cml0dGVuTGVuZ3RoICE9IHRoaXMuZmlsZUJ1Zi5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0KfQoKY2xhc3MgSENBIHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgfQogICAgc3RhdGljIGRlY3J5cHQoaGNhLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjcnlwdE9yRW5jcnlwdChoY2EsIGZhbHNlLCBrZXkxLCBrZXkyKTsKICAgIH0KICAgIHN0YXRpYyBlbmNyeXB0KGhjYSwga2V5MSwga2V5MikgewogICAgICAgIHJldHVybiB0aGlzLmRlY3J5cHRPckVuY3J5cHQoaGNhLCB0cnVlLCBrZXkxLCBrZXkyKTsKICAgIH0KICAgIHN0YXRpYyBkZWNyeXB0T3JFbmNyeXB0KGhjYSwgZW5jcnlwdCwga2V5MSwga2V5MikgewogICAgICAgIC8vIGluLXBsYWNlIGRlY3J5cHRpb24vZW5jcnlwdGlvbgogICAgICAgIC8vIHBhcnNlIGhlYWRlcgogICAgICAgIGxldCBpbmZvID0gbmV3IEhDQUluZm8oaGNhKTsgLy8gdGhyb3dzICJOb3QgYSBIQ0EgZmlsZSIgaWYgbWlzbWF0Y2gKICAgICAgICBpZiAoIWVuY3J5cHQgJiYgIWluZm8uaGFzSGVhZGVyWyJjaXBoIl0pIHsKICAgICAgICAgICAgcmV0dXJuIGhjYTsgLy8gbm90IGVuY3J5cHRlZAogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlbmNyeXB0ICYmICFpbmZvLmhhc0hlYWRlclsiY2lwaCJdKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5wdXQgaGNhIGxhY2tzICJjaXBoIiBoZWFkZXIgc2VjdGlvbi4gUGxlYXNlIGNhbGwgSENBSW5mby5hZGRDaXBoZXJIZWFkZXIoaGNhKSBmaXJzdC4nKTsKICAgICAgICB9CiAgICAgICAgbGV0IGNpcGhlcjsKICAgICAgICBzd2l0Y2ggKGluZm8uY2lwaGVyKSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIC8vIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIGlmIChlbmNyeXB0KQogICAgICAgICAgICAgICAgICAgIGNpcGhlciA9IG5ldyBIQ0FDaXBoZXIoa2V5MSwga2V5MikuaW52ZXJ0VGFibGUoKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGNhOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoICJubyBrZXkiCiAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYWxyZWFkeSBlbmNyeXB0ZWQgd2l0aCAibm8ga2V5IiwgcGxlYXNlIGRlY3J5cHQgZmlyc3QnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKCJub25lIik7IC8vIGlnbm9yZSBnaXZlbiBrZXlzCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAweDM4OgogICAgICAgICAgICAgICAgLy8gZW5jcnlwdGVkIHdpdGgga2V5cyAtIHdpbGwgeWllbGQgaW5jb3JyZWN0IHdhdmVmb3JtIGlmIGluY29ycmVjdCBrZXlzIGFyZSBnaXZlbiEKICAgICAgICAgICAgICAgIGlmIChlbmNyeXB0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhbHJlYWR5IGVuY3J5cHRlZCB3aXRoIHNwZWNpZmljIGtleXMsIHBsZWFzZSBkZWNyeXB0IHdpdGggY29ycmVjdCBrZXlzIGZpcnN0Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgY2lwaGVyID0gbmV3IEhDQUNpcGhlcihrZXkxLCBrZXkyKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIGNpcGgudHlwZSIpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQ7ICsraSkgewogICAgICAgICAgICBsZXQgZnRlbGwgPSBpbmZvLmRhdGFPZmZzZXQgKyBpbmZvLmJsb2NrU2l6ZSAqIGk7CiAgICAgICAgICAgIGxldCBibG9jayA9IGhjYS5zdWJhcnJheShmdGVsbCwgZnRlbGwgKyBpbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgIC8vIHZlcmlmeSBibG9jayBjaGVja3N1bQogICAgICAgICAgICBDcmMxNi52ZXJpZnkoYmxvY2ssIGluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgICAgIC8vIGRlY3J5cHQvZW5jcnlwdCBibG9jawogICAgICAgICAgICBjaXBoZXIubWFzayhibG9jaywgMCwgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgLy8gZml4IGNoZWNrc3VtCiAgICAgICAgICAgIENyYzE2LmZpeChibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICB9CiAgICAgICAgLy8gcmUtKHVuKW1hc2sgaGVhZGVycywgYW5kIHNldCBjaXBoIGhlYWRlciB0byBuZXcgdmFsdWUKICAgICAgICBsZXQgbmV3Q2lwaGVyRGF0YSA9IG5ldyBVaW50OEFycmF5KDIpOwogICAgICAgIGxldCBuZXdDaXBoZXJUeXBlID0gZW5jcnlwdCA/IGNpcGhlci5nZXRUeXBlKCkgOiAwOwogICAgICAgIG5ldyBEYXRhVmlldyhuZXdDaXBoZXJEYXRhLmJ1ZmZlcikuc2V0VWludDE2KDAsIG5ld0NpcGhlclR5cGUpOwogICAgICAgIGluZm8ubW9kaWZ5KGhjYSwgImNpcGgiLCBuZXdDaXBoZXJEYXRhKTsKICAgICAgICByZXR1cm4gaGNhOwogICAgfQogICAgc3RhdGljIGRlY29kZShoY2EsIG1vZGUgPSAzMiwgbG9vcCA9IDAsIHZvbHVtZSA9IDEuMCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmICh2b2x1bWUgPiAxKQogICAgICAgICAgICB2b2x1bWUgPSAxOwogICAgICAgIGVsc2UgaWYgKHZvbHVtZSA8IDApCiAgICAgICAgICAgIHZvbHVtZSA9IDA7CiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOyAvLyB0aHJvd3MgIk5vdCBhIEhDQSBmaWxlIiBpZiBtaXNtYXRjaAogICAgICAgIGxldCBmcmFtZSA9IG5ldyBIQ0FGcmFtZShpbmZvKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImNpcGgiXSAmJiBpbmZvLmNpcGhlciAhPSAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSENBIGlzIGVuY3J5cHRlZCwgcGxlYXNlIGRlY3J5cHQgaXQgZmlyc3QgYmVmb3JlIGRlY29kaW5nIik7CiAgICAgICAgfQogICAgICAgIC8vIHByZXBhcmUgb3V0cHV0IFdBViBmaWxlCiAgICAgICAgY29uc3Qgb3V0cHV0V2F2ID0gbmV3IEhDQVdhdihpbmZvLCBtb2RlLCBsb29wKTsKICAgICAgICBjb25zdCBmaWxlQnVmID0gb3V0cHV0V2F2LmZpbGVCdWY7CiAgICAgICAgY29uc3QgZGF0YVBhcnQgPSBvdXRwdXRXYXYuZGF0YVBhcnQ7CiAgICAgICAgLy8gY2FsY3VsYXRlIGluLVdBViBzaXplCiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICAvLyBkZWNvZGUgYmxvY2tzIChmcmFtZXMpCiAgICAgICAgZm9yIChsZXQgaSA9IDAsIG9mZnNldCA9IDA7IGkgPCBpbmZvLmZvcm1hdC5ibG9ja0NvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGxhc3REZWNvZGVkU2FtcGxlcyA9IGkgKiBTYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgICAgIGxldCBjdXJyZW50RGVjb2RlZFNhbXBsZXMgPSBsYXN0RGVjb2RlZFNhbXBsZXMgKyBTYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgICAgIGlmIChjdXJyZW50RGVjb2RlZFNhbXBsZXMgPD0gaW5mby5zdGFydEF0U2FtcGxlIHx8CiAgICAgICAgICAgICAgICBsYXN0RGVjb2RlZFNhbXBsZXMgPj0gaW5mby5lbmRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHN0YXJ0T2Zmc2V0ID0gaW5mby5kYXRhT2Zmc2V0ICsgaW5mby5ibG9ja1NpemUgKiBpOwogICAgICAgICAgICBsZXQgYmxvY2sgPSBoY2Euc3ViYXJyYXkoc3RhcnRPZmZzZXQsIHN0YXJ0T2Zmc2V0ICsgaW5mby5ibG9ja1NpemUpOwogICAgICAgICAgICB0aGlzLmRlY29kZUJsb2NrKGZyYW1lLCBibG9jayk7CiAgICAgICAgICAgIGxldCB3YXZlYnVmZjsKICAgICAgICAgICAgaWYgKGxhc3REZWNvZGVkU2FtcGxlcyA8IGluZm8uc3RhcnRBdFNhbXBsZSB8fAogICAgICAgICAgICAgICAgY3VycmVudERlY29kZWRTYW1wbGVzID4gaW5mby5lbmRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgLy8gY3Jvc3Npbmcgc3RhcnRBdFNhbXBsZS9lbmRBdFNhbXBsZSwgc2tpcC9kcm9wIHNwZWNpZmllZCBieXRlcwogICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB0aGlzLndyaXRlVG9QQ00oZnJhbWUsIG1vZGUsIHZvbHVtZSk7CiAgICAgICAgICAgICAgICBpZiAobGFzdERlY29kZWRTYW1wbGVzIDwgaW5mby5zdGFydEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNraXBwZWRTaXplID0gKGluZm8uc3RhcnRBdFNhbXBsZSAtIGxhc3REZWNvZGVkU2FtcGxlcykgKgogICAgICAgICAgICAgICAgICAgICAgICBpbldhdlNpemUuc2FtcGxlOwogICAgICAgICAgICAgICAgICAgIHdhdmVidWZmID0gd2F2ZWJ1ZmYuc3ViYXJyYXkoc2tpcHBlZFNpemUsIGluV2F2U2l6ZS5ibG9jayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50RGVjb2RlZFNhbXBsZXMgPiBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHdyaXRlU2l6ZSA9IChpbmZvLmVuZEF0U2FtcGxlIC0gbGFzdERlY29kZWRTYW1wbGVzKSAqCiAgICAgICAgICAgICAgICAgICAgICAgIGluV2F2U2l6ZS5zYW1wbGU7CiAgICAgICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB3YXZlYnVmZi5zdWJhcnJheSgwLCB3cml0ZVNpemUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJzaG91bGQgbmV2ZXIgZ28gaGVyZSIpOwogICAgICAgICAgICAgICAgZGF0YVBhcnQuc2V0KHdhdmVidWZmLCBvZmZzZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB0aGlzLndyaXRlVG9QQ00oZnJhbWUsIG1vZGUsIHZvbHVtZSwgZGF0YVBhcnQsIG9mZnNldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2Zmc2V0ICs9IHdhdmVidWZmLmJ5dGVMZW5ndGg7CiAgICAgICAgfQogICAgICAgIC8vIGRlY29kaW5nIGRvbmUsIHRoZW4ganVzdCBjb3B5IGxvb3BpbmcgcGFydAogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlclsibG9vcCJdICYmIGxvb3ApIHsKICAgICAgICAgICAgLy8gInRhaWwiIGJleW9uZCBsb29wIGVuZCBpcyBkcm9wcGVkCiAgICAgICAgICAgIC8vIGNvcHkgbG9vcGluZyBhdWRpbyBjbGlwcwogICAgICAgICAgICBpZiAoaW5XYXZTaXplLmxvb3AgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICBsZXQgcHJlTG9vcFNpemVJbldhdiA9IGluV2F2U2l6ZS5zYW1wbGUgKgogICAgICAgICAgICAgICAgKGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGUpOwogICAgICAgICAgICBsZXQgc3JjID0gZGF0YVBhcnQuc3ViYXJyYXkocHJlTG9vcFNpemVJbldhdiwgcHJlTG9vcFNpemVJbldhdiArIGluV2F2U2l6ZS5sb29wLmxvb3BQYXJ0KTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIHN0YXJ0ID0gcHJlTG9vcFNpemVJbldhdiArIGluV2F2U2l6ZS5sb29wLmxvb3BQYXJ0OyBpIDwgbG9vcDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsZXQgZHN0ID0gZGF0YVBhcnQuc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQpOwogICAgICAgICAgICAgICAgZHN0LnNldChzcmMpOwogICAgICAgICAgICAgICAgc3RhcnQgKz0gaW5XYXZTaXplLmxvb3AubG9vcFBhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZpbGVCdWY7CiAgICB9CiAgICBzdGF0aWMgZGVjb2RlQmxvY2soZnJhbWUsIGJsb2NrKSB7CiAgICAgICAgbGV0IGluZm8gPSBmcmFtZS5IY2E7CiAgICAgICAgaWYgKGJsb2NrLmJ5dGVMZW5ndGggIT0gaW5mby5ibG9ja1NpemUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIC8vIHZlcmlmeSBjaGVja3N1bQogICAgICAgIENyYzE2LnZlcmlmeShibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAvLyBkZWNvZGUKICAgICAgICBIQ0FEZWNvZGVyLkRlY29kZUZyYW1lKGJsb2NrLCBmcmFtZSk7CiAgICB9CiAgICBzdGF0aWMgd3JpdGVUb1BDTShmcmFtZSwgbW9kZSA9IDMyLCB2b2x1bWUgPSAxLjAsIHdyaXRlciwgZnRlbGwpIHsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBpZiAodm9sdW1lID4gMSkKICAgICAgICAgICAgdm9sdW1lID0gMTsKICAgICAgICBlbHNlIGlmICh2b2x1bWUgPCAwKQogICAgICAgICAgICB2b2x1bWUgPSAwOwogICAgICAgIC8vIGNyZWF0ZSBuZXcgd3JpdGVyIGlmIG5vdCBzcGVjaWZpZWQKICAgICAgICBsZXQgaW5mbyA9IGZyYW1lLkhjYTsKICAgICAgICBpZiAod3JpdGVyID09IG51bGwpIHsKICAgICAgICAgICAgd3JpdGVyID0gbmV3IFVpbnQ4QXJyYXkoU2FtcGxlc1BlckZyYW1lICogaW5mby5mb3JtYXQuY2hhbm5lbENvdW50ICoKICAgICAgICAgICAgICAgIChtb2RlID09IDAgPyAzMiA6IG1vZGUpIC8gOCk7CiAgICAgICAgICAgIGlmIChmdGVsbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmdGVsbCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlmIChmdGVsbCA9PSBudWxsKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIC8vIHdyaXRlIGRlY29kZWQgZGF0YSBpbnRvIHdyaXRlcgogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KHdyaXRlci5idWZmZXIsIHdyaXRlci5ieXRlT2Zmc2V0LCB3cml0ZXIuYnl0ZUxlbmd0aCk7CiAgICAgICAgbGV0IGZ0ZWxsQmVnaW4gPSBmdGVsbDsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBTYW1wbGVzUGVyU3ViRnJhbWU7IHMrKykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBmcmFtZS5DaGFubmVscy5sZW5ndGg7IGMrKykgewogICAgICAgICAgICAgICAgICAgIGxldCBmID0gZnJhbWUuQ2hhbm5lbHNbY10uUGNtRmxvYXRbc2ZdW3NdICogdm9sdW1lOwogICAgICAgICAgICAgICAgICAgIGlmIChmID4gMSkKICAgICAgICAgICAgICAgICAgICAgICAgZiA9IDE7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZiA8IC0xKQogICAgICAgICAgICAgICAgICAgICAgICBmID0gLTE7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG11c3QgYmUgdW5zaWduZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwsIGYgKiAweDdGICsgMHg4MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3IgYWJvdmUgOC1iaXQgaW50ZWdlciwgbGl0dGxlLWVuZGlhbiBzaWduZWQgaW50ZWdlciBpcyB1c2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAoc2V0VWludDE2L3NldEludDE2IGFjdHVhbGx5IGRvZXNuJ3Qgc2VlbSB0byBtYWtlIGFueSBkaWZmZXJlbmNlIGhlcmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldEludDE2KGZ0ZWxsLCBmICogMHg3RkZGLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZXJlJ3Mgbm8gc2V0SW50MjQsIHdyaXRlIDMgYnl0ZXMgd2l0aCBzZXRVaW50OCByZXNwZWN0aXZlbHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYgKj0gMHg3RkZGRkY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldFVpbnQ4KGZ0ZWxsLCBmICYgMHhGRik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldFVpbnQ4KGZ0ZWxsICsgMSwgZiA+PiA4ICYgMHhGRik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldFVpbnQ4KGZ0ZWxsICsgMiwgZiA+PiAxNiAmIDB4RkYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDMyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRJbnQzMihmdGVsbCwgZiAqIDB4N0ZGRkZGRkYsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmbG9hdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRGbG9hdDMyKGZ0ZWxsLCBmLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5rbm93biBtb2RlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB3cml0ZXIuc3ViYXJyYXkoZnRlbGxCZWdpbiwgZnRlbGwpOwogICAgfQogICAgc3RhdGljIGZpeENoZWNrc3VtKGhjYSkgewogICAgICAgIEhDQUluZm8uZml4SGVhZGVyQ2hlY2tzdW0oaGNhKTsKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmZvLmZvcm1hdC5ibG9ja0NvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGZ0ZWxsID0gaW5mby5kYXRhT2Zmc2V0ICsgaSAqIGluZm8uYmxvY2tTaXplOwogICAgICAgICAgICBsZXQgYmxvY2sgPSBoY2Euc3ViYXJyYXkoZnRlbGwsIGZ0ZWxsICsgaW5mby5ibG9ja1NpemUpOwogICAgICAgICAgICBDcmMxNi5maXgoYmxvY2ssIGluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBoY2E7CiAgICB9Cn0KCi8vIGNvbnZlcnQgbm9uLXRyYW5zZmVyYWJsZSB0eXBlZCBhcnJheSB0byB0cmFuc2ZlcmFibGUgYXJyYXkgYnVmZmVyCmNsYXNzIEhDQVRyYW5zVHlwZWRBcnJheSB7CiAgICBjb25zdHJ1Y3Rvcih0YSwgdHJhbnNmZXJMaXN0KSB7CiAgICAgICAgY29uc3QgdHlwZSA9IEhDQVRyYW5zVHlwZWRBcnJheS5nZXRUeXBlKHRhKTsKICAgICAgICBpZiAodHlwZSAhPSBudWxsKQogICAgICAgICAgICB0aGlzLnR5cGUgPSB0eXBlLnR5cGU7CiAgICAgICAgZWxzZQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVuZXhwZWN0ZWQgdHlwZSIpOwogICAgICAgIHRoaXMuYnVmZmVyID0gdGEuYnVmZmVyOwogICAgICAgIHRoaXMuYnl0ZU9mZnNldCA9IHRhLmJ5dGVPZmZzZXQ7CiAgICAgICAgdGhpcy5sZW5ndGggPSB0YS5sZW5ndGg7CiAgICAgICAgaWYgKCF0cmFuc2Zlckxpc3QuZmluZCgodmFsKSA9PiB2YWwgPT09IHRoaXMuYnVmZmVyKSkgewogICAgICAgICAgICB0cmFuc2Zlckxpc3QucHVzaCh0aGlzLmJ1ZmZlcik7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNvbnZlcnQoYXJnLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBpZiAodGhpcy5nZXRUeXBlKGFyZykgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbmV3IEhDQVRyYW5zVHlwZWRBcnJheShhcmcsIHRyYW5zZmVyTGlzdCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KICAgIHN0YXRpYyByZXN0b3JlKGFyZykgewogICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLmdldFR5cGUoYXJnKTsKICAgICAgICBpZiAodHlwZSAhPSBudWxsICYmIHR5cGUuY29udmVydGVkKSB7CiAgICAgICAgICAgIHJldHVybiBhcmcuYXJyYXk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KICAgIHN0YXRpYyBnZXRUeXBlKGFyZykgewogICAgICAgIGlmIChhcmcgPT0gbnVsbCB8fCB0eXBlb2YgYXJnICE9PSAib2JqZWN0IikKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBJbnQ4QXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkludDgiIH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDE2QXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkludDE2IiB9OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBJbnQzMkFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJJbnQzMiIgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiVWludDgiIH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJVaW50MTYiIH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJVaW50MzIiIH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkgewogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiRmxvYXQzMiIgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJGbG9hdDY0IiB9OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChhcmcuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgJiYgdHlwZW9mIGFyZy50eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IHRydWUsIHR5cGU6IGFyZy50eXBlIH07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGdldCBhcnJheSgpIHsKICAgICAgICBzd2l0Y2ggKHRoaXMudHlwZSkgewogICAgICAgICAgICBjYXNlICJJbnQ4IjoKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW50OEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiSW50MTYiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQxNkFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiSW50MzIiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQzMkFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiVWludDgiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiVWludDE2IjoKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJVaW50MzIiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIkZsb2F0MzIiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJGbG9hdDY0IjoKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bmV4cGVjdGVkIHR5cGUiKTsKICAgIH0KfQoKY2xhc3MgSENBVGFzayB7CiAgICBjb25zdHJ1Y3RvcihvcmlnaW4sIHRhc2tJRCwgY21kLCBhcmdzLCByZXBseUFyZ3MsIGlzRHVtbXkpIHsKICAgICAgICB0aGlzLnRyYW5zZmVyTGlzdCA9IFtdOwogICAgICAgIHRoaXMuX2hhc1Jlc3VsdCA9IGZhbHNlOwogICAgICAgIHRoaXMub3JpZ2luID0gb3JpZ2luOwogICAgICAgIHRoaXMudGFza0lEID0gdGFza0lEOwogICAgICAgIHRoaXMuY21kID0gY21kOwogICAgICAgIHRoaXMuX2FyZ3MgPSBhcmdzID09PSBudWxsIHx8IGFyZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFyZ3MubWFwKChhcmcpID0+IEhDQVRyYW5zVHlwZWRBcnJheS5jb252ZXJ0KGFyZywgdGhpcy50cmFuc2Zlckxpc3QpKTsKICAgICAgICB0aGlzLl9yZXBseUFyZ3MgPSByZXBseUFyZ3M7CiAgICAgICAgaWYgKGlzRHVtbXkgIT0gbnVsbCAmJiBpc0R1bW15KQogICAgICAgICAgICB0aGlzLmlzRHVtbXkgPSB0cnVlOwogICAgfQogICAgZ2V0IGFyZ3MoKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHJldHVybiAoX2EgPSB0aGlzLl9hcmdzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubWFwKChhcmcpID0+IEhDQVRyYW5zVHlwZWRBcnJheS5yZXN0b3JlKGFyZykpOwogICAgfQogICAgZ2V0IGhhc1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzUmVzdWx0OwogICAgfQogICAgZ2V0IHJlc3VsdCgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1Jlc3VsdCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJubyByZXN1bHQiKTsKICAgICAgICByZXR1cm4gSENBVHJhbnNUeXBlZEFycmF5LnJlc3RvcmUodGhpcy5fcmVzdWx0KTsKICAgIH0KICAgIHNldCByZXN1bHQocmVzdWx0KSB7CiAgICAgICAgaWYgKHRoaXMuaGFzRXJyKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgaGFzIGVycm9yLCBjYW5ub3Qgc2V0IHJlc3VsdCIpOwogICAgICAgIGlmICh0aGlzLl9oYXNSZXN1bHQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IHNldCByZXN1bHQgYWdhaW4iKTsKICAgICAgICB0aGlzLl9yZXN1bHQgPSBIQ0FUcmFuc1R5cGVkQXJyYXkuY29udmVydChyZXN1bHQsIHRoaXMudHJhbnNmZXJMaXN0KTsKICAgICAgICB0aGlzLl9oYXNSZXN1bHQgPSB0cnVlOwogICAgICAgIGlmICghdGhpcy5fcmVwbHlBcmdzKQogICAgICAgICAgICBkZWxldGUgdGhpcy5fYXJnczsKICAgIH0KICAgIGdldCBoYXNFcnIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Vyck1zZyAhPSBudWxsOwogICAgfQogICAgZ2V0IGVyck1zZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZXJyTXNnOwogICAgfQogICAgc2V0IGVyck1zZyhtc2cpIHsKICAgICAgICAvLyBjaGFuZ2luZyBlcnJNc2cgaXMgYWxsb3dlZCwgYnV0IGNsZWFyaW5nIGVyck1zZyBpcyBkaXNhbGxvd2VkCiAgICAgICAgaWYgKHR5cGVvZiBtc2cgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZXJyb3IgbWVzc2FnZSBtdXN0IGJlIGEgc3RyaW5nIik7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSB0aGlzLl9hcmdzOwogICAgICAgIGlmICh0aGlzLl9oYXNSZXN1bHQpIHsKICAgICAgICAgICAgLy8gY2xlYXIgcmVzdWx0IG9uIGVycm9yCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXN1bHQ7CiAgICAgICAgICAgIHRoaXMuX2hhc1Jlc3VsdCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRyYW5zZmVyTGlzdCA9IFtdOwogICAgICAgICAgICB0aGlzLmFyZ3MuZm9yRWFjaCgoYXJnKSA9PiBIQ0FUcmFuc1R5cGVkQXJyYXkuY29udmVydChhcmcsIHRoaXMudHJhbnNmZXJMaXN0KSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Vyck1zZyA9IG1zZzsKICAgIH0KICAgIHN0YXRpYyByZWNyZWF0ZSh0YXNrKSB7CiAgICAgICAgY29uc3QgcmVjcmVhdGVkID0gbmV3IEhDQVRhc2sodGFzay5vcmlnaW4sIHRhc2sudGFza0lELCB0YXNrLmNtZCwgdGFzay5fYXJncywgdGFzay5fcmVwbHlBcmdzKTsKICAgICAgICBpZiAodGFzay5fZXJyTXNnICE9IG51bGwpCiAgICAgICAgICAgIHJlY3JlYXRlZC5lcnJNc2cgPSB0YXNrLl9lcnJNc2c7CiAgICAgICAgZWxzZSBpZiAodGFzay5faGFzUmVzdWx0KQogICAgICAgICAgICByZWNyZWF0ZWQucmVzdWx0ID0gdGFzay5fcmVzdWx0OwogICAgICAgIHJldHVybiByZWNyZWF0ZWQ7CiAgICB9Cn0KCmNsYXNzIEhDQVRhc2tRdWV1ZSB7CiAgICBjb25zdHJ1Y3RvcihvcmlnaW4sIHBvc3RNZXNzYWdlLCB0YXNrSGFuZGxlciwgZGVzdHJveSkgewogICAgICAgIHRoaXMuX2lzQWxpdmUgPSB0cnVlOwogICAgICAgIHRoaXMuaXNJZGxlID0gdHJ1ZTsKICAgICAgICAvLyBjb21wYXJpbmcgdG8gc3RydWN0dXJlZCBjb3B5IChieSBkZWZhdWx0KSwgaWYgZGF0YSBzaXplIGlzIGJpZyAoYmVjYXVzZSBvZiB6ZXJvLWNvcHkpLAogICAgICAgIC8vIHRyYW5zZmVycmluZyBpcyBnZW5lcmFsbHkgbXVjaCBmYXN0ZXIuIGhvd2V2ZXIgaXQgb2J2aW91c2x5IGhhcyBhIGRyYXdiYWNrLAogICAgICAgIC8vIHRoYXQgdHJhbnNmZXJyZWQgYXJndW1lbnRzIGFyZSBubyBsb25nZXIgYWNjZXNzaWJsZSBpbiB0aGUgc2VuZGVyIHRocmVhZAogICAgICAgIHRoaXMudHJhbnNmZXJBcmdzID0gZmFsc2U7CiAgICAgICAgLy8gdGhlIHJlY2VpdmVyL2NhbGxlZSB3aWxsIGFsd2F5cyB1c2UgdHJhbnNmZXJyaW5nIHRvIHNlbmQgYmFjayBhcmd1bWVudHMsCiAgICAgICAgLy8gbm90IHNlbmRpbmcgdGhlIGFyZ3VtZW50cyBiYWNrIGlzIHN1cHBvc2VkIHRvIHNhdmUgYSBsaXR0bGUgdGltZS9vdmVyaGVhZAogICAgICAgIHRoaXMucmVwbHlBcmdzID0gZmFsc2U7CiAgICAgICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgICAgIHRoaXMuX2xhc3RUYXNrSUQgPSAwOwogICAgICAgIHRoaXMuY2FsbGJhY2tzID0ge307CiAgICAgICAgdGhpcy5vcmlnaW4gPSBvcmlnaW47CiAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSA9IHBvc3RNZXNzYWdlOwogICAgICAgIHRoaXMudGFza0hhbmRsZXIgPSB0YXNrSGFuZGxlcjsKICAgICAgICB0aGlzLmRlc3Ryb3kgPSBkZXN0cm95OwogICAgfQogICAgZ2V0TmV4dFRhc2tJRCgpIHsKICAgICAgICBjb25zdCBtYXggPSBIQ0FUYXNrUXVldWUubWF4VGFza0lEIC0gMTsKICAgICAgICBpZiAodGhpcy5fbGFzdFRhc2tJRCA8IDAgfHwgdGhpcy5fbGFzdFRhc2tJRCA+IG1heCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImxhc3RUYXNrSUQgb3V0IG9mIHJhbmdlIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5fbGFzdFRhc2tJRCArIDE7CiAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDw9IHN0YXJ0ICsgbWF4OyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdGFza0lEID0gaSAlIChtYXggKyAxKTsKICAgICAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9sYXN0VGFza0lEID0gdGFza0lEOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNhbm5vdCBmaW5kIG5leHQgdGFza0lEIik7CiAgICB9CiAgICBzZW5kVGFzayh0YXNrKSB7CiAgICAgICAgaWYgKHRhc2sub3JpZ2luICE9PSB0aGlzLm9yaWdpbikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoZSB0YXNrIHRvIGJlIHNlbnQgbXVzdCBoYXZlIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgdGFzayBxdWV1ZSIpOwogICAgICAgIH0KICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHRhc2ssIHRoaXMudHJhbnNmZXJBcmdzID8gdGFzay50cmFuc2Zlckxpc3QgOiBbXSk7CiAgICB9CiAgICBzZW5kUmVwbHkodGFzaykgewogICAgICAgIGlmICh0YXNrLm9yaWdpbiA9PT0gdGhpcy5vcmlnaW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0aGUgcmVwbHkgdG8gYmUgc2VudCBtdXN0IG5vdCBoYXZlIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgdGFzayBxdWV1ZSIpOwogICAgICAgIH0KICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHRhc2ssIHRhc2sudHJhbnNmZXJMaXN0KTsgLy8gYWx3YXlzIHVzZSB0cmFuc2ZlcnJpbmcgdG8gc2VuZCBiYWNrIGFyZ3VtZW50cwogICAgfQogICAgYXN5bmMgc2VuZE5leHRUYXNrKCkgewogICAgICAgIGxldCB0YXNrID0gdGhpcy5xdWV1ZS5zaGlmdCgpOwogICAgICAgIGlmICh0YXNrID09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5pc0lkbGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdGhpcy5pc0lkbGUgPSBmYWxzZTsKICAgICAgICAgICAgLy8gYXBwbHkgaG9vayBmaXJzdAogICAgICAgICAgICBjb25zdCByZWdpc3RlcmVkID0gdGhpcy5jYWxsYmFja3NbdGFzay50YXNrSURdOwogICAgICAgICAgICBjb25zdCB0YXNrSG9vayA9IHJlZ2lzdGVyZWQgIT0gbnVsbCAmJiByZWdpc3RlcmVkLmhvb2sgIT0gbnVsbCAmJgogICAgICAgICAgICAgICAgcmVnaXN0ZXJlZC5ob29rLnRhc2sgIT0gbnVsbAogICAgICAgICAgICAgICAgPyByZWdpc3RlcmVkLmhvb2sudGFzawogICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmICh0YXNrSG9vayAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHRhc2sgPSBhd2FpdCB0YXNrSG9vayh0YXNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSBgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIGFwcGx5aW5nIGhvb2sgYCArCiAgICAgICAgICAgICAgICAgICAgICAgIGBiZWZvcmUgZXhlY3V0aW5nIGNtZCAke3Rhc2suY21kfSBmcm9tICR7dGFzay5vcmlnaW59YDsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0YXNrLmlzRHVtbXkgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHNlbmQgdGFzawogICAgICAgICAgICBpZiAodGFzay5pc0R1bW15KSB7CiAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyICYmICF0YXNrLmhhc1Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICB0YXNrLnJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICBjb25zdCBldiA9IG5ldyBNZXNzYWdlRXZlbnQoIm1lc3NhZ2UiLCB7IGRhdGE6IHRhc2sgfSk7IC8vIG5vdCBhY3R1YWxseSBzZW5kaW5nLCB1c2UgYSBmYWtlIHJlcGx5CiAgICAgICAgICAgICAgICB0aGlzLm1zZ0hhbmRsZXIoZXYpOyAvLyB3b24ndCBhd2FpdAogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZW5kVGFzayh0YXNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc0FsaXZlOwogICAgfQogICAgLy8gdGhlc2UgZm9sbG93aW5nIHR3byBtZXRob2RzL2Z1bmN0aW9ucyBhcmUgc3VwcG9zZWQgdG8gYmUgY2FsbGJhY2tzCiAgICBhc3luYyBtc2dIYW5kbGVyKGV2KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgdGFzayA9IEhDQVRhc2sucmVjcmVhdGUoZXYuZGF0YSk7CiAgICAgICAgICAgIGlmICh0YXNrLm9yaWdpbiAhPT0gdGhpcy5vcmlnaW4pIHsKICAgICAgICAgICAgICAgIC8vIGluY29taW5nIGNtZCB0byBleGVjdXRlCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHRhc2sucmVzdWx0ID0gYXdhaXQgdGhpcy50YXNrSGFuZGxlcih0YXNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaXQncyBvYnNlcnZlZCB0aGF0IEZpcmVmb3ggcmVmdXNlcyB0byBwb3N0TWVzc2FnZSBhbiBFcnJvciBvYmplY3Q6CiAgICAgICAgICAgICAgICAgICAgLy8gIkRhdGFDbG9uZUVycm9yOiBUaGUgb2JqZWN0IGNvdWxkIG5vdCBiZSBjbG9uZWQuIgogICAgICAgICAgICAgICAgICAgIC8vIChvYnNlcnZlZCBpbiBGaXJlZm94IDk3LCBub3QgY2xlYXIgYWJvdXQgb3RoZXIgdmVyc2lvbnMpCiAgICAgICAgICAgICAgICAgICAgLy8gQ2hyb21lIGRvZXNuJ3Qgc2VlbSB0byBoYXZlIHRoaXMgcHJvYmxlbSwKICAgICAgICAgICAgICAgICAgICAvLyBob3dldmVyLCBpbiBvcmRlciB0byBrZWVwIGNvbXBhdGlibGUgd2l0aCBGaXJlZm94LAogICAgICAgICAgICAgICAgICAgIC8vIHdlIHN0aWxsIGhhdmUgdG8gYXZvaWQgcG9zdGluZyBhbiBFcnJvciBvYmplY3QKICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyA9CiAgICAgICAgICAgICAgICAgICAgICAgIGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gZXhlY3V0aW5nIGNtZCAke3Rhc2suY21kfSBmcm9tICR7dGFzay5vcmlnaW59YDsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0YXNrLnRhc2tJRCAhPSBIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lEKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gc2VuZFJlcGx5IGZhaWxlZC5gLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSAodGFzay5lcnJNc2cgPT0gbnVsbCA/ICIiIDogdGFzay5lcnJNc2cgKyAiXG5cbiIpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJwb3N0TWVzc2FnZSBmcm9tIFdvcmtlciBmYWlsZWQiOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cnkgYWdhaW4KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7IC8vIGlmIGl0IHRocm93cywganVzdCBsZXQgaXQgdGhyb3cKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZWNlaXZpbmcgY21kIHJlc3VsdAogICAgICAgICAgICAgICAgLy8gZmluZCAmIHVucmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyZWQgPSB0aGlzLmNhbGxiYWNrc1t0YXNrLnRhc2tJRF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jYWxsYmFja3NbdGFzay50YXNrSURdOwogICAgICAgICAgICAgICAgLy8gYXBwbHkgaG9vawogICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRhc2suaGFzUmVzdWx0ID8gdGFzay5yZXN1bHQgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBjb25zdCBob29rID0gcmVnaXN0ZXJlZC5ob29rOwogICAgICAgICAgICAgICAgaWYgKGhvb2sgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLmhhc0VyciAmJiBob29rLmVycm9yICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGhvb2suZXJyb3IodGFzay5lcnJNc2cpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRhc2suaGFzUmVzdWx0ICYmIGhvb2sucmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IGhvb2sucmVzdWx0KHRhc2sucmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBhcHBseWluZyBob29rIGAgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFmdGVyIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gc2V0dGxlIHByb21pc2UKICAgICAgICAgICAgICAgIGlmICh0YXNrLmhhc0VycikgewogICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyZWQucmVqZWN0KHRhc2suZXJyTXNnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRhc2suaGFzUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJlZC5yZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhc2sgKG9yaWdpbj0ke3Rhc2sub3JpZ2lufSB0YXNrSUQ9JHt0YXNrLnRhc2tJRH0gY21kPSR7dGFzay5jbWR9KSBgICsKICAgICAgICAgICAgICAgICAgICAgICAgYGhhcyBuZWl0aGVyIGVycm9yIG5vciByZXN1bHRgKTsgLy8gc2hvdWxkIG5ldmVyIGhhcHBlbgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gc3RhcnQgbmV4dCB0YXNrCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIGlycmVjb3ZlcmFibGUgZXJyb3IKICAgICAgICAgICAgYXdhaXQgdGhpcy5lcnJIYW5kbGVyKGUpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGVyckhhbmRsZXIoZGF0YSkgewogICAgICAgIC8vIGlycmVjb3ZlcmFibGUgZXJyb3IKICAgICAgICBpZiAodGhpcy5faXNBbGl2ZSkgewogICAgICAgICAgICAvLyBwcmludCBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZGVzdHJveWluZyBiYWNrZ3JvdW5kIHdvcmtlciBvbiBpcnJlY292ZXJhYmxlIGVycm9yYCwgZGF0YSk7CiAgICAgICAgICAgIC8vIGRlc3Ryb3kgYmFja2dyb3VuZCB3b3JrZXIKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gdHJ5aW5nIHRvIGRlc3Ryb3koKWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFmdGVyIGRlc3Ryb3ksIG1hcmsgaXNBbGl2ZSBhcyBmYWxzZSAob3RoZXJ3aXNlIHNlbmRDbWQgd2lsbCBmYWlsKQogICAgICAgICAgICB0aGlzLl9pc0FsaXZlID0gZmFsc2U7CiAgICAgICAgICAgIC8vIHJlamVjdCBhbGwgcGVuZGluZyBwcm9taXNlcwogICAgICAgICAgICBmb3IgKGxldCB0YXNrSUQgaW4gdGhpcy5jYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlamVjdCA9IHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0ucmVqZWN0OwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF07CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlamVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHJlamVjdGluZyB0YXNrSUQ9JHt0YXNrSUR9YCwgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBnZXRUcmFuc2ZlckNvbmZpZygpIHsKICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWNDbWQoIm5vcCIsIFtdLCB7CiAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gKHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyQXJnczogdGhpcy50cmFuc2ZlckFyZ3MsCiAgICAgICAgICAgICAgICByZXBseUFyZ3M6IHRoaXMucmVwbHlBcmdzLAogICAgICAgICAgICB9KSwKICAgICAgICB9KTsKICAgIH0KICAgIGFzeW5jIGNvbmZpZ1RyYW5zZmVyKHRyYW5zZmVyQXJncywgcmVwbHlBcmdzKSB7CiAgICAgICAgaWYgKCF0aGlzLl9pc0FsaXZlKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjQ21kKCJub3AiLCBbXSwgewogICAgICAgICAgICByZXN1bHQ6ICgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXMudHJhbnNmZXJBcmdzID0gdHJhbnNmZXJBcmdzID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5yZXBseUFyZ3MgPSByZXBseUFyZ3MgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICB9CiAgICBhc3luYyBleGVjQ21kKGNtZCwgYXJncywgaG9vaykgewogICAgICAgIC8vIGNhbiBiZSBtb2RpZmllZCB0byBzaW1wbHkgd3JhcCBleGVjTXVsdGlDbWQgYnV0IEkganVzdCB3YW50IHRvIGxldCBpdCBhbG9uZSBmb3Igbm8gc3BlY2lhbCByZWFzb24KICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIC8vIGFzc2lnbiBuZXcgdGFza0lECiAgICAgICAgY29uc3QgdGFza0lEID0gdGhpcy5nZXROZXh0VGFza0lEKCk7CiAgICAgICAgY29uc3QgdGFzayA9IG5ldyBIQ0FUYXNrKHRoaXMub3JpZ2luLCB0YXNrSUQsIGNtZCwgYXJncywgdGhpcy5yZXBseUFyZ3MpOwogICAgICAgIC8vIHJlZ2lzdGVyIGNhbGxiYWNrCiAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhc2tJRD0ke3Rhc2tJRH0gaXMgYWxyZWFkeSBvY2N1cGllZGApOwogICAgICAgIH0KICAgICAgICBjb25zdCByZXN1bHRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gdGhpcy5jYWxsYmFja3NbdGFza0lEXSA9IHsgcmVzb2x2ZTogcmVzb2x2ZSwgcmVqZWN0OiByZWplY3QsIGhvb2s6IGhvb2sgfSk7CiAgICAgICAgLy8gYXBwZW5kIHRvIGNvbW1hbmQgcXVldWUKICAgICAgICB0aGlzLnF1ZXVlLnB1c2godGFzayk7CiAgICAgICAgLy8gc3RhcnQgZXhlY3V0aW5nIHRhc2tzCiAgICAgICAgaWYgKHRoaXMuaXNJZGxlKQogICAgICAgICAgICBhd2FpdCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgIC8vIHJldHVybiByZXN1bHQKICAgICAgICByZXR1cm4gYXdhaXQgcmVzdWx0UHJvbWlzZTsKICAgIH0KICAgIGFzeW5jIGV4ZWNNdWx0aUNtZChjbWRMaXN0KSB7CiAgICAgICAgLy8gdGhlIHBvaW50IGlzIHRvIGVuc3VyZSAiYXRvbWljaXR5IiBiZXR3ZWVuIGNtZHMKICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIGxldCByZXN1bHRQcm9taXNlcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY21kTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAvLyBhc3NpZ24gbmV3IHRhc2tJRAogICAgICAgICAgICBjb25zdCB0YXNrSUQgPSB0aGlzLmdldE5leHRUYXNrSUQoKTsKICAgICAgICAgICAgY29uc3QgbGlzdEl0ZW0gPSBjbWRMaXN0W2ldOwogICAgICAgICAgICBjb25zdCB0YXNrID0gbmV3IEhDQVRhc2sodGhpcy5vcmlnaW4sIHRhc2tJRCwgbGlzdEl0ZW0uY21kLCBsaXN0SXRlbS5hcmdzLCB0aGlzLnJlcGx5QXJncyk7CiAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGNhbGxiYWNrCiAgICAgICAgICAgIGlmICh0aGlzLmNhbGxiYWNrc1t0YXNrSURdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGFza0lEPSR7dGFza0lEfSBpcyBhbHJlYWR5IG9jY3VwaWVkYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0UHJvbWlzZXMucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLmNhbGxiYWNrc1t0YXNrSURdID0gewogICAgICAgICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZSwKICAgICAgICAgICAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICAgICAgICAgICAgaG9vazogbGlzdEl0ZW0uaG9vaywKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgICAgICB0aGlzLnF1ZXVlLnB1c2godGFzayk7CiAgICAgICAgfQogICAgICAgIC8vIHN0YXJ0IGV4ZWN1dGluZyB0YXNrcwogICAgICAgIGlmICh0aGlzLmlzSWRsZSkKICAgICAgICAgICAgYXdhaXQgdGhpcy5zZW5kTmV4dFRhc2soKTsKICAgICAgICAvLyByZXR1cm4gcmVzdWx0cwogICAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLmFsbChyZXN1bHRQcm9taXNlcyk7CiAgICB9CiAgICBzZW5kQ21kKGNtZCwgYXJncykgewogICAgICAgIC8vIHNlbmQgY21kIHdpdGhvdXQgcmVnaXN0ZXJpbmcgY2FsbGJhY2sKICAgICAgICAvLyBnZW5lcmFsbHkgbm90IHJlY29tbWVuZGVkCiAgICAgICAgaWYgKCF0aGlzLl9pc0FsaXZlKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICBjb25zdCB0YXNrID0gbmV3IEhDQVRhc2sodGhpcy5vcmlnaW4sIEhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQsIGNtZCwgYXJncywgZmFsc2UpOwogICAgICAgIHRoaXMuc2VuZFRhc2sodGFzayk7CiAgICB9CiAgICBhc3luYyBzaHV0ZG93bihmb3JjaWJseSA9IGZhbHNlKSB7CiAgICAgICAgaWYgKHRoaXMuX2lzQWxpdmUpIHsKICAgICAgICAgICAgaWYgKGZvcmNpYmx5KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gdHJ5aW5nIHRvIGZvcmNpYmx5IHNodXRkb3duLmAsIGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faXNBbGl2ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5leGVjQ21kKCJub3AiLCBbXSwgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdDogYXN5bmMgKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faXNBbGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpIQ0FUYXNrUXVldWUubWF4VGFza0lEID0gMjU2OyAvLyB0aGVyZSdzIHJlY3Vyc2lvbiBpbiBzZW5kTmV4dFRhc2sgd2hlbiBtYWtpbmcgZmFrZSByZXBseQpIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lEID0gLTE7CgovLyBXZWIgV29ya2VyIC8gQXVkaW9Xb3JrbGV0IHN1cHBvcnQKaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2Ygb25tZXNzYWdlID09PSAidW5kZWZpbmVkIikgOwogICAgZWxzZSB7CiAgICAgICAgLy8gV2ViIFdvcmtlcgogICAgICAgIGNvbnN0IHRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIkJhY2tncm91bmQtSENBV29ya2VyIiwgKG1zZywgdHJhbnMpID0+IHBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gewogICAgICAgICAgICBzd2l0Y2ggKHRhc2suY21kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJub3AiOgogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgImZpeEhlYWRlckNoZWNrc3VtIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBSW5mby5maXhIZWFkZXJDaGVja3N1bS5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZml4Q2hlY2tzdW0iOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZml4Q2hlY2tzdW0uYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjcnlwdCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQS5kZWNyeXB0LmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImVuY3J5cHQiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZW5jcnlwdC5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBjYXNlICJhZGRDaXBoZXJIZWFkZXIiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0FJbmZvLmFkZENpcGhlckhlYWRlci5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjb2RlIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBLmRlY29kZS5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBjbWQgJHt0YXNrLmNtZH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0sICgpID0+IHsKICAgICAgICAgICAgdGFza1F1ZXVlLnNlbmRDbWQoInNlbGYtZGVzdHJ1Y3QiLCBbXSk7CiAgICAgICAgfSk7CiAgICAgICAgb25tZXNzYWdlID0gKGV2KSA9PiB0YXNrUXVldWUubXNnSGFuZGxlcihldik7CiAgICB9Cn0KCi8vIGNyZWF0ZSAmIGNvbnRyb2wgd29ya2VyCmNsYXNzIEhDQVdvcmtlciB7CiAgICBjb25zdHJ1Y3RvcihzZWxmVXJsKSB7CiAgICAgICAgdGhpcy5sYXN0VGljayA9IDA7CiAgICAgICAgdGhpcy5oY2FXb3JrZXIgPSBuZXcgV29ya2VyKHNlbGZVcmwsIHsgdHlwZTogIm1vZHVsZSIgfSk7IC8vIHNldHRpbmcgdHlwZSB0byAibW9kdWxlIiBpcyBjdXJyZW50bHkgYm9ndXMgaW4gRmlyZWZveAogICAgICAgIHRoaXMuc2VsZlVybCA9IHNlbGZVcmw7CiAgICAgICAgdGhpcy50YXNrUXVldWUgPSBuZXcgSENBVGFza1F1ZXVlKCJNYWluLUhDQVdvcmtlciIsIChtc2csIHRyYW5zKSA9PiB0aGlzLmhjYVdvcmtlci5wb3N0TWVzc2FnZShtc2csIHRyYW5zKSwgYXN5bmMgKHRhc2spID0+IHsKICAgICAgICAgICAgc3dpdGNoICh0YXNrLmNtZCkgewogICAgICAgICAgICAgICAgY2FzZSAic2VsZi1kZXN0cnVjdCI6IC8vIGRvZXNuJ3Qgc2VlbSB0byBoYXZlIGEgY2hhbmNlIHRvIGJlIGNhbGxlZAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGhjYVdvcmtlciByZXF1ZXN0ZWQgdG8gc2VsZi1kZXN0cnVjdGApOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudGFza1F1ZXVlLnNodXRkb3duKHRydWUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfSwgKCkgPT4gdGhpcy5oY2FXb3JrZXIudGVybWluYXRlKCkpOwogICAgICAgIHRoaXMuaGNhV29ya2VyLm9ubWVzc2FnZSA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLm1zZ0hhbmRsZXIobXNnKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbmVycm9yID0gKG1zZykgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihtc2cpOwogICAgICAgIHRoaXMuaGNhV29ya2VyLm9ubWVzc2FnZWVycm9yID0gKG1zZykgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihtc2cpOwogICAgfQogICAgZ2V0IGlzQWxpdmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGFza1F1ZXVlLmlzQWxpdmU7CiAgICB9CiAgICBhc3luYyBzaHV0ZG93bihmb3JjaWJseSA9IGZhbHNlKSB7CiAgICAgICAgaWYgKHRoaXMudGFza1F1ZXVlLmlzQWxpdmUpCiAgICAgICAgICAgIGF3YWl0IHRoaXMudGFza1F1ZXVlLnNodXRkb3duKGZvcmNpYmx5KTsKICAgIH0KICAgIGFzeW5jIHRpY2soKSB7CiAgICAgICAgYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgibm9wIiwgW10pOwogICAgICAgIHRoaXMubGFzdFRpY2sgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0KICAgIGFzeW5jIHRvY2sodGV4dCA9ICIiKSB7CiAgICAgICAgYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgibm9wIiwgW10pOwogICAgICAgIGNvbnN0IGR1cmF0aW9uID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLmxhc3RUaWNrOwogICAgICAgIGNvbnNvbGUubG9nKGAke3RleHR9IHRvb2sgJHtkdXJhdGlvbn0gbXNgKTsKICAgICAgICByZXR1cm4gZHVyYXRpb247CiAgICB9CiAgICBzdGF0aWMgYXN5bmMgY3JlYXRlKHNlbGZVcmwpIHsKICAgICAgICBpZiAodHlwZW9mIHNlbGZVcmwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHNlbGZVcmwgPSBuZXcgVVJMKHNlbGZVcmwsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghKHNlbGZVcmwgaW5zdGFuY2VvZiBVUkwpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2VsZlVybCBtdXN0IGJlIGVpdGhlciBzdHJpbmcgb3IgVVJMIik7CiAgICAgICAgfQogICAgICAgIC8vIGZldGNoICYgc2F2ZSBoY2EuanMgYXMgYmxvYiBpbiBhZHZhbmNlLCB0byBhdm9pZCBjcmVhdGluZyB3b3JrZXIgYmVpbmcgYmxvY2tlZCBsYXRlciwgbGlrZToKICAgICAgICAvLyAoSSBvYnNlcnZlZCB0aGlzIHByb2JsZW0gaW4gRmlyZWZveCkKICAgICAgICAvLyBjcmVhdGluZyBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIgcmVxdWlyZXMgaW5mb3JtYXRpb24gZnJvbSBIQ0EsIHdoaWNoIGlzIHNhbXBsZSByYXRlIGFuZCBjaGFubmVsIGNvdW50OwogICAgICAgIC8vIGhvd2V2ZXIsIGZldGNoaW5nIEhDQSAob3JpZ2luYWxseSBzdXBwb3NlZCB0byBiZSBwcm9ncmVzc2l2ZS9zdHJlYW1lZCkgYmxvY2tzIGxhdGVyIHJlcXVlc3QgdG8gZmV0Y2ggaGNhLmpzLAogICAgICAgIC8vIHNvIHRoYXQgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIGNhbiBvbmx5IGJlIGNyZWF0ZWQgYWZ0ZXIgZmluaXNoaW5nIGRvd25sb2FkaW5nIHRoZSB3aG9sZSBIQ0EsCiAgICAgICAgLy8gd2hpY2ggb2J2aW91c2x5IGRlZmVhdHMgdGhlIHB1cnBvc2Ugb2Ygc3RyZWFtaW5nIEhDQQogICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goc2VsZlVybC5ocmVmKTsKICAgICAgICAvLyBGaXJlZm94IGN1cnJlbnRseSBkb2VzIG5vdCBzdXBwb3J0IEVDTUFTY3JpcHQgbW9kdWxlcyBpbiBXb3JrZXIsCiAgICAgICAgLy8gdGhlcmVmb3JlIHdlIG11c3Qgc3RyaXAgYWxsIGV4cG9ydCBkZWNsYXJhdGlvbnMKICAgICAgICBjb25zdCBvcmlnVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTsKICAgICAgICBjb25zdCBjb252ZXJ0ZWRUZXh0ID0gKCJcbiIgKyBvcmlnVGV4dCkucmVwbGFjZSgvXGJleHBvcnRccyt7Lio/fTs/LywgIiIpLnNsaWNlKDEpOwogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbY29udmVydGVkVGV4dF0sIHsgdHlwZTogInRleHQvamF2YXNjcmlwdCIgfSk7CiAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChibG9iKTsKICAgICAgICBjb25zdCBkYXRhVVJJID0gYXdhaXQgbmV3IFByb21pc2UoKHJlcykgPT4gewogICAgICAgICAgICByZWFkZXIub25sb2FkZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmVzKHJlYWRlci5yZXN1bHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICAgIHNlbGZVcmwgPSBuZXcgVVJMKGRhdGFVUkksIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgIHJldHVybiBuZXcgSENBV29ya2VyKHNlbGZVcmwpOwogICAgfQogICAgLy8gY29tbWFuZHMKICAgIGFzeW5jIGdldFRyYW5zZmVyQ29uZmlnKCkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5nZXRUcmFuc2ZlckNvbmZpZygpOwogICAgfQogICAgYXN5bmMgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpOwogICAgfQogICAgYXN5bmMgZml4SGVhZGVyQ2hlY2tzdW0oaGNhKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpeEhlYWRlckNoZWNrc3VtIiwgW2hjYV0pOwogICAgfQogICAgYXN5bmMgZml4Q2hlY2tzdW0oaGNhKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpeENoZWNrc3VtIiwgW2hjYV0pOwogICAgfQogICAgYXN5bmMgZGVjcnlwdChoY2EsIGtleTEsIGtleTIpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiZGVjcnlwdCIsIFtoY2EsIGtleTEsIGtleTJdKTsKICAgIH0KICAgIGFzeW5jIGVuY3J5cHQoaGNhLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImVuY3J5cHQiLCBbaGNhLCBrZXkxLCBrZXkyXSk7CiAgICB9CiAgICBhc3luYyBhZGRIZWFkZXIoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiYWRkSGVhZGVyIiwgW2hjYSwgc2lnLCBuZXdEYXRhXSk7CiAgICB9CiAgICBhc3luYyBhZGRDaXBoZXJIZWFkZXIoaGNhLCBjaXBoZXJUeXBlKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImFkZENpcGhlckhlYWRlciIsIFtoY2EsIGNpcGhlclR5cGVdKTsKICAgIH0KICAgIGFzeW5jIGRlY29kZShoY2EsIG1vZGUgPSAzMiwgbG9vcCA9IDAsIHZvbHVtZSA9IDEuMCkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJkZWNvZGUiLCBbaGNhLCBtb2RlLCBsb29wLCB2b2x1bWVdKTsKICAgIH0KfQoKZXhwb3J0IHsgSENBLCBIQ0FJbmZvLCBIQ0FXb3JrZXIgfTsK", document.baseURI);
        var hcaJsModule, hcaJsObjUrl, HCAInfo, HCAWorker;

        // mime types
        const defMimeType = "application/octet-stream";
        const mimeTypeMap = {
            wav: "audio/x-wav",
            hca: defMimeType,
        }

        // HCAWorker instance
        var worker = null;

        // dragged file
        var draggedFile = null;

        // local file picker
        const localfile = document.getElementById("localfile");
        const localfileform = document.getElementById("localfileform");
        // reset state on refresh
        // https://bugzilla.mozilla.org/show_bug.cgi?id=685657
        localfileform.reset();

        // input HCA URL
        const urlinput = document.getElementById("urlinput");

        // file name
        var fileName = null;

        // HCA info table
        const hcaInfoTable = {
            el: document.getElementById("hcaInfoTable"),
            body: {
                el: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0],
                defText: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0]
                    .getElementsByTagName("td")[0]
                    .textContent,
                data: {},
            },
        }
        Object.defineProperty(hcaInfoTable.body, "data", {
            get: function () {return this.value},
            set: function (val) {
                // clear existing content
                for (let i = hcaInfoTable.body.el.getElementsByTagName("tr").length - 1; i >= 0; i--) {
                    hcaInfoTable.body.el.deleteRow(i);
                }
                function appendRow(cells, rowspan) {
                    let newRow = hcaInfoTable.body.el.insertRow(-1);
                    cells.forEach((val, idx) => {
                        let newCell = newRow.insertCell(idx);
                        if (rowspan != null && idx == 0)
                            newCell.setAttribute("rowspan", rowspan);
                        if (cells.length < 3 && idx == cells.length - 1)
                            newCell.setAttribute("colspan", cells.length - idx + 1);
                        let newText = val != null
                            ? document.createTextNode("" + val)
                            : (() => {
                                let italic = document.createElement("i");
                                italic.innerHTML = "(not defined)";
                                return italic;
                            })();
                        newCell.appendChild(newText);
                    });
                }
                function toHex(num) {
                    const padding = "0000";
                    let hex = padding + num.toString(padding.length * 4).toUpperCase();
                    return "0x" + hex.substring(hex.length - padding.length, hex.length)
                }
                if (val == null || !val instanceof HCAInfo) {
                    appendRow([hcaInfoTable.body.defText]);
                    return; // nothing to add
                }
                // add given content
                let info = val;
                const hcaInfoTextArray = [
                    ["Version", info.version],
                    ["Header size", info.dataOffset],
                    ["Format", !info.hasHeader["fmt"] ? null : [
                        ["Channels", info.format.channelCount],
                        ["Sampling Rate", info.format.samplingRate],
                        ["Blocks", info.format.blockCount],
                        ["Dropped smpl. (head)", info.format.droppedHeader],
                        ["Dropped smpl. (tail)", info.format.droppedFooter],
                    ]],
                    ["Block size", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.blockSize],
                    ["Bitrate (kbps)", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.kbps],
                    ["VBR", info.hasHeader["vbr"] ? "yes" : "no"],
                    ["ATH", !info.hasHeader["ath"] ? null : toHex(info.ath)],
                    ["Loop", !info.hasHeader["loop"] ? null : [
                        ["Start", info.loop.start],
                        ["End", info.loop.end],
                        ["Dropped smpl. (head)", info.loop.droppedHeader],
                        ["Dropped smpl. (tail)", info.loop.droppedFooter],
                    ]],
                    ["Cipher", !info.hasHeader["ciph"] ? null : toHex(info.cipher)],
                    ["RVA (volume)", !info.hasHeader["rva"] ? null : info.rva],
                    ["Comment", !info.hasHeader["comm"] ? null : info.comment],
                ];
                for (let item of hcaInfoTextArray) {
                    let key = item[0];
                    let val = item[1];
                    if (Array.isArray(val)) {
                        let textList = val[0].slice(0);
                        textList.unshift(key);
                        appendRow(textList, val.length);
                        val.shift();
                        val.forEach((item) => appendRow(item))
                    } else {
                        appendRow([key, val]);
                    }
                }
                // update value
                this.value = val;
            },
        });

        // keys
        const keys = {key1: undefined, key2: undefined};
        for (let key in keys) {
            Object.defineProperty(keys, key, {
                get: function () {return document.getElementById(key + "input").value},
                set: function (val) {document.getElementById(key + "input").value = val},
            });
        }

        // mode/loop/volume
        const decodingParam = {
            mode: {
                el: document.getElementById("decodingmodeinput"),
                defVal: 16,
            },
            loop: {
                el: document.getElementById("loopcountinput"),
                defVal: 0,
            },
            volumePerCent: {
                el: document.getElementById("volumeinput"),
                defVal: 100,
            },
        }

        for (let paramName in decodingParam) {
            let el = decodingParam[paramName].el;
            let defVal = decodingParam[paramName].defVal;
            let attr = {};
            ["min", "max", "step"].forEach((attrName) => attr[attrName] = el.getAttribute(attrName));
            let clampVal = function (val) {
                if (val == null || val === "")
                    return defVal;
                val = parseInt(val);
                if (isNaN(val))
                    return defVal;
                if (val % attr.step != 0)
                    val = Math.floor(val / attr.step);
                else if (val < attr.min)
                    val = attr.min;
                else if (val > attr.max)
                    val = attr.max;
                return val;
            }
            Object.defineProperty(decodingParam, paramName, {
                get: function () {
                    let clamped = clampVal(el.value);
                    el.value = "" + clamped;
                    return clamped;
                },
                set: function (val) {
                    el.value = "" + clampVal(val);
                }
            });
        }

        // HCA file data
        const hcaFileData = {
            // original HCA file content
            original: {
                btnID: "downloadbtn",
                data: {},
            },
            // after fixing checksum
            fixed_checksum: {
                btnID: "fixcsumbtn",
                data: {},
            },
            // after decryption
            decrypted: {
                btnID: "decryptbtn",
                data: {},
            },
            // after encryption
            encrypted: {
                btnID: "encryptbtn",
                data: {},
            },
            // after decoding
            decoded: {
                btnID: "decodebtn",
                data: {},
            },
        }
        for (let suffix in hcaFileData) {
            Object.defineProperty(hcaFileData[suffix], "data", {
                get: function () {return this.value},
                set: function (val) {
                    this.value = null; // clear existing data
                    const fileExtRegEx = /\.([^\.]+)$/;
                    let newFileName = fileName.replace(fileExtRegEx, "_" + suffix + ".$1");
                    if (suffix === "decoded")
                        newFileName = newFileName.replace(fileExtRegEx, ".wav");
                    let id = suffix + "-download-link";
                    let el = document.getElementById(id);
                    if (el != null) {
                        // remove existing download link
                        URL.revokeObjectURL(el.getAttribute("href"));
                        el.nextSibling.remove();
                        el.remove();
                    }
                    if (val == null) {
                        console.log(`hcaFileData ${suffix} cleared`);
                        return; // nothing to create
                    }
                    console.log(`hcaFileData ${suffix} byteLength=${val.byteLength}`);
                    // create new download link
                    el = document.createElement("a");
                    el.setAttribute("id", id);
                    el.setAttribute("download", newFileName);
                    let extName = newFileName.match(fileExtRegEx)[0];
                    let mimeType = mimeTypeMap[extName];
                    if (mimeType == null) mimeType = defMimeType;
                    el.setAttribute("href", URL.createObjectURL(new Blob([val], {type: mimeType})));
                    el.innerHTML = newFileName;
                    let refNode = document.getElementById(hcaFileData[suffix].btnID).nextSibling;
                    document.body.insertBefore(document.createElement("br"), refNode);
                    document.body.insertBefore(el, refNode);
                    // update value
                    this.value = val;
                },
            });
        }
        function clearAllData() {
            localfileform.reset();
            for (let suffix in hcaFileData) {
                hcaFileData[suffix].data = null;
            }
            hcaInfoTable.body.data = null;
            audioElement.src = null;
            console.log(`cleared all data`);
        }

        // Audio element
        const audioElement = {
            el: document.getElementById("audioElement"),
            src: ""
        };
        Object.defineProperty(audioElement, "src", {
            get: function () {return this.value},
            set: function (val) {
                if (this.value != null && this.value != "")
                    URL.revokeObjectURL(this.value);
                if (val == null || val === "") {
                    this.value = audioElement.el.src = "";
                    return;
                }
                let newUrl;
                if (val instanceof ArrayBuffer || val.buffer instanceof ArrayBuffer) {
                    newUrl = URL.createObjectURL(new Blob([val], {type: mimeTypeMap.wav}));
                } else {
                    newUrl = val;
                }
                this.value = audioElement.el.src = newUrl;
            }
        });

        // buttons
        const buttons = {
            startworkerbtn: async (self) => {
                if (worker == null) {
                    if (hcaJsObjUrl == null) {
                        const response = await fetch(hcaJsUrl.href);
                        const blob = new Blob([await response.arrayBuffer()], {type: "text/javascript"});
                        hcaJsObjUrl = URL.createObjectURL(blob);
                    }
                    if (hcaJsModule == null) {
                        hcaJsModule = await import(hcaJsObjUrl);
                    }
                    if (HCAInfo == null) HCAInfo = hcaJsModule.HCAInfo;
                    if (HCAWorker == null) HCAWorker = hcaJsModule.HCAWorker;
                    worker = await HCAWorker.create(hcaJsObjUrl);
                    console.log("started background worker");
                }
                self.disabled = true; // added because button won't grey out if there's any await above
                buttons.shutdownbtn = true;
            },
            shutdownbtn: async (self) => {
                if (worker != null) {
                    await worker.shutdown();
                    worker = null;
                    console.log("background worker is now shut down");
                }
                self.disabled = true; // added together with above startworkerbtn
                buttons.startworkerbtn = true;
            },
            loadfilebtn: async (self) => {
                let file = null;
                if (draggedFile != null) {
                    self.textContent = "loading dragged file...";
                    file = draggedFile;
                    draggedFile = null;
                } else {
                    self.textContent = "loading picked file...";
                    file = localfile.files[0];
                }
                let newFileName = file.name;
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await file.arrayBuffer();
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "load picked file (successful)";
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            downloadbtn: async (self) => {
                self.textContent = "downloading...";
                let requestUrl = urlinput.value;
                if (requestUrl === "") {
                    self.textContent = "download (empty URL)";
                    self.disabled = false;
                    return;
                }
                let response = null;
                try {
                    response = await fetch(requestUrl);
                } catch (e) {
                    console.error(e);
                    self.textContent = "download (network error)";
                    self.disabled = false;
                    return;
                }
                if (response.status != 200) {
                    console.error("download failed,", response);
                    self.textContent = `download (failed, ${response.status} ${response.statusText})`;
                    self.disabled = false;
                    return;
                }
                // get filename from Content-Disposition
                let cd = response.headers.get("Content-Disposition");
                let newFileName = null;
                if (cd != null) {
                    let splitted = cd.split(";");
                    let cdFileName = splitted.find((substr) => substr.startsWith("filename="));
                    if (cdFileName != null) {
                        newFileName = cdFileName.substring("filename=".length)
                            .replaceAll(" ", "")
                            .replaceAll("\"", "");
                    }
                }
                // failed to get filename from Content-Disposition, try URL
                const fileNameRegEx = /[^\/^\\]+$/;
                if (newFileName == null || newFileName === "") {
                    let urlFilename = [response.url, requestUrl].find((url) => url != null && url.match(fileNameRegEx));
                    if (urlFilename != null)
                        newFileName = urlFilename.match(fileNameRegEx)[0];
                }
                // failed to get filename, use default filename
                if (newFileName == null || newFileName === "") {
                    newFileName = "downloaded.hca";
                }
                // strip query string
                let stripped = newFileName.match(/^[^\?]+/);
                if (stripped != null)
                    newFileName = stripped[0];
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await response.arrayBuffer();
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "download (successful)";
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            infobtn: async (self) => {
                let hca = hcaFileData[
                    ["fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`get HCA info from ${suffix} file data`);
                            return true;
                        }
                    })
                ].data;
                try {
                    let info = new HCAInfo(hca);
                    self.textContent = "get HCA info (successful)";
                    // update table content
                    hcaInfoTable.body.data = info;
                    // next step
                    let isEncrypted = info.hasHeader["ciph"] && info.cipher !=0;
                    buttons.encryptbtn = !isEncrypted;
                    buttons.decryptbtn = isEncrypted;
                    buttons.decodebtn = !isEncrypted;
                } catch (e) {
                    console.error(e);
                    self.textContent = "get HCA info (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            fixcsumbtn: async (self) => {
                try {
                    worker.tick();
                    let newHcaPromise = worker.fixChecksum(hcaFileData.original.data);
                    worker.tock("fix checksum");
                    let newHca = await newHcaPromise;
                    // update data
                    hcaFileData.fixed_checksum.data = newHca;
                    self.textContent = "fix checksum (successful)";
                } catch (e) {
                    console.error(e);
                    self.textContent = "fix checksum (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            encryptbtn: async (self) => {
                await encryptOrDecrypt(self, true);
                // let the button bounce
                self.disabled = false;
            },
            decryptbtn: async (self) => {
                await encryptOrDecrypt(self, false);
                // let the button bounce
                self.disabled = false;
            },
            decodebtn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = worker.decode(hca,
                        decodingParam.mode, decodingParam.loop, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let decoded = await decodedPromise;
                    // update data
                    hcaFileData.decoded.data = decoded;
                    self.textContent = "decode (done)";
                    // next step (play)
                    audioElement.src = decoded;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
        };
        const _buttons = {};
        for (let id in buttons) {
            let el = document.getElementById(id);
            let onclick = buttons[id];
            el.onclick = (ev) => {
                let self = ev.srcElement;
                self.disabled = true;
                onclick(self);
            }
            const initialText = el.textContent;
            Object.defineProperty(buttons, id, {
                get: function () {return !el.disabled},
                set: function (val) {
                    if (val === "click") {
                        el.disabled = true;
                        onclick(el);
                        return;
                    }
                    el.textContent = initialText;
                    el.disabled = !val;
                },
            });
            Object.defineProperty(_buttons, id, {
                get: function () {return onclick;},
            });
        }
        buttons.startworkerbtn = "click"; // start background worker
        function resetButtonsExcept(exceptBtnID) {
            for (let btnID in buttons) {
                if (btnID !== exceptBtnID) switch (btnID) {
                    case "startworkerbtn":
                        buttons[btnID] = worker == null || !worker.isAlive;
                        break;
                    case "shutdownbtn":
                        buttons[btnID] = worker != null && worker.isAlive;
                        break;
                    case "loadfilebtn":
                        buttons[btnID] = false;
                        break;
                    case "downloadbtn":
                        buttons[btnID] = true;
                        break;
                    default:
                        buttons[btnID] = false;
                }
            }
        }
        resetButtonsExcept(); // same to above, reset state on refresh
        async function encryptOrDecrypt(self, isEncrypting) {
            const action = isEncrypting ? "encrypt" : "decrypt";
            const opposite = isEncrypting ? "decrypt" : "encrypt";
            // disable both buttons
            self.disabled = true;
            buttons[opposite + "btn"] = false;
            self.textContent = action + "ing...";
            // disable decodebtn if necessary
            if (!isEncrypting)
                buttons.decodebtn = false
            // prepare data
            let hca = hcaFileData[
                [opposite + "ed", "fixed_checksum", "original"].find((suffix) => {
                    if (hcaFileData[suffix].data != null) {
                        console.log(`${action}ing ${suffix} data...`);
                        return true;
                    }
                })
            ].data;
            if (isEncrypting && !hcaInfoTable.body.data.hasHeader["ciph"]) {
                // check for ciph header section
                console.log("input HCA lacks ciph header section, adding it");
                hca = await worker.addCipherHeader(hca);
            } else {
                hca = hca.slice(0); // just copy to new buffer
            }
            // start to encrypt/decrypt
            try {
                worker.tick();
                // although decryption/encryption is done in-place,
                // however since we are not using SharedArrayBuffer,
                // the background worker is still actually overwritting a newly allocated buffer
                let resultPromise = worker[action](hca, keys.key1, keys.key2);
                worker.tock(isEncrypting ? "encryption" : "decryption");
                let result = await resultPromise;
                self.textContent = action + " (done)";
                // update data
                hcaFileData[action + "ed"].data = result;
                // next steps
                buttons[opposite + "btn"] = true;
                if (!isEncrypting)
                    buttons.decodebtn = true;
            } catch (e) {
                console.error(e);
                self.textContent = "Error during " + (isEncrypting ? "encryption" : "decryption");
            }
        }

        globalThis.buttons = buttons;
    </script>
</body>
</html>