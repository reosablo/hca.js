<!DOCTYPE html>
<html>
<head></head>
<body>
    <h1>HCA decoder demo</h1>
    <i>Standalone version - you may right-click & save this page for offline use.</i><br>
    <hr>
    <button disabled id="startworkerbtn">start background worker</button><br>
    <button disabled id="shutdownbtn">shutdown background worker</button><br>
    <hr>
    <h3>Choose a HCA file</h3>
    Drag & drop a file here,<br>
    <form id="localfileform">
        Or pick a local file: <input type="file" id="localfile" accept=".hca,application/octet-stream" onchange="buttons.loadfilebtn = this.files.length > 0"><br>
    </form>
    <b><u>Don't forget to</u></b> <button disabled id="loadfilebtn">load picked file</button><br>
    Or download from URL: <input type="text" spellcheck="false" id="urlinput" value="bgm01_anime02_hca.hca"><br>
    <button id="downloadbtn">download</button><br>
    <hr>
    <h3>Set keys for decryption/encryption</h3>
    key1=<input type="text" spellcheck="false" id="key1input" value="0x01395C51"><br>
    key2=<input type="text" spellcheck="false" id="key2input" value="0x00000000"><br>
    <i>Note: output waveform will be nothing but unpleasant meaningless noise if incorrect keys are given!</i><br>
    <hr>
    <h3>Decode the whole file</h3>
    Decoding mode: <input type="number" step="8" min="0" max="32" placeholder="0-99" id="decodingmodeinput" value="16"><br>
    Loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
    Volume: <input type="number" step="1" min="0" max="100" placeholder="0-100" id="volumeinput" value="100"><br>
    Note:<br>
    (1) Setting decoding mode to <b>zero means 32-bit float mode</b>, or <b>8/16/24/32-bit integer mode</b> otherwise.<br>
    (2) Loop count is <b>ignored if HCA header doesn't have loop section</b><br>
    (3) Loop count doesn't count the existing part which is originally supposed to be looped.<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>In other words, actual loop count will be: the number set here plus one.</b><br>
    (4) When <b>decoding the whole file</b>, setting loop count to <b>zero</b> means: <b>disabling loop</b>.</b><br>
    <button disabled id="infobtn">get HCA info</button><br>
    <style>
        table {
            border-top: 1px solid #000;
            border-left: 1px solid #000;
            border-spacing: 0;
        }
        tbody td {
            border-bottom: 1px solid #000;
            border-right: 1px solid #000;
            min-width: 8ch;
        }
        thead tr th, tfoot tr th {
            background-color: #fff;
            color: #000;
            border-bottom: 1px solid #000;
            border-right: 1px solid #000;
        }
    </style>
    <table id="hcaInfoTable">
        <thead>
            <tr>
                <th colspan="3">HCA info</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>(Not loaded)</td>
            </tr>
        </tbody>
    </table>
    <button disabled id="fixcsumbtn">fix checksum</button><br>
    <button disabled id="encryptbtn">encrypt</button><br>
    <button disabled id="decryptbtn">decrypt</button><br>
    <button disabled id="decodebtn">decode</button><br>
    <audio id="audioElement" controls></audio>
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script> -->
    <script type="module">
        const hcaJsUrl = new URL("data:text/javascript;base64,dmFyIF9hLCBfYjsKY2xhc3MgSENBSW5mbyB7CiAgICBjb25zdHJ1Y3RvcihoY2EsIGNoYW5nZU1hc2sgPSBmYWxzZSwgZW5jcnlwdCA9IGZhbHNlKSB7CiAgICAgICAgdGhpcy52ZXJzaW9uID0gIiI7CiAgICAgICAgdGhpcy5kYXRhT2Zmc2V0ID0gMDsKICAgICAgICB0aGlzLmZvcm1hdCA9IHsKICAgICAgICAgICAgY2hhbm5lbENvdW50OiAwLAogICAgICAgICAgICBzYW1wbGluZ1JhdGU6IDAsCiAgICAgICAgICAgIGJsb2NrQ291bnQ6IDAsCiAgICAgICAgICAgIGRyb3BwZWRIZWFkZXI6IDAsCiAgICAgICAgICAgIGRyb3BwZWRGb290ZXI6IDAKICAgICAgICB9OwogICAgICAgIHRoaXMuYmxvY2tTaXplID0gMDsKICAgICAgICB0aGlzLmhhc0hlYWRlciA9IHt9OwogICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0ID0ge307IC8vIFtzdGFydCAoaW5jbHVzaXZlKSwgZW5kIChleGNsdXNpdmUpXQogICAgICAgIHRoaXMua2JwcyA9IDA7CiAgICAgICAgdGhpcy5jb21wRGVjID0gewogICAgICAgICAgICBNaW5SZXNvbHV0aW9uOiAwLAogICAgICAgICAgICBNYXhSZXNvbHV0aW9uOiAwLAogICAgICAgICAgICBUcmFja0NvdW50OiAwLAogICAgICAgICAgICBDaGFubmVsQ29uZmlnOiAwLAogICAgICAgICAgICBUb3RhbEJhbmRDb3VudDogMCwKICAgICAgICAgICAgQmFzZUJhbmRDb3VudDogMCwKICAgICAgICAgICAgU3RlcmVvQmFuZENvdW50OiAwLAogICAgICAgICAgICBIZnJCYW5kQ291bnQ6IDAsCiAgICAgICAgICAgIEJhbmRzUGVySGZyR3JvdXA6IDAsCiAgICAgICAgICAgIFJlc2VydmVkMTogMCwKICAgICAgICAgICAgUmVzZXJ2ZWQyOiAwLAogICAgICAgIH07CiAgICAgICAgdGhpcy5kZWMgPSB7CiAgICAgICAgICAgIERlY1N0ZXJlb1R5cGU6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLmxvb3AgPSB7CiAgICAgICAgICAgIHN0YXJ0OiAwLAogICAgICAgICAgICBlbmQ6IDAsCiAgICAgICAgICAgIC8vIGNvdW50OiAwLCAvLyBOeWFnYW1vbidzIGludGVycHJldGF0aW9uCiAgICAgICAgICAgIC8vIHIwMTogMCwKICAgICAgICAgICAgZHJvcHBlZEhlYWRlcjogMCwKICAgICAgICAgICAgZHJvcHBlZEZvb3RlcjogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMudmJyID0gewogICAgICAgICAgICBNYXhCbG9ja1NpemU6IDAsCiAgICAgICAgICAgIE5vaXNlTGV2ZWw6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLlVzZUF0aEN1cnZlID0gZmFsc2U7CiAgICAgICAgdGhpcy5jaXBoZXIgPSAwOwogICAgICAgIHRoaXMucnZhID0gMC4wOwogICAgICAgIHRoaXMuY29tbWVudCA9ICIiOwogICAgICAgIC8vIGNvbXB1dGVkIHNhbXBsZSBjb3VudC9vZmZzZXRzCiAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gMDsKICAgICAgICB0aGlzLmZ1bGxTYW1wbGVDb3VudCA9IDA7CiAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wU3RhcnRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wRW5kQXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMubG9vcFNhbXBsZUNvdW50ID0gMDsKICAgICAgICB0aGlzLmVuZEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLnNhbXBsZUNvdW50ID0gMDsKICAgICAgICAvLyBmdWxsIGZpbGUgc2l6ZSAvIGRhdGEgcGFydCAoZXhjbHVkaW5nIGhlYWRlciwganVzdCBibG9ja3MvZnJhbWVzKSBzaXplCiAgICAgICAgdGhpcy5mdWxsU2l6ZSA9IDA7CiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IDA7CiAgICAgICAgLy8gaWYgY2hhbmdlTWFzayA9PSB0cnVlLCAodW4pbWFzayB0aGUgaGVhZGVyIHNpZ3MgaW4tcGxhY2UKICAgICAgICB0aGlzLnJhd0hlYWRlciA9IHRoaXMucGFyc2VIZWFkZXIoaGNhLCBjaGFuZ2VNYXNrLCBlbmNyeXB0LCB7fSk7CiAgICB9CiAgICBzdGF0aWMgZ2V0U2lnbihyYXcsIG9mZnNldCA9IDAsIGNoYW5nZU1hc2ssIGVuY3J5cHQpIHsKICAgICAgICBsZXQgbWFnaWMgPSByYXcuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgICAgbGV0IHN0ckxlbiA9IDQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICAgICAgaWYgKHJhdy5nZXRVaW50OChvZmZzZXQgKyBpKSA9PSAwKSB7CiAgICAgICAgICAgICAgICBzdHJMZW4gPSBpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHN0ckxlbiA+IDApIHsKICAgICAgICAgICAgbGV0IG1hc2sgPSAweDgwODA4MDgwID4+PiA4ICogKDQgLSBzdHJMZW4pOwogICAgICAgICAgICBtYWdpYyAmPSAweDdmN2Y3ZjdmOwogICAgICAgICAgICBpZiAoY2hhbmdlTWFzaykKICAgICAgICAgICAgICAgIHJhdy5zZXRVaW50MzIob2Zmc2V0LCBlbmNyeXB0ID8gbWFnaWMgfCBtYXNrIDogbWFnaWMsIHRydWUpOwogICAgICAgIH0KICAgICAgICBsZXQgaGV4ID0gW21hZ2ljICYgMHhmZiwgbWFnaWMgPj4gOCAmIDB4ZmYsIG1hZ2ljID4+IDE2ICYgMHhmZiwgbWFnaWMgPj4gMjQgJiAweGZmXTsKICAgICAgICBoZXggPSBoZXguc2xpY2UoMCwgc3RyTGVuKTsKICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGhleCk7CiAgICB9CiAgICBjbG9uZSgpIHsKICAgICAgICByZXR1cm4gbmV3IEhDQUluZm8odGhpcy5yYXdIZWFkZXIpOwogICAgfQogICAgcGFyc2VIZWFkZXIoaGNhLCBjaGFuZ2VNYXNrLCBlbmNyeXB0LCBtb2RMaXN0KSB7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoaGNhLmJ1ZmZlciwgaGNhLmJ5dGVPZmZzZXQsIDgpOwogICAgICAgIGxldCBoZWFkID0gSENBSW5mby5nZXRTaWduKHAsIDAsIGZhbHNlLCBlbmNyeXB0KTsgLy8gZG8gbm90IG92ZXJ3cml0ZSBmb3Igbm93LCB1bnRpbCBjaGVja3N1bSB2ZXJpZmllZAogICAgICAgIGlmIChoZWFkICE9PSAiSENBIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBhIEhDQSBmaWxlIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZlcnNpb24gPSB7CiAgICAgICAgICAgIG1haW46IHAuZ2V0VWludDgoNCksCiAgICAgICAgICAgIHN1YjogcC5nZXRVaW50OCg1KQogICAgICAgIH07CiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbi5tYWluICsgJy4nICsgdmVyc2lvbi5zdWI7CiAgICAgICAgdGhpcy5kYXRhT2Zmc2V0ID0gcC5nZXRVaW50MTYoNik7CiAgICAgICAgLy8gdmVyaWZ5IGNoZWNrc3VtCiAgICAgICAgSENBQ3JjMTYudmVyaWZ5KGhjYSwgdGhpcy5kYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgbGV0IGhhc01vZERvbmUgPSBmYWxzZTsKICAgICAgICAvLyBjaGVja3N1bSB2ZXJpZmllZCwgbm93IHdlIGNhbiBvdmVyd3JpdGUgaXQKICAgICAgICBpZiAoY2hhbmdlTWFzaykKICAgICAgICAgICAgSENBSW5mby5nZXRTaWduKHAsIDAsIGNoYW5nZU1hc2ssIGVuY3J5cHQpOwogICAgICAgIC8vIHBhcnNlIHRoZSBoZWFkZXIKICAgICAgICBwID0gbmV3IERhdGFWaWV3KGhjYS5idWZmZXIsIGhjYS5ieXRlT2Zmc2V0LCB0aGlzLmRhdGFPZmZzZXQpOwogICAgICAgIGxldCBmdGVsbCA9IDg7CiAgICAgICAgd2hpbGUgKGZ0ZWxsIDwgdGhpcy5kYXRhT2Zmc2V0IC0gMikgewogICAgICAgICAgICBsZXQgbGFzdEZ0ZWxsID0gZnRlbGw7CiAgICAgICAgICAgIC8vIGdldCB0aGUgc2lnCiAgICAgICAgICAgIGxldCBzaWduID0gSENBSW5mby5nZXRTaWduKHAsIGZ0ZWxsLCBjaGFuZ2VNYXNrLCBlbmNyeXB0KTsKICAgICAgICAgICAgLy8gcmVjb3JkIGhhc0hlYWRlcgogICAgICAgICAgICB0aGlzLmhhc0hlYWRlcltzaWduXSA9IHRydWU7CiAgICAgICAgICAgIC8vIHBhZGRpbmcgc2hvdWxkIGJlIHRoZSBsYXN0IG9uZQogICAgICAgICAgICBpZiAoc2lnbiA9PSAicGFkIikgewogICAgICAgICAgICAgICAgdGhpcy5oZWFkZXJPZmZzZXRbc2lnbl0gPSBbZnRlbGwsIHRoaXMuZGF0YU9mZnNldCAtIDJdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcGFyc2UgZGF0YSBhY2NvcmRpbmdseQogICAgICAgICAgICBzd2l0Y2ggKHNpZ24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImZtdCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuY2hhbm5lbENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSA9IHAuZ2V0VWludDMyKGZ0ZWxsICsgNCkgJiAweDAwZmZmZmZmOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmJsb2NrQ291bnQgPSBwLmdldFVpbnQzMihmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmRyb3BwZWRIZWFkZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDEyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5kcm9wcGVkRm9vdGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxNCk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjb21wIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rYnBzID0gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlICogdGhpcy5ibG9ja1NpemUgLyAxMjgwMDAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWluUmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWF4UmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA3KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVHJhY2tDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyA9IHAuZ2V0VWludDgoZnRlbGwgKyA5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDExKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDEyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMSA9IHAuZ2V0VWludDgoZnRlbGwgKyAxNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMiA9IHAuZ2V0VWludDgoZnRlbGwgKyAxNSk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJkZWMiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmxvY2tTaXplID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmticHMgPSB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGUgKiB0aGlzLmJsb2NrU2l6ZSAvIDEyODAwMC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5NaW5SZXNvbHV0aW9uID0gcC5nZXRVaW50OChmdGVsbCArIDYpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5NYXhSZXNvbHV0aW9uID0gcC5nZXRVaW50OChmdGVsbCArIDcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA5KTsKICAgICAgICAgICAgICAgICAgICBsZXQgYSA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSBIQ0FVdGlsRnVuYy5HZXRIaWdoTmliYmxlKGEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5DaGFubmVsQ29uZmlnID0gSENBVXRpbEZ1bmMuR2V0TG93TmliYmxlKGEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjLkRlY1N0ZXJlb1R5cGUgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTEpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlYy5EZWNTdGVyZW9UeXBlID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDEyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidmJyIjoKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA4OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYXRoIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLlVzZUF0aEN1cnZlID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KSA9PSAxOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJsb29wIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3Auc3RhcnQgPSBwLmdldFVpbnQzMihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5lbmQgPSBwLmdldFVpbnQzMihmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29wLmRyb3BwZWRGb290ZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDE0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNpcGgiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicnZhIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLnJ2YSA9IHAuZ2V0RmxvYXQzMihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJ2YnIiOgogICAgICAgICAgICAgICAgICAgIHRoaXMudmJyLk1heEJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YnIuTm9pc2VMZXZlbCA9IHAuZ2V0SW50MTYoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNvbW0iOgogICAgICAgICAgICAgICAgICAgIGxldCBsZW4gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGppc2RlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoJ3NoaWZ0LWppcycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tbWVudCA9IGppc2RlY29kZXIuZGVjb2RlKGhjYS5zbGljZShmdGVsbCArIDUsIGZ0ZWxsICsgNSArIGxlbikpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIGhlYWRlciBzaWciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyByZWNvcmQgaGVhZGVyT2Zmc2V0CiAgICAgICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0W3NpZ25dID0gW2xhc3RGdGVsbCwgZnRlbGxdOwogICAgICAgICAgICAvLyBkbyBtb2RpZmljYXRpb24gaWYgbmVlZGVkCiAgICAgICAgICAgIGxldCBzZWN0aW9uRGF0YUxlbiA9IGZ0ZWxsIC0gbGFzdEZ0ZWxsIC0gNDsKICAgICAgICAgICAgbGV0IG5ld0RhdGEgPSBtb2RMaXN0W3NpZ25dOwogICAgICAgICAgICBpZiAobmV3RGF0YSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobmV3RGF0YS5ieXRlTGVuZ3RoID4gc2VjdGlvbkRhdGFMZW4pCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgICAgICBoY2Euc2V0KG5ld0RhdGEsIGxhc3RGdGVsbCArIDQpOwogICAgICAgICAgICAgICAgaGFzTW9kRG9uZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLyoKICAgICAgICAvLyAocG9ydGVkIGZyb20pIE55YWdhbW9uJ3Mgb3JpZ2luYWwgY29kZSwgc2hvdWxkIGJlIChhbG1vc3QpIGVxdWl2YWxlbnQgdG8gQ2FsY3VsYXRlSGZyVmFsdWVzCiAgICAgICAgdGhpcy5jb21wUGFyYW1bMl0gPSB0aGlzLmNvbXBQYXJhbVsyXSB8fCAxOwogICAgICAgIGxldCBfYSA9IHRoaXMuY29tcFBhcmFtWzRdIC0gdGhpcy5jb21wUGFyYW1bNV0gLSB0aGlzLmNvbXBQYXJhbVs2XTsKICAgICAgICBsZXQgX2IgPSB0aGlzLmNvbXBQYXJhbVs3XTsKICAgICAgICB0aGlzLmNvbXBEZWMuUmVzZXJ2ZWQxID0gX2IgPiAwID8gX2EgLyBfYiArIChfYSAlIF9iID8gMSA6IDApIDogMDsKICAgICAgICAvLyBUcmFuc2xhdGluZyB0aGUgYWJvdmUgY29kZSB3aXRoIG1lYW5pbmdmdWwgdmFyaWFibGUgbmFtZXM6CiAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSB0aGlzLmNvbXBEZWMuVHJhY2tDb3VudCB8fCAxOwogICAgICAgIHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCAtIHRoaXMuY29tcERlYy5TdGVyZW9CYW5kQ291bnQ7CiAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXA7CiAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMSA9IHRoaXMuSGZyR3JvdXBDb3VudCA+IDAgPyB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50IC8gdGhpcy5IZnJHcm91cENvdW50ICsgKHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgJSB0aGlzLkhmckdyb3VwQ291bnQgPyAxIDogMCkgOiAwOwogICAgICAgICovCiAgICAgICAgLy8gQ2FsY3VsYXRlSGZyVmFsdWVzLCBwb3J0ZWQgZnJvbSBWR0F1ZGlvCiAgICAgICAgaWYgKHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwID4gMCkgewogICAgICAgICAgICB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgICAgICB0aGlzLkhmckdyb3VwQ291bnQgPSBIQ0FVdGlsRnVuYy5EaXZpZGVCeVJvdW5kVXAodGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCwgdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXApOwogICAgICAgIH0KICAgICAgICAvLyBjYWxjdWxhdGUgc2FtcGxlIGNvdW50L29mZnNldHMKICAgICAgICB0aGlzLmZ1bGxTYW1wbGVDb3VudCA9IHRoaXMuZm9ybWF0LmJsb2NrQ291bnQgKiBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlID0gdGhpcy5mb3JtYXQuZHJvcHBlZEhlYWRlcjsKICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA9IHRoaXMuZnVsbFNhbXBsZUNvdW50IC0gdGhpcy5mb3JtYXQuZHJvcHBlZEZvb3RlcjsKICAgICAgICBpZiAodGhpcy5oYXNIZWFkZXJbImxvb3AiXSkgewogICAgICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlID0gdGhpcy5sb29wLnN0YXJ0ICogSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lICsgdGhpcy5sb29wLmRyb3BwZWRIZWFkZXI7CiAgICAgICAgICAgIHRoaXMubG9vcEVuZEF0U2FtcGxlID0gKHRoaXMubG9vcC5lbmQgKyAxKSAqIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSAtIHRoaXMubG9vcC5kcm9wcGVkRm9vdGVyOwogICAgICAgICAgICB0aGlzLmxvb3BTYW1wbGVDb3VudCA9IHRoaXMubG9vcEVuZEF0U2FtcGxlIC0gdGhpcy5sb29wU3RhcnRBdFNhbXBsZTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbmRBdFNhbXBsZSA9IHRoaXMuaGFzSGVhZGVyWyJsb29wIl0gPyB0aGlzLmxvb3BFbmRBdFNhbXBsZSA6IHRoaXMuZnVsbEVuZEF0U2FtcGxlOwogICAgICAgIHRoaXMuc2FtcGxlQ291bnQgPSB0aGlzLmVuZEF0U2FtcGxlIC0gdGhpcy5zdGFydEF0U2FtcGxlOwogICAgICAgIC8vIGNhbGN1bGF0ZSBmaWxlL2RhdGEgc2l6ZQogICAgICAgIHRoaXMuZGF0YVNpemUgPSB0aGlzLmJsb2NrU2l6ZSAqIHRoaXMuZm9ybWF0LmJsb2NrQ291bnQ7CiAgICAgICAgdGhpcy5mdWxsU2l6ZSA9IHRoaXMuZGF0YU9mZnNldCArIHRoaXMuZGF0YVNpemU7CiAgICAgICAgaWYgKGNoYW5nZU1hc2sgfHwgaGFzTW9kRG9uZSkgewogICAgICAgICAgICAvLyBmaXggY2hlY2tzdW0gaWYgcmVxdWVzdGVkCiAgICAgICAgICAgIEhDQUNyYzE2LmZpeChoY2EsIHRoaXMuZGF0YU9mZnNldCAtIDIpOwogICAgICAgIH0KICAgICAgICBsZXQgcmF3SGVhZGVyID0gaGNhLnNsaWNlKDAsIHRoaXMuZGF0YU9mZnNldCk7CiAgICAgICAgLy8gY2hlY2sgdmFsaWRpdHkgb2YgcGFyc2VkIHZhbHVlcwogICAgICAgIHRoaXMuY2hlY2tWYWxpZGl0eSgpOwogICAgICAgIHJldHVybiByYXdIZWFkZXI7CiAgICB9CiAgICBjaGVja1ZhbGlkaXR5KCkgewogICAgICAgIGNvbnN0IHJlc3VsdHMgPSBbCiAgICAgICAgICAgIHRoaXMuYmxvY2tTaXplID4gMCwKICAgICAgICAgICAgMCA8IHRoaXMuZm9ybWF0LmJsb2NrQ291bnQsCiAgICAgICAgICAgIDAgPD0gdGhpcy5zdGFydEF0U2FtcGxlLAogICAgICAgICAgICB0aGlzLnN0YXJ0QXRTYW1wbGUgPCB0aGlzLmZ1bGxFbmRBdFNhbXBsZSwKICAgICAgICAgICAgdGhpcy5mdWxsRW5kQXRTYW1wbGUgPD0gdGhpcy5mdWxsU2FtcGxlQ291bnQsCiAgICAgICAgXTsKICAgICAgICByZXN1bHRzLmZpbmQoKHJlc3VsdCwgaW5kZXgpID0+IHsKICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZGlkIG5vdCBwYXNzIG5vcm1hbCBjaGVjayBvbiBydWxlICR7aW5kZXh9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAodGhpcy5oYXNIZWFkZXJbImxvb3AiXSkgewogICAgICAgICAgICBjb25zdCBsb29wQ2hlY2tzID0gWwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlIDw9IHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlIDwgdGhpcy5sb29wRW5kQXRTYW1wbGUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA8PSB0aGlzLmZ1bGxFbmRBdFNhbXBsZSwKICAgICAgICAgICAgXTsKICAgICAgICAgICAgbG9vcENoZWNrcy5maW5kKChyZXN1bHQsIGluZGV4KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZGlkIG5vdCBwYXNzIGxvb3AgY2hlY2sgb24gcnVsZSAke2luZGV4fWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBnZXRSYXdIZWFkZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmF3SGVhZGVyLnNsaWNlKDApOwogICAgfQogICAgaXNIZWFkZXJDaGFuZ2VkKGhjYSkgewogICAgICAgIGlmIChoY2EubGVuZ3RoID49IHRoaXMucmF3SGVhZGVyLmxlbmd0aCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmF3SGVhZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaGNhW2ldICE9IHRoaXMucmF3SGVhZGVyW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBtb2RpZnkoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICAvLyByZXBhcnNlIGhlYWRlciBpZiBuZWVkZWQKICAgICAgICBpZiAodGhpcy5pc0hlYWRlckNoYW5nZWQoaGNhKSkgewogICAgICAgICAgICB0aGlzLnBhcnNlSGVhZGVyKGhjYSwgZmFsc2UsIGZhbHNlLCB7fSk7CiAgICAgICAgfQogICAgICAgIC8vIHByZXBhcmUgdG8gbW9kaWZ5IGRhdGEgaW4tcGxhY2UKICAgICAgICBsZXQgbW9kTGlzdCA9IHt9OwogICAgICAgIG1vZExpc3Rbc2lnXSA9IG5ld0RhdGE7CiAgICAgICAgbGV0IGVuY3J5cHQgPSB0aGlzLmNpcGhlciAhPSAwOwogICAgICAgIGlmIChzaWcgPT09ICJjaXBoIikgewogICAgICAgICAgICBlbmNyeXB0ID0gbmV3IERhdGFWaWV3KG5ld0RhdGEuYnVmZmVyLCBuZXdEYXRhLmJ5dGVPZmZzZXQsIG5ld0RhdGEuYnl0ZUxlbmd0aCkuZ2V0VWludDE2KDApICE9IDA7CiAgICAgICAgfQogICAgICAgIC8vIGRvIGFjdHVhbCBtb2RpZmljYXRpb24gJiBjaGVjayB2YWxpZGl0eQogICAgICAgIHRoaXMucmF3SGVhZGVyID0gdGhpcy5wYXJzZUhlYWRlcihoY2EsIHRydWUsIGVuY3J5cHQsIG1vZExpc3QpOwogICAgfQogICAgc3RhdGljIGFkZEhlYWRlcihoY2EsIHNpZywgbmV3RGF0YSkgewogICAgICAgIC8vIHNpZyBtdXN0IGNvbnNpc3Qgb2YgMS00IEFTQ0lJIGNoYXJhY3RlcnMKICAgICAgICBpZiAoc2lnLmxlbmd0aCA8IDEgfHwgc2lnLmxlbmd0aCA+IDQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBuZXdTaWcgPSBuZXcgVWludDhBcnJheSg0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgICBsZXQgYyA9IHNpZy5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBpZiAoYyA+PSAweDgwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIG5ld1NpZ1tpXSA9IGM7CiAgICAgICAgfQogICAgICAgIC8vIHBhcnNlIGhlYWRlciAmIGNoZWNrIHZhbGlkdHkKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7CiAgICAgICAgLy8gY2hlY2sgd2hldGhlciBzcGVjaWZpZWQgaGVhZGVyIHNlY3Rpb24gYWxyZWFkeSBleGlzdHMKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbc2lnXSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBoZWFkZXIgc2VjdGlvbiAke3NpZ30gYWxyZWFkeSBleGlzdHNgKTsKICAgICAgICAvLyBwcmVwYXJlIGEgbmV3bHkgYWxsb2NhdGVkIGJ1ZmZlcgogICAgICAgIGxldCBuZXdIY2EgPSBuZXcgVWludDhBcnJheShoY2EuYnl0ZUxlbmd0aCArIG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoKTsKICAgICAgICBsZXQgaW5zZXJ0T2Zmc2V0ID0gaW5mby5oZWFkZXJPZmZzZXRbInBhZCJdWzBdOwogICAgICAgIC8vIGNvcHkgZXhpc3RpbmcgaGVhZGVycyAoZXhjZXB0IHBhZGRpbmcpCiAgICAgICAgbmV3SGNhLnNldChoY2Euc3ViYXJyYXkoMCwgaW5zZXJ0T2Zmc2V0KSwgMCk7CiAgICAgICAgLy8gY29weSBpbnNlcnRlZCBoZWFkZXIKICAgICAgICBuZXdIY2Euc2V0KG5ld1NpZywgaW5zZXJ0T2Zmc2V0KTsKICAgICAgICBuZXdIY2Euc2V0KG5ld0RhdGEsIGluc2VydE9mZnNldCArIG5ld1NpZy5ieXRlTGVuZ3RoKTsKICAgICAgICAvLyBjb3B5IHJlbWFpbmluZyBkYXRhIChwYWRkaW5nIGFuZCBibG9ja3MpCiAgICAgICAgbmV3SGNhLnNldChoY2Euc3ViYXJyYXkoaW5zZXJ0T2Zmc2V0LCBoY2EuYnl0ZUxlbmd0aCksIGluc2VydE9mZnNldCArIG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoKTsKICAgICAgICAvLyB1cGRhdGUgZGF0YU9mZnNldAogICAgICAgIGluZm8uZGF0YU9mZnNldCArPSBuZXdTaWcuYnl0ZUxlbmd0aCArIG5ld0RhdGEuYnl0ZUxlbmd0aDsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhuZXdIY2EuYnVmZmVyLCBuZXdIY2EuYnl0ZU9mZnNldCwgbmV3SGNhLmJ5dGVMZW5ndGgpOwogICAgICAgIHAuc2V0SW50MTYoNiwgaW5mby5kYXRhT2Zmc2V0KTsKICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICBIQ0FDcmMxNi5maXgobmV3SGNhLCBpbmZvLmRhdGFPZmZzZXQgLSAyKTsKICAgICAgICAvLyByZXBhcnNlIGhlYWRlciAmIHJlY2hlY2sgdmFsaWR0eQogICAgICAgIGluZm8gPSBuZXcgSENBSW5mbyhuZXdIY2EpOwogICAgICAgIHJldHVybiBuZXdIY2E7CiAgICB9CiAgICBzdGF0aWMgYWRkQ2lwaGVySGVhZGVyKGhjYSwgY2lwaGVyVHlwZSkgewogICAgICAgIGxldCBuZXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgaWYgKGNpcGhlclR5cGUgIT0gbnVsbCkKICAgICAgICAgICAgbmV3IERhdGFWaWV3KG5ld0RhdGEuYnVmZmVyKS5zZXRVaW50MTYoMCwgY2lwaGVyVHlwZSk7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkSGVhZGVyKGhjYSwgImNpcGgiLCBuZXdEYXRhKTsKICAgIH0KICAgIHN0YXRpYyBmaXhIZWFkZXJDaGVja3N1bShoY2EpIHsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhoY2EuYnVmZmVyLCBoY2EuYnl0ZU9mZnNldCwgOCk7CiAgICAgICAgbGV0IGhlYWQgPSB0aGlzLmdldFNpZ24ocCwgMCwgZmFsc2UsIGZhbHNlKTsKICAgICAgICBpZiAoaGVhZCAhPT0gIkhDQSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgYSBIQ0EgZmlsZSIpOwogICAgICAgIH0KICAgICAgICBsZXQgZGF0YU9mZnNldCA9IHAuZ2V0VWludDE2KDYpOwogICAgICAgIEhDQUNyYzE2LmZpeChoY2EsIGRhdGFPZmZzZXQgLSAyKTsKICAgICAgICByZXR1cm4gaGNhOwogICAgfQogICAgY2FsY0luV2F2U2l6ZShtb2RlID0gMzIpIHsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBsZXQgYml0c1BlclNhbXBsZSA9IG1vZGUgPT0gMCA/IDMyIDogbW9kZTsKICAgICAgICBsZXQgc2FtcGxlU2l6ZUluV2F2ID0gdGhpcy5mb3JtYXQuY2hhbm5lbENvdW50ICogYml0c1BlclNhbXBsZSAvIDg7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5XYXZTaXplID0gewogICAgICAgICAgICBiaXRzUGVyU2FtcGxlOiBiaXRzUGVyU2FtcGxlLAogICAgICAgICAgICBzYW1wbGU6IHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgYmxvY2s6IEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgZHJvcHBlZDogewogICAgICAgICAgICAgICAgaGVhZGVyOiB0aGlzLmZvcm1hdC5kcm9wcGVkSGVhZGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgZm9vdGVyOiB0aGlzLmZvcm1hdC5kcm9wcGVkRm9vdGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICB9LAogICAgICAgICAgICBsb29wOiB0aGlzLmhhc0hlYWRlclsibG9vcCJdID8gewogICAgICAgICAgICAgICAgbG9vcFBhcnQ6ICh0aGlzLmxvb3BFbmRBdFNhbXBsZSAtIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUpICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgZHJvcHBlZDogewogICAgICAgICAgICAgICAgICAgIGhlYWRlcjogdGhpcy5sb29wLmRyb3BwZWRIZWFkZXIgKiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgICAgICAgICAgZm9vdGVyOiB0aGlzLmxvb3AuZHJvcHBlZEZvb3RlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSA6IHVuZGVmaW5lZCwKICAgICAgICB9OwogICAgfQp9CmNsYXNzIEhDQVV0aWxGdW5jIHsKICAgIHN0YXRpYyBEaXZpZGVCeVJvdW5kVXAodmFsdWUsIGRpdmlzb3IpIHsKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHZhbHVlIC8gZGl2aXNvcik7CiAgICB9CiAgICBzdGF0aWMgR2V0SGlnaE5pYmJsZSh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICh2YWx1ZSA8IC0weDgwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gKHZhbHVlID4+PiA0KSAmIDB4RjsKICAgIH0KICAgIHN0YXRpYyBHZXRMb3dOaWJibGUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgcmV0dXJuIHZhbHVlICYgMHhGOwogICAgfQogICAgc3RhdGljIEdldEhpZ2hOaWJibGVTaWduZWQodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuU2lnbmVkTmliYmxlc1sodmFsdWUgPj4+IDQpICYgMHhGXTsKICAgIH0KICAgIHN0YXRpYyBHZXRMb3dOaWJibGVTaWduZWQodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuU2lnbmVkTmliYmxlc1t2YWx1ZSAmIDB4Rl07CiAgICB9CiAgICBzdGF0aWMgQ29tYmluZU5pYmJsZXMoaGlnaCwgbG93KSB7CiAgICAgICAgcmV0dXJuICgoaGlnaCA8PCA0KSB8IChsb3cgJiAweEYpKSAmIDB4RkY7CiAgICB9CiAgICBzdGF0aWMgR2V0TmV4dE11bHRpcGxlKHZhbHVlLCBtdWx0aXBsZSkgewogICAgICAgIGlmIChtdWx0aXBsZSA8PSAwKQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlICUgbXVsdGlwbGUgPT0gMCkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIHJldHVybiB2YWx1ZSArIG11bHRpcGxlIC0gdmFsdWUgJSBtdWx0aXBsZTsKICAgIH0KICAgIHN0YXRpYyBTaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmZmZmZmZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MDAwMDAwMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhhYWFhYWFhYSkgPj4+IDEpIHwgKCh2YWx1ZSAmIDB4NTU1NTU1NTUpIDw8IDEpOwogICAgICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4Y2NjY2NjY2MpID4+PiAyKSB8ICgodmFsdWUgJiAweDMzMzMzMzMzKSA8PCAyKTsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGYwZjBmMGYwKSA+Pj4gNCkgfCAoKHZhbHVlICYgMHgwZjBmMGYwZikgPDwgNCk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhmZjAwZmYwMCkgPj4+IDgpIHwgKCh2YWx1ZSAmIDB4MDBmZjAwZmYpIDw8IDgpOwogICAgICAgIHJldHVybiAoKHZhbHVlICYgMHhmZmZmMDAwMCkgPj4+IDE2KSB8ICgodmFsdWUgJiAweDAwMDBmZmZmKSA8PCAxNik7CiAgICB9CiAgICBzdGF0aWMgVW5zaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5TaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpID4+PiAwOwogICAgfQogICAgc3RhdGljIFVuc2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5zaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpID4+PiAoMzIgLSBiaXRDb3VudCk7CiAgICB9CiAgICBzdGF0aWMgU2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5zaWduZWRCaXRSZXZlcnNlMzJUcnVuYyh2YWx1ZSA+Pj4gMCwgYml0Q291bnQpOwogICAgfQogICAgc3RhdGljIEJpdFJldmVyc2U4KHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gMHhmZikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgaWYgKHZhbHVlIDwgLTB4ODApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIHZhbHVlID4+Pj0gMDsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGFhKSA+Pj4gMSkgfCAoKHZhbHVlICYgMHg1NSkgPDwgMSk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhjYykgPj4+IDIpIHwgKCh2YWx1ZSAmIDB4MzMpIDw8IDIpOwogICAgICAgIHJldHVybiAoKCh2YWx1ZSAmIDB4ZjApID4+PiA0KSB8ICgodmFsdWUgJiAweDBmKSA8PCA0KSkgPj4+IDA7CiAgICB9CiAgICBzdGF0aWMgQ2xhbXAodmFsdWUsIG1pbiwgbWF4KSB7CiAgICAgICAgaWYgKHZhbHVlIDwgbWluKQogICAgICAgICAgICByZXR1cm4gbWluOwogICAgICAgIGlmICh2YWx1ZSA+IG1heCkKICAgICAgICAgICAgcmV0dXJuIG1heDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgRGVidWdBc3NlcnQoY29uZGl0aW9uKSB7CiAgICAgICAgaWYgKCFjb25kaXRpb24pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRGVidWdBc3NlcnQgZmFpbGVkIik7CiAgICB9Cn0KSENBVXRpbEZ1bmMuU2lnbmVkTmliYmxlcyA9IFswLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCAtOCwgLTcsIC02LCAtNSwgLTQsIC0zLCAtMiwgLTFdOwpjbGFzcyBIQ0EgewogICAgY29uc3RydWN0b3IoKSB7CiAgICB9CiAgICBzdGF0aWMgZGVjcnlwdChoY2EsIGtleTEsIGtleTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWNyeXB0T3JFbmNyeXB0KGhjYSwgZmFsc2UsIGtleTEsIGtleTIpOwogICAgfQogICAgc3RhdGljIGVuY3J5cHQoaGNhLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjcnlwdE9yRW5jcnlwdChoY2EsIHRydWUsIGtleTEsIGtleTIpOwogICAgfQogICAgc3RhdGljIGRlY3J5cHRPckVuY3J5cHQoaGNhLCBlbmNyeXB0LCBrZXkxLCBrZXkyKSB7CiAgICAgICAgLy8gaW4tcGxhY2UgZGVjcnlwdGlvbi9lbmNyeXB0aW9uCiAgICAgICAgLy8gcGFyc2UgaGVhZGVyCiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOyAvLyB0aHJvd3MgIk5vdCBhIEhDQSBmaWxlIiBpZiBtaXNtYXRjaAogICAgICAgIGlmICghZW5jcnlwdCAmJiAhaW5mby5oYXNIZWFkZXJbImNpcGgiXSkgewogICAgICAgICAgICByZXR1cm4gaGNhOyAvLyBub3QgZW5jcnlwdGVkCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGVuY3J5cHQgJiYgIWluZm8uaGFzSGVhZGVyWyJjaXBoIl0pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnB1dCBoY2EgbGFja3MgXCJjaXBoXCIgaGVhZGVyIHNlY3Rpb24uIFBsZWFzZSBjYWxsIEhDQUluZm8uYWRkQ2lwaGVySGVhZGVyKGhjYSkgZmlyc3QuIik7CiAgICAgICAgfQogICAgICAgIGxldCBjaXBoZXI7CiAgICAgICAgc3dpdGNoIChpbmZvLmNpcGhlcikgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAvLyBub3QgZW5jcnlwdGVkCiAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdCkKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKGtleTEsIGtleTIpLmludmVydFRhYmxlKCk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhjYTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAvLyBlbmNyeXB0ZWQgd2l0aCAibm8ga2V5IgogICAgICAgICAgICAgICAgaWYgKGVuY3J5cHQpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhbHJlYWR5IGVuY3J5cHRlZCB3aXRoIFwibm8ga2V5XCIsIHBsZWFzZSBkZWNyeXB0IGZpcnN0Iik7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgY2lwaGVyID0gbmV3IEhDQUNpcGhlcigibm9uZSIpOyAvLyBpZ25vcmUgZ2l2ZW4ga2V5cwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMHgzODoKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoIGtleXMgLSB3aWxsIHlpZWxkIGluY29ycmVjdCB3YXZlZm9ybSBpZiBpbmNvcnJlY3Qga2V5cyBhcmUgZ2l2ZW4hCiAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgZW5jcnlwdGVkIHdpdGggc3BlY2lmaWMga2V5cywgcGxlYXNlIGRlY3J5cHQgd2l0aCBjb3JyZWN0IGtleXMgZmlyc3QiKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKGtleTEsIGtleTIpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gY2lwaC50eXBlIik7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby5mb3JtYXQuYmxvY2tDb3VudDsgKytpKSB7CiAgICAgICAgICAgIGxldCBmdGVsbCA9IGluZm8uZGF0YU9mZnNldCArIGluZm8uYmxvY2tTaXplICogaTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KGZ0ZWxsLCBmdGVsbCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgLy8gdmVyaWZ5IGJsb2NrIGNoZWNrc3VtCiAgICAgICAgICAgIEhDQUNyYzE2LnZlcmlmeShibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgLy8gZGVjcnlwdC9lbmNyeXB0IGJsb2NrCiAgICAgICAgICAgIGNpcGhlci5tYXNrKGJsb2NrLCAwLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICAgICAgSENBQ3JjMTYuZml4KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIH0KICAgICAgICAvLyByZS0odW4pbWFzayBoZWFkZXJzLCBhbmQgc2V0IGNpcGggaGVhZGVyIHRvIG5ldyB2YWx1ZQogICAgICAgIGxldCBuZXdDaXBoZXJEYXRhID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgbGV0IG5ld0NpcGhlclR5cGUgPSBlbmNyeXB0ID8gY2lwaGVyLmdldFR5cGUoKSA6IDA7CiAgICAgICAgbmV3IERhdGFWaWV3KG5ld0NpcGhlckRhdGEuYnVmZmVyKS5zZXRVaW50MTYoMCwgbmV3Q2lwaGVyVHlwZSk7CiAgICAgICAgaW5mby5tb2RpZnkoaGNhLCAiY2lwaCIsIG5ld0NpcGhlckRhdGEpOwogICAgICAgIHJldHVybiBoY2E7CiAgICB9CiAgICBzdGF0aWMgZGVjb2RlKGhjYSwgbW9kZSA9IDMyLCBsb29wID0gMCwgdm9sdW1lID0gMS4wKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgaWYgKHZvbHVtZSA+IDEpCiAgICAgICAgICAgIHZvbHVtZSA9IDE7CiAgICAgICAgZWxzZSBpZiAodm9sdW1lIDwgMCkKICAgICAgICAgICAgdm9sdW1lID0gMDsKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7IC8vIHRocm93cyAiTm90IGEgSENBIGZpbGUiIGlmIG1pc21hdGNoCiAgICAgICAgbGV0IGZyYW1lID0gbmV3IEhDQUZyYW1lKGluZm8pOwogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlclsiY2lwaCJdICYmIGluZm8uY2lwaGVyICE9IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJIQ0EgaXMgZW5jcnlwdGVkLCBwbGVhc2UgZGVjcnlwdCBpdCBmaXJzdCBiZWZvcmUgZGVjb2RpbmciKTsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSBvdXRwdXQgV0FWIGZpbGUKICAgICAgICBjb25zdCBvdXRwdXRXYXYgPSBuZXcgSENBV2F2KGluZm8sIG1vZGUsIGxvb3ApOwogICAgICAgIGNvbnN0IGZpbGVCdWYgPSBvdXRwdXRXYXYuZmlsZUJ1ZjsKICAgICAgICBjb25zdCBkYXRhUGFydCA9IG91dHB1dFdhdi5kYXRhUGFydDsKICAgICAgICAvLyBjYWxjdWxhdGUgaW4tV0FWIHNpemUKICAgICAgICBsZXQgaW5XYXZTaXplID0gaW5mby5jYWxjSW5XYXZTaXplKG1vZGUpOwogICAgICAgIC8vIGRlY29kZSBibG9ja3MgKGZyYW1lcykKICAgICAgICBmb3IgKGxldCBpID0gMCwgb2Zmc2V0ID0gMDsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgbGFzdERlY29kZWRTYW1wbGVzID0gaSAqIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgbGV0IGN1cnJlbnREZWNvZGVkU2FtcGxlcyA9IGxhc3REZWNvZGVkU2FtcGxlcyArIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnREZWNvZGVkU2FtcGxlcyA8PSBpbmZvLnN0YXJ0QXRTYW1wbGUgfHwgbGFzdERlY29kZWRTYW1wbGVzID49IGluZm8uZW5kQXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBzdGFydE9mZnNldCA9IGluZm8uZGF0YU9mZnNldCArIGluZm8uYmxvY2tTaXplICogaTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KHN0YXJ0T2Zmc2V0LCBzdGFydE9mZnNldCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgdGhpcy5kZWNvZGVCbG9jayhmcmFtZSwgYmxvY2spOwogICAgICAgICAgICBsZXQgd2F2ZWJ1ZmY7CiAgICAgICAgICAgIGlmIChsYXN0RGVjb2RlZFNhbXBsZXMgPCBpbmZvLnN0YXJ0QXRTYW1wbGUgfHwgY3VycmVudERlY29kZWRTYW1wbGVzID4gaW5mby5lbmRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgLy8gY3Jvc3Npbmcgc3RhcnRBdFNhbXBsZS9lbmRBdFNhbXBsZSwgc2tpcC9kcm9wIHNwZWNpZmllZCBieXRlcwogICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB0aGlzLndyaXRlVG9QQ00oZnJhbWUsIG1vZGUsIHZvbHVtZSk7CiAgICAgICAgICAgICAgICBpZiAobGFzdERlY29kZWRTYW1wbGVzIDwgaW5mby5zdGFydEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHNraXBwZWRTaXplID0gKGluZm8uc3RhcnRBdFNhbXBsZSAtIGxhc3REZWNvZGVkU2FtcGxlcykgKiBpbldhdlNpemUuc2FtcGxlOwogICAgICAgICAgICAgICAgICAgIHdhdmVidWZmID0gd2F2ZWJ1ZmYuc3ViYXJyYXkoc2tpcHBlZFNpemUsIGluV2F2U2l6ZS5ibG9jayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50RGVjb2RlZFNhbXBsZXMgPiBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHdyaXRlU2l6ZSA9IChpbmZvLmVuZEF0U2FtcGxlIC0gbGFzdERlY29kZWRTYW1wbGVzKSAqIGluV2F2U2l6ZS5zYW1wbGU7CiAgICAgICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB3YXZlYnVmZi5zdWJhcnJheSgwLCB3cml0ZVNpemUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJzaG91bGQgbmV2ZXIgZ28gaGVyZSIpOwogICAgICAgICAgICAgICAgZGF0YVBhcnQuc2V0KHdhdmVidWZmLCBvZmZzZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB0aGlzLndyaXRlVG9QQ00oZnJhbWUsIG1vZGUsIHZvbHVtZSwgZGF0YVBhcnQsIG9mZnNldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2Zmc2V0ICs9IHdhdmVidWZmLmJ5dGVMZW5ndGg7CiAgICAgICAgfQogICAgICAgIC8vIGRlY29kaW5nIGRvbmUsIHRoZW4ganVzdCBjb3B5IGxvb3BpbmcgcGFydAogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlclsibG9vcCJdICYmIGxvb3ApIHsKICAgICAgICAgICAgLy8gInRhaWwiIGJleW9uZCBsb29wIGVuZCBpcyBkcm9wcGVkCiAgICAgICAgICAgIC8vIGNvcHkgbG9vcGluZyBhdWRpbyBjbGlwcwogICAgICAgICAgICBpZiAoaW5XYXZTaXplLmxvb3AgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICBsZXQgcHJlTG9vcFNpemVJbldhdiA9IGluV2F2U2l6ZS5zYW1wbGUgKiAoaW5mby5sb29wU3RhcnRBdFNhbXBsZSAtIGluZm8uc3RhcnRBdFNhbXBsZSk7CiAgICAgICAgICAgIGxldCBzcmMgPSBkYXRhUGFydC5zdWJhcnJheShwcmVMb29wU2l6ZUluV2F2LCBwcmVMb29wU2l6ZUluV2F2ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgc3RhcnQgPSBwcmVMb29wU2l6ZUluV2F2ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQ7IGkgPCBsb29wOyBpKyspIHsKICAgICAgICAgICAgICAgIGxldCBkc3QgPSBkYXRhUGFydC5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBpbldhdlNpemUubG9vcC5sb29wUGFydCk7CiAgICAgICAgICAgICAgICBkc3Quc2V0KHNyYyk7CiAgICAgICAgICAgICAgICBzdGFydCArPSBpbldhdlNpemUubG9vcC5sb29wUGFydDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsZUJ1ZjsKICAgIH0KICAgIHN0YXRpYyBkZWNvZGVCbG9jayhmcmFtZSwgYmxvY2spIHsKICAgICAgICBsZXQgaW5mbyA9IGZyYW1lLkhjYTsKICAgICAgICBpZiAoYmxvY2suYnl0ZUxlbmd0aCAhPSBpbmZvLmJsb2NrU2l6ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgLy8gdmVyaWZ5IGNoZWNrc3VtCiAgICAgICAgSENBQ3JjMTYudmVyaWZ5KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIC8vIGRlY29kZQogICAgICAgIEhDQURlY29kZXIuRGVjb2RlRnJhbWUoYmxvY2ssIGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyB3cml0ZVRvUENNKGZyYW1lLCBtb2RlID0gMzIsIHZvbHVtZSA9IDEuMCwgd3JpdGVyLCBmdGVsbCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmICh2b2x1bWUgPiAxKQogICAgICAgICAgICB2b2x1bWUgPSAxOwogICAgICAgIGVsc2UgaWYgKHZvbHVtZSA8IDApCiAgICAgICAgICAgIHZvbHVtZSA9IDA7CiAgICAgICAgLy8gY3JlYXRlIG5ldyB3cml0ZXIgaWYgbm90IHNwZWNpZmllZAogICAgICAgIGxldCBpbmZvID0gZnJhbWUuSGNhOwogICAgICAgIGlmICh3cml0ZXIgPT0gbnVsbCkgewogICAgICAgICAgICB3cml0ZXIgPSBuZXcgVWludDhBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWUgKiBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQgKiAobW9kZSA9PSAwID8gMzIgOiBtb2RlKSAvIDgpOwogICAgICAgICAgICBpZiAoZnRlbGwgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZnRlbGwgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoZnRlbGwgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIH0KICAgICAgICAvLyB3cml0ZSBkZWNvZGVkIGRhdGEgaW50byB3cml0ZXIKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyh3cml0ZXIuYnVmZmVyLCB3cml0ZXIuYnl0ZU9mZnNldCwgd3JpdGVyLmJ5dGVMZW5ndGgpOwogICAgICAgIGxldCBmdGVsbEJlZ2luID0gZnRlbGw7CiAgICAgICAgZm9yIChsZXQgc2YgPSAwOyBzZiA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBzZisrKSB7CiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lOyBzKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZiA9IGZyYW1lLkNoYW5uZWxzW2NdLlBjbUZsb2F0W3NmXVtzXSAqIHZvbHVtZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZiA+IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGYgPSAxOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGYgPCAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgZiA9IC0xOwogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtdXN0IGJlIHVuc2lnbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldFVpbnQ4KGZ0ZWxsLCBmICogMHg3RiArIDB4ODApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm9yIGFib3ZlIDgtYml0IGludGVnZXIsIGxpdHRsZS1lbmRpYW4gc2lnbmVkIGludGVnZXIgaXMgdXNlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKHNldFVpbnQxNi9zZXRJbnQxNiBhY3R1YWxseSBkb2Vzbid0IHNlZW0gdG8gbWFrZSBhbnkgZGlmZmVyZW5jZSBoZXJlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRJbnQxNihmdGVsbCwgZiAqIDB4N0ZGRiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVyZSdzIG5vIHNldEludDI0LCB3cml0ZSAzIGJ5dGVzIHdpdGggc2V0VWludDggcmVzcGVjdGl2ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmICo9IDB4N0ZGRkZGOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCwgZiAmIDB4RkYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCArIDEsIGYgPj4gOCAmIDB4RkYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCArIDIsIGYgPj4gMTYgJiAweEZGKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0SW50MzIoZnRlbGwsIGYgKiAweDdGRkZGRkZGLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmxvYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0RmxvYXQzMihmdGVsbCwgZiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gbW9kZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gd3JpdGVyLnN1YmFycmF5KGZ0ZWxsQmVnaW4sIGZ0ZWxsKTsKICAgIH0KICAgIHN0YXRpYyBmaXhDaGVja3N1bShoY2EpIHsKICAgICAgICBIQ0FJbmZvLmZpeEhlYWRlckNoZWNrc3VtKGhjYSk7CiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby5mb3JtYXQuYmxvY2tDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGxldCBmdGVsbCA9IGluZm8uZGF0YU9mZnNldCArIGkgKiBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KGZ0ZWxsLCBmdGVsbCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgSENBQ3JjMTYuZml4KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaGNhOwogICAgfQp9CmNsYXNzIEhDQVdhdiB7CiAgICBjb25zdHJ1Y3RvcihpbmZvLCBtb2RlID0gMzIsIGxvb3AgPSAwKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTmFOKGxvb3ApKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImxvb3AgaXMgbm90IG51bWJlciIpOwogICAgICAgIGxvb3AgPSBNYXRoLmZsb29yKGxvb3ApOwogICAgICAgIGlmIChsb29wIDwgMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICBsZXQgZGF0YVNpemUgPSBpbldhdlNpemUuc2FtcGxlICogaW5mby5zYW1wbGVDb3VudDsKICAgICAgICBpZiAobG9vcCA+IDApIHsKICAgICAgICAgICAgaWYgKGluV2F2U2l6ZS5sb29wID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgZGF0YVNpemUgKz0gaW5XYXZTaXplLmxvb3AubG9vcFBhcnQgKiBsb29wOwogICAgICAgIH0KICAgICAgICAvLyBwcmVwYXJlIG1ldGFkYXRhIGNodW5rcyBhbmQgZGF0YSBjaHVuayBoZWFkZXIKICAgICAgICB0aGlzLmZtdCA9IG5ldyBIQ0FXYXZGbXRDaHVuayhpbmZvLCBtb2RlKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImNvbW0iXSkKICAgICAgICAgICAgdGhpcy5ub3RlID0gbmV3IEhDQVdhdkNvbW1lbnRDaHVuayhpbmZvKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImxvb3AiXSkKICAgICAgICAgICAgdGhpcy5zbXBsID0gbmV3IEhDQVdhdmVTbXBsQ2h1bmsoaW5mbyk7CiAgICAgICAgdGhpcy53YXZlUmlmZiA9IG5ldyBIQ0FXYXZXYXZlUmlmZkhlYWRlcig4ICsgdGhpcy5mbXQuc2l6ZQogICAgICAgICAgICArICh0aGlzLm5vdGUgPT0gbnVsbCA/IDAgOiA4ICsgdGhpcy5ub3RlLnNpemUpCiAgICAgICAgICAgICsgOCArIGRhdGFTaXplCiAgICAgICAgICAgICsgKHRoaXMuc21wbCA9PSBudWxsID8gMCA6IDggKyB0aGlzLnNtcGwuc2l6ZSkpOwogICAgICAgIC8vIGdldCBieXRlcyBvZiBwcmVwYXJlZCBjaHVua3MKICAgICAgICBsZXQgd2F2ZVJpZmZIZWFkZXIgPSB0aGlzLndhdmVSaWZmLmdldCgpOwogICAgICAgIGxldCBmbXRDaHVuayA9IHRoaXMuZm10LmdldCgpOwogICAgICAgIGxldCBub3RlQ2h1bmsgPSB0aGlzLm5vdGUgIT0gbnVsbCA/IHRoaXMubm90ZS5nZXQoKSA6IG5ldyBVaW50OEFycmF5KDApOwogICAgICAgIGxldCBkYXRhQ2h1bmtIZWFkZXIgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgICBkYXRhQ2h1bmtIZWFkZXIuc2V0KG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZSgiZGF0YSIpKTsKICAgICAgICBuZXcgRGF0YVZpZXcoZGF0YUNodW5rSGVhZGVyLmJ1ZmZlcikuc2V0VWludDMyKDQsIGRhdGFTaXplLCB0cnVlKTsKICAgICAgICBsZXQgc21wbENodW5rID0gdGhpcy5zbXBsICE9IG51bGwgPyB0aGlzLnNtcGwuZ2V0KCkgOiBuZXcgVWludDhBcnJheSgwKTsKICAgICAgICAvLyBjcmVhdGUgd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICB0aGlzLmZpbGVCdWYgPSBuZXcgVWludDhBcnJheSg4ICsgdGhpcy53YXZlUmlmZi5zaXplKTsKICAgICAgICAvLyBjb3B5IHByZXBhcmVkIG1ldGFkYXRhIGNodW5rcyBhbmQgZGF0YSBjaHVuayBoZWFkZXIgdG8gd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICBsZXQgd3JpdHRlbkxlbmd0aCA9IDA7CiAgICAgICAgW3dhdmVSaWZmSGVhZGVyLCBmbXRDaHVuaywgbm90ZUNodW5rLCBkYXRhQ2h1bmtIZWFkZXJdLmZvckVhY2goKGNodW5rKSA9PiB7CiAgICAgICAgICAgIHRoaXMuZmlsZUJ1Zi5zZXQoY2h1bmssIHdyaXR0ZW5MZW5ndGgpOwogICAgICAgICAgICB3cml0dGVuTGVuZ3RoICs9IGNodW5rLmJ5dGVMZW5ndGg7CiAgICAgICAgfSk7CiAgICAgICAgLy8gc2tpcCBkYXRhUGFydCBzaW5jZSBpdCdzIGVtcHR5CiAgICAgICAgdGhpcy5kYXRhUGFydCA9IHRoaXMuZmlsZUJ1Zi5zdWJhcnJheSh3cml0dGVuTGVuZ3RoLCB3cml0dGVuTGVuZ3RoICsgZGF0YVNpemUpOwogICAgICAgIHdyaXR0ZW5MZW5ndGggKz0gZGF0YVNpemU7CiAgICAgICAgLy8gY29weSB0aGUgbGFzdCBwcmVwYXJlZCBjaHVuayB0byB3aG9sZS1maWxlIGJ1ZmZlcgogICAgICAgIHRoaXMuZmlsZUJ1Zi5zZXQoc21wbENodW5rLCB3cml0dGVuTGVuZ3RoKTsKICAgICAgICB3cml0dGVuTGVuZ3RoICs9IHNtcGxDaHVuay5ieXRlTGVuZ3RoOwogICAgICAgIGlmICh3cml0dGVuTGVuZ3RoICE9IHRoaXMuZmlsZUJ1Zi5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0KfQpjbGFzcyBIQ0FXYXZXYXZlUmlmZkhlYWRlciB7CiAgICBjb25zdHJ1Y3RvcihzaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKHNpemUpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNpemUgbXVzdCBiZSBudW1iZXIiKTsKICAgICAgICBzaXplID0gTWF0aC5mbG9vcihzaXplKTsKICAgICAgICBpZiAoc2l6ZSA8PSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB0aGlzLnNpemUgPSA0ICsgc2l6ZTsgLy8gIldBVkUiICsgcmVtYWluaW5nIHBhcnQKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDEyKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJSSUZGIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoIldBVkUiKSwgOCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FXYXZGbXRDaHVuayB7CiAgICBjb25zdHJ1Y3RvcihpbmZvLCBtb2RlID0gMzIpIHsKICAgICAgICB0aGlzLnNpemUgPSAxNjsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBsZXQgaW5XYXZTaXplID0gaW5mby5jYWxjSW5XYXZTaXplKG1vZGUpOwogICAgICAgIHRoaXMuZm9ybWF0VGFnID0gbW9kZSA+IDAgPyAxIDogMzsKICAgICAgICB0aGlzLmNoYW5uZWxDb3VudCA9IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudDsKICAgICAgICB0aGlzLnNhbXBsZXNQZXJTZWMgPSBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5ieXRlc1BlclNlYyA9IGluV2F2U2l6ZS5zYW1wbGUgKiBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5ibG9ja0FsaWduID0gaW5XYXZTaXplLnNhbXBsZTsKICAgICAgICB0aGlzLmJpdHNQZXJTYW1wbGUgPSBpbldhdlNpemUuYml0c1BlclNhbXBsZTsKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDggKyB0aGlzLnNpemUpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoImZtdCAiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQxNig4LCB0aGlzLmZvcm1hdFRhZywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMTAsIHRoaXMuY2hhbm5lbENvdW50LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxMiwgdGhpcy5zYW1wbGVzUGVyU2VjLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxNiwgdGhpcy5ieXRlc1BlclNlYywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMjAsIHRoaXMuYmxvY2tBbGlnbiwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMjIsIHRoaXMuYml0c1BlclNhbXBsZSwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FXYXZDb21tZW50Q2h1bmsgewogICAgY29uc3RydWN0b3IoaW5mbykgewogICAgICAgIHRoaXMuY29tbWVudEJ1ZiA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShpbmZvLmNvbW1lbnQpOwogICAgICAgIGxldCBzaXplID0gdGhpcy5jb21tZW50QnVmLmJ5dGVMZW5ndGg7CiAgICAgICAgc2l6ZSArPSA0OwogICAgICAgIGlmIChzaXplICUgNCkKICAgICAgICAgICAgc2l6ZSArPSA0IC0gc2l6ZSAlIDQ7CiAgICAgICAgdGhpcy5zaXplID0gc2l6ZTsKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDggKyB0aGlzLnNpemUpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoIm5vdGUiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICByZXQuc2V0KHRoaXMuY29tbWVudEJ1ZiwgOCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FXYXZlU21wbENodW5rIHsKICAgIGNvbnN0cnVjdG9yKGluZm8pIHsKICAgICAgICB0aGlzLnNpemUgPSA2MDsKICAgICAgICB0aGlzLm1hbnVmYWN0dXJlciA9IDA7CiAgICAgICAgdGhpcy5wcm9kdWN0ID0gMDsKICAgICAgICB0aGlzLk1JRElVbml0eU5vdGUgPSAweDNjOwogICAgICAgIHRoaXMuTUlESVBpdGNoRnJhY3Rpb24gPSAwOwogICAgICAgIHRoaXMuU01QVEVGb3JtYXQgPSAwOwogICAgICAgIHRoaXMuc2FtcGxlTG9vcHMgPSAxOwogICAgICAgIHRoaXMuc2FtcGxlckRhdGEgPSAweDE4OwogICAgICAgIHRoaXMubG9vcF9JZGVudGlmaWVyID0gMDsKICAgICAgICB0aGlzLmxvb3BfVHlwZSA9IDA7CiAgICAgICAgdGhpcy5sb29wX0ZyYWN0aW9uID0gMDsKICAgICAgICB0aGlzLmxvb3BfUGxheUNvdW50ID0gMDsKICAgICAgICBpZiAoIWluZm8uaGFzSGVhZGVyWyJsb29wIl0pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibWlzc2luZyBcImxvb3BcIiBoZWFkZXIiKTsKICAgICAgICB0aGlzLnNhbXBsZVBlcmlvZCA9ICgxIC8gaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlICogMTAwMDAwMDAwMCk7CiAgICAgICAgdGhpcy5sb29wX1N0YXJ0ID0gaW5mby5sb29wU3RhcnRBdFNhbXBsZSAtIGluZm8uc3RhcnRBdFNhbXBsZTsKICAgICAgICB0aGlzLmxvb3BfRW5kID0gaW5mby5sb29wRW5kQXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5TTVBURU9mZnNldCA9IDE7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJzbXBsIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoOCwgdGhpcy5tYW51ZmFjdHVyZXIsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDEyLCB0aGlzLnByb2R1Y3QsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDE2LCB0aGlzLnNhbXBsZVBlcmlvZCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMjAsIHRoaXMuTUlESVVuaXR5Tm90ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMjQsIHRoaXMuTUlESVBpdGNoRnJhY3Rpb24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDI4LCB0aGlzLlNNUFRFRm9ybWF0LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigzMiwgdGhpcy5TTVBURU9mZnNldCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMzYsIHRoaXMuc2FtcGxlTG9vcHMsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDQwLCB0aGlzLnNhbXBsZXJEYXRhLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0NCwgdGhpcy5sb29wX0lkZW50aWZpZXIsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDQ4LCB0aGlzLmxvb3BfVHlwZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNTIsIHRoaXMubG9vcF9TdGFydCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNTYsIHRoaXMubG9vcF9FbmQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDYwLCB0aGlzLmxvb3BfRnJhY3Rpb24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDY0LCB0aGlzLmxvb3BfUGxheUNvdW50LCB0cnVlKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQp9CmNsYXNzIEhDQUJpdFJlYWRlciB7CiAgICBjb25zdHJ1Y3RvcihidWZmZXIpIHsKICAgICAgICB0aGlzLkJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICB0aGlzLmR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdGhpcy5MZW5ndGhCaXRzID0gYnVmZmVyLmxlbmd0aCAqIDg7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IDA7CiAgICB9CiAgICBnZXQgUmVtYWluaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLkxlbmd0aEJpdHMgLSB0aGlzLlBvc2l0aW9uOwogICAgfQogICAgUmVhZEludChiaXRDb3VudCkgewogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuUGVla0ludChiaXRDb3VudCk7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBSZWFkQm9vbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5SZWFkSW50KDEpID09IDE7CiAgICB9CiAgICBSZWFkT2Zmc2V0QmluYXJ5KGJpdENvdW50LCBiaWFzKSB7CiAgICAgICAgbGV0IG9mZnNldCA9ICgxIDw8IChiaXRDb3VudCAtIDEpKSAtIGJpYXM7CiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5QZWVrSW50KGJpdENvdW50KSAtIG9mZnNldDsKICAgICAgICB0aGlzLlBvc2l0aW9uICs9IGJpdENvdW50OwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIEFsaWduUG9zaXRpb24obXVsdGlwbGUpIHsKICAgICAgICB0aGlzLlBvc2l0aW9uID0gSENBVXRpbEZ1bmMuR2V0TmV4dE11bHRpcGxlKHRoaXMuUG9zaXRpb24sIG11bHRpcGxlKTsKICAgIH0KICAgIFBlZWtJbnQoYml0Q291bnQpIHsKICAgICAgICBIQ0FVdGlsRnVuYy5EZWJ1Z0Fzc2VydChiaXRDb3VudCA+PSAwICYmIGJpdENvdW50IDw9IDMyKTsKICAgICAgICBpZiAoYml0Q291bnQgPiB0aGlzLlJlbWFpbmluZykgewogICAgICAgICAgICBpZiAodGhpcy5Qb3NpdGlvbiA+PSB0aGlzLkxlbmd0aEJpdHMpCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgbGV0IGV4dHJhQml0cyA9IGJpdENvdW50IC0gdGhpcy5SZW1haW5pbmc7CiAgICAgICAgICAgIHJldHVybiB0aGlzLlBlZWtJbnRGYWxsYmFjayh0aGlzLlJlbWFpbmluZykgPDwgZXh0cmFCaXRzOwogICAgICAgIH0KICAgICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5Qb3NpdGlvbiAvIDg7CiAgICAgICAgbGV0IGJpdEluZGV4ID0gdGhpcy5Qb3NpdGlvbiAlIDg7CiAgICAgICAgaWYgKGJpdENvdW50IDw9IDkgJiYgdGhpcy5SZW1haW5pbmcgPj0gMTYpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MTYoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdmFsdWUgJj0gMHhGRkZGID4+IGJpdEluZGV4OwogICAgICAgICAgICB2YWx1ZSA+Pj0gMTYgLSBiaXRDb3VudCAtIGJpdEluZGV4OwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChiaXRDb3VudCA8PSAxNyAmJiB0aGlzLlJlbWFpbmluZyA+PSAyNCkgewogICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmR2LmdldFVpbnQxNihieXRlSW5kZXgpIDw8IDggfCB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCArIDIpOwogICAgICAgICAgICB2YWx1ZSAmPSAweEZGRkZGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDI0IC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoYml0Q291bnQgPD0gMjUgJiYgdGhpcy5SZW1haW5pbmcgPj0gMzIpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MzIoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdmFsdWUgJj0gMHhGRkZGRkZGRiA+Pj4gYml0SW5kZXg7CiAgICAgICAgICAgIHZhbHVlID4+PSAzMiAtIGJpdENvdW50IC0gYml0SW5kZXg7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuUGVla0ludEZhbGxiYWNrKGJpdENvdW50KTsKICAgIH0KICAgIFBlZWtJbnRGYWxsYmFjayhiaXRDb3VudCkgewogICAgICAgIGxldCB2YWx1ZSA9IDA7CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIHdoaWxlIChiaXRDb3VudCA+IDApIHsKICAgICAgICAgICAgaWYgKGJpdEluZGV4ID49IDgpIHsKICAgICAgICAgICAgICAgIGJpdEluZGV4ID0gMDsKICAgICAgICAgICAgICAgIGJ5dGVJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBiaXRzVG9SZWFkID0gTWF0aC5taW4oYml0Q291bnQsIDggLSBiaXRJbmRleCk7CiAgICAgICAgICAgIGxldCBtYXNrID0gMHhGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgbGV0IGN1cnJlbnRCeXRlID0gKG1hc2sgJiB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCkpID4+ICg4IC0gYml0SW5kZXggLSBiaXRzVG9SZWFkKTsKICAgICAgICAgICAgdmFsdWUgPSAodmFsdWUgPDwgYml0c1RvUmVhZCkgfCBjdXJyZW50Qnl0ZTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvUmVhZDsKICAgICAgICAgICAgYml0Q291bnQgLT0gYml0c1RvUmVhZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9CnZhciBIQ0FPZmZzZXRCaWFzOwooZnVuY3Rpb24gKEhDQU9mZnNldEJpYXMpIHsKICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyBTcGVjaWZpZXMgdGhlIGJpYXMgb2YgYW4gb2Zmc2V0IGJpbmFyeSB2YWx1ZS4gQSBwb3NpdGl2ZSBiaWFzIGNhbiByZXByZXNlbnQgb25lIG1vcmUKICAgIC8vLyBwb3NpdGl2ZSB2YWx1ZSB0aGFuIG5lZ2F0aXZlIHZhbHVlLCBhbmQgYSBuZWdhdGl2ZSBiaWFzIGNhbiByZXByZXNlbnQgb25lIG1vcmUKICAgIC8vLyBuZWdhdGl2ZSB2YWx1ZSB0aGFuIHBvc2l0aXZlIHZhbHVlLgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cmVtYXJrcz5FeGFtcGxlOgogICAgLy8vIEEgNC1iaXQgb2Zmc2V0IGJpbmFyeSB2YWx1ZSB3aXRoIGEgcG9zaXRpdmUgYmlhcyBjYW4gc3RvcmUKICAgIC8vLyB0aGUgdmFsdWVzIDggdGhyb3VnaCAtNyBpbmNsdXNpdmUuCiAgICAvLy8gQSA0LWJpdCBvZmZzZXQgYmluYXJ5IHZhbHVlIHdpdGggYSBuZWdhdGl2ZSBiaWFzIGNhbiBzdG9yZQogICAgLy8vIHRoZSB2YWx1ZXMgNyB0aHJvdWdoIC04IGluY2x1c2l2ZS48L3JlbWFya3M+CiAgICBIQ0FPZmZzZXRCaWFzW0hDQU9mZnNldEJpYXNbIlBvc2l0aXZlIl0gPSAxXSA9ICJQb3NpdGl2ZSI7CiAgICBIQ0FPZmZzZXRCaWFzW0hDQU9mZnNldEJpYXNbIk5lZ2F0aXZlIl0gPSAwXSA9ICJOZWdhdGl2ZSI7Cn0pKEhDQU9mZnNldEJpYXMgfHwgKEhDQU9mZnNldEJpYXMgPSB7fSkpOwpjbGFzcyBIQ0FCaXRXcml0ZXIgewogICAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IDA7CiAgICAgICAgdGhpcy5CdWZmZXIgPSBidWZmZXI7CiAgICAgICAgdGhpcy5kdiA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHRoaXMuTGVuZ3RoQml0cyA9IGJ1ZmZlci5sZW5ndGggKiA4OwogICAgfQogICAgZ2V0IFJlbWFpbmluZygpIHsgcmV0dXJuIHRoaXMuTGVuZ3RoQml0cyAtIHRoaXMuUG9zaXRpb247IH0KICAgIEFsaWduUG9zaXRpb24obXVsdGlwbGUpIHsKICAgICAgICBsZXQgbmV3UG9zaXRpb24gPSBIQ0FVdGlsRnVuYy5HZXROZXh0TXVsdGlwbGUodGhpcy5Qb3NpdGlvbiwgbXVsdGlwbGUpOwogICAgICAgIGxldCBiaXRzID0gbmV3UG9zaXRpb24gLSB0aGlzLlBvc2l0aW9uOwogICAgICAgIHRoaXMuV3JpdGUoMCwgYml0cyk7CiAgICB9CiAgICBXcml0ZSh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICBIQ0FVdGlsRnVuYy5EZWJ1Z0Fzc2VydChiaXRDb3VudCA+PSAwICYmIGJpdENvdW50IDw9IDMyKTsKICAgICAgICBpZiAoYml0Q291bnQgPiB0aGlzLlJlbWFpbmluZykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBlbm91Z2ggYml0cyBsZWZ0IGluIG91dHB1dCBidWZmZXIiKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCBvdXRWYWx1ZSA9ICgodmFsdWUgPDwgKDE2IC0gYml0Q291bnQpKSAmIDB4RkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDE2KGJ5dGVJbmRleCwgb3V0VmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAxNyAmJiB0aGlzLlJlbWFpbmluZyA+PSAyNCkgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKHZhbHVlIDw8ICgyNCAtIGJpdENvdW50KSkgJiAweEZGRkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCkgPDwgOCB8IHRoaXMuZHYuZ2V0VWludDgoYnl0ZUluZGV4ICsgMik7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDE2KGJ5dGVJbmRleCwgb3V0VmFsdWUgPj4+IDgpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQ4KGJ5dGVJbmRleCArIDIsIG91dFZhbHVlICYgMHhGRik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGJpdENvdW50IDw9IDI1ICYmIHRoaXMuUmVtYWluaW5nID49IDMyKSB7CiAgICAgICAgICAgIGxldCBvdXRWYWx1ZSA9ICgoKHZhbHVlIDw8ICgzMiAtIGJpdENvdW50KSkgJiAweEZGRkZGRkZGKSA+Pj4gYml0SW5kZXgpOwogICAgICAgICAgICBvdXRWYWx1ZSB8PSB0aGlzLmR2LmdldFVpbnQzMihieXRlSW5kZXgpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQzMihieXRlSW5kZXgsIG91dFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuV3JpdGVGYWxsYmFjayh2YWx1ZSwgYml0Q291bnQpOwogICAgICAgIH0KICAgICAgICB0aGlzLlBvc2l0aW9uICs9IGJpdENvdW50OwogICAgfQogICAgV3JpdGVGYWxsYmFjayh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5Qb3NpdGlvbiAvIDg7CiAgICAgICAgbGV0IGJpdEluZGV4ID0gdGhpcy5Qb3NpdGlvbiAlIDg7CiAgICAgICAgd2hpbGUgKGJpdENvdW50ID4gMCkgewogICAgICAgICAgICBpZiAoYml0SW5kZXggPj0gOCkgewogICAgICAgICAgICAgICAgYml0SW5kZXggPSAwOwogICAgICAgICAgICAgICAgYnl0ZUluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHRvU2hpZnQgPSA4IC0gYml0SW5kZXggLSBiaXRDb3VudDsKICAgICAgICAgICAgbGV0IHNoaWZ0ZWQgPSB0b1NoaWZ0IDwgMCA/IHZhbHVlID4+PiAtdG9TaGlmdCA6IHZhbHVlIDw8IHRvU2hpZnQ7CiAgICAgICAgICAgIGxldCBiaXRzVG9Xcml0ZSA9IE1hdGgubWluKGJpdENvdW50LCA4IC0gYml0SW5kZXgpOwogICAgICAgICAgICBsZXQgbWFzayA9ICgoMSA8PCBiaXRzVG9Xcml0ZSkgLSAxKSA8PCA4IC0gYml0SW5kZXggLSBiaXRzVG9Xcml0ZTsKICAgICAgICAgICAgbGV0IG91dEJ5dGUgPSB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCkgJiB+bWFzazsKICAgICAgICAgICAgb3V0Qnl0ZSB8PSBzaGlmdGVkICYgbWFzazsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50OChieXRlSW5kZXgsIG91dEJ5dGUpOwogICAgICAgICAgICBiaXRJbmRleCArPSBiaXRzVG9Xcml0ZTsKICAgICAgICAgICAgYml0Q291bnQgLT0gYml0c1RvV3JpdGU7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEhDQUZyYW1lIHsKICAgIGNvbnN0cnVjdG9yKGhjYSkgewogICAgICAgIHRoaXMuQWNjZXB0YWJsZU5vaXNlTGV2ZWwgPSAwOwogICAgICAgIHRoaXMuRXZhbHVhdGlvbkJvdW5kYXJ5ID0gMDsKICAgICAgICB0aGlzLkhjYSA9IGhjYTsKICAgICAgICBsZXQgY2hhbm5lbFR5cGVzID0gSENBRnJhbWUuR2V0Q2hhbm5lbFR5cGVzKGhjYSk7CiAgICAgICAgdGhpcy5DaGFubmVscyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGNhLmZvcm1hdC5jaGFubmVsQ291bnQ7IGkrKykgewogICAgICAgICAgICB0aGlzLkNoYW5uZWxzLnB1c2gobmV3IEhDQUNoYW5uZWwoewogICAgICAgICAgICAgICAgVHlwZTogY2hhbm5lbFR5cGVzW2ldLAogICAgICAgICAgICAgICAgQ29kZWRTY2FsZUZhY3RvckNvdW50OiBjaGFubmVsVHlwZXNbaV0gPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5CiAgICAgICAgICAgICAgICAgICAgPyBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50CiAgICAgICAgICAgICAgICAgICAgOiBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50ICsgaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50CiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5BdGhDdXJ2ZSA9IGhjYS5Vc2VBdGhDdXJ2ZSA/IEhDQUZyYW1lLlNjYWxlQXRoQ3VydmUoaGNhLmZvcm1hdC5zYW1wbGluZ1JhdGUpIDogbmV3IFVpbnQ4QXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyBHZXRDaGFubmVsVHlwZXMoaGNhKSB7CiAgICAgICAgbGV0IGNoYW5uZWxzUGVyVHJhY2sgPSBoY2EuZm9ybWF0LmNoYW5uZWxDb3VudCAvIGhjYS5jb21wRGVjLlRyYWNrQ291bnQ7CiAgICAgICAgaWYgKGhjYS5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCA9PSAwIHx8IGNoYW5uZWxzUGVyVHJhY2sgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gbmV3IEFycmF5KDgpLmZpbGwoSENBQ2hhbm5lbFR5cGUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBEaXNjcmV0ZSA9IEhDQUNoYW5uZWxUeXBlLkRpc2NyZXRlOwogICAgICAgIGNvbnN0IFN0ZXJlb1ByaW1hcnkgPSBIQ0FDaGFubmVsVHlwZS5TdGVyZW9QcmltYXJ5OwogICAgICAgIGNvbnN0IFN0ZXJlb1NlY29uZGFyeSA9IEhDQUNoYW5uZWxUeXBlLlN0ZXJlb1NlY29uZGFyeTsKICAgICAgICBzd2l0Y2ggKGNoYW5uZWxzUGVyVHJhY2spIHsKICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gW1N0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeV07CiAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlXTsKICAgICAgICAgICAgY2FzZSA0OiBpZiAoaGNhLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyAhPSAwKQogICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZV07CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBjYXNlIDU6IGlmIChoY2EuY29tcERlYy5DaGFubmVsQ29uZmlnID4gMikKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGUsIERpc2NyZXRlXTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBjYXNlIDY6IHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGUsIFN0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeV07CiAgICAgICAgICAgIGNhc2UgNzogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZV07CiAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbmV3IEFycmF5KGNoYW5uZWxzUGVyVHJhY2spLmZpbGwoSENBQ2hhbm5lbFR5cGUpOwogICAgICAgIH0KICAgIH0KICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyBTY2FsZXMgYW4gQVRIIGN1cnZlIHRvIHRoZSBzcGVjaWZpZWQgZnJlcXVlbmN5LgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iZnJlcXVlbmN5Ij5UaGUgZnJlcXVlbmN5IHRvIHNjYWxlIHRoZSBjdXJ2ZSB0by48L3BhcmFtPgogICAgLy8vIDxyZXR1cm5zPlRoZSBzY2FsZWQgQVRIIGN1cnZlPC9yZXR1cm5zPgogICAgLy8vIDxyZW1hcmtzPlRoZSBvcmlnaW5hbCBBVEggY3VydmUgaXMgZm9yIGEgZnJlcXVlbmN5IG9mIDQxODU2IEh6LjwvcmVtYXJrcz4KICAgIHN0YXRpYyBTY2FsZUF0aEN1cnZlKGZyZXF1ZW5jeSkgewogICAgICAgIHZhciBhdGggPSBuZXcgVWludDhBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIGxldCBhY2MgPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWNjICs9IGZyZXF1ZW5jeTsKICAgICAgICAgICAgbGV0IGluZGV4ID0gYWNjID4+IDEzOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gSENBVGFibGVzLkF0aEN1cnZlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXRoW2ldID0gSENBVGFibGVzLkF0aEN1cnZlW2luZGV4XTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGkgPCBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXRoW2ldID0gMHhmZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0aDsKICAgIH0KfQpfYSA9IEhDQUZyYW1lOwpIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSA9IDg7CkhDQUZyYW1lLlN1YkZyYW1lU2FtcGxlc0JpdHMgPSA3OwpIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUgPSAxIDw8IF9hLlN1YkZyYW1lU2FtcGxlc0JpdHM7CkhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSA9IF9hLlN1YmZyYW1lc1BlckZyYW1lICogX2EuU2FtcGxlc1BlclN1YkZyYW1lOwpjbGFzcyBIQ0FDaGFubmVsIHsKICAgIGNvbnN0cnVjdG9yKHZhbHVlcykgewogICAgICAgIHRoaXMuVHlwZSA9IDA7CiAgICAgICAgdGhpcy5Db2RlZFNjYWxlRmFjdG9yQ291bnQgPSAwOwogICAgICAgIHRoaXMuUGNtRmxvYXQgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSB9LCAoKSA9PiBuZXcgRmxvYXQ2NEFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSkpOwogICAgICAgIHRoaXMuU3BlY3RyYSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TY2FsZWRTcGVjdHJhID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWUpKTsKICAgICAgICB0aGlzLlF1YW50aXplZFNwZWN0cmEgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSB9LCAoKSA9PiBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpKTsKICAgICAgICB0aGlzLkdhaW4gPSBuZXcgRmxvYXQ2NEFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5JbnRlbnNpdHkgPSBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSk7CiAgICAgICAgdGhpcy5IZnJTY2FsZXMgPSBuZXcgSW50MzJBcnJheSg4KTsKICAgICAgICB0aGlzLkhmckdyb3VwQXZlcmFnZVNwZWN0cmEgPSBuZXcgRmxvYXQ2NEFycmF5KDgpOwogICAgICAgIHRoaXMuTWRjdCA9IG5ldyBIQ0FNZGN0KEhDQUZyYW1lLlN1YkZyYW1lU2FtcGxlc0JpdHMsIEhDQVRhYmxlcy5NZGN0V2luZG93LCBNYXRoLnNxcnQoMi4wIC8gSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TY2FsZUZhY3RvcnMgPSBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIHRoaXMuUmVzb2x1dGlvbiA9IG5ldyBJbnQzMkFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5IZWFkZXJMZW5ndGhCaXRzID0gMDsKICAgICAgICB0aGlzLlNjYWxlRmFjdG9yRGVsdGFCaXRzID0gMDsKICAgICAgICBsZXQgdCA9IHRoaXM7CiAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHVlcykgewogICAgICAgICAgICB0W2tleV0gPSB2YWx1ZXNba2V5XTsKICAgICAgICB9CiAgICB9Cn0KdmFyIEhDQUNoYW5uZWxUeXBlOwooZnVuY3Rpb24gKEhDQUNoYW5uZWxUeXBlKSB7CiAgICBIQ0FDaGFubmVsVHlwZVtIQ0FDaGFubmVsVHlwZVsiRGlzY3JldGUiXSA9IDBdID0gIkRpc2NyZXRlIjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9QcmltYXJ5Il0gPSAxXSA9ICJTdGVyZW9QcmltYXJ5IjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9TZWNvbmRhcnkiXSA9IDJdID0gIlN0ZXJlb1NlY29uZGFyeSI7Cn0pKEhDQUNoYW5uZWxUeXBlIHx8IChIQ0FDaGFubmVsVHlwZSA9IHt9KSk7CmNsYXNzIEhDQURlY29kZXIgewogICAgc3RhdGljIERlY29kZUZyYW1lKGF1ZGlvLCBmcmFtZSkgewogICAgICAgIGxldCByZWFkZXIgPSBuZXcgSENBQml0UmVhZGVyKGF1ZGlvKTsKICAgICAgICBIQ0FQYWNraW5nLlVucGFja0ZyYW1lKGZyYW1lLCByZWFkZXIpOwogICAgICAgIHRoaXMuRGVxdWFudGl6ZUZyYW1lKGZyYW1lKTsKICAgICAgICB0aGlzLlJlc3RvcmVNaXNzaW5nQmFuZHMoZnJhbWUpOwogICAgICAgIHRoaXMuUnVuSW1kY3QoZnJhbWUpOwogICAgfQogICAgc3RhdGljIERlcXVhbnRpemVGcmFtZShmcmFtZSkgewogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgdGhpcy5DYWxjdWxhdGVHYWluKGNoYW5uZWwpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXVtzXSA9IGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzZl1bc10gKiBjaGFubmVsLkdhaW5bc107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVzdG9yZU1pc3NpbmdCYW5kcyhmcmFtZSkgewogICAgICAgIHRoaXMuUmVjb25zdHJ1Y3RIaWdoRnJlcXVlbmN5KGZyYW1lKTsKICAgICAgICB0aGlzLkFwcGx5SW50ZW5zaXR5U3RlcmVvKGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVHYWluKGNoYW5uZWwpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgY2hhbm5lbC5HYWluW2ldID0gSENBVGFibGVzLkRlcXVhbnRpemVyU2NhbGluZ1RhYmxlW2NoYW5uZWwuU2NhbGVGYWN0b3JzW2ldXSAqIEhDQVRhYmxlcy5RdWFudGl6ZXJTdGVwU2l6ZVtjaGFubmVsLlJlc29sdXRpb25baV1dOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSZWNvbnN0cnVjdEhpZ2hGcmVxdWVuY3koZnJhbWUpIHsKICAgICAgICBsZXQgaGNhID0gZnJhbWUuSGNhOwogICAgICAgIGlmIChoY2EuSGZyR3JvdXBDb3VudCA9PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgLy8gVGhlIGxhc3Qgc3BlY3RyYWwgY29lZmZpY2llbnQgc2hvdWxkIGFsd2F5cyBiZSAwOwogICAgICAgIGxldCB0b3RhbEJhbmRDb3VudCA9IE1hdGgubWluKGhjYS5jb21wRGVjLlRvdGFsQmFuZENvdW50LCAxMjcpOwogICAgICAgIGxldCBoZnJTdGFydEJhbmQgPSBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50ICsgaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgIGxldCBoZnJCYW5kQ291bnQgPSBNYXRoLm1pbihoY2EuY29tcERlYy5IZnJCYW5kQ291bnQsIHRvdGFsQmFuZENvdW50IC0gaGNhLmNvbXBEZWMuSGZyQmFuZENvdW50KTsKICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5KQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGZvciAobGV0IGdyb3VwID0gMCwgYmFuZCA9IDA7IGdyb3VwIDwgaGNhLkhmckdyb3VwQ291bnQ7IGdyb3VwKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGNhLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCAmJiBiYW5kIDwgaGZyQmFuZENvdW50OyBiYW5kKyssIGkrKykgewogICAgICAgICAgICAgICAgICAgIGxldCBoaWdoQmFuZCA9IGhmclN0YXJ0QmFuZCArIGJhbmQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IGxvd0JhbmQgPSBoZnJTdGFydEJhbmQgLSBiYW5kIC0gMTsKICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBjaGFubmVsLkhmclNjYWxlc1tncm91cF0gLSBjaGFubmVsLlNjYWxlRmFjdG9yc1tsb3dCYW5kXSArIDY0OwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdW2hpZ2hCYW5kXSA9IEhDQVRhYmxlcy5TY2FsZUNvbnZlcnNpb25UYWJsZVtpbmRleF0gKiBjaGFubmVsLlNwZWN0cmFbc2ZdW2xvd0JhbmRdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBBcHBseUludGVuc2l0eVN0ZXJlbyhmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5IY2EuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPD0gMCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgaWYgKGZyYW1lLkNoYW5uZWxzW2NdLlR5cGUgIT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvUHJpbWFyeSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgIGxldCBsID0gZnJhbWUuQ2hhbm5lbHNbY10uU3BlY3RyYVtzZl07CiAgICAgICAgICAgICAgICBsZXQgciA9IGZyYW1lLkNoYW5uZWxzW2MgKyAxXS5TcGVjdHJhW3NmXTsKICAgICAgICAgICAgICAgIGxldCByYXRpb0wgPSBIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9UYWJsZVtmcmFtZS5DaGFubmVsc1tjICsgMV0uSW50ZW5zaXR5W3NmXV07CiAgICAgICAgICAgICAgICBsZXQgcmF0aW9SID0gcmF0aW9MIC0gMi4wOwogICAgICAgICAgICAgICAgZm9yIChsZXQgYiA9IGZyYW1lLkhjYS5jb21wRGVjLkJhc2VCYW5kQ291bnQ7IGIgPCBmcmFtZS5IY2EuY29tcERlYy5Ub3RhbEJhbmRDb3VudDsgYisrKSB7CiAgICAgICAgICAgICAgICAgICAgcltiXSA9IGxbYl0gKiByYXRpb1I7CiAgICAgICAgICAgICAgICAgICAgbFtiXSAqPSByYXRpb0w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUnVuSW1kY3QoZnJhbWUpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5NZGN0LlJ1bkltZGN0KGNoYW5uZWwuU3BlY3RyYVtzZl0sIGNoYW5uZWwuUGNtRmxvYXRbc2ZdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjbGFzcyBIQ0FQYWNraW5nIHsKICAgIHN0YXRpYyBVbnBhY2tGcmFtZShmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgaWYgKCF0aGlzLlVucGFja0ZyYW1lSGVhZGVyKGZyYW1lLCByZWFkZXIpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdGhpcy5SZWFkU3BlY3RyYWxDb2VmZmljaWVudHMoZnJhbWUsIHJlYWRlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5wYWNraW5nV2FzU3VjY2Vzc2Z1bChmcmFtZSwgcmVhZGVyKTsKICAgIH0KICAgIHN0YXRpYyBQYWNrRnJhbWUoZnJhbWUsIG91dEJ1ZmZlcikgewogICAgICAgIHZhciB3cml0ZXIgPSBuZXcgSENBQml0V3JpdGVyKG91dEJ1ZmZlcik7CiAgICAgICAgd3JpdGVyLldyaXRlKDB4ZmZmZiwgMTYpOwogICAgICAgIHdyaXRlci5Xcml0ZShmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCwgOSk7CiAgICAgICAgd3JpdGVyLldyaXRlKGZyYW1lLkV2YWx1YXRpb25Cb3VuZGFyeSwgNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICB0aGlzLldyaXRlU2NhbGVGYWN0b3JzKHdyaXRlciwgY2hhbm5lbCk7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoY2hhbm5lbC5JbnRlbnNpdHlbaV0sIDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZS5IY2EuSGZyR3JvdXBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKGNoYW5uZWwuSGZyU2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgdGhpcy5Xcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzZik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd3JpdGVyLkFsaWduUG9zaXRpb24oOCk7CiAgICAgICAgZm9yIChsZXQgaSA9IHdyaXRlci5Qb3NpdGlvbiAvIDg7IGkgPCBmcmFtZS5IY2EuYmxvY2tTaXplIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIHdyaXRlci5kdi5zZXRVaW50OChpLCAwKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Xcml0ZUNoZWNrc3VtKHdyaXRlciwgb3V0QnVmZmVyKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVSZXNvbHV0aW9uKHNjYWxlRmFjdG9yLCBub2lzZUxldmVsKSB7CiAgICAgICAgaWYgKHNjYWxlRmFjdG9yID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGxldCBjdXJ2ZVBvc2l0aW9uID0gbm9pc2VMZXZlbCAtICg1ICogc2NhbGVGYWN0b3IgPj4gMSkgKyAyOwogICAgICAgIGN1cnZlUG9zaXRpb24gPSBIQ0FVdGlsRnVuYy5DbGFtcChjdXJ2ZVBvc2l0aW9uLCAwLCA1OCk7CiAgICAgICAgcmV0dXJuIEhDQVRhYmxlcy5TY2FsZVRvUmVzb2x1dGlvbkN1cnZlW2N1cnZlUG9zaXRpb25dOwogICAgfQogICAgc3RhdGljIFVucGFja0ZyYW1lSGVhZGVyKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICBsZXQgc3luY1dvcmQgPSByZWFkZXIuUmVhZEludCgxNik7CiAgICAgICAgaWYgKHN5bmNXb3JkICE9IDB4ZmZmZikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZnJhbWUgaGVhZGVyIik7CiAgICAgICAgfQogICAgICAgIGxldCBhdGhDdXJ2ZSA9IGZyYW1lLkF0aEN1cnZlOwogICAgICAgIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID0gcmVhZGVyLlJlYWRJbnQoOSk7CiAgICAgICAgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5ID0gcmVhZGVyLlJlYWRJbnQoNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoIXRoaXMuUmVhZFNjYWxlRmFjdG9ycyhjaGFubmVsLCByZWFkZXIpKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lLkV2YWx1YXRpb25Cb3VuZGFyeTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLlJlc29sdXRpb25baV0gPSB0aGlzLkNhbGN1bGF0ZVJlc29sdXRpb24oY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0sIGF0aEN1cnZlW2ldICsgZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwgLSAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5SZXNvbHV0aW9uW2ldID0gdGhpcy5DYWxjdWxhdGVSZXNvbHV0aW9uKGNoYW5uZWwuU2NhbGVGYWN0b3JzW2ldLCBhdGhDdXJ2ZVtpXSArIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hhbm5lbC5UeXBlID09IEhDQUNoYW5uZWxUeXBlLlN0ZXJlb1NlY29uZGFyeSkgewogICAgICAgICAgICAgICAgdGhpcy5SZWFkSW50ZW5zaXR5KHJlYWRlciwgY2hhbm5lbC5JbnRlbnNpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5SZWFkSGZyU2NhbGVGYWN0b3JzKHJlYWRlciwgZnJhbWUuSGNhLkhmckdyb3VwQ291bnQsIGNoYW5uZWwuSGZyU2NhbGVzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBSZWFkU2NhbGVGYWN0b3JzKGNoYW5uZWwsIHJlYWRlcikgewogICAgICAgIGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPSByZWFkZXIuUmVhZEludCgzKTsKICAgICAgICBpZiAoY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA9PSAwKSB7CiAgICAgICAgICAgIGNoYW5uZWwuU2NhbGVGYWN0b3JzLmZpbGwoMCwgMCwgY2hhbm5lbC5TY2FsZUZhY3RvcnMubGVuZ3RoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzID49IDYpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLlNjYWxlRmFjdG9yc1tpXSA9IHJlYWRlci5SZWFkSW50KDYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5EZWx0YURlY29kZShyZWFkZXIsIGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMsIDYsIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50LCBjaGFubmVsLlNjYWxlRmFjdG9ycyk7CiAgICB9CiAgICBzdGF0aWMgUmVhZEludGVuc2l0eShyZWFkZXIsIGludGVuc2l0eSkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IGkrKykgewogICAgICAgICAgICBpbnRlbnNpdHlbaV0gPSByZWFkZXIuUmVhZEludCg0KTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVhZEhmclNjYWxlRmFjdG9ycyhyZWFkZXIsIGdyb3VwQ291bnQsIGhmclNjYWxlKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cENvdW50OyBpKyspIHsKICAgICAgICAgICAgaGZyU2NhbGVbaV0gPSByZWFkZXIuUmVhZEludCg2KTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVhZFNwZWN0cmFsQ29lZmZpY2llbnRzKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc29sdXRpb24gPSBjaGFubmVsLlJlc29sdXRpb25bc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzW3Jlc29sdXRpb25dOwogICAgICAgICAgICAgICAgICAgIGxldCBjb2RlID0gcmVhZGVyLlBlZWtJbnQoYml0cyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc29sdXRpb24gPCA4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1CaXRzW3Jlc29sdXRpb25dW2NvZGVdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc2ZdW3NdID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtVmFsdWVbcmVzb2x1dGlvbl1bY29kZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWFkIHRoZSBzaWduLW1hZ25pdHVkZSB2YWx1ZS4gVGhlIGxvdyBiaXQgaXMgdGhlIHNpZ24KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YW50aXplZENvZWZmaWNpZW50ID0gKGNvZGUgPj4gMSkgKiAoMSAtIChjb2RlICUgMiAqIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHF1YW50aXplZENvZWZmaWNpZW50ID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMtLTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc2ZdW3NdID0gcXVhbnRpemVkQ29lZmZpY2llbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlYWRlci5Qb3NpdGlvbiArPSBiaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXS5maWxsKDAsIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50LCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCArIDB4ODAgLSBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgRGVsdGFEZWNvZGUocmVhZGVyLCBkZWx0YUJpdHMsIGRhdGFCaXRzLCBjb3VudCwgb3V0cHV0KSB7CiAgICAgICAgb3V0cHV0WzBdID0gcmVhZGVyLlJlYWRJbnQoZGF0YUJpdHMpOwogICAgICAgIGxldCBtYXhEZWx0YSA9IDEgPDwgKGRlbHRhQml0cyAtIDEpOwogICAgICAgIGxldCBtYXhWYWx1ZSA9ICgxIDw8IGRhdGFCaXRzKSAtIDE7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGxldCBkZWx0YSA9IHJlYWRlci5SZWFkT2Zmc2V0QmluYXJ5KGRlbHRhQml0cywgSENBT2Zmc2V0Qmlhcy5Qb3NpdGl2ZSk7CiAgICAgICAgICAgIGlmIChkZWx0YSA8IG1heERlbHRhKSB7CiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBvdXRwdXRbaSAtIDFdICsgZGVsdGE7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPCAwIHx8IHZhbHVlID4gbWF4VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXRbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHB1dFtpXSA9IHJlYWRlci5SZWFkSW50KGRhdGFCaXRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBVbnBhY2tpbmdXYXNTdWNjZXNzZnVsKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICAvLyAxMjggbGVmdG92ZXIgYml0cyBhZnRlciB1bnBhY2tpbmcgc2hvdWxkIGJlIGhpZ2ggZW5vdWdoIHRvIGdldCByaWQgb2YgZmFsc2UgbmVnYXRpdmVzLAogICAgICAgIC8vIGFuZCBsb3cgZW5vdWdoIHRoYXQgZmFsc2UgcG9zaXRpdmVzIHdpbGwgYmUgdW5jb21tb24uCiAgICAgICAgcmV0dXJuIHJlYWRlci5SZW1haW5pbmcgPj0gMTYgJiYgcmVhZGVyLlJlbWFpbmluZyA8PSAxMjgKICAgICAgICAgICAgfHwgdGhpcy5GcmFtZUVtcHR5KGZyYW1lKQogICAgICAgICAgICB8fCBmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCA9PSAwICYmIHJlYWRlci5SZW1haW5pbmcgPj0gMTY7CiAgICB9CiAgICBzdGF0aWMgRnJhbWVFbXB0eShmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCA+IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAvLyBJZiBhbGwgdGhlIHNjYWxlIGZhY3RvcnMgYXJlIDAsIHRoZSBmcmFtZSBpcyBlbXB0eQogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgaWYgKGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgV3JpdGVDaGVja3N1bSh3cml0ZXIsIGhjYUJ1ZmZlcikgewogICAgICAgIHdyaXRlci5Qb3NpdGlvbiA9IHdyaXRlci5MZW5ndGhCaXRzIC0gMTY7CiAgICAgICAgbGV0IGNyYzE2ID0gSENBQ3JjMTYuY2FsYyhoY2FCdWZmZXIsIGhjYUJ1ZmZlci5sZW5ndGggLSAyKTsKICAgICAgICB3cml0ZXIuV3JpdGUoY3JjMTYsIDE2KTsKICAgIH0KICAgIHN0YXRpYyBXcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzdWJGcmFtZSkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgcmVzb2x1dGlvbiA9IGNoYW5uZWwuUmVzb2x1dGlvbltpXTsKICAgICAgICAgICAgbGV0IHF1YW50aXplZFNwZWN0cmEgPSBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc3ViRnJhbWVdW2ldOwogICAgICAgICAgICBpZiAocmVzb2x1dGlvbiA9PSAwKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uIDwgOCkgewogICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bUJpdHNbcmVzb2x1dGlvbl1bcXVhbnRpemVkU3BlY3RyYSArIDhdOwogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKEhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtVmFsdWVbcmVzb2x1dGlvbl1bcXVhbnRpemVkU3BlY3RyYSArIDhdLCBiaXRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChyZXNvbHV0aW9uIDwgMTYpIHsKICAgICAgICAgICAgICAgIGxldCBiaXRzID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtTWF4Qml0c1tyZXNvbHV0aW9uXSAtIDE7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoTWF0aC5hYnMocXVhbnRpemVkU3BlY3RyYSksIGJpdHMpOwogICAgICAgICAgICAgICAgaWYgKHF1YW50aXplZFNwZWN0cmEgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShxdWFudGl6ZWRTcGVjdHJhID4gMCA/IDAgOiAxLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBXcml0ZVNjYWxlRmFjdG9ycyh3cml0ZXIsIGNoYW5uZWwpIHsKICAgICAgICBsZXQgZGVsdGFCaXRzID0gY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0czsKICAgICAgICBsZXQgc2NhbGVzID0gY2hhbm5lbC5TY2FsZUZhY3RvcnM7CiAgICAgICAgd3JpdGVyLldyaXRlKGRlbHRhQml0cywgMyk7CiAgICAgICAgaWYgKGRlbHRhQml0cyA9PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKGRlbHRhQml0cyA9PSA2KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKHNjYWxlc1tpXSwgNik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzWzBdLCA2KTsKICAgICAgICBsZXQgbWF4RGVsdGEgPSAoMSA8PCAoZGVsdGFCaXRzIC0gMSkpIC0gMTsKICAgICAgICBsZXQgZXNjYXBlVmFsdWUgPSAoMSA8PCBkZWx0YUJpdHMpIC0gMTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGRlbHRhID0gc2NhbGVzW2ldIC0gc2NhbGVzW2kgLSAxXTsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRlbHRhKSA+IG1heERlbHRhKSB7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoZXNjYXBlVmFsdWUsIGRlbHRhQml0cyk7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShtYXhEZWx0YSArIGRlbHRhLCBkZWx0YUJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEhDQU1kY3QgewogICAgY29uc3RydWN0b3IobWRjdEJpdHMsIHdpbmRvdywgc2NhbGUgPSAxKSB7CiAgICAgICAgSENBTWRjdC5TZXRUYWJsZXMobWRjdEJpdHMpOwogICAgICAgIHRoaXMuTWRjdEJpdHMgPSBtZGN0Qml0czsKICAgICAgICB0aGlzLk1kY3RTaXplID0gMSA8PCBtZGN0Qml0czsKICAgICAgICB0aGlzLlNjYWxlID0gc2NhbGU7CiAgICAgICAgaWYgKHdpbmRvdy5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2luZG93IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9tZGN0UHJldmlvdXMgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXMgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX3NjcmF0Y2hNZGN0ID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9zY3JhdGNoRGN0ID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9pbWRjdFdpbmRvdyA9IHdpbmRvdzsKICAgIH0KICAgIHN0YXRpYyBTZXRUYWJsZXMobWF4Qml0cykgewogICAgICAgIGlmIChtYXhCaXRzID4gdGhpcy5fdGFibGVCaXRzKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLl90YWJsZUJpdHMgKyAxOyBpIDw9IG1heEJpdHM7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IG91dCA9IHRoaXMuR2VuZXJhdGVUcmlnVGFibGVzKGkpOwogICAgICAgICAgICAgICAgdGhpcy5TaW5UYWJsZXMucHVzaChvdXQuc2luKTsKICAgICAgICAgICAgICAgIHRoaXMuQ29zVGFibGVzLnB1c2gob3V0LmNvcyk7CiAgICAgICAgICAgICAgICB0aGlzLlNodWZmbGVUYWJsZXMucHVzaCh0aGlzLkdlbmVyYXRlU2h1ZmZsZVRhYmxlKGkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl90YWJsZUJpdHMgPSBtYXhCaXRzOwogICAgICAgIH0KICAgIH0KICAgIFJ1bk1kY3QoaW5wdXQsIG91dHB1dCkgewogICAgICAgIGlmIChpbnB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChvdXRwdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk91dHB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBoYWxmID0gKHNpemUgPj4gMSk7CiAgICAgICAgbGV0IGRjdEluID0gdGhpcy5fc2NyYXRjaE1kY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYWxmOyBpKyspIHsKICAgICAgICAgICAgbGV0IGEgPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmIC0gaSAtIDFdICogLWlucHV0W2hhbGYgKyBpXTsKICAgICAgICAgICAgbGV0IGIgPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmICsgaV0gKiBpbnB1dFtoYWxmIC0gaSAtIDFdOwogICAgICAgICAgICBsZXQgYyA9IHRoaXMuX2ltZGN0V2luZG93W2ldICogdGhpcy5fbWRjdFByZXZpb3VzW2ldOwogICAgICAgICAgICBsZXQgZCA9IHRoaXMuX2ltZGN0V2luZG93W3NpemUgLSBpIC0gMV0gKiB0aGlzLl9tZGN0UHJldmlvdXNbc2l6ZSAtIGkgLSAxXTsKICAgICAgICAgICAgZGN0SW5baV0gPSBhIC0gYjsKICAgICAgICAgICAgZGN0SW5baGFsZiArIGldID0gYyAtIGQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuRGN0NChkY3RJbiwgb3V0cHV0KTsKICAgICAgICB0aGlzLl9tZGN0UHJldmlvdXMuc2V0KGlucHV0LCBpbnB1dC5sZW5ndGgpOwogICAgfQogICAgUnVuSW1kY3QoaW5wdXQsIG91dHB1dCkgewogICAgICAgIGlmIChpbnB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChvdXRwdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk91dHB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBoYWxmID0gKHNpemUgPj4gMSk7CiAgICAgICAgbGV0IGRjdE91dCA9IHRoaXMuX3NjcmF0Y2hNZGN0OwogICAgICAgIHRoaXMuRGN0NChpbnB1dCwgZGN0T3V0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGY7IGkrKykgewogICAgICAgICAgICBvdXRwdXRbaV0gPSB0aGlzLl9pbWRjdFdpbmRvd1tpXSAqIGRjdE91dFtpICsgaGFsZl0gKyB0aGlzLl9pbWRjdFByZXZpb3VzW2ldOwogICAgICAgICAgICBvdXRwdXRbaSArIGhhbGZdID0gdGhpcy5faW1kY3RXaW5kb3dbaSArIGhhbGZdICogLWRjdE91dFtzaXplIC0gMSAtIGldIC0gdGhpcy5faW1kY3RQcmV2aW91c1tpICsgaGFsZl07CiAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaV0gPSB0aGlzLl9pbWRjdFdpbmRvd1tzaXplIC0gMSAtIGldICogLWRjdE91dFtoYWxmIC0gaSAtIDFdOwogICAgICAgICAgICB0aGlzLl9pbWRjdFByZXZpb3VzW2kgKyBoYWxmXSA9IHRoaXMuX2ltZGN0V2luZG93W2hhbGYgLSBpIC0gMV0gKiBkY3RPdXRbaV07CiAgICAgICAgfQogICAgfQogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIERvZXMgYSBUeXBlLTQgRENULgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iaW5wdXQiPlRoZSBpbnB1dCBhcnJheSBjb250YWluaW5nIHRoZSB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICAvLy8gPHBhcmFtIG5hbWU9Im91dHB1dCI+VGhlIG91dHB1dCBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgdHJhbnNmb3JtZWQgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXM8L3BhcmFtPgogICAgRGN0NChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgbGV0IHNodWZmbGVUYWJsZSA9IEhDQU1kY3QuU2h1ZmZsZVRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgc2luVGFibGUgPSBIQ0FNZGN0LlNpblRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgY29zVGFibGUgPSBIQ0FNZGN0LkNvc1RhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgZGN0VGVtcCA9IHRoaXMuX3NjcmF0Y2hEY3Q7CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBsYXN0SW5kZXggPSBzaXplIC0gMTsKICAgICAgICBsZXQgaGFsZlNpemUgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGZTaXplOyBpKyspIHsKICAgICAgICAgICAgbGV0IGkyID0gaSAqIDI7CiAgICAgICAgICAgIGxldCBhID0gaW5wdXRbaTJdOwogICAgICAgICAgICBsZXQgYiA9IGlucHV0W2xhc3RJbmRleCAtIGkyXTsKICAgICAgICAgICAgbGV0IHNpbiA9IHNpblRhYmxlW2ldOwogICAgICAgICAgICBsZXQgY29zID0gY29zVGFibGVbaV07CiAgICAgICAgICAgIGRjdFRlbXBbaTJdID0gYSAqIGNvcyArIGIgKiBzaW47CiAgICAgICAgICAgIGRjdFRlbXBbaTIgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgIH0KICAgICAgICBsZXQgc3RhZ2VDb3VudCA9IHRoaXMuTWRjdEJpdHMgLSAxOwogICAgICAgIGZvciAobGV0IHN0YWdlID0gMDsgc3RhZ2UgPCBzdGFnZUNvdW50OyBzdGFnZSsrKSB7CiAgICAgICAgICAgIGxldCBibG9ja0NvdW50ID0gMSA8PCBzdGFnZTsKICAgICAgICAgICAgbGV0IGJsb2NrU2l6ZUJpdHMgPSBzdGFnZUNvdW50IC0gc3RhZ2U7CiAgICAgICAgICAgIGxldCBibG9ja0hhbGZTaXplQml0cyA9IGJsb2NrU2l6ZUJpdHMgLSAxOwogICAgICAgICAgICBsZXQgYmxvY2tTaXplID0gMSA8PCBibG9ja1NpemVCaXRzOwogICAgICAgICAgICBsZXQgYmxvY2tIYWxmU2l6ZSA9IDEgPDwgYmxvY2tIYWxmU2l6ZUJpdHM7CiAgICAgICAgICAgIHNpblRhYmxlID0gSENBTWRjdC5TaW5UYWJsZXNbYmxvY2tIYWxmU2l6ZUJpdHNdOwogICAgICAgICAgICBjb3NUYWJsZSA9IEhDQU1kY3QuQ29zVGFibGVzW2Jsb2NrSGFsZlNpemVCaXRzXTsKICAgICAgICAgICAgZm9yIChsZXQgYmxvY2sgPSAwOyBibG9jayA8IGJsb2NrQ291bnQ7IGJsb2NrKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tIYWxmU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGZyb250UG9zID0gKGJsb2NrICogYmxvY2tTaXplICsgaSkgKiAyOwogICAgICAgICAgICAgICAgICAgIGxldCBiYWNrUG9zID0gZnJvbnRQb3MgKyBibG9ja1NpemU7CiAgICAgICAgICAgICAgICAgICAgbGV0IGEgPSBkY3RUZW1wW2Zyb250UG9zXSAtIGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGIgPSBkY3RUZW1wW2Zyb250UG9zICsgMV0gLSBkY3RUZW1wW2JhY2tQb3MgKyAxXTsKICAgICAgICAgICAgICAgICAgICBsZXQgc2luID0gc2luVGFibGVbaV07CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvcyA9IGNvc1RhYmxlW2ldOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbZnJvbnRQb3NdICs9IGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgZGN0VGVtcFtmcm9udFBvcyArIDFdICs9IGRjdFRlbXBbYmFja1BvcyArIDFdOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbYmFja1Bvc10gPSBhICogY29zICsgYiAqIHNpbjsKICAgICAgICAgICAgICAgICAgICBkY3RUZW1wW2JhY2tQb3MgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5NZGN0U2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dFtpXSA9IGRjdFRlbXBbc2h1ZmZsZVRhYmxlW2ldXSAqIHRoaXMuU2NhbGU7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIEdlbmVyYXRlVHJpZ1RhYmxlcyhzaXplQml0cykgewogICAgICAgIGxldCBzaXplID0gMSA8PCBzaXplQml0czsKICAgICAgICBsZXQgb3V0ID0gewogICAgICAgICAgICBzaW46IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSksCiAgICAgICAgICAgIGNvczogbmV3IEZsb2F0NjRBcnJheShzaXplKQogICAgICAgIH07CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gTWF0aC5QSSAqICg0ICogaSArIDEpIC8gKDQgKiBzaXplKTsKICAgICAgICAgICAgb3V0LnNpbltpXSA9IE1hdGguc2luKHZhbHVlKTsKICAgICAgICAgICAgb3V0LmNvc1tpXSA9IE1hdGguY29zKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0KICAgIHN0YXRpYyBHZW5lcmF0ZVNodWZmbGVUYWJsZShzaXplQml0cykgewogICAgICAgIGxldCBzaXplID0gMSA8PCBzaXplQml0czsKICAgICAgICB2YXIgdGFibGUgPSBuZXcgSW50MzJBcnJheShzaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgICB0YWJsZVtpXSA9IEhDQVV0aWxGdW5jLlNpZ25lZEJpdFJldmVyc2UzMlRydW5jKGkgXiAoaSA+PiAxKSwgc2l6ZUJpdHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGFibGU7CiAgICB9CiAgICAvLyBSZVNoYXJwZXIgZGlzYWJsZSBvbmNlIFVudXNlZE1lbWJlci5Mb2NhbAogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIERvZXMgYSBUeXBlLTQgRENULiBJbnRlbmRlZCBmb3IgcmVmZXJlbmNlLgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iaW5wdXQiPlRoZSBpbnB1dCBhcnJheSBjb250YWluaW5nIHRoZSB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICAvLy8gPHBhcmFtIG5hbWU9Im91dHB1dCI+VGhlIG91dHB1dCBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgdHJhbnNmb3JtZWQgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXM8L3BhcmFtPgogICAgRGN0NFNsb3coaW5wdXQsIG91dHB1dCkgewogICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdGhpcy5NZGN0U2l6ZTsgaysrKSB7CiAgICAgICAgICAgIGxldCBzYW1wbGUgPSAwOwogICAgICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IHRoaXMuTWRjdFNpemU7IG4rKykgewogICAgICAgICAgICAgICAgbGV0IGFuZ2xlID0gTWF0aC5QSSAvIHRoaXMuTWRjdFNpemUgKiAoayArIDAuNSkgKiAobiArIDAuNSk7CiAgICAgICAgICAgICAgICBzYW1wbGUgKz0gTWF0aC5jb3MoYW5nbGUpICogaW5wdXRbbl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0W2tdID0gc2FtcGxlICogdGhpcy5TY2FsZTsKICAgICAgICB9CiAgICB9Cn0KSENBTWRjdC5fdGFibGVCaXRzID0gLTE7CkhDQU1kY3QuU2luVGFibGVzID0gW107CkhDQU1kY3QuQ29zVGFibGVzID0gW107CkhDQU1kY3QuU2h1ZmZsZVRhYmxlcyA9IFtdOwpjbGFzcyBIQ0FUYWJsZXMgewogICAgc3RhdGljIGlzTGl0dGxlRW5kaWFuKCkgewogICAgICAgIGxldCB0ZXN0ID0gbmV3IEZsb2F0NjRBcnJheShbMS4wXSk7CiAgICAgICAgbGV0IGR2ID0gbmV3IERhdGFWaWV3KHRlc3QuYnVmZmVyKTsKICAgICAgICBpZiAoZHYuZ2V0VWludDMyKDApICE9IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBhZGFwdEVuZGlhbm5lc3M2NDMyKGEpIHsKICAgICAgICBpZiAoYS5ieXRlTGVuZ3RoICUgOCAhPSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoIXRoaXMuaXNMaXR0bGVFbmRpYW4oKSkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgICAgIGxldCB0ZW1wID0gYVtpXTsKICAgICAgICAgICAgICAgIGFbaV0gPSBhW2kgKyAxXTsKICAgICAgICAgICAgICAgIGFbaSArIDFdID0gdGVtcDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYTsKICAgIH0KfQpfYiA9IEhDQVRhYmxlczsKSENBVGFibGVzLlF1YW50aXplU3BlY3RydW1CaXRzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDIsIDB4MDEsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bVZhbHVlID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDcsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDcsIDB4MDUsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDQsIDB4MDYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MEYsIDB4MDYsIDB4MDQsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDMsIDB4MDUsIDB4MEUsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDQsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDMsIDB4MEEsIDB4MEMsIDB4MEUsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDksIDB4MDcsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDYsIDB4MDgsIDB4MEEsIDB4MEMsIDB4MEUsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDksIDB4MDcsIDB4MDUsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDQsIDB4MDYsIDB4MDgsIDB4MEEsIDB4MEMsIDB4MEUKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1CaXRzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDEsIDB4MDEsIDB4MDIsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgMHgwMCwgMHgwMiwgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNSwgMHgwNiwgMHgwNywgMHgwOCwgMHgwOSwgMHgwQSwgMHgwQiwgMHgwQwpdKTsKSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtVmFsdWUgPSBbCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHhGRSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDEsIDB4RkYsIDB4RkYsIDB4MDIsIDB4MDIsIDB4RkUsIDB4RkUsIDB4MDMsIDB4MDMsIDB4RkQsIDB4RkQsIDB4MDQsIDB4RkMKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHgwMiwgMHhGRSwgMHhGRSwgMHgwMywgMHhGRCwgMHgwNCwgMHhGQywgMHgwNSwgMHhGQgogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweDAxLCAweEZGLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDA0LCAweEZDLCAweDA1LCAweEZCLCAweDA2LCAweEZBCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDIsIDB4RkUsIDB4MDMsIDB4RkQsIDB4MDQsIDB4RkMsIDB4MDUsIDB4RkIsIDB4MDYsIDB4RkEsIDB4MDcsIDB4RjkKICAgIF0pLApdOwpIQ0FUYWJsZXMuU2NhbGVUb1Jlc29sdXRpb25DdXJ2ZSA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4MEYsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEMsIDB4MEMsIDB4MEMsCiAgICAweDBDLCAweDBDLCAweDBDLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLAogICAgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwNywgMHgwNiwgMHgwNiwgMHgwNSwKICAgIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDEKXSk7CkhDQVRhYmxlcy5BdGhDdXJ2ZSA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4NzgsIDB4NUYsIDB4NTYsIDB4NTEsIDB4NEUsIDB4NEMsIDB4NEIsIDB4NDksIDB4NDgsIDB4NDgsIDB4NDcsIDB4NDYsIDB4NDYsIDB4NDUsIDB4NDUsIDB4NDUsCiAgICAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLAogICAgMHg0MiwgMHg0MiwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwKICAgIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELAogICAgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwKICAgIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsCiAgICAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLAogICAgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRiwKICAgIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLAogICAgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwKICAgIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsCiAgICAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLAogICAgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MywgMHg0MywgMHg0MywKICAgIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDQsIDB4NDQsCiAgICAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ1LCAweDQ1LCAweDQ1LCAweDQ1LAogICAgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwKICAgIDB4NDYsIDB4NDYsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDgsIDB4NDgsIDB4NDgsIDB4NDgsCiAgICAweDQ4LCAweDQ4LCAweDQ4LCAweDQ4LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDRBLCAweDRBLCAweDRBLCAweDRBLAogICAgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QywgMHg0QywgMHg0QywgMHg0QywgMHg0QywKICAgIDB4NEMsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEYsIDB4NEYsIDB4NEYsCiAgICAweDRGLCAweDRGLCAweDRGLCAweDUwLCAweDUwLCAweDUwLCAweDUwLCAweDUwLCAweDUxLCAweDUxLCAweDUxLCAweDUxLCAweDUxLCAweDUyLCAweDUyLCAweDUyLAogICAgMHg1MiwgMHg1MiwgMHg1MywgMHg1MywgMHg1MywgMHg1MywgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NSwgMHg1NSwgMHg1NSwgMHg1NSwgMHg1NiwKICAgIDB4NTYsIDB4NTYsIDB4NTYsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTgsIDB4NTgsIDB4NTgsIDB4NTksIDB4NTksIDB4NTksIDB4NTksIDB4NUEsCiAgICAweDVBLCAweDVBLCAweDVBLCAweDVCLCAweDVCLCAweDVCLCAweDVCLCAweDVDLCAweDVDLCAweDVDLCAweDVELCAweDVELCAweDVELCAweDVELCAweDVFLCAweDVFLAogICAgMHg1RSwgMHg1RiwgMHg1RiwgMHg1RiwgMHg2MCwgMHg2MCwgMHg2MCwgMHg2MSwgMHg2MSwgMHg2MSwgMHg2MSwgMHg2MiwgMHg2MiwgMHg2MiwgMHg2MywgMHg2MywKICAgIDB4NjMsIDB4NjQsIDB4NjQsIDB4NjQsIDB4NjUsIDB4NjUsIDB4NjYsIDB4NjYsIDB4NjYsIDB4NjcsIDB4NjcsIDB4NjcsIDB4NjgsIDB4NjgsIDB4NjgsIDB4NjksCiAgICAweDY5LCAweDZBLCAweDZBLCAweDZBLCAweDZCLCAweDZCLCAweDZCLCAweDZDLCAweDZDLCAweDZELCAweDZELCAweDZELCAweDZFLCAweDZFLCAweDZGLCAweDZGLAogICAgMHg3MCwgMHg3MCwgMHg3MCwgMHg3MSwgMHg3MSwgMHg3MiwgMHg3MiwgMHg3MywgMHg3MywgMHg3MywgMHg3NCwgMHg3NCwgMHg3NSwgMHg3NSwgMHg3NiwgMHg3NiwKICAgIDB4NzcsIDB4NzcsIDB4NzgsIDB4NzgsIDB4NzgsIDB4NzksIDB4NzksIDB4N0EsIDB4N0EsIDB4N0IsIDB4N0IsIDB4N0MsIDB4N0MsIDB4N0QsIDB4N0QsIDB4N0UsCiAgICAweDdFLCAweDdGLCAweDdGLCAweDgwLCAweDgwLCAweDgxLCAweDgxLCAweDgyLCAweDgzLCAweDgzLCAweDg0LCAweDg0LCAweDg1LCAweDg1LCAweDg2LCAweDg2LAogICAgMHg4NywgMHg4OCwgMHg4OCwgMHg4OSwgMHg4OSwgMHg4QSwgMHg4QSwgMHg4QiwgMHg4QywgMHg4QywgMHg4RCwgMHg4RCwgMHg4RSwgMHg4RiwgMHg4RiwgMHg5MCwKICAgIDB4OTAsIDB4OTEsIDB4OTIsIDB4OTIsIDB4OTMsIDB4OTQsIDB4OTQsIDB4OTUsIDB4OTUsIDB4OTYsIDB4OTcsIDB4OTcsIDB4OTgsIDB4OTksIDB4OTksIDB4OUEsCiAgICAweDlCLCAweDlCLCAweDlDLCAweDlELCAweDlELCAweDlFLCAweDlGLCAweEEwLCAweEEwLCAweEExLCAweEEyLCAweEEyLCAweEEzLCAweEE0LCAweEE1LCAweEE1LAogICAgMHhBNiwgMHhBNywgMHhBNywgMHhBOCwgMHhBOSwgMHhBQSwgMHhBQSwgMHhBQiwgMHhBQywgMHhBRCwgMHhBRSwgMHhBRSwgMHhBRiwgMHhCMCwgMHhCMSwgMHhCMSwKICAgIDB4QjIsIDB4QjMsIDB4QjQsIDB4QjUsIDB4QjYsIDB4QjYsIDB4QjcsIDB4QjgsIDB4QjksIDB4QkEsIDB4QkEsIDB4QkIsIDB4QkMsIDB4QkQsIDB4QkUsIDB4QkYsCiAgICAweEMwLCAweEMxLCAweEMxLCAweEMyLCAweEMzLCAweEM0LCAweEM1LCAweEM2LCAweEM3LCAweEM4LCAweEM5LCAweEM5LCAweENBLCAweENCLCAweENDLCAweENELAogICAgMHhDRSwgMHhDRiwgMHhEMCwgMHhEMSwgMHhEMiwgMHhEMywgMHhENCwgMHhENSwgMHhENiwgMHhENywgMHhEOCwgMHhEOSwgMHhEQSwgMHhEQiwgMHhEQywgMHhERCwKICAgIDB4REUsIDB4REYsIDB4RTAsIDB4RTEsIDB4RTIsIDB4RTMsIDB4RTQsIDB4RTUsIDB4RTYsIDB4RTcsIDB4RTgsIDB4RTksIDB4RUEsIDB4RUIsIDB4RUQsIDB4RUUsCiAgICAweEVGLCAweEYwLCAweEYxLCAweEYyLCAweEYzLCAweEY0LCAweEY1LCAweEY3LCAweEY4LCAweEY5LCAweEZBLCAweEZCLCAweEZDLCAweEZECl0pOwpIQ0FUYWJsZXMuTWRjdFdpbmRvdyA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgzRjQ2QTA5RSwgMHgwMDAwMDAwMCwgMHgzRjYwMzA3NywgMHgwMDAwMDAwMCwgMHgzRjZFMThBNywgMHgwMDAwMDAwMCwgMHgzRjc3NzI0RCwKICAgIDB4MjAwMDAwMDAsIDB4M0Y4MDk1MDEsIDB4MDAwMDAwMDAsIDB4M0Y4NjEwNDAsIDB4ODAwMDAwMDAsIDB4M0Y4QzI1MDksIDB4RTAwMDAwMDAsIDB4M0Y5MTY3RTIsCiAgICAweDQwMDAwMDAwLCAweDNGOTUwNzMyLCAweEEwMDAwMDAwLCAweDNGOThFRkY3LCAweDAwMDAwMDAwLCAweDNGOUQyMjIyLCAweEEwMDAwMDAwLCAweDNGQTBDRUY5LAogICAgMHg4MDAwMDAwMCwgMHgzRkEzMzFGOCwgMHg4MDAwMDAwMCwgMHgzRkE1QkE2QiwgMHg2MDAwMDAwMCwgMHgzRkE4NjhDOCwgMHgyMDAwMDAwMCwgMHgzRkFCM0Q5OCwKICAgIDB4MDAwMDAwMDAsIDB4M0ZBRTM5NzUsIDB4QzAwMDAwMDAsIDB4M0ZCMEFFODMsIDB4NjAwMDAwMDAsIDB4M0ZCMjU0ODIsIDB4ODAwMDAwMDAsIDB4M0ZCNDBGMTYsCiAgICAweDQwMDAwMDAwLCAweDNGQjVERUE0LCAweEMwMDAwMDAwLCAweDNGQjdDMzkzLCAweDYwMDAwMDAwLCAweDNGQjlCRTRGLCAweEEwMDAwMDAwLCAweDNGQkJDRjQzLAogICAgMHhBMDAwMDAwMCwgMHgzRkJERjZERCwgMHg2MDAwMDAwMCwgMHgzRkMwMUFDNSwgMHg0MDAwMDAwMCwgMHgzRkMxNDVEQiwgMHg0MDAwMDAwMCwgMHgzRkMyN0NFNSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZDM0MwMTYsIDB4NDAwMDAwMDAsIDB4M0ZDNTBGOUUsIDB4QTAwMDAwMDAsIDB4M0ZDNjZCQUEsIDB4MjAwMDAwMDAsIDB4M0ZDN0Q0NjQsCiAgICAweEEwMDAwMDAwLCAweDNGQzk0OUVFLCAweEUwMDAwMDAwLCAweDNGQ0FDQzY3LCAweEUwMDAwMDAwLCAweDNGQ0M1QkU2LCAweDIwMDAwMDAwLCAweDNGQ0RGODdBLAogICAgMHgwMDAwMDAwMCwgMHgzRkNGQTIyNywgMHg0MDAwMDAwMCwgMHgzRkQwQUM3NCwgMHhFMDAwMDAwMCwgMHgzRkQxOEU1NiwgMHgyMDAwMDAwMCwgMHgzRkQyNzZBQywKICAgIDB4RTAwMDAwMDAsIDB4M0ZEMzY1NUQsIDB4RTAwMDAwMDAsIDB4M0ZENDVBNEQsIDB4NjAwMDAwMDAsIDB4M0ZENTU1NTUsIDB4NDAwMDAwMDAsIDB4M0ZENjU2NDQsCiAgICAweEMwMDAwMDAwLCAweDNGRDc1Q0UwLCAweEUwMDAwMDAwLCAweDNGRDg2OEU2LCAweEEwMDAwMDAwLCAweDNGRDk3QTA3LCAweEMwMDAwMDAwLCAweDNGREE4RkU4LAogICAgMHgwMDAwMDAwMCwgMHgzRkRCQUEyNSwgMHg4MDAwMDAwMCwgMHgzRkRDQzg0QiwgMHhFMDAwMDAwMCwgMHgzRkRERTlERiwgMHhFMDAwMDAwMCwgMHgzRkRGMEU1QSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZFMDFBOTUsIDB4NDAwMDAwMDAsIDB4M0ZFMEFFRDksIDB4NjAwMDAwMDAsIDB4M0ZFMTQzQTcsIDB4MDAwMDAwMDAsIDB4M0ZFMUQ4QTksCiAgICAweEEwMDAwMDAwLCAweDNGRTI2RDg0LCAweDQwMDAwMDAwLCAweDNGRTMwMURFLCAweDQwMDAwMDAwLCAweDNGRTM5NTU4LCAweDQwMDAwMDAwLCAweDNGRTQyNzk0LAogICAgMHhBMDAwMDAwMCwgMHgzRkU0QjgzNCwgMHhFMDAwMDAwMCwgMHgzRkU1NDZEQywgMHgwMDAwMDAwMCwgMHgzRkU1RDMzMywgMHhBMDAwMDAwMCwgMHgzRkU2NUNFMCwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFNkUzOTMsIDB4QzAwMDAwMDAsIDB4M0ZFNzY2RkYsIDB4NDAwMDAwMDAsIDB4M0ZFN0U2REUsIDB4MDAwMDAwMDAsIDB4M0ZFODYyRjAsCiAgICAweEMwMDAwMDAwLCAweDNGRThEQUZDLCAweDgwMDAwMDAwLCAweDNGRTk0RUQ0LCAweDgwMDAwMDAwLCAweDNGRTlCRTRGLCAweEUwMDAwMDAwLCAweDNGRUEyOTRELAogICAgMHhBMDAwMDAwMCwgMHgzRkVBOEZCOCwgMHg2MDAwMDAwMCwgMHgzRkVBRjE4MCwgMHhDMDAwMDAwMCwgMHgzRkVCNEU5RCwgMHhFMDAwMDAwMCwgMHgzRkVCQTcxMCwKICAgIDB4RTAwMDAwMDAsIDB4M0ZFQkZBRTAsIDB4NDAwMDAwMDAsIDB4M0ZFQzRBMUIsIDB4MjAwMDAwMDAsIDB4M0ZFQzk0RDMsIDB4MDAwMDAwMDAsIDB4M0ZFQ0RCMjEsCiAgICAweEMwMDAwMDAwLCAweDNGRUQxRDIxLCAweDIwMDAwMDAwLCAweDNGRUQ1QUY2LCAweDIwMDAwMDAwLCAweDNGRUQ5NEMyLCAweDQwMDAwMDAwLCAweDNGRURDQUFDLAogICAgMHhFMDAwMDAwMCwgMHgzRkVERkNEQywgMHhFMDAwMDAwMCwgMHgzRkVFMkI3RCwgMHgyMDAwMDAwMCwgMHgzRkVFNTZCQSwgMHhDMDAwMDAwMCwgMHgzRkVFN0VCQywKICAgIDB4MjAwMDAwMDAsIDB4M0ZFRUEzQjEsIDB4NjAwMDAwMDAsIDB4M0ZFRUM1QzIsIDB4RTAwMDAwMDAsIDB4M0ZFRUU1MUEsIDB4MDAwMDAwMDAsIDB4M0ZFRjAxRTQsCiAgICAweDgwMDAwMDAwLCAweDNGRUYxQzQ2LCAweDgwMDAwMDAwLCAweDNGRUYzNDY5LCAweEUwMDAwMDAwLCAweDNGRUY0QTcyLCAweDIwMDAwMDAwLCAweDNGRUY1RTg3LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGNzBDOSwgMHhDMDAwMDAwMCwgMHgzRkVGODE1OSwgMHgwMDAwMDAwMCwgMHgzRkVGOTA1OSwgMHhDMDAwMDAwMCwgMHgzRkVGOURFNCwKICAgIDB4NjAwMDAwMDAsIDB4M0ZFRkFBMTksIDB4QzAwMDAwMDAsIDB4M0ZFRkI1MTEsIDB4RTAwMDAwMDAsIDB4M0ZFRkJFRTYsIDB4QzAwMDAwMDAsIDB4M0ZFRkM3QjAsCiAgICAweDQwMDAwMDAwLCAweDNGRUZDRjg1LCAweDgwMDAwMDAwLCAweDNGRUZENjc5LCAweEUwMDAwMDAwLCAweDNGRUZEQ0EwLCAweDgwMDAwMDAwLCAweDNGRUZFMjBELAogICAgMHg2MDAwMDAwMCwgMHgzRkVGRTZEMCwgMHg0MDAwMDAwMCwgMHgzRkVGRUFGOSwgMHhDMDAwMDAwMCwgMHgzRkVGRUU5NiwgMHhDMDAwMDAwMCwgMHgzRkVGRjFCNiwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFRkY0NjUsIDB4NjAwMDAwMDAsIDB4M0ZFRkY2QUYsIDB4QzAwMDAwMDAsIDB4M0ZFRkY4OUUsIDB4QTAwMDAwMDAsIDB4M0ZFRkZBM0QsCiAgICAweEEwMDAwMDAwLCAweDNGRUZGQjk1LCAweDIwMDAwMDAwLCAweDNGRUZGQ0FGLCAweDAwMDAwMDAwLCAweDNGRUZGRDkyLCAweEMwMDAwMDAwLCAweDNGRUZGRTQ1LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGRkVEMSwgMHgwMDAwMDAwMCwgMHgzRkVGRkYzQSwgMHg0MDAwMDAwMCwgMHgzRkVGRkY4NiwgMHg0MDAwMDAwMCwgMHgzRkVGRkZCQiwKICAgIDB4QTAwMDAwMDAsIDB4M0ZFRkZGREQsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRjEsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRkIsIDB4ODAwMDAwMDAsIDB4M0ZFRkZGRkYKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5EZWZhdWx0Q2hhbm5lbE1hcHBpbmcgPSBuZXcgVWludDhBcnJheShbCiAgICAweDAwLCAweDAxLCAweDAwLCAweDA0LCAweDAwLCAweDAxLCAweDAzLCAweDA3LCAweDAzCl0pOwpIQ0FUYWJsZXMuVmFsaWRDaGFubmVsTWFwcGluZ3MgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCl07CkhDQVRhYmxlcy5EZXF1YW50aXplclNjYWxpbmdUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHhDQTVEOTIwMSwgMHgzRTg1NTFBNCwgMHgyRTU3RDEzOSwgMHgzRThDNjdGMSwgMHhBOTNFMkY0QSwgMHgzRTkyRUNBRiwgMHhCMENEQzVENSwgMHgzRTk5MzczNywKICAgIDB4MkI3MjQ3RUQsIDB4M0VBMENDOTIsIDB4ODI1NTIyMTcsIDB4M0VBNjYyMzgsIDB4RjMwMUI0NEYsIDB4M0VBREQzMjEsIDB4NEMxMjM0MTYsIDB4M0VCM0RFQTYsCiAgICAweDEzMzBCMzQ5LCAweDNFQkE3OTlFLCAweEVCNkZDQjZDLCAweDNFQzFBMzVCLCAweDRGREU1RDMzLCAweDNFQzc4MDY5LCAweDVCNkU0NTJGLCAweDNFQ0Y1MDc2LAogICAgMHg5OUZEREQwMywgMHgzRUQ0RENCMiwgMHg5MDRCQzFDMywgMHgzRURCQ0MxRSwgMHhFMUY1NjM3OCwgMHgzRUUyODRERiwgMHg0MjJBQTBDRiwgMHgzRUU4QUNFNSwKICAgIDB4MjlEREY2RDYsIDB4M0VGMDcwNkIsIDB4MTVBRDIxM0UsIDB4M0VGNUU3NkYsIDB4MDgwRDg5RTMsIDB4M0VGRDJGODcsIDB4MzczQUE5QzIsIDB4M0YwMzcxQTcsCiAgICAweDE5RTMyMzE4LCAweDNGMDlFODYzLCAweEFFQTkyREQ4LCAweDNGMTE0MjlBLCAweEY5NTE5NDdCLCAweDNGMTZGRjdELCAweEEyQTQ5MENELCAweDNGMUVBNEFGLAogICAgMHhFRDFEMDA1MCwgMHgzRjI0NkE0MSwgMHhCODRGMTVGMCwgMHgzRjJCMzNBMiwgMHg5MTdEREM5MCwgMHgzRjMyMUY0OSwgMHg5OTRDQ0UwQSwgMHgzRjM4MjU4OSwKICAgIDB4QTlGQjMzMkYsIDB4M0Y0MDE2M0QsIDB4MzZCNTI3RDMsIDB4M0Y0NTZGNDcsIDB4OTQwNkU3QUMsIDB4M0Y0QzhGNkQsIDB4MEEzMUI3MEYsIDB4M0Y1MzA2RkUsCiAgICAweENCQzg1MjA3LCAweDNGNTk1QTQ0LCAweDMyRDNEMTlELCAweDNGNjBFM0VDLCAweEQ0NENBOTZDLCAweDNGNjY4MTU1LCAweDMzN0I5QjU2LCAweDNGNkRGQzk3LAogICAgMHgwNEFDODAxNiwgMHgzRjczRkE0NSwgMHg1NTc5RkRCOCwgMHgzRjdBOUU2QiwgMHg4NDA0NUNDRiwgMHgzRjgxQkJFMCwgMHg3M0VCMDE4MSwgMHgzRjg3QTExNCwKICAgIDB4QUQ5Q0JFMEMsIDB4M0Y4RjdCRkQsIDB4NzY5RDJDQTIsIDB4M0Y5NEY5QjIsIDB4NUJENzFFMDMsIDB4M0Y5QkYyQzIsIDB4RjUxRkRFREUsIDB4M0ZBMjlFOUQsCiAgICAweDE2QjU0NDg3LCAweDNGQThDRjMyLCAweDE4NzU5QkM1LCAweDNGQjA4NzQ1LCAweEI5NzZEQzA1LCAweDNGQjYwNUUxLCAweERDRkJBNDgzLCAweDNGQkQ1ODE4LAogICAgMHg2RDA1RDg2MywgMHgzRkMzOENBRSwgMHg3QjVERTU2MSwgMHgzRkNBMEM2NiwgMHhDOEE1OEU0RiwgMHgzRkQxNUE5OCwgMHhFOEVDNUY3MSwgMHgzRkQ3MUY3NSwKICAgIDB4MkQ4RTY3RUQsIDB4M0ZERUNGNDgsIDB4QjVDMTNDQ0UsIDB4M0ZFNDg2QTIsIDB4OERFNTU5MzgsIDB4M0ZFQjU5NzIsIDB4NkU3NTYyMzcsIDB4M0ZGMjM4N0EsCiAgICAweDQ2MjNDN0FDLCAweDNGRjg0NzFBLCAweDNFNzc4MDYwLCAweDQwMDAyQzlBLCAweEQ0OTdDN0ZELCAweDQwMDU4RDEyLCAweERDRUY5MDY4LCAweDQwMENCNzIwLAogICAgMHhGQzRDRDgzMSwgMHg0MDEzMjE3MCwgMHg5RkRFNEU1MCwgMHg0MDE5N0Q4MiwgMHhBRkZFRDMxQiwgMHg0MDIwRkI2NiwgMHg2NjdGM0JDRCwgMHg0MDI2QTA5RQpdKSkuYnVmZmVyKTsKSENBVGFibGVzLlF1YW50aXplclN0ZXBTaXplID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDU1NTU1NTU1LCAweDNGRTU1NTU1LCAweDk5OTk5OTlBLCAweDNGRDk5OTk5LCAweDkyNDkyNDkyLCAweDNGRDI0OTI0LAogICAgMHgxQzcxQzcxQywgMHgzRkNDNzFDNywgMHg3NDVEMTc0NiwgMHgzRkM3NDVEMSwgMHgxM0IxM0IxNCwgMHgzRkMzQjEzQiwgMHgxMTExMTExMSwgMHgzRkMxMTExMSwKICAgIDB4MDg0MjEwODQsIDB4M0ZCMDg0MjEsIDB4MTA0MTA0MTAsIDB4M0ZBMDQxMDQsIDB4ODEwMjA0MDgsIDB4M0Y5MDIwNDAsIDB4MTAxMDEwMTAsIDB4M0Y4MDEwMTAsCiAgICAweDAyMDEwMDgwLCAweDNGNzAwODA0LCAweDAwNDAxMDA0LCAweDNGNjAwNDAxLCAweDQwMDgwMTAwLCAweDNGNTAwMjAwLCAweDEwMDEwMDEwLCAweDNGNDAwMTAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUXVhbnRpemVyRGVhZFpvbmUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4RkZGRkZGRkYsIDB4RkZGRkZGRkYsIDB4NTU1NTU1NTMsIDB4M0ZENTU1NTUsIDB4OTk5OTk5OTcsIDB4M0ZDOTk5OTksIDB4OTI0OTI0OEUsIDB4M0ZDMjQ5MjQsCiAgICAweDFDNzFDNzE3LCAweDNGQkM3MUM3LCAweDc0NUQxNzQwLCAweDNGQjc0NUQxLCAweDEzQjEzQjBELCAweDNGQjNCMTNCLCAweDExMTExMTA5LCAweDNGQjExMTExLAogICAgMHgwODQyMTA3NCwgMHgzRkEwODQyMSwgMHgxMDQxMDNGMCwgMHgzRjkwNDEwNCwgMHg4MTAyMDNDOCwgMHgzRjgwMjA0MCwgMHgxMDEwMEY5MCwgMHgzRjcwMTAxMCwKICAgIDB4MDIwMEZGODAsIDB4M0Y2MDA4MDQsIDB4MDA0MDBFMDQsIDB4M0Y1MDA0MDEsIDB4NDAwN0ZEMDAsIDB4M0Y0MDAyMDAsIDB4MTAwMEY4MTAsIDB4M0YzMDAxMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJTY2FsaW5nVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4NTQzRTFBMjEsIDB4NDE1ODA0MjcsIDB4ODg2MjhDRTIsIDB4NDE1MjA2M0IsIDB4Mjk4REI2NzcsIDB4NDE0QjBFMDcsIDB4NjA2MTg5M0EsIDB4NDE0NDRFMDgsCiAgICAweEZCQzc0Qzk2LCAweDQxM0U3QTUxLCAweDNDNjUxQTNELCAweDQxMzZERkIyLCAweEMwNkMzMUQ2LCAweDQxMzEyQUJELCAweDgyQTNGMEEwLCAweDQxMjlDNDkxLAogICAgMHg1RjkyOUZGQywgMHg0MTIzNTZDNSwgMHg0QTA3ODk4QiwgMHg0MTFEMDcyRCwgMHg4QTU5NDZDMiwgMHg0MTE1QzkyNiwgMHhEMzE1ODU3RCwgMHg0MTEwNTlCMCwKICAgIDB4RDk4QTY2QTYsIDB4NDEwODhBQzcsIDB4NjVFMjdDRTcsIDB4NDEwMjZCNDUsIDB4MzBBMTA2NTYsIDB4NDBGQkE1QjAsIDB4RDUzNjJBMzIsIDB4NDBGNEJGREEsCiAgICAweDM3NkJCQUE2LCAweDQwRUYyNTJCLCAweDU2NDI2N0Q0LCAweDQwRTc1RkVCLCAweDM4OEM4REYyLCAweDQwRTE4QUY5LCAweEIyM0UyNTY4LCAweDQwREE1NTAzLAogICAgMHhDMzEzQThFRCwgMHg0MEQzQzMyRCwgMHgwM0RCMzI5MywgMHg0MENEQTlFNiwgMHgzNENDQzMyOCwgMHg0MEM2NDM0NiwgMHg2Q0Y5ODkxNiwgMHg0MEMwQjU1OCwKICAgIDB4MEI5MUZGQ0YsIDB4NDBCOTE0NUIsIDB4QTZFNDAzMTMsIDB4NDBCMkQyODUsIDB4NUZGRkQwODQsIDB4NDBBQzQwQUIsIDB4NTY5RDRGODksIDB4NDBBNTM0MkIsCiAgICAweDJCOEY3MUZFLCAweDQwOUZEM0MyLCAweDM2Q0Y0RTZBLCAweDQwOTdFMkYzLCAweDIyRkNEOTIyLCAweDQwOTFFRDUwLCAweDk5NUFEM0I2LCAweDQwOEFFODlGLAogICAgMHhEOTUwQTg5RCwgMHg0MDg0MzFGNSwgMHhFNzhCM0ZGRiwgMHg0MDdFNTAyRSwgMHg3NTBCREFDNiwgMHg0MDc2QzAxMiwgMHhEMDEyNUI1NiwgMHg0MDcxMTMwMSwKICAgIDB4NzBDQTA3QzEsIDB4NDA2OUEwRjEsIDB4QjI2NDE3MDUsIDB4NDA2MzNDMDgsIDB4NTU1REM0MDEsIDB4NDA1Q0RGMEIsIDB4REQ0ODU0MkYsIDB4NDA1NUFCMDcsCiAgICAweEU4NkU3Rjg5LCAweDQwNTA0MzE1LCAweDlCNDQ5MkYyLCAweDQwNDg2OEQ5LCAweDRGQjJBNjQzLCAweDQwNDI1MUNFLCAweEYyRkI1RTRDLCAweDQwM0I3Rjc2LAogICAgMHhGMEQ3RDNFMywgMHg0MDM0QTMyQSwgMHhFRTYxNUEyRCwgMHg0MDJFRkExQiwgMHg0OEE1ODE3OCwgMHg0MDI3M0Y5QSwgMHgzQzdENTE3RCwgMHg0MDIxNzJCOCwKICAgIDB4RUM0QTJEMzcsIDB4NDAxQTMwOUIsIDB4MzRFNTlGRkEsIDB4NDAxM0E3REIsIDB4MTZDOTgzOUIsIDB4NDAwRDgwRTMsIDB4QjAzQTU1ODcsIDB4NDAwNjI0N0UsCiAgICAweENBQzZGMzg1LCAweDQwMDA5RTNFLCAweDk5MTU3NzM5LCAweDNGRjhGMUFFLCAweEQwREFEOTkxLCAweDNGRjJCODdGLCAweEREODU1MjlFLCAweDNGRUMxOTlCLAogICAgMHhBMkNGNjY0MiwgMHgzRkU1MTZEQSwgMHg4MTlFOTBEQSwgMHgzRkRGQTdDMSwgMHgwMTMwQzEzMywgMHgzRkQ3QzFFRCwgMHgzMTY4QjlBQiwgMHgzRkQxRDQ4NywKICAgIDB4QkZEM0YzN0EsIDB4M0ZDQUMzNkIsIDB4MjFGNzJFMkEsIDB4M0ZDNDE2MEEsIDB4MTRGNUExMjksIDB4M0ZCRTI2NDYsIDB4NjY3RjNCQ0MsIDB4M0ZCNkEwOUUKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJJbnZlcnNlU3RlcFNpemUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4MDAwMDAwMDAsIDB4M0ZFMDAwMDAsIDB4MDAwMDAwMDAsIDB4M0ZGODAwMDAsIDB4MDAwMDAwMDAsIDB4NDAwNDAwMDAsIDB4MDAwMDAwMDAsIDB4NDAwQzAwMDAsCiAgICAweDAwMDAwMDAwLCAweDQwMTIwMDAwLCAweDAwMDAwMDAwLCAweDQwMTYwMDAwLCAweDAwMDAwMDAwLCAweDQwMUEwMDAwLCAweDAwMDAwMDAwLCAweDQwMUUwMDAwLAogICAgMHgwMDAwMDAwMCwgMHg0MDJGMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDNGODAwMCwgMHgwMDAwMDAwMCwgMHg0MDRGQzAwMCwgMHgwMDAwMDAwMCwgMHg0MDVGRTAwMCwKICAgIDB4MDAwMDAwMDAsIDB4NDA2RkYwMDAsIDB4MDAwMDAwMDAsIDB4NDA3RkY4MDAsIDB4MDAwMDAwMDAsIDB4NDA4RkZDMDAsIDB4MDAwMDAwMDAsIDB4NDA5RkZFMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5SZXNvbHV0aW9uTWF4VmFsdWVzID0gbmV3IEludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMSwgMHgwMDAwMDAwMiwgMHgwMDAwMDAwMywgMHgwMDAwMDAwNCwgMHgwMDAwMDAwNSwgMHgwMDAwMDAwNiwgMHgwMDAwMDAwNywKICAgIDB4MDAwMDAwMEYsIDB4MDAwMDAwMUYsIDB4MDAwMDAwM0YsIDB4MDAwMDAwN0YsIDB4MDAwMDAwRkYsIDB4MDAwMDAxRkYsIDB4MDAwMDAzRkYsIDB4MDAwMDA3RkYKXSk7CkhDQVRhYmxlcy5JbnRlbnNpdHlSYXRpb1RhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDQwMDAwMDAwLCAweDZEQjZEQjZFLCAweDNGRkRCNkRCLCAweERCNkRCNkRCLCAweDNGRkI2REI2LCAweDQ5MjQ5MjQ5LCAweDNGRjkyNDkyLAogICAgMHhCNkRCNkRCNywgMHgzRkY2REI2RCwgMHgyNDkyNDkyNSwgMHgzRkY0OTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkYyNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwKICAgIDB4REI2REI2REIsIDB4M0ZFQjZEQjYsIDB4QjZEQjZEQjcsIDB4M0ZFNkRCNkQsIDB4OTI0OTI0OTIsIDB4M0ZFMjQ5MjQsIDB4REI2REI2REIsIDB4M0ZEQjZEQjYsCiAgICAweDkyNDkyNDkyLCAweDNGRDI0OTI0LCAweDkyNDkyNDkyLCAweDNGQzI0OTI0LCAweDAwMDAwMDAwLCAweDAwMDAwMDAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9Cb3VuZHNUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHhCNkRCNkRCNywgMHgzRkZFREI2RCwgMHgyNDkyNDkyNSwgMHgzRkZDOTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkZBNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkY4MDAwMCwKICAgIDB4NkRCNkRCNkUsIDB4M0ZGNUI2REIsIDB4REI2REI2REIsIDB4M0ZGMzZEQjYsIDB4NDkyNDkyNDksIDB4M0ZGMTI0OTIsIDB4NkRCNkRCNkUsIDB4M0ZFREI2REIsCiAgICAweDQ5MjQ5MjQ5LCAweDNGRTkyNDkyLCAweDI0OTI0OTI1LCAweDNGRTQ5MjQ5LCAweDAwMDAwMDAwLCAweDNGRTAwMDAwLCAweEI2REI2REI3LCAweDNGRDZEQjZELAogICAgMHhEQjZEQjZEQiwgMHgzRkNCNkRCNiwgMHg5MjQ5MjQ5MiwgMHgzRkIyNDkyNApdKSkuYnVmZmVyKTsKSENBVGFibGVzLlNjYWxlQ29udmVyc2lvblRhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDIxRjcyRTFELCAweDNFNTQxNjBBLCAweEJGRDNGMzY4LCAweDNFNUFDMzZCLAogICAgMHgzMTY4Qjk5RiwgMHgzRTYxRDQ4NywgMHgwMTMwQzEyMywgMHgzRTY3QzFFRCwgMHg4MTlFOTBDNCwgMHgzRTZGQTdDMSwgMHhBMkNGNjYzNSwgMHgzRTc1MTZEQSwKICAgIDB4REQ4NTUyOEIsIDB4M0U3QzE5OUIsIDB4RDBEQUQ5ODUsIDB4M0U4MkI4N0YsIDB4OTkxNTc3MjgsIDB4M0U4OEYxQUUsIDB4Q0FDNkYzN0EsIDB4M0U5MDlFM0UsCiAgICAweEIwM0E1NTc4LCAweDNFOTYyNDdFLCAweDE2Qzk4Mzg4LCAweDNFOUQ4MEUzLCAweDM0RTU5RkVDLCAweDNFQTNBN0RCLCAweEVDNEEyRDI2LCAweDNFQUEzMDlCLAogICAgMHgzQzdENTE3MiwgMHgzRUIxNzJCOCwgMHg0OEE1ODE2OCwgMHgzRUI3M0Y5QSwgMHhFRTYxNUExOCwgMHgzRUJFRkExQiwgMHhGMEQ3RDNENCwgMHgzRUM0QTMyQSwKICAgIDB4RjJGQjVFM0EsIDB4M0VDQjdGNzYsIDB4NEZCMkE2MzcsIDB4M0VEMjUxQ0UsIDB4OUI0NDkyRTEsIDB4M0VEODY4RDksIDB4RTg2RTdGN0UsIDB4M0VFMDQzMTUsCiAgICAweERENDg1NDIwLCAweDNFRTVBQjA3LCAweDU1NURDM0VFLCAweDNFRUNERjBCLCAweEIyNjQxNkY3LCAweDNFRjMzQzA4LCAweDcwQ0EwN0IwLCAweDNFRjlBMEYxLAogICAgMHhEMDEyNUI0QSwgMHgzRjAxMTMwMSwgMHg3NTBCREFCNiwgMHgzRjA2QzAxMiwgMHhFNzhCM0ZFQiwgMHgzRjBFNTAyRSwgMHhEOTUwQTg5MCwgMHgzRjE0MzFGNSwKICAgIDB4OTk1QUQzQTQsIDB4M0YxQUU4OUYsIDB4MjJGQ0Q5MTcsIDB4M0YyMUVENTAsIDB4MzZDRjRFNUEsIDB4M0YyN0UyRjMsIDB4MkI4RjcxRTcsIDB4M0YyRkQzQzIsCiAgICAweDU2OUQ0RjdCLCAweDNGMzUzNDJCLCAweDVGRkZEMDcyLCAweDNGM0M0MEFCLCAweEE2RTQwMzA2LCAweDNGNDJEMjg1LCAweDBCOTFGRkJGLCAweDNGNDkxNDVCLAogICAgMHg2Q0Y5ODkwQiwgMHgzRjUwQjU1OCwgMHgzNENDQzMxQSwgMHgzRjU2NDM0NiwgMHgwM0RCMzI3RSwgMHgzRjVEQTlFNiwgMHhDMzEzQThFMCwgMHgzRjYzQzMyRCwKICAgIDB4QjIzRTI1NTcsIDB4M0Y2QTU1MDMsIDB4Mzg4QzhERTYsIDB4M0Y3MThBRjksIDB4NTY0MjY3QzQsIDB4M0Y3NzVGRUIsIDB4Mzc2QkJBOTIsIDB4M0Y3RjI1MkIsCiAgICAweEQ1MzYyQTI0LCAweDNGODRCRkRBLCAweDMwQTEwNjQ1LCAweDNGOEJBNUIwLCAweDY1RTI3Q0RBLCAweDNGOTI2QjQ1LCAweEQ5OEE2Njk2LCAweDNGOTg4QUM3LAogICAgMHhEMzE1ODU3MiwgMHgzRkEwNTlCMCwgMHg4QTU5NDZCNCwgMHgzRkE1QzkyNiwgMHg0QTA3ODk3OCwgMHgzRkFEMDcyRCwgMHg1RjkyOUZFRiwgMHgzRkIzNTZDNSwKICAgIDB4ODJBM0YwOEUsIDB4M0ZCOUM0OTEsIDB4QzA2QzMxQ0IsIDB4M0ZDMTJBQkQsIDB4M0M2NTFBMkQsIDB4M0ZDNkRGQjIsIDB4RkJDNzRDODIsIDB4M0ZDRTdBNTEsCiAgICAweDYwNjE4OTJDLCAweDNGRDQ0RTA4LCAweDI5OERCNjY1LCAweDNGREIwRTA3LCAweDg4NjI4Q0Q2LCAweDNGRTIwNjNCLCAweDU0M0UxQTExLCAweDNGRTgwNDI3LAogICAgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwgMHhDQTVEOTIwRiwgMHgzRkY1NTFBNCwgMHgyRTU3RDE0QywgMHgzRkZDNjdGMSwgMHhBOTNFMkY1NywgMHg0MDAyRUNBRiwKICAgIDB4QjBDREM1RTYsIDB4NDAwOTM3MzcsIDB4MkI3MjQ3RjgsIDB4NDAxMENDOTIsIDB4ODI1NTIyMjYsIDB4NDAxNjYyMzgsIDB4RjMwMUI0NjMsIDB4NDAxREQzMjEsCiAgICAweDRDMTIzNDI0LCAweDQwMjNERUE2LCAweDEzMzBCMzVCLCAweDQwMkE3OTlFLCAweEVCNkZDQjc3LCAweDQwMzFBMzVCLCAweDRGREU1RDQyLCAweDQwMzc4MDY5LAogICAgMHg1QjZFNDU0NCwgMHg0MDNGNTA3NiwgMHg5OUZEREQxMCwgMHg0MDQ0RENCMiwgMHg5MDRCQzFENiwgMHg0MDRCQ0MxRSwgMHhFMUY1NjM4NCwgMHg0MDUyODRERiwKICAgIDB4NDIyQUEwRTAsIDB4NDA1OEFDRTUsIDB4MjlEREY2RTEsIDB4NDA2MDcwNkIsIDB4MTVBRDIxNEQsIDB4NDA2NUU3NkYsIDB4MDgwRDg5RjgsIDB4NDA2RDJGODcsCiAgICAweDM3M0FBOUNGLCAweDQwNzM3MUE3LCAweDE5RTMyMzI5LCAweDQwNzlFODYzLCAweEFFQTkyREU0LCAweDQwODE0MjlBLCAweEY5NTE5NDhBLCAweDQwODZGRjdELAogICAgMHhBMkE0OTBFMSwgMHg0MDhFQTRBRiwgMHhFRDFEMDA1RCwgMHg0MDk0NkE0MSwgMHhCODRGMTYwMywgMHg0MDlCMzNBMiwgMHg5MTdEREM5QiwgMHg0MEEyMUY0OSwKICAgIDB4OTk0Q0NFMUEsIDB4NDBBODI1ODksIDB4QTlGQjMzM0EsIDB4NDBCMDE2M0QsIDB4MzZCNTI3RTEsIDB4NDBCNTZGNDcsIDB4OTQwNkU3QkYsIDB4NDBCQzhGNkQsCiAgICAweDBBMzFCNzFDLCAweDQwQzMwNkZFLCAweENCQzg1MjE4LCAweDQwQzk1QTQ0LCAweDMyRDNEMUE4LCAweDQwRDBFM0VDLCAweEQ0NENBOTdDLCAweDQwRDY4MTU1LAogICAgMHgzMzdCOUI2QSwgMHg0MERERkM5NywgMHgwNEFDODAyNCwgMHg0MEUzRkE0NSwgMHg1NTc5RkRDQSwgMHg0MEVBOUU2QiwgMHg4NDA0NUNEQiwgMHg0MEYxQkJFMCwKICAgIDB4NzNFQjAxOTEsIDB4NDBGN0ExMTQsIDB4QUQ5Q0JFMjEsIDB4NDBGRjdCRkQsIDB4NzY5RDJDQjAsIDB4NDEwNEY5QjIsIDB4NUJENzFFMTUsIDB4NDEwQkYyQzIsCiAgICAweEY1MUZERUVBLCAweDQxMTI5RTlELCAweDE2QjU0NDk4LCAweDQxMThDRjMyLCAweDE4NzU5QkQwLCAweDQxMjA4NzQ1LCAweEI5NzZEQzE0LCAweDQxMjYwNUUxLAogICAgMHhEQ0ZCQTQ5NiwgMHg0MTJENTgxOCwgMHg2RDA1RDg3MCwgMHg0MTMzOENBRSwgMHg3QjVERTU3MywgMHg0MTNBMEM2NiwgMHhDOEE1OEU1QiwgMHg0MTQxNUE5OCwKICAgIDB4RThFQzVGODEsIDB4NDE0NzFGNzUsIDB4MkQ4RTY4MDIsIDB4NDE0RUNGNDgsIDB4QjVDMTNDREMsIDB4NDE1NDg2QTIsIDB4OERFNTU5NEEsIDB4NDE1QjU5NzIsCiAgICAweDZFNzU2MjQzLCAweDQxNjIzODdBLCAweDQ2MjNDN0JDLCAweDQxNjg0NzFBLCAweDNFNzc4MDZCLCAweDQxNzAyQzlBLCAweEQ0OTdDODBCLCAweDQxNzU4RDEyLAogICAgMHhEQ0VGOTA3QywgMHg0MTdDQjcyMCwgMHhGQzRDRDgzRSwgMHg0MTgzMjE3MCwgMHg5RkRFNEU2MSwgMHg0MTg5N0Q4MiwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMApdKSkuYnVmZmVyKTsKY2xhc3MgSENBQ3JjMTYgewogICAgc3RhdGljIGNhbGMoZGF0YSwgc2l6ZSkgewogICAgICAgIGlmIChzaXplID4gZGF0YS5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoc2l6ZSA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKQogICAgICAgICAgICBzdW0gPSAoKHN1bSA8PCA4KSBeIHRoaXMuX3ZbKHN1bSA+PiA4KSBeIGRhdGFbaV1dKSAmIDB4MDAwMGZmZmY7CiAgICAgICAgcmV0dXJuIHN1bSAmIDB4MDAwMGZmZmY7CiAgICB9CiAgICBzdGF0aWMgdmVyaWZ5KGRhdGEsIHNpemUsIGV4cGVjdGVkLCBkb05vdFRocm93ID0gZmFsc2UpIHsKICAgICAgICBpZiAoZXhwZWN0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICBleHBlY3RlZCA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpLmdldFVpbnQxNihzaXplKTsKICAgICAgICB9CiAgICAgICAgbGV0IGFjdHVhbCA9IHRoaXMuY2FsYyhkYXRhLCBzaXplKTsKICAgICAgICBsZXQgcmVzdWx0ID0gZXhwZWN0ZWQgPT0gYWN0dWFsOwogICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIHRvSGV4KG51bSkgewogICAgICAgICAgICAgICAgY29uc3QgcGFkZGluZyA9ICIwMDAwIjsKICAgICAgICAgICAgICAgIGxldCBoZXggPSBwYWRkaW5nICsgbnVtLnRvU3RyaW5nKHBhZGRpbmcubGVuZ3RoICogNCkudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgIHJldHVybiAiMHgiICsgaGV4LnN1YnN0cmluZyhoZXgubGVuZ3RoIC0gcGFkZGluZy5sZW5ndGgsIGhleC5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBtc2cgPSBgY2hlY2tzdW0gbWlzbWF0Y2ggKGV4cGVjdGVkPSR7dG9IZXgoZXhwZWN0ZWQpfSBhY3R1YWw9JHt0b0hleChhY3R1YWwpfSlgOwogICAgICAgICAgICBpZiAoZG9Ob3RUaHJvdykKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBzdGF0aWMgZml4KGRhdGEsIHNpemUpIHsKICAgICAgICBsZXQgbmV3Q3JjMTYgPSB0aGlzLmNhbGMoZGF0YSwgc2l6ZSk7CiAgICAgICAgbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCkuc2V0VWludDE2KHNpemUsIG5ld0NyYzE2KTsKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KfQpIQ0FDcmMxNi5fdiA9IG5ldyBVaW50MTZBcnJheShbCiAgICAweDAwMDAsIDB4ODAwNSwgMHg4MDBGLCAweDAwMEEsIDB4ODAxQiwgMHgwMDFFLCAweDAwMTQsIDB4ODAxMSwgMHg4MDMzLCAweDAwMzYsIDB4MDAzQywgMHg4MDM5LCAweDAwMjgsIDB4ODAyRCwgMHg4MDI3LCAweDAwMjIsCiAgICAweDgwNjMsIDB4MDA2NiwgMHgwMDZDLCAweDgwNjksIDB4MDA3OCwgMHg4MDdELCAweDgwNzcsIDB4MDA3MiwgMHgwMDUwLCAweDgwNTUsIDB4ODA1RiwgMHgwMDVBLCAweDgwNEIsIDB4MDA0RSwgMHgwMDQ0LCAweDgwNDEsCiAgICAweDgwQzMsIDB4MDBDNiwgMHgwMENDLCAweDgwQzksIDB4MDBEOCwgMHg4MERELCAweDgwRDcsIDB4MDBEMiwgMHgwMEYwLCAweDgwRjUsIDB4ODBGRiwgMHgwMEZBLCAweDgwRUIsIDB4MDBFRSwgMHgwMEU0LCAweDgwRTEsCiAgICAweDAwQTAsIDB4ODBBNSwgMHg4MEFGLCAweDAwQUEsIDB4ODBCQiwgMHgwMEJFLCAweDAwQjQsIDB4ODBCMSwgMHg4MDkzLCAweDAwOTYsIDB4MDA5QywgMHg4MDk5LCAweDAwODgsIDB4ODA4RCwgMHg4MDg3LCAweDAwODIsCiAgICAweDgxODMsIDB4MDE4NiwgMHgwMThDLCAweDgxODksIDB4MDE5OCwgMHg4MTlELCAweDgxOTcsIDB4MDE5MiwgMHgwMUIwLCAweDgxQjUsIDB4ODFCRiwgMHgwMUJBLCAweDgxQUIsIDB4MDFBRSwgMHgwMUE0LCAweDgxQTEsCiAgICAweDAxRTAsIDB4ODFFNSwgMHg4MUVGLCAweDAxRUEsIDB4ODFGQiwgMHgwMUZFLCAweDAxRjQsIDB4ODFGMSwgMHg4MUQzLCAweDAxRDYsIDB4MDFEQywgMHg4MUQ5LCAweDAxQzgsIDB4ODFDRCwgMHg4MUM3LCAweDAxQzIsCiAgICAweDAxNDAsIDB4ODE0NSwgMHg4MTRGLCAweDAxNEEsIDB4ODE1QiwgMHgwMTVFLCAweDAxNTQsIDB4ODE1MSwgMHg4MTczLCAweDAxNzYsIDB4MDE3QywgMHg4MTc5LCAweDAxNjgsIDB4ODE2RCwgMHg4MTY3LCAweDAxNjIsCiAgICAweDgxMjMsIDB4MDEyNiwgMHgwMTJDLCAweDgxMjksIDB4MDEzOCwgMHg4MTNELCAweDgxMzcsIDB4MDEzMiwgMHgwMTEwLCAweDgxMTUsIDB4ODExRiwgMHgwMTFBLCAweDgxMEIsIDB4MDEwRSwgMHgwMTA0LCAweDgxMDEsCiAgICAweDgzMDMsIDB4MDMwNiwgMHgwMzBDLCAweDgzMDksIDB4MDMxOCwgMHg4MzFELCAweDgzMTcsIDB4MDMxMiwgMHgwMzMwLCAweDgzMzUsIDB4ODMzRiwgMHgwMzNBLCAweDgzMkIsIDB4MDMyRSwgMHgwMzI0LCAweDgzMjEsCiAgICAweDAzNjAsIDB4ODM2NSwgMHg4MzZGLCAweDAzNkEsIDB4ODM3QiwgMHgwMzdFLCAweDAzNzQsIDB4ODM3MSwgMHg4MzUzLCAweDAzNTYsIDB4MDM1QywgMHg4MzU5LCAweDAzNDgsIDB4ODM0RCwgMHg4MzQ3LCAweDAzNDIsCiAgICAweDAzQzAsIDB4ODNDNSwgMHg4M0NGLCAweDAzQ0EsIDB4ODNEQiwgMHgwM0RFLCAweDAzRDQsIDB4ODNEMSwgMHg4M0YzLCAweDAzRjYsIDB4MDNGQywgMHg4M0Y5LCAweDAzRTgsIDB4ODNFRCwgMHg4M0U3LCAweDAzRTIsCiAgICAweDgzQTMsIDB4MDNBNiwgMHgwM0FDLCAweDgzQTksIDB4MDNCOCwgMHg4M0JELCAweDgzQjcsIDB4MDNCMiwgMHgwMzkwLCAweDgzOTUsIDB4ODM5RiwgMHgwMzlBLCAweDgzOEIsIDB4MDM4RSwgMHgwMzg0LCAweDgzODEsCiAgICAweDAyODAsIDB4ODI4NSwgMHg4MjhGLCAweDAyOEEsIDB4ODI5QiwgMHgwMjlFLCAweDAyOTQsIDB4ODI5MSwgMHg4MkIzLCAweDAyQjYsIDB4MDJCQywgMHg4MkI5LCAweDAyQTgsIDB4ODJBRCwgMHg4MkE3LCAweDAyQTIsCiAgICAweDgyRTMsIDB4MDJFNiwgMHgwMkVDLCAweDgyRTksIDB4MDJGOCwgMHg4MkZELCAweDgyRjcsIDB4MDJGMiwgMHgwMkQwLCAweDgyRDUsIDB4ODJERiwgMHgwMkRBLCAweDgyQ0IsIDB4MDJDRSwgMHgwMkM0LCAweDgyQzEsCiAgICAweDgyNDMsIDB4MDI0NiwgMHgwMjRDLCAweDgyNDksIDB4MDI1OCwgMHg4MjVELCAweDgyNTcsIDB4MDI1MiwgMHgwMjcwLCAweDgyNzUsIDB4ODI3RiwgMHgwMjdBLCAweDgyNkIsIDB4MDI2RSwgMHgwMjY0LCAweDgyNjEsCiAgICAweDAyMjAsIDB4ODIyNSwgMHg4MjJGLCAweDAyMkEsIDB4ODIzQiwgMHgwMjNFLCAweDAyMzQsIDB4ODIzMSwgMHg4MjEzLCAweDAyMTYsIDB4MDIxQywgMHg4MjE5LCAweDAyMDgsIDB4ODIwRCwgMHg4MjA3LCAweDAyMDIKXSk7CmNsYXNzIEhDQUNpcGhlciB7CiAgICBjb25zdHJ1Y3RvcihrZXkxLCBrZXkyKSB7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMDsKICAgICAgICB0aGlzLmVuY3J5cHQgPSBmYWxzZTsKICAgICAgICB0aGlzLmtleTFidWYgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgICAgdGhpcy5rZXkyYnVmID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICAgIHRoaXMuX3RhYmxlID0gbmV3IFVpbnQ4QXJyYXkoMjU2KTsKICAgICAgICB0aGlzLmR2MSA9IG5ldyBEYXRhVmlldyh0aGlzLmtleTFidWYpOwogICAgICAgIHRoaXMuZHYyID0gbmV3IERhdGFWaWV3KHRoaXMua2V5MmJ1Zik7CiAgICAgICAgaWYgKGtleTEgPT0gbnVsbCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJubyBrZXlzIGdpdmVuLiB1c2UgXCJkZWZhdWx0a2V5XCIgaWYgeW91IHdhbnQgdG8gdXNlIHRoZSBkZWZhdWx0IGtleSIpOwogICAgICAgIHN3aXRjaCAoa2V5MSkgewogICAgICAgICAgICBjYXNlICJub25lIjoKICAgICAgICAgICAgY2FzZSAibm9rZXkiOgogICAgICAgICAgICBjYXNlICJub0tleSI6CiAgICAgICAgICAgIGNhc2UgIm5vIGtleSI6CiAgICAgICAgICAgIGNhc2UgIm5vX0tleSI6CiAgICAgICAgICAgICAgICB0aGlzLnNldFRvTm9LZXkoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZWZhdWx0a2V5IjoKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdEtleSI6CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHQga2V5IjoKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdF9rZXkiOgogICAgICAgICAgICAgICAgdGhpcy5zZXRUb0RlZktleXMoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAga2V5MSA9IEhDQUNpcGhlci5wYXJzZUtleShrZXkxKTsKICAgICAgICAgICAgICAgIGlmIChrZXkyID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrZXkyID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGtleTIgPSBIQ0FDaXBoZXIucGFyc2VLZXkoa2V5Mik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnNldEtleXMoa2V5MSwga2V5Mik7CiAgICAgICAgfQogICAgfQogICAgaW5pdDEoKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDEsIHYgPSAwOyBpIDwgMHhGRjsgaSsrKSB7CiAgICAgICAgICAgIHYgPSAodiAqIDEzICsgMTEpICYgMHhGRjsKICAgICAgICAgICAgaWYgKHYgPT0gMCB8fCB2ID09IDB4RkYpCiAgICAgICAgICAgICAgICB2ID0gKHYgKiAxMyArIDExKSAmIDB4RkY7CiAgICAgICAgICAgIHRoaXMuX3RhYmxlW2ldID0gdjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdGFibGVbMF0gPSAwOwogICAgICAgIHRoaXMuX3RhYmxlWzB4RkZdID0gMHhGRjsKICAgIH0KICAgIGluaXQ1NigpIHsKICAgICAgICBsZXQga2V5MSA9IHRoaXMuZ2V0S2V5MSgpOwogICAgICAgIGxldCBrZXkyID0gdGhpcy5nZXRLZXkyKCk7CiAgICAgICAgaWYgKCFrZXkxKQogICAgICAgICAgICBrZXkyLS07CiAgICAgICAga2V5MS0tOwogICAgICAgIHRoaXMuZHYxLnNldFVpbnQzMigwLCBrZXkxLCB0cnVlKTsKICAgICAgICB0aGlzLmR2Mi5zZXRVaW50MzIoMCwga2V5MiwgdHJ1ZSk7CiAgICAgICAgbGV0IHQxID0gdGhpcy5nZXRCeXRlc09mVHdvS2V5cygpOwogICAgICAgIGxldCB0MiA9IG5ldyBVaW50OEFycmF5KFsKICAgICAgICAgICAgdDFbMV0sIHQxWzFdIF4gdDFbNl0sIHQxWzJdIF4gdDFbM10sCiAgICAgICAgICAgIHQxWzJdLCB0MVsyXSBeIHQxWzFdLCB0MVszXSBeIHQxWzRdLAogICAgICAgICAgICB0MVszXSwgdDFbM10gXiB0MVsyXSwgdDFbNF0gXiB0MVs1XSwKICAgICAgICAgICAgdDFbNF0sIHQxWzRdIF4gdDFbM10sIHQxWzVdIF4gdDFbNl0sCiAgICAgICAgICAgIHQxWzVdLCB0MVs1XSBeIHQxWzRdLCB0MVs2XSBeIHQxWzFdLAogICAgICAgICAgICB0MVs2XQogICAgICAgIF0pOwogICAgICAgIGxldCB0MyA9IG5ldyBVaW50OEFycmF5KDB4MTAwKTsKICAgICAgICBsZXQgdDMxID0gbmV3IFVpbnQ4QXJyYXkoMHgxMCk7CiAgICAgICAgbGV0IHQzMiA9IG5ldyBVaW50OEFycmF5KDB4MTApOwogICAgICAgIHRoaXMuY3JlYXRlVGFibGUodDMxLCB0MVswXSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHQgPSAwOyBpIDwgMHgxMDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlVGFibGUodDMyLCB0MltpXSk7CiAgICAgICAgICAgIGxldCB2ID0gdDMxW2ldIDw8IDQ7CiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMHgxMDsgaisrKSB7CiAgICAgICAgICAgICAgICB0M1t0KytdID0gdiB8IHQzMltqXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMCwgdiA9IDAsIHQgPSAxOyBpIDwgMHgxMDA7IGkrKykgewogICAgICAgICAgICB2ID0gKHYgKyAweDExKSAmIDB4RkY7CiAgICAgICAgICAgIGxldCBhID0gdDNbdl07CiAgICAgICAgICAgIGlmIChhICE9IDAgJiYgYSAhPSAweEZGKQogICAgICAgICAgICAgICAgdGhpcy5fdGFibGVbdCsrXSA9IGE7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3RhYmxlWzBdID0gMDsKICAgICAgICB0aGlzLl90YWJsZVsweEZGXSA9IDB4RkY7CiAgICB9CiAgICBjcmVhdGVUYWJsZShyLCBrZXkpIHsKICAgICAgICBsZXQgbXVsID0gKChrZXkgJiAxKSA8PCAzKSB8IDU7CiAgICAgICAgbGV0IGFkZCA9IChrZXkgJiAweEUpIHwgMTsKICAgICAgICBsZXQgdCA9IDA7CiAgICAgICAga2V5ID4+PSA0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMHgxMDsgaSsrKSB7CiAgICAgICAgICAgIGtleSA9IChrZXkgKiBtdWwgKyBhZGQpICYgMHhGOwogICAgICAgICAgICByW3QrK10gPSBrZXk7CiAgICAgICAgfQogICAgfQogICAgaW52ZXJ0VGFibGUoKSB7CiAgICAgICAgLy8gYWN0dWFsbHksIHRoaXMgbWV0aG9kIHN3aXRjaCB0aGUgbW9kZSBiZXR3ZWVuIGVuY3J5cHQvZGVjcnlwdAogICAgICAgIHRoaXMuZW5jcnlwdCA9ICF0aGlzLmVuY3J5cHQ7CiAgICAgICAgbGV0IF9vbGRfdGFibGUgPSB0aGlzLl90YWJsZS5zbGljZSgwKTsKICAgICAgICBsZXQgYml0TWFwID0gbmV3IFVpbnQxNkFycmF5KDE2KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI1NjsgaSsrKSB7CiAgICAgICAgICAgIC8vIGludmVydCBrZXkgYW5kIHZhbHVlCiAgICAgICAgICAgIGxldCBrZXkgPSBfb2xkX3RhYmxlW2ldOwogICAgICAgICAgICBsZXQgdmFsID0gaTsKICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGluY29uc2lzdGVuY3kKICAgICAgICAgICAgbGV0IGhpZ2hlcjQgPSBrZXkgPj4gNCAmIDB4MEY7CiAgICAgICAgICAgIGxldCBsb3dlcjQgPSBrZXkgJiAweDBGOwogICAgICAgICAgICBsZXQgZmxhZyA9IDB4MDEgPDwgbG93ZXI0OwogICAgICAgICAgICBpZiAoYml0TWFwW2hpZ2hlcjRdICYgZmxhZykKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiX3RhYmxlIGlzIG5vdCBiaWplY3RpdmUiKTsKICAgICAgICAgICAgLy8gdXBkYXRlIHRhYmxlCiAgICAgICAgICAgIHRoaXMuX3RhYmxlW2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgZ2V0VHlwZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jaXBoZXJUeXBlOwogICAgfQogICAgZ2V0RW5jcnlwdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNyeXB0OwogICAgfQogICAgZ2V0S2V5MSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5kdjEuZ2V0VWludDMyKDAsIHRydWUpOwogICAgfQogICAgZ2V0S2V5MigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kdjIuZ2V0VWludDMyKDAsIHRydWUpOwogICAgfQogICAgZ2V0Qnl0ZXNPZlR3b0tleXMoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDgpOwogICAgICAgIGJ1Zi5zZXQobmV3IFVpbnQ4QXJyYXkodGhpcy5rZXkxYnVmKSwgMCk7CiAgICAgICAgYnVmLnNldChuZXcgVWludDhBcnJheSh0aGlzLmtleTJidWYpLCA0KTsKICAgICAgICByZXR1cm4gYnVmOwogICAgfQogICAgc2V0S2V5MShrZXkpIHsKICAgICAgICB0aGlzLmR2MS5zZXRVaW50MzIoMCwga2V5LCB0cnVlKTsKICAgICAgICB0aGlzLmluaXQ1NigpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4Mzg7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBzZXRLZXkyKGtleSkgewogICAgICAgIHRoaXMuZHYyLnNldFVpbnQzMigwLCBrZXksIHRydWUpOwogICAgICAgIHRoaXMuaW5pdDU2KCk7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMHgzODsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHNldEtleXMoa2V5MSwga2V5MikgewogICAgICAgIHRoaXMuZHYxLnNldFVpbnQzMigwLCBrZXkxLCB0cnVlKTsKICAgICAgICB0aGlzLmR2Mi5zZXRVaW50MzIoMCwga2V5MiwgdHJ1ZSk7CiAgICAgICAgdGhpcy5pbml0NTYoKTsKICAgICAgICB0aGlzLmNpcGhlclR5cGUgPSAweDM4OwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgc2V0VG9EZWZLZXlzKCkgewogICAgICAgIHJldHVybiB0aGlzLnNldEtleXMoSENBQ2lwaGVyLmRlZktleTEsIEhDQUNpcGhlci5kZWZLZXkyKTsKICAgIH0KICAgIHNldFRvTm9LZXkoKSB7CiAgICAgICAgdGhpcy5pbml0MSgpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4MDE7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBtYXNrKGJsb2NrLCBvZmZzZXQsIHNpemUpIHsKICAgICAgICAvLyBlbmNyeXB0IG9yIGRlY3J5cHQgYmxvY2sgZGF0YQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKQogICAgICAgICAgICBibG9ja1tvZmZzZXQgKyBpXSA9IHRoaXMuX3RhYmxlW2Jsb2NrW29mZnNldCArIGldXTsKICAgIH0KICAgIHN0YXRpYyBpc0hDQUhlYWRlck1hc2tlZChoY2EpIHsKICAgICAgICAvLyBmYXN0ICYgZGlydHkgd2F5IHRvIGRldGVybWluZSB3aGV0aGVyIGVuY3J5cHRlZCwgbm90IHJlY29tbWVuZGVkCiAgICAgICAgaWYgKGhjYVswXSAmIDB4ODAgfHwgaGNhWzFdICYgMHg4MCB8fCBoY2FbMl0gJiAweDgwKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHN0YXRpYyBwYXJzZUtleShrZXkpIHsKICAgICAgICBzd2l0Y2ggKHR5cGVvZiBrZXkpIHsKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgICAvLyBhdm9pZCBhbWJpZ3VpdHk6IGFsd2F5cyB0cmVhdCBhcyBoZXgKICAgICAgICAgICAgICAgIGlmICgha2V5Lm1hdGNoKC9eMHgvKSkKICAgICAgICAgICAgICAgICAgICBrZXkgPSAiMHgiICsga2V5OwogICAgICAgICAgICAgICAga2V5ID0gcGFyc2VJbnQoa2V5KTsKICAgICAgICAgICAgICAgIGlmIChpc05hTihrZXkpKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IHBhcnNlIGFzIGludGVnZXIiKTsKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAvLyBhdm9pZCBlbmRpYW5uZXNzIGFtYmlndWl0eTogb25seSBhY2NlcHRpbmcgVWludDhBcnJheSwgdGhlbiByZWFkIGFzIGxpdHRsZSBlbmRpYW4KICAgICAgICAgICAgICAgIGlmIChrZXkgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGtleS5ieXRlTGVuZ3RoID09IDQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGFWaWV3KGtleS5idWZmZXIsIGtleS5ieXRlT2Zmc2V0LCBrZXkuYnl0ZUxlbmd0aCkuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW4gb25seSBhY2NlcHQgbnVtYmVyL2hleCBzdHJpbmcvVWludDhBcnJheVs0XSIpOwogICAgICAgIH0KICAgIH0KfQpIQ0FDaXBoZXIuZGVmS2V5MSA9IDB4MDEzOTVDNTE7CkhDQUNpcGhlci5kZWZLZXkyID0gMHgwMDAwMDAwMDsKLy8gY29udmVydCBub24tdHJhbnNmZXJhYmxlIHR5cGVkIGFycmF5IHRvIHRyYW5zZmVyYWJsZSBhcnJheSBidWZmZXIKY2xhc3MgSENBVHJhbnNUeXBlZEFycmF5IHsKICAgIGNvbnN0cnVjdG9yKHRhLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBjb25zdCB0eXBlID0gSENBVHJhbnNUeXBlZEFycmF5LmdldFR5cGUodGEpOwogICAgICAgIGlmICh0eXBlICE9IG51bGwpCiAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGUudHlwZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5leHBlY3RlZCB0eXBlIik7CiAgICAgICAgdGhpcy5idWZmZXIgPSB0YS5idWZmZXI7CiAgICAgICAgdGhpcy5ieXRlT2Zmc2V0ID0gdGEuYnl0ZU9mZnNldDsKICAgICAgICB0aGlzLmxlbmd0aCA9IHRhLmxlbmd0aDsKICAgICAgICBpZiAoIXRyYW5zZmVyTGlzdC5maW5kKCh2YWwpID0+IHZhbCA9PT0gdGhpcy5idWZmZXIpKQogICAgICAgICAgICB0cmFuc2Zlckxpc3QucHVzaCh0aGlzLmJ1ZmZlcik7CiAgICB9CiAgICBzdGF0aWMgY29udmVydChhcmcsIHRyYW5zZmVyTGlzdCkgewogICAgICAgIGlmICh0aGlzLmdldFR5cGUoYXJnKSAhPSBudWxsKQogICAgICAgICAgICByZXR1cm4gbmV3IEhDQVRyYW5zVHlwZWRBcnJheShhcmcsIHRyYW5zZmVyTGlzdCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gYXJnOwogICAgfQogICAgc3RhdGljIHJlc3RvcmUoYXJnKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMuZ2V0VHlwZShhcmcpOwogICAgICAgIGlmICh0eXBlICE9IG51bGwgJiYgdHlwZS5jb252ZXJ0ZWQpCiAgICAgICAgICAgIHJldHVybiBhcmcuYXJyYXk7CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gYXJnOwogICAgfQogICAgc3RhdGljIGdldFR5cGUoYXJnKSB7CiAgICAgICAgaWYgKGFyZyA9PSBudWxsIHx8IHR5cGVvZiBhcmcgIT09ICJvYmplY3QiKQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDhBcnJheSkKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkludDgiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgSW50MTZBcnJheSkKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkludDE2IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDMyQXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJJbnQzMiIgfTsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBVaW50OEFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiVWludDgiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDE2QXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJVaW50MTYiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDMyQXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJVaW50MzIiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiRmxvYXQzMiIgfTsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBGbG9hdDY0QXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJGbG9hdDY0IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZy5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciAmJiB0eXBlb2YgYXJnLnR5cGUgPT09ICJzdHJpbmciKQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IHRydWUsIHR5cGU6IGFyZy50eXBlIH07CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgZ2V0IGFycmF5KCkgewogICAgICAgIHN3aXRjaCAodGhpcy50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgIkludDgiOiByZXR1cm4gbmV3IEludDhBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIkludDE2IjogcmV0dXJuIG5ldyBJbnQxNkFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiSW50MzIiOiByZXR1cm4gbmV3IEludDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJVaW50OCI6IHJldHVybiBuZXcgVWludDhBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIlVpbnQxNiI6IHJldHVybiBuZXcgVWludDE2QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJVaW50MzIiOiByZXR1cm4gbmV3IFVpbnQzMkFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiRmxvYXQzMiI6IHJldHVybiBuZXcgRmxvYXQzMkFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiRmxvYXQ2NCI6IHJldHVybiBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bmV4cGVjdGVkIHR5cGUiKTsKICAgIH0KfQpjbGFzcyBIQ0FUYXNrIHsKICAgIGNvbnN0cnVjdG9yKG9yaWdpbiwgdGFza0lELCBjbWQsIGFyZ3MsIHJlcGx5QXJncywgaXNEdW1teSkgewogICAgICAgIHRoaXMudHJhbnNmZXJMaXN0ID0gW107CiAgICAgICAgdGhpcy5faGFzUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5vcmlnaW4gPSBvcmlnaW47CiAgICAgICAgdGhpcy50YXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgdGhpcy5jbWQgPSBjbWQ7CiAgICAgICAgdGhpcy5fYXJncyA9IGFyZ3MgPT09IG51bGwgfHwgYXJncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXJncy5tYXAoKGFyZykgPT4gSENBVHJhbnNUeXBlZEFycmF5LmNvbnZlcnQoYXJnLCB0aGlzLnRyYW5zZmVyTGlzdCkpOwogICAgICAgIHRoaXMuX3JlcGx5QXJncyA9IHJlcGx5QXJnczsKICAgICAgICBpZiAoaXNEdW1teSAhPSBudWxsICYmIGlzRHVtbXkpCiAgICAgICAgICAgIHRoaXMuaXNEdW1teSA9IHRydWU7CiAgICB9CiAgICBnZXQgYXJncygpIHsKICAgICAgICB2YXIgX2M7CiAgICAgICAgcmV0dXJuIChfYyA9IHRoaXMuX2FyZ3MpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5tYXAoKGFyZykgPT4gSENBVHJhbnNUeXBlZEFycmF5LnJlc3RvcmUoYXJnKSk7CiAgICB9CiAgICBnZXQgaGFzUmVzdWx0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNSZXN1bHQ7CiAgICB9CiAgICBnZXQgcmVzdWx0KCkgewogICAgICAgIGlmICghdGhpcy5faGFzUmVzdWx0KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIHJlc3VsdCIpOwogICAgICAgIHJldHVybiBIQ0FUcmFuc1R5cGVkQXJyYXkucmVzdG9yZSh0aGlzLl9yZXN1bHQpOwogICAgfQogICAgc2V0IHJlc3VsdChyZXN1bHQpIHsKICAgICAgICBpZiAodGhpcy5oYXNFcnIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYWxyZWFkeSBoYXMgZXJyb3IsIGNhbm5vdCBzZXQgcmVzdWx0Iik7CiAgICAgICAgaWYgKHRoaXMuX2hhc1Jlc3VsdCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3Qgc2V0IHJlc3VsdCBhZ2FpbiIpOwogICAgICAgIHRoaXMuX3Jlc3VsdCA9IEhDQVRyYW5zVHlwZWRBcnJheS5jb252ZXJ0KHJlc3VsdCwgdGhpcy50cmFuc2Zlckxpc3QpOwogICAgICAgIHRoaXMuX2hhc1Jlc3VsdCA9IHRydWU7CiAgICAgICAgaWYgKCF0aGlzLl9yZXBseUFyZ3MpCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9hcmdzOwogICAgfQogICAgZ2V0IGhhc0VycigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZXJyTXNnICE9IG51bGw7CiAgICB9CiAgICBnZXQgZXJyTXNnKCkgewogICAgICAgIHJldHVybiB0aGlzLl9lcnJNc2c7CiAgICB9CiAgICBzZXQgZXJyTXNnKG1zZykgewogICAgICAgIC8vIGNoYW5naW5nIGVyck1zZyBpcyBhbGxvd2VkLCBidXQgY2xlYXJpbmcgZXJyTXNnIGlzIGRpc2FsbG93ZWQKICAgICAgICBpZiAodHlwZW9mIG1zZyAhPT0gInN0cmluZyIpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZXJyb3IgbWVzc2FnZSBtdXN0IGJlIGEgc3RyaW5nIik7CiAgICAgICAgZGVsZXRlIHRoaXMuX2FyZ3M7CiAgICAgICAgaWYgKHRoaXMuX2hhc1Jlc3VsdCkgewogICAgICAgICAgICAvLyBjbGVhciByZXN1bHQgb24gZXJyb3IKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3Jlc3VsdDsKICAgICAgICAgICAgdGhpcy5faGFzUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudHJhbnNmZXJMaXN0ID0gW107CiAgICAgICAgICAgIHRoaXMuYXJncy5mb3JFYWNoKChhcmcpID0+IEhDQVRyYW5zVHlwZWRBcnJheS5jb252ZXJ0KGFyZywgdGhpcy50cmFuc2Zlckxpc3QpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fZXJyTXNnID0gbXNnOwogICAgfQogICAgc3RhdGljIHJlY3JlYXRlKHRhc2spIHsKICAgICAgICBjb25zdCByZWNyZWF0ZWQgPSBuZXcgSENBVGFzayh0YXNrLm9yaWdpbiwgdGFzay50YXNrSUQsIHRhc2suY21kLCB0YXNrLl9hcmdzLCB0YXNrLl9yZXBseUFyZ3MpOwogICAgICAgIGlmICh0YXNrLl9lcnJNc2cgIT0gbnVsbCkKICAgICAgICAgICAgcmVjcmVhdGVkLmVyck1zZyA9IHRhc2suX2Vyck1zZzsKICAgICAgICBlbHNlIGlmICh0YXNrLl9oYXNSZXN1bHQpCiAgICAgICAgICAgIHJlY3JlYXRlZC5yZXN1bHQgPSB0YXNrLl9yZXN1bHQ7CiAgICAgICAgcmV0dXJuIHJlY3JlYXRlZDsKICAgIH0KfQpjbGFzcyBIQ0FUYXNrUXVldWUgewogICAgY29uc3RydWN0b3Iob3JpZ2luLCBwb3N0TWVzc2FnZSwgdGFza0hhbmRsZXIsIGRlc3Ryb3kpIHsKICAgICAgICB0aGlzLl9pc0FsaXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzSWRsZSA9IHRydWU7CiAgICAgICAgLy8gY29tcGFyaW5nIHRvIHN0cnVjdHVyZWQgY29weSAoYnkgZGVmYXVsdCksIGlmIGRhdGEgc2l6ZSBpcyBiaWcgKGJlY2F1c2Ugb2YgemVyby1jb3B5KSwKICAgICAgICAvLyB0cmFuc2ZlcnJpbmcgaXMgZ2VuZXJhbGx5IG11Y2ggZmFzdGVyLiBob3dldmVyIGl0IG9idmlvdXNseSBoYXMgYSBkcmF3YmFjaywKICAgICAgICAvLyB0aGF0IHRyYW5zZmVycmVkIGFyZ3VtZW50cyBhcmUgbm8gbG9uZ2VyIGFjY2Vzc2libGUgaW4gdGhlIHNlbmRlciB0aHJlYWQKICAgICAgICB0aGlzLnRyYW5zZmVyQXJncyA9IGZhbHNlOwogICAgICAgIC8vIHRoZSByZWNlaXZlci9jYWxsZWUgd2lsbCBhbHdheXMgdXNlIHRyYW5zZmVycmluZyB0byBzZW5kIGJhY2sgYXJndW1lbnRzLAogICAgICAgIC8vIG5vdCBzZW5kaW5nIHRoZSBhcmd1bWVudHMgYmFjayBpcyBzdXBwb3NlZCB0byBzYXZlIGEgbGl0dGxlIHRpbWUvb3ZlcmhlYWQKICAgICAgICB0aGlzLnJlcGx5QXJncyA9IGZhbHNlOwogICAgICAgIHRoaXMucXVldWUgPSBbXTsKICAgICAgICB0aGlzLl9sYXN0VGFza0lEID0gMDsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IHt9OwogICAgICAgIHRoaXMub3JpZ2luID0gb3JpZ2luOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UgPSBwb3N0TWVzc2FnZTsKICAgICAgICB0aGlzLnRhc2tIYW5kbGVyID0gdGFza0hhbmRsZXI7CiAgICAgICAgdGhpcy5kZXN0cm95ID0gZGVzdHJveTsKICAgIH0KICAgIGdldE5leHRUYXNrSUQoKSB7CiAgICAgICAgY29uc3QgbWF4ID0gSENBVGFza1F1ZXVlLm1heFRhc2tJRCAtIDE7CiAgICAgICAgaWYgKHRoaXMuX2xhc3RUYXNrSUQgPCAwIHx8IHRoaXMuX2xhc3RUYXNrSUQgPiBtYXgpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibGFzdFRhc2tJRCBvdXQgb2YgcmFuZ2UiKTsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX2xhc3RUYXNrSUQgKyAxOwogICAgICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8PSBzdGFydCArIG1heDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHRhc2tJRCA9IGkgJSAobWF4ICsgMSk7CiAgICAgICAgICAgIGlmICh0aGlzLmNhbGxiYWNrc1t0YXNrSURdID09IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbGFzdFRhc2tJRCA9IHRhc2tJRDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3QgZmluZCBuZXh0IHRhc2tJRCIpOwogICAgfQogICAgc2VuZFRhc2sodGFzaykgewogICAgICAgIGlmICh0YXNrLm9yaWdpbiAhPT0gdGhpcy5vcmlnaW4pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidGhlIHRhc2sgdG8gYmUgc2VudCBtdXN0IGhhdmUgdGhlIHNhbWUgb3JpZ2luIGFzIHRoZSB0YXNrIHF1ZXVlIik7CiAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSh0YXNrLCB0aGlzLnRyYW5zZmVyQXJncyA/IHRhc2sudHJhbnNmZXJMaXN0IDogW10pOwogICAgfQogICAgc2VuZFJlcGx5KHRhc2spIHsKICAgICAgICBpZiAodGFzay5vcmlnaW4gPT09IHRoaXMub3JpZ2luKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoZSByZXBseSB0byBiZSBzZW50IG11c3Qgbm90IGhhdmUgdGhlIHNhbWUgb3JpZ2luIGFzIHRoZSB0YXNrIHF1ZXVlIik7CiAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSh0YXNrLCB0YXNrLnRyYW5zZmVyTGlzdCk7IC8vIGFsd2F5cyB1c2UgdHJhbnNmZXJyaW5nIHRvIHNlbmQgYmFjayBhcmd1bWVudHMKICAgIH0KICAgIGFzeW5jIHNlbmROZXh0VGFzaygpIHsKICAgICAgICBsZXQgdGFzayA9IHRoaXMucXVldWUuc2hpZnQoKTsKICAgICAgICBpZiAodGFzayA9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuaXNJZGxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuaXNJZGxlID0gZmFsc2U7CiAgICAgICAgICAgIC8vIGFwcGx5IGhvb2sgZmlyc3QKICAgICAgICAgICAgY29uc3QgcmVnaXN0ZXJlZCA9IHRoaXMuY2FsbGJhY2tzW3Rhc2sudGFza0lEXTsKICAgICAgICAgICAgY29uc3QgdGFza0hvb2sgPSByZWdpc3RlcmVkICE9IG51bGwgJiYgcmVnaXN0ZXJlZC5ob29rICE9IG51bGwgJiYgcmVnaXN0ZXJlZC5ob29rLnRhc2sgIT0gbnVsbAogICAgICAgICAgICAgICAgPyByZWdpc3RlcmVkLmhvb2sudGFzawogICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmICh0YXNrSG9vayAhPSBudWxsKQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB0YXNrID0gYXdhaXQgdGFza0hvb2sodGFzayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBhcHBseWluZyBob29rIGAKICAgICAgICAgICAgICAgICAgICAgICAgKyBgYmVmb3JlIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlID09PSAic3RyaW5nIiB8fCBlIGluc3RhbmNlb2YgRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnICs9ICJcbiIgKyBlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgdGFzay5pc0R1bW15ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2VuZCB0YXNrCiAgICAgICAgICAgIGlmICh0YXNrLmlzRHVtbXkpIHsKICAgICAgICAgICAgICAgIGlmICghdGFzay5oYXNFcnIgJiYgIXRhc2suaGFzUmVzdWx0KQogICAgICAgICAgICAgICAgICAgIHRhc2sucmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIGNvbnN0IGV2ID0gbmV3IE1lc3NhZ2VFdmVudCgibWVzc2FnZSIsIHsgZGF0YTogdGFzayB9KTsgLy8gbm90IGFjdHVhbGx5IHNlbmRpbmcsIHVzZSBhIGZha2UgcmVwbHkKICAgICAgICAgICAgICAgIHRoaXMubXNnSGFuZGxlcihldik7IC8vIHdvbid0IGF3YWl0CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlbmRUYXNrKHRhc2spOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZ2V0IGlzQWxpdmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzQWxpdmU7CiAgICB9CiAgICAvLyB0aGVzZSBmb2xsb3dpbmcgdHdvIG1ldGhvZHMvZnVuY3Rpb25zIGFyZSBzdXBwb3NlZCB0byBiZSBjYWxsYmFja3MKICAgIGFzeW5jIG1zZ0hhbmRsZXIoZXYpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB0YXNrID0gSENBVGFzay5yZWNyZWF0ZShldi5kYXRhKTsKICAgICAgICAgICAgaWYgKHRhc2sub3JpZ2luICE9PSB0aGlzLm9yaWdpbikgewogICAgICAgICAgICAgICAgLy8gaW5jb21pbmcgY21kIHRvIGV4ZWN1dGUKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdGFzay5yZXN1bHQgPSBhd2FpdCB0aGlzLnRhc2tIYW5kbGVyKHRhc2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIG9ic2VydmVkIHRoYXQgRmlyZWZveCByZWZ1c2VzIHRvIHBvc3RNZXNzYWdlIGFuIEVycm9yIG9iamVjdDoKICAgICAgICAgICAgICAgICAgICAvLyAiRGF0YUNsb25lRXJyb3I6IFRoZSBvYmplY3QgY291bGQgbm90IGJlIGNsb25lZC4iCiAgICAgICAgICAgICAgICAgICAgLy8gKG9ic2VydmVkIGluIEZpcmVmb3ggOTcsIG5vdCBjbGVhciBhYm91dCBvdGhlciB2ZXJzaW9ucykKICAgICAgICAgICAgICAgICAgICAvLyBDaHJvbWUgZG9lc24ndCBzZWVtIHRvIGhhdmUgdGhpcyBwcm9ibGVtLAogICAgICAgICAgICAgICAgICAgIC8vIGhvd2V2ZXIsIGluIG9yZGVyIHRvIGtlZXAgY29tcGF0aWJsZSB3aXRoIEZpcmVmb3gsCiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc3RpbGwgaGF2ZSB0byBhdm9pZCBwb3N0aW5nIGFuIEVycm9yIG9iamVjdAogICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBleGVjdXRpbmcgY21kICR7dGFzay5jbWR9IGZyb20gJHt0YXNrLm9yaWdpbn1gOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRhc2sudGFza0lEICE9IEhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQpCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gc2VuZFJlcGx5IGZhaWxlZC5gLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSAodGFzay5lcnJNc2cgPT0gbnVsbCA/ICIiIDogdGFzay5lcnJNc2cgKyAiXG5cbiIpICsgInBvc3RNZXNzYWdlIGZyb20gV29ya2VyIGZhaWxlZCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IGFnYWluCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZFJlcGx5KHRhc2spOyAvLyBpZiBpdCB0aHJvd3MsIGp1c3QgbGV0IGl0IHRocm93CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgLy8gcmVjZWl2aW5nIGNtZCByZXN1bHQKICAgICAgICAgICAgICAgIC8vIGZpbmQgJiB1bnJlZ2lzdGVyIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBjb25zdCByZWdpc3RlcmVkID0gdGhpcy5jYWxsYmFja3NbdGFzay50YXNrSURdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW3Rhc2sudGFza0lEXTsKICAgICAgICAgICAgICAgIC8vIGFwcGx5IGhvb2sKICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSB0YXNrLmhhc1Jlc3VsdCA/IHRhc2sucmVzdWx0IDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgY29uc3QgaG9vayA9IHJlZ2lzdGVyZWQuaG9vazsKICAgICAgICAgICAgICAgIGlmIChob29rICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2suaGFzRXJyICYmIGhvb2suZXJyb3IgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGhvb2suZXJyb3IodGFzay5lcnJNc2cpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0YXNrLmhhc1Jlc3VsdCAmJiBob29rLnJlc3VsdCAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgaG9vay5yZXN1bHQodGFzay5yZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBhcHBseWluZyBob29rIGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgYGFmdGVyIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzZXR0bGUgcHJvbWlzZQogICAgICAgICAgICAgICAgaWYgKHRhc2suaGFzRXJyKSB7CiAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJlZC5yZWplY3QodGFzay5lcnJNc2cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodGFzay5oYXNSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICByZWdpc3RlcmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhc2sgKG9yaWdpbj0ke3Rhc2sub3JpZ2lufSB0YXNrSUQ9JHt0YXNrLnRhc2tJRH0gY21kPSR7dGFzay5jbWR9KSBgCiAgICAgICAgICAgICAgICAgICAgICAgICsgYGhhcyBuZWl0aGVyIGVycm9yIG5vciByZXN1bHRgKTsgLy8gc2hvdWxkIG5ldmVyIGhhcHBlbgogICAgICAgICAgICAgICAgLy8gc3RhcnQgbmV4dCB0YXNrCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIGlycmVjb3ZlcmFibGUgZXJyb3IKICAgICAgICAgICAgYXdhaXQgdGhpcy5lcnJIYW5kbGVyKGUpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGVyckhhbmRsZXIoZGF0YSkgewogICAgICAgIC8vIGlycmVjb3ZlcmFibGUgZXJyb3IKICAgICAgICBpZiAodGhpcy5faXNBbGl2ZSkgewogICAgICAgICAgICAvLyBwcmludCBlcnJvciBtZXNzYWdlCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZGVzdHJveWluZyBiYWNrZ3JvdW5kIHdvcmtlciBvbiBpcnJlY292ZXJhYmxlIGVycm9yYCwgZGF0YSk7CiAgICAgICAgICAgIC8vIGRlc3Ryb3kgYmFja2dyb3VuZCB3b3JrZXIKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gdHJ5aW5nIHRvIGRlc3Ryb3koKWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFmdGVyIGRlc3Ryb3ksIG1hcmsgaXNBbGl2ZSBhcyBmYWxzZSAob3RoZXJ3aXNlIHNlbmRDbWQgd2lsbCBmYWlsKQogICAgICAgICAgICB0aGlzLl9pc0FsaXZlID0gZmFsc2U7CiAgICAgICAgICAgIC8vIHJlamVjdCBhbGwgcGVuZGluZyBwcm9taXNlcwogICAgICAgICAgICBmb3IgKGxldCB0YXNrSUQgaW4gdGhpcy5jYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlamVjdCA9IHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0ucmVqZWN0OwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF07CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlamVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHJlamVjdGluZyB0YXNrSUQ9JHt0YXNrSUR9YCwgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBnZXRUcmFuc2ZlckNvbmZpZygpIHsKICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWNDbWQoIm5vcCIsIFtdLCB7IHJlc3VsdDogKCkgPT4gKHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyQXJnczogdGhpcy50cmFuc2ZlckFyZ3MsCiAgICAgICAgICAgICAgICByZXBseUFyZ3M6IHRoaXMucmVwbHlBcmdzCiAgICAgICAgICAgIH0pIH0pOwogICAgfQogICAgYXN5bmMgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWNDbWQoIm5vcCIsIFtdLCB7IHJlc3VsdDogKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy50cmFuc2ZlckFyZ3MgPSB0cmFuc2ZlckFyZ3MgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnJlcGx5QXJncyA9IHJlcGx5QXJncyA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgfSB9KTsKICAgIH0KICAgIGFzeW5jIGV4ZWNDbWQoY21kLCBhcmdzLCBob29rKSB7CiAgICAgICAgLy8gY2FuIGJlIG1vZGlmaWVkIHRvIHNpbXBseSB3cmFwIGV4ZWNNdWx0aUNtZCBidXQgSSBqdXN0IHdhbnQgdG8gbGV0IGl0IGFsb25lIGZvciBubyBzcGVjaWFsIHJlYXNvbgogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgLy8gYXNzaWduIG5ldyB0YXNrSUQKICAgICAgICBjb25zdCB0YXNrSUQgPSB0aGlzLmdldE5leHRUYXNrSUQoKTsKICAgICAgICBjb25zdCB0YXNrID0gbmV3IEhDQVRhc2sodGhpcy5vcmlnaW4sIHRhc2tJRCwgY21kLCBhcmdzLCB0aGlzLnJlcGx5QXJncyk7CiAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbdGFza0lEXSAhPSBudWxsKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhc2tJRD0ke3Rhc2tJRH0gaXMgYWxyZWFkeSBvY2N1cGllZGApOwogICAgICAgIGNvbnN0IHJlc3VsdFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLmNhbGxiYWNrc1t0YXNrSURdID0geyByZXNvbHZlOiByZXNvbHZlLCByZWplY3Q6IHJlamVjdCwKICAgICAgICAgICAgaG9vazogaG9vayB9KTsKICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgIHRoaXMucXVldWUucHVzaCh0YXNrKTsKICAgICAgICAvLyBzdGFydCBleGVjdXRpbmcgdGFza3MKICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VuZE5leHRUYXNrKCk7CiAgICAgICAgLy8gcmV0dXJuIHJlc3VsdAogICAgICAgIHJldHVybiBhd2FpdCByZXN1bHRQcm9taXNlOwogICAgfQogICAgYXN5bmMgZXhlY011bHRpQ21kKGNtZExpc3QpIHsKICAgICAgICAvLyB0aGUgcG9pbnQgaXMgdG8gZW5zdXJlICJhdG9taWNpdHkiIGJldHdlZW4gY21kcwogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgbGV0IHJlc3VsdFByb21pc2VzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjbWRMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIC8vIGFzc2lnbiBuZXcgdGFza0lECiAgICAgICAgICAgIGNvbnN0IHRhc2tJRCA9IHRoaXMuZ2V0TmV4dFRhc2tJRCgpOwogICAgICAgICAgICBjb25zdCBsaXN0SXRlbSA9IGNtZExpc3RbaV07CiAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBuZXcgSENBVGFzayh0aGlzLm9yaWdpbiwgdGFza0lELCBsaXN0SXRlbS5jbWQsIGxpc3RJdGVtLmFyZ3MsIHRoaXMucmVwbHlBcmdzKTsKICAgICAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGFza0lEPSR7dGFza0lEfSBpcyBhbHJlYWR5IG9jY3VwaWVkYCk7CiAgICAgICAgICAgIHJlc3VsdFByb21pc2VzLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gdGhpcy5jYWxsYmFja3NbdGFza0lEXSA9IHsgcmVzb2x2ZTogcmVzb2x2ZSwgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgICAgICBob29rOiBsaXN0SXRlbS5ob29rIH0pKTsKICAgICAgICAgICAgLy8gYXBwZW5kIHRvIGNvbW1hbmQgcXVldWUKICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHRhc2spOwogICAgICAgIH0KICAgICAgICAvLyBzdGFydCBleGVjdXRpbmcgdGFza3MKICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VuZE5leHRUYXNrKCk7CiAgICAgICAgLy8gcmV0dXJuIHJlc3VsdHMKICAgICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwocmVzdWx0UHJvbWlzZXMpOwogICAgfQogICAgc2VuZENtZChjbWQsIGFyZ3MpIHsKICAgICAgICAvLyBzZW5kIGNtZCB3aXRob3V0IHJlZ2lzdGVyaW5nIGNhbGxiYWNrCiAgICAgICAgLy8gZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZAogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgY29uc3QgdGFzayA9IG5ldyBIQ0FUYXNrKHRoaXMub3JpZ2luLCBIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lELCBjbWQsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB0aGlzLnNlbmRUYXNrKHRhc2spOwogICAgfQogICAgYXN5bmMgc2h1dGRvd24oZm9yY2libHkgPSBmYWxzZSkgewogICAgICAgIGlmICh0aGlzLl9pc0FsaXZlKSB7CiAgICAgICAgICAgIGlmIChmb3JjaWJseSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIHRyeWluZyB0byBmb3JjaWJseSBzaHV0ZG93bi5gLCBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2lzQWxpdmUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmV4ZWNDbWQoIm5vcCIsIFtdLCB7IHJlc3VsdDogYXN5bmMgKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faXNBbGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0gfSk7CiAgICAgICAgfQogICAgfQp9CkhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgPSAyNTY7IC8vIHRoZXJlJ3MgcmVjdXJzaW9uIGluIHNlbmROZXh0VGFzayB3aGVuIG1ha2luZyBmYWtlIHJlcGx5CkhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQgPSAtMTsKaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2Ygb25tZXNzYWdlID09PSAidW5kZWZpbmVkIikgOwogICAgZWxzZSB7CiAgICAgICAgLy8gV2ViIFdvcmtlcgogICAgICAgIGNvbnN0IHRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIkJhY2tncm91bmQtSENBV29ya2VyIiwgKG1zZywgdHJhbnMpID0+IHBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gewogICAgICAgICAgICBzd2l0Y2ggKHRhc2suY21kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJub3AiOgogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgImZpeEhlYWRlckNoZWNrc3VtIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBSW5mby5maXhIZWFkZXJDaGVja3N1bS5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZml4Q2hlY2tzdW0iOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZml4Q2hlY2tzdW0uYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjcnlwdCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQS5kZWNyeXB0LmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImVuY3J5cHQiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZW5jcnlwdC5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBjYXNlICJhZGRDaXBoZXJIZWFkZXIiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0FJbmZvLmFkZENpcGhlckhlYWRlci5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjb2RlIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBLmRlY29kZS5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBjbWQgJHt0YXNrLmNtZH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0sICgpID0+IHsgdGFza1F1ZXVlLnNlbmRDbWQoInNlbGYtZGVzdHJ1Y3QiLCBbXSk7IH0pOwogICAgICAgIG9ubWVzc2FnZSA9IChldikgPT4gdGFza1F1ZXVlLm1zZ0hhbmRsZXIoZXYpOwogICAgfQp9Ci8vIGNyZWF0ZSAmIGNvbnRyb2wgd29ya2VyCmNsYXNzIEhDQVdvcmtlciB7CiAgICBjb25zdHJ1Y3RvcihzZWxmVXJsKSB7CiAgICAgICAgdGhpcy5sYXN0VGljayA9IDA7CiAgICAgICAgdGhpcy5oY2FXb3JrZXIgPSBuZXcgV29ya2VyKHNlbGZVcmwsIHsgdHlwZTogIm1vZHVsZSIgfSk7IC8vIHNldHRpbmcgdHlwZSB0byAibW9kdWxlIiBpcyBjdXJyZW50bHkgYm9ndXMgaW4gRmlyZWZveAogICAgICAgIHRoaXMuc2VsZlVybCA9IHNlbGZVcmw7CiAgICAgICAgdGhpcy50YXNrUXVldWUgPSBuZXcgSENBVGFza1F1ZXVlKCJNYWluLUhDQVdvcmtlciIsIChtc2csIHRyYW5zKSA9PiB0aGlzLmhjYVdvcmtlci5wb3N0TWVzc2FnZShtc2csIHRyYW5zKSwgYXN5bmMgKHRhc2spID0+IHsKICAgICAgICAgICAgc3dpdGNoICh0YXNrLmNtZCkgewogICAgICAgICAgICAgICAgY2FzZSAic2VsZi1kZXN0cnVjdCI6IC8vIGRvZXNuJ3Qgc2VlbSB0byBoYXZlIGEgY2hhbmNlIHRvIGJlIGNhbGxlZAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGhjYVdvcmtlciByZXF1ZXN0ZWQgdG8gc2VsZi1kZXN0cnVjdGApOwogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudGFza1F1ZXVlLnNodXRkb3duKHRydWUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfSwgKCkgPT4gdGhpcy5oY2FXb3JrZXIudGVybWluYXRlKCkpOwogICAgICAgIHRoaXMuaGNhV29ya2VyLm9ubWVzc2FnZSA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLm1zZ0hhbmRsZXIobXNnKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbmVycm9yID0gKG1zZykgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihtc2cpOwogICAgICAgIHRoaXMuaGNhV29ya2VyLm9ubWVzc2FnZWVycm9yID0gKG1zZykgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihtc2cpOwogICAgfQogICAgZ2V0IGlzQWxpdmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGFza1F1ZXVlLmlzQWxpdmU7CiAgICB9CiAgICBhc3luYyBzaHV0ZG93bihmb3JjaWJseSA9IGZhbHNlKSB7CiAgICAgICAgaWYgKHRoaXMudGFza1F1ZXVlLmlzQWxpdmUpCiAgICAgICAgICAgIGF3YWl0IHRoaXMudGFza1F1ZXVlLnNodXRkb3duKGZvcmNpYmx5KTsKICAgIH0KICAgIGFzeW5jIHRpY2soKSB7CiAgICAgICAgYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgibm9wIiwgW10pOwogICAgICAgIHRoaXMubGFzdFRpY2sgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0KICAgIGFzeW5jIHRvY2sodGV4dCA9ICIiKSB7CiAgICAgICAgYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgibm9wIiwgW10pOwogICAgICAgIGNvbnN0IGR1cmF0aW9uID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aGlzLmxhc3RUaWNrOwogICAgICAgIGNvbnNvbGUubG9nKGAke3RleHR9IHRvb2sgJHtkdXJhdGlvbn0gbXNgKTsKICAgICAgICByZXR1cm4gZHVyYXRpb247CiAgICB9CiAgICBzdGF0aWMgYXN5bmMgY3JlYXRlKHNlbGZVcmwpIHsKICAgICAgICBpZiAodHlwZW9mIHNlbGZVcmwgPT09ICJzdHJpbmciKQogICAgICAgICAgICBzZWxmVXJsID0gbmV3IFVSTChzZWxmVXJsLCBkb2N1bWVudC5iYXNlVVJJKTsKICAgICAgICBlbHNlIGlmICghKHNlbGZVcmwgaW5zdGFuY2VvZiBVUkwpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNlbGZVcmwgbXVzdCBiZSBlaXRoZXIgc3RyaW5nIG9yIFVSTCIpOwogICAgICAgIC8vIGZldGNoICYgc2F2ZSBoY2EuanMgYXMgYmxvYiBpbiBhZHZhbmNlLCB0byBhdm9pZCBjcmVhdGluZyB3b3JrZXIgYmVpbmcgYmxvY2tlZCBsYXRlciwgbGlrZToKICAgICAgICAvLyAoSSBvYnNlcnZlZCB0aGlzIHByb2JsZW0gaW4gRmlyZWZveCkKICAgICAgICAvLyBjcmVhdGluZyBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIgcmVxdWlyZXMgaW5mb3JtYXRpb24gZnJvbSBIQ0EsIHdoaWNoIGlzIHNhbXBsZSByYXRlIGFuZCBjaGFubmVsIGNvdW50OwogICAgICAgIC8vIGhvd2V2ZXIsIGZldGNoaW5nIEhDQSAob3JpZ2luYWxseSBzdXBwb3NlZCB0byBiZSBwcm9ncmVzc2l2ZS9zdHJlYW1lZCkgYmxvY2tzIGxhdGVyIHJlcXVlc3QgdG8gZmV0Y2ggaGNhLmpzLAogICAgICAgIC8vIHNvIHRoYXQgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIGNhbiBvbmx5IGJlIGNyZWF0ZWQgYWZ0ZXIgZmluaXNoaW5nIGRvd25sb2FkaW5nIHRoZSB3aG9sZSBIQ0EsCiAgICAgICAgLy8gd2hpY2ggb2J2aW91c2x5IGRlZmVhdHMgdGhlIHB1cnBvc2Ugb2Ygc3RyZWFtaW5nIEhDQQogICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goc2VsZlVybC5ocmVmKTsKICAgICAgICAvLyBGaXJlZm94IGN1cnJlbnRseSBkb2VzIG5vdCBzdXBwb3J0IEVDTUFTY3JpcHQgbW9kdWxlcyBpbiBXb3JrZXIsCiAgICAgICAgLy8gdGhlcmVmb3JlIHdlIG11c3Qgc3RyaXAgYWxsIGV4cG9ydCBkZWNsYXJhdGlvbnMKICAgICAgICBjb25zdCBvcmlnVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTsKICAgICAgICBjb25zdCBjb252ZXJ0ZWRUZXh0ID0gKCJcbiIgKyBvcmlnVGV4dCkucmVwbGFjZSgvXGJleHBvcnRccyt7Lio/fTs/LywgIiIpLnNsaWNlKDEpOwogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbY29udmVydGVkVGV4dF0sIHsgdHlwZTogInRleHQvamF2YXNjcmlwdCIgfSk7CiAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChibG9iKTsKICAgICAgICBjb25zdCBkYXRhVVJJID0gYXdhaXQgbmV3IFByb21pc2UoKHJlcykgPT4gewogICAgICAgICAgICByZWFkZXIub25sb2FkZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmVzKHJlYWRlci5yZXN1bHQpOwogICAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgICAgIHNlbGZVcmwgPSBuZXcgVVJMKGRhdGFVUkksIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgIHJldHVybiBuZXcgSENBV29ya2VyKHNlbGZVcmwpOwogICAgfQogICAgLy8gY29tbWFuZHMKICAgIGFzeW5jIGdldFRyYW5zZmVyQ29uZmlnKCkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5nZXRUcmFuc2ZlckNvbmZpZygpOwogICAgfQogICAgYXN5bmMgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpOwogICAgfQogICAgYXN5bmMgZml4SGVhZGVyQ2hlY2tzdW0oaGNhKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpeEhlYWRlckNoZWNrc3VtIiwgW2hjYV0pOwogICAgfQogICAgYXN5bmMgZml4Q2hlY2tzdW0oaGNhKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpeENoZWNrc3VtIiwgW2hjYV0pOwogICAgfQogICAgYXN5bmMgZGVjcnlwdChoY2EsIGtleTEsIGtleTIpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiZGVjcnlwdCIsIFtoY2EsIGtleTEsIGtleTJdKTsKICAgIH0KICAgIGFzeW5jIGVuY3J5cHQoaGNhLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImVuY3J5cHQiLCBbaGNhLCBrZXkxLCBrZXkyXSk7CiAgICB9CiAgICBhc3luYyBhZGRIZWFkZXIoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiYWRkSGVhZGVyIiwgW2hjYSwgc2lnLCBuZXdEYXRhXSk7CiAgICB9CiAgICBhc3luYyBhZGRDaXBoZXJIZWFkZXIoaGNhLCBjaXBoZXJUeXBlKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImFkZENpcGhlckhlYWRlciIsIFtoY2EsIGNpcGhlclR5cGVdKTsKICAgIH0KICAgIGFzeW5jIGRlY29kZShoY2EsIG1vZGUgPSAzMiwgbG9vcCA9IDAsIHZvbHVtZSA9IDEuMCkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJkZWNvZGUiLCBbaGNhLCBtb2RlLCBsb29wLCB2b2x1bWVdKTsKICAgIH0KfQoKZXhwb3J0IHsgSENBLCBIQ0FJbmZvLCBIQ0FXb3JrZXIgfTsK", document.baseURI);
        var hcaJsModule, hcaJsObjUrl, HCAInfo, HCAWorker;

        // mime types
        const defMimeType = "application/octet-stream";
        const mimeTypeMap = {
            wav: "audio/x-wav",
            hca: defMimeType,
        }

        // HCAWorker instance
        var worker = null;

        // dragged file
        var draggedFile = null;

        // local file picker
        const localfile = document.getElementById("localfile");
        const localfileform = document.getElementById("localfileform");
        // reset state on refresh
        // https://bugzilla.mozilla.org/show_bug.cgi?id=685657
        localfileform.reset();

        // input HCA URL
        const urlinput = document.getElementById("urlinput");

        // file name
        var fileName = null;

        // HCA info table
        const hcaInfoTable = {
            el: document.getElementById("hcaInfoTable"),
            body: {
                el: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0],
                defText: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0]
                    .getElementsByTagName("td")[0]
                    .textContent,
                data: {},
            },
        }
        Object.defineProperty(hcaInfoTable.body, "data", {
            get: function () {return this.value},
            set: function (val) {
                // clear existing content
                for (let i = hcaInfoTable.body.el.getElementsByTagName("tr").length - 1; i >= 0; i--) {
                    hcaInfoTable.body.el.deleteRow(i);
                }
                function appendRow(cells, rowspan) {
                    let newRow = hcaInfoTable.body.el.insertRow(-1);
                    cells.forEach((val, idx) => {
                        let newCell = newRow.insertCell(idx);
                        if (rowspan != null && idx == 0)
                            newCell.setAttribute("rowspan", rowspan);
                        if (cells.length < 3 && idx == cells.length - 1)
                            newCell.setAttribute("colspan", cells.length - idx + 1);
                        let newText = val != null
                            ? document.createTextNode("" + val)
                            : (() => {
                                let italic = document.createElement("i");
                                italic.innerHTML = "(not defined)";
                                return italic;
                            })();
                        newCell.appendChild(newText);
                    });
                }
                function toHex(num) {
                    const padding = "0000";
                    let hex = padding + num.toString(padding.length * 4).toUpperCase();
                    return "0x" + hex.substring(hex.length - padding.length, hex.length)
                }
                if (val == null || !val instanceof HCAInfo) {
                    appendRow([hcaInfoTable.body.defText]);
                    return; // nothing to add
                }
                // add given content
                let info = val;
                const hcaInfoTextArray = [
                    ["Version", info.version],
                    ["Header size", info.dataOffset],
                    ["Format", !info.hasHeader["fmt"] ? null : [
                        ["Channels", info.format.channelCount],
                        ["Sampling Rate", info.format.samplingRate],
                        ["Blocks", info.format.blockCount],
                        ["Dropped smpl. (head)", info.format.droppedHeader],
                        ["Dropped smpl. (tail)", info.format.droppedFooter],
                    ]],
                    ["Block size", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.blockSize],
                    ["Bitrate (kbps)", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.kbps],
                    ["VBR", info.hasHeader["vbr"] ? "yes" : "no"],
                    ["ATH", !info.hasHeader["ath"] ? null : toHex(info.ath)],
                    ["Loop", !info.hasHeader["loop"] ? null : [
                        ["Start", info.loop.start],
                        ["End", info.loop.end],
                        ["Dropped smpl. (head)", info.loop.droppedHeader],
                        ["Dropped smpl. (tail)", info.loop.droppedFooter],
                    ]],
                    ["Cipher", !info.hasHeader["ciph"] ? null : toHex(info.cipher)],
                    ["RVA (volume)", !info.hasHeader["rva"] ? null : info.rva],
                    ["Comment", !info.hasHeader["comm"] ? null : info.comment],
                ];
                for (let item of hcaInfoTextArray) {
                    let key = item[0];
                    let val = item[1];
                    if (Array.isArray(val)) {
                        let textList = val[0].slice(0);
                        textList.unshift(key);
                        appendRow(textList, val.length);
                        val.shift();
                        val.forEach((item) => appendRow(item))
                    } else {
                        appendRow([key, val]);
                    }
                }
                // update value
                this.value = val;
            },
        });

        // keys
        const keys = {key1: undefined, key2: undefined};
        for (let key in keys) {
            Object.defineProperty(keys, key, {
                get: function () {return document.getElementById(key + "input").value},
                set: function (val) {document.getElementById(key + "input").value = val},
            });
        }

        // mode/loop/volume
        const decodingParam = {
            mode: {
                el: document.getElementById("decodingmodeinput"),
                defVal: 16,
            },
            loop: {
                el: document.getElementById("loopcountinput"),
                defVal: 0,
            },
            volumePerCent: {
                el: document.getElementById("volumeinput"),
                defVal: 100,
            },
        }

        for (let paramName in decodingParam) {
            let el = decodingParam[paramName].el;
            let defVal = decodingParam[paramName].defVal;
            let attr = {};
            ["min", "max", "step"].forEach((attrName) => attr[attrName] = el.getAttribute(attrName));
            let clampVal = function (val) {
                if (val == null || val === "")
                    return defVal;
                val = parseInt(val);
                if (isNaN(val))
                    return defVal;
                if (val % attr.step != 0)
                    val = Math.floor(val / attr.step);
                else if (val < attr.min)
                    val = attr.min;
                else if (val > attr.max)
                    val = attr.max;
                return val;
            }
            Object.defineProperty(decodingParam, paramName, {
                get: function () {
                    let clamped = clampVal(el.value);
                    el.value = "" + clamped;
                    return clamped;
                },
                set: function (val) {
                    el.value = "" + clampVal(val);
                }
            });
        }

        // HCA file data
        const hcaFileData = {
            // original HCA file content
            original: {
                btnID: "downloadbtn",
                data: {},
            },
            // after fixing checksum
            fixed_checksum: {
                btnID: "fixcsumbtn",
                data: {},
            },
            // after decryption
            decrypted: {
                btnID: "decryptbtn",
                data: {},
            },
            // after encryption
            encrypted: {
                btnID: "encryptbtn",
                data: {},
            },
            // after decoding
            decoded: {
                btnID: "decodebtn",
                data: {},
            },
        }
        for (let suffix in hcaFileData) {
            Object.defineProperty(hcaFileData[suffix], "data", {
                get: function () {return this.value},
                set: function (val) {
                    this.value = null; // clear existing data
                    const fileExtRegEx = /\.([^\.]+)$/;
                    let newFileName = fileName.replace(fileExtRegEx, "_" + suffix + ".$1");
                    if (suffix === "decoded")
                        newFileName = newFileName.replace(fileExtRegEx, ".wav");
                    let id = suffix + "-download-link";
                    let el = document.getElementById(id);
                    if (el != null) {
                        // remove existing download link
                        URL.revokeObjectURL(el.getAttribute("href"));
                        el.nextSibling.remove();
                        el.remove();
                    }
                    if (val == null) {
                        console.log(`hcaFileData ${suffix} cleared`);
                        return; // nothing to create
                    }
                    console.log(`hcaFileData ${suffix} byteLength=${val.byteLength}`);
                    // create new download link
                    el = document.createElement("a");
                    el.setAttribute("id", id);
                    el.setAttribute("download", newFileName);
                    let extName = newFileName.match(fileExtRegEx)[0];
                    let mimeType = mimeTypeMap[extName];
                    if (mimeType == null) mimeType = defMimeType;
                    el.setAttribute("href", URL.createObjectURL(new Blob([val], {type: mimeType})));
                    el.innerHTML = newFileName;
                    let refNode = document.getElementById(hcaFileData[suffix].btnID).nextSibling;
                    document.body.insertBefore(document.createElement("br"), refNode);
                    document.body.insertBefore(el, refNode);
                    // update value
                    this.value = val;
                },
            });
        }
        function clearAllData() {
            localfileform.reset();
            for (let suffix in hcaFileData) {
                hcaFileData[suffix].data = null;
            }
            hcaInfoTable.body.data = null;
            audioElement.src = null;
            console.log(`cleared all data`);
        }

        // Audio element
        const audioElement = {
            el: document.getElementById("audioElement"),
            src: ""
        };
        Object.defineProperty(audioElement, "src", {
            get: function () {return this.value},
            set: function (val) {
                if (this.value != null && this.value != "")
                    URL.revokeObjectURL(this.value);
                if (val == null || val === "") {
                    this.value = audioElement.el.src = "";
                    return;
                }
                let newUrl;
                if (val instanceof ArrayBuffer || val.buffer instanceof ArrayBuffer) {
                    newUrl = URL.createObjectURL(new Blob([val], {type: mimeTypeMap.wav}));
                } else {
                    newUrl = val;
                }
                this.value = audioElement.el.src = newUrl;
            }
        });

        // buttons
        const buttons = {
            startworkerbtn: async (self) => {
                if (worker == null) {
                    if (hcaJsObjUrl == null) {
                        const response = await fetch(hcaJsUrl.href);
                        const blob = new Blob([await response.arrayBuffer()], {type: "text/javascript"});
                        hcaJsObjUrl = URL.createObjectURL(blob);
                    }
                    if (hcaJsModule == null) {
                        hcaJsModule = await import(hcaJsObjUrl);
                    }
                    if (HCAInfo == null) HCAInfo = hcaJsModule.HCAInfo;
                    if (HCAWorker == null) HCAWorker = hcaJsModule.HCAWorker;
                    worker = await HCAWorker.create(hcaJsObjUrl);
                    console.log("started background worker");
                }
                self.disabled = true; // added because button won't grey out if there's any await above
                buttons.shutdownbtn = true;
            },
            shutdownbtn: async (self) => {
                if (worker != null) {
                    await worker.shutdown();
                    worker = null;
                    console.log("background worker is now shut down");
                }
                self.disabled = true; // added together with above startworkerbtn
                buttons.startworkerbtn = true;
            },
            loadfilebtn: async (self) => {
                let file = null;
                if (draggedFile != null) {
                    self.textContent = "loading dragged file...";
                    file = draggedFile;
                    draggedFile = null;
                } else {
                    self.textContent = "loading picked file...";
                    file = localfile.files[0];
                }
                let newFileName = file.name;
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await file.arrayBuffer();
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "load picked file (successful)";
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            downloadbtn: async (self) => {
                self.textContent = "downloading...";
                let requestUrl = urlinput.value;
                if (requestUrl === "") {
                    self.textContent = "download (empty URL)";
                    self.disabled = false;
                    return;
                }
                let response = null;
                try {
                    response = await fetch(requestUrl);
                } catch (e) {
                    console.error(e);
                    self.textContent = "download (network error)";
                    self.disabled = false;
                    return;
                }
                if (response.status != 200) {
                    console.error("download failed,", response);
                    self.textContent = `download (failed, ${response.status} ${response.statusText})`;
                    self.disabled = false;
                    return;
                }
                // get filename from Content-Disposition
                let cd = response.headers.get("Content-Disposition");
                let newFileName = null;
                if (cd != null) {
                    let splitted = cd.split(";");
                    let cdFileName = splitted.find((substr) => substr.startsWith("filename="));
                    if (cdFileName != null) {
                        newFileName = cdFileName.substring("filename=".length)
                            .replaceAll(" ", "")
                            .replaceAll("\"", "");
                    }
                }
                // failed to get filename from Content-Disposition, try URL
                const fileNameRegEx = /[^\/^\\]+$/;
                if (newFileName == null || newFileName === "") {
                    let urlFilename = [response.url, requestUrl].find((url) => url != null && url.match(fileNameRegEx));
                    if (urlFilename != null)
                        newFileName = urlFilename.match(fileNameRegEx)[0];
                }
                // failed to get filename, use default filename
                if (newFileName == null || newFileName === "") {
                    newFileName = "downloaded.hca";
                }
                // strip query string
                let stripped = newFileName.match(/^[^\?]+/);
                if (stripped != null)
                    newFileName = stripped[0];
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await response.arrayBuffer();
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "download (successful)";
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            infobtn: async (self) => {
                let hca = hcaFileData[
                    ["fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`get HCA info from ${suffix} file data`);
                            return true;
                        }
                    })
                ].data;
                try {
                    let info = new HCAInfo(hca);
                    self.textContent = "get HCA info (successful)";
                    // update table content
                    hcaInfoTable.body.data = info;
                    // next step
                    let isEncrypted = info.hasHeader["ciph"] && info.cipher !=0;
                    buttons.encryptbtn = !isEncrypted;
                    buttons.decryptbtn = isEncrypted;
                    buttons.decodebtn = !isEncrypted;
                } catch (e) {
                    console.error(e);
                    self.textContent = "get HCA info (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            fixcsumbtn: async (self) => {
                try {
                    worker.tick();
                    let newHcaPromise = worker.fixChecksum(hcaFileData.original.data);
                    worker.tock("fix checksum");
                    let newHca = await newHcaPromise;
                    // update data
                    hcaFileData.fixed_checksum.data = newHca;
                    self.textContent = "fix checksum (successful)";
                } catch (e) {
                    console.error(e);
                    self.textContent = "fix checksum (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            encryptbtn: async (self) => {
                await encryptOrDecrypt(self, true);
                // let the button bounce
                self.disabled = false;
            },
            decryptbtn: async (self) => {
                await encryptOrDecrypt(self, false);
                // let the button bounce
                self.disabled = false;
            },
            decodebtn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = worker.decode(hca,
                        decodingParam.mode, decodingParam.loop, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let decoded = await decodedPromise;
                    // update data
                    hcaFileData.decoded.data = decoded;
                    self.textContent = "decode (done)";
                    // next step (play)
                    audioElement.src = decoded;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
        };
        const _buttons = {};
        for (let id in buttons) {
            let el = document.getElementById(id);
            let onclick = buttons[id];
            el.onclick = (ev) => {
                let self = ev.srcElement;
                self.disabled = true;
                onclick(self);
            }
            const initialText = el.textContent;
            Object.defineProperty(buttons, id, {
                get: function () {return !el.disabled},
                set: function (val) {
                    if (val === "click") {
                        el.disabled = true;
                        onclick(el);
                        return;
                    }
                    el.textContent = initialText;
                    el.disabled = !val;
                },
            });
            Object.defineProperty(_buttons, id, {
                get: function () {return onclick;},
            });
        }
        buttons.startworkerbtn = "click"; // start background worker
        function resetButtonsExcept(exceptBtnID) {
            for (let btnID in buttons) {
                if (btnID !== exceptBtnID) switch (btnID) {
                    case "startworkerbtn":
                        buttons[btnID] = worker == null || !worker.isAlive;
                        break;
                    case "shutdownbtn":
                        buttons[btnID] = worker != null && worker.isAlive;
                        break;
                    case "loadfilebtn":
                        buttons[btnID] = false;
                        break;
                    case "downloadbtn":
                        buttons[btnID] = true;
                        break;
                    default:
                        buttons[btnID] = false;
                }
            }
        }
        resetButtonsExcept(); // same to above, reset state on refresh
        async function encryptOrDecrypt(self, isEncrypting) {
            const action = isEncrypting ? "encrypt" : "decrypt";
            const opposite = isEncrypting ? "decrypt" : "encrypt";
            // disable both buttons
            self.disabled = true;
            buttons[opposite + "btn"] = false;
            self.textContent = action + "ing...";
            // disable decodebtn if necessary
            if (!isEncrypting)
                buttons.decodebtn = false
            // prepare data
            let hca = hcaFileData[
                [opposite + "ed", "fixed_checksum", "original"].find((suffix) => {
                    if (hcaFileData[suffix].data != null) {
                        console.log(`${action}ing ${suffix} data...`);
                        return true;
                    }
                })
            ].data;
            if (isEncrypting && !hcaInfoTable.body.data.hasHeader["ciph"]) {
                // check for ciph header section
                console.log("input HCA lacks ciph header section, adding it");
                hca = await worker.addCipherHeader(hca);
            } else {
                hca = hca.slice(0); // just copy to new buffer
            }
            // start to encrypt/decrypt
            try {
                worker.tick();
                // although decryption/encryption is done in-place,
                // however since we are not using SharedArrayBuffer,
                // the background worker is still actually overwritting a newly allocated buffer
                let resultPromise = worker[action](hca, keys.key1, keys.key2);
                worker.tock(isEncrypting ? "encryption" : "decryption");
                let result = await resultPromise;
                self.textContent = action + " (done)";
                // update data
                hcaFileData[action + "ed"].data = result;
                // next steps
                buttons[opposite + "btn"] = true;
                if (!isEncrypting)
                    buttons.decodebtn = true;
            } catch (e) {
                console.error(e);
                self.textContent = "Error during " + (isEncrypting ? "encryption" : "decryption");
            }
        }

        globalThis.buttons = buttons;
    </script>
</body>
</html>